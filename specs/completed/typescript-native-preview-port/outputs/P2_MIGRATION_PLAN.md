# P2 Migration Plan: TypeScript Native Preview Port

**Date**: 2026-02-10
**Branch**: `native-preview-experiment`
**Phase**: 2 — Planning
**Input**: P1 Discovery Report (`outputs/P1_DISCOVERY_REPORT.md`)

---

## Migration Path

- **Chosen path**: CHECK-ONLY
- **Rationale**: tsgo replaces `tsc` exclusively in `check` scripts (type-checking with `--noEmit`). Build scripts (`build-esm`, `build`, `dev`) continue using `tsc`.

### Decision Tree Evidence

```
1. Can tsgo emit JS + declarations for a leaf package?
   → YES: @beep/types built successfully with tsgo -b tsconfig.build.json (EXIT 0)

2. Can tsgo emit JS + declarations for an Effect-heavy package?
   → NO: @beep/schema fails with tsgo -b due to const type parameter parser bug.
     tsgo cannot parse `<const Value>` syntax in .d.ts files generated by
     upstream packages (even files tsgo itself generated).
     ERROR: TS1389: 'const' is not allowed as a variable declaration name
   → PATH = "CHECK-ONLY"
```

### Why Not Other Paths?

| Path | Blocked By | Evidence |
|------|-----------|----------|
| **STRICT** | typescript package cannot be removed | ts-morph (`tooling/cli`), effect-language-service (root `prepare`), analyze-jsdoc (`tooling/repo-scripts`) all require it at runtime |
| **HYBRID** | const type parameter parser bug | tsgo -b fails on any package downstream of @beep/utils (~54 of 57 packages). tsgo emits .d.ts with `<const Value>` but cannot parse them back. Self-incompatibility confirmed. |
| **CHECK-ONLY** | Nothing — viable | tsgo --noEmit -p resolves through .ts source files via `paths` in tsconfig.base.jsonc, completely avoiding the .d.ts parsing issue |

### Performance Benefit

- `check` is the most frequently executed developer command
- 7-10x speedup on type-checking across all packages
- Build frequency is lower and already cached by Turborepo

---

## tsconfig Changes

**None required.** All flags in `tsconfig.base.jsonc` are accepted by tsgo.

| Flag | Value | tsgo Status |
|------|-------|-------------|
| `rewriteRelativeImportExtensions` | `true` | Accepted |
| `erasableSyntaxOnly` | `true` | Accepted |
| `emitDecoratorMetadata` | `true` | Accepted |
| `experimentalDecorators` | `true` | Accepted |
| `exactOptionalPropertyTypes` | `true` | Accepted |
| `noUncheckedIndexedAccess` | `true` | Accepted |
| `declarationMap` | `true` | Accepted |
| `preserveWatchOutput` | `true` | Accepted |
| `composite` | `true` | Accepted |
| `incremental` | `true` | Accepted |
| All other flags | various | Accepted |

**Note on `--noEmit` vs `-b`**: The current `check` scripts use `tsc -b tsconfig.json` (build mode, validates project references via .d.ts). The new `tsgo --noEmit -p tsconfig.json` resolves through `paths` in `tsconfig.base.jsonc` to .ts source files. This is a resolution strategy change, but both validate types correctly. Project reference integrity is still validated by the unchanged `build-esm` scripts using `tsc -b`.

---

## Package Migration Order

### Universal Change Pattern

For **63 of 64 packages**, the change is identical:

```diff
- "check": "tsc -b tsconfig.json"
+ "check": "tsgo --noEmit -p tsconfig.json"
```

For **1 package** (`apps/todox`), the change is:

```diff
- "check": "tsc --noEmit"
+ "check": "tsgo --noEmit"
```

**No other scripts are modified.** `build-esm`, `build`, `dev`, and all other scripts remain unchanged.

### Batch Execution Strategy

Because the change is uniform, the migration can be executed as a batch operation rather than per-package. Two sed commands cover the entire monorepo:

```bash
# Step 1: All packages with "tsc -b tsconfig.json" check scripts (63 packages)
find packages/ tooling/ apps/server -name "package.json" -not -path "*/node_modules/*" \
  -exec sed -i 's/"check": "tsc -b tsconfig.json"/"check": "tsgo --noEmit -p tsconfig.json"/g' {} +

# Step 2: apps/todox special case
sed -i 's/"check": "tsc --noEmit"/"check": "tsgo --noEmit"/g' apps/todox/package.json
```

### Tier 1: Leaf Packages (3 packages)

| # | Package | Location | Check Before | Check After |
|---|---------|----------|-------------|------------|
| 1 | `@beep/types` | `packages/common/types` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 2 | `@beep/constants` | `packages/common/constants` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 3 | `@beep/invariant` | `packages/common/invariant` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |

### Tier 2: Common Foundation (7 packages)

| # | Package | Location | Check Before | Check After |
|---|---------|----------|-------------|------------|
| 4 | `@beep/utils` | `packages/common/utils` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 5 | `@beep/schema` | `packages/common/schema` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 6 | `@beep/identity` | `packages/common/identity` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 7 | `@beep/wrap` | `packages/common/wrap` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 8 | `@beep/errors` | `packages/common/errors` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 9 | `@beep/machine` | `packages/common/machine` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 10 | `@beep/semantic-web` | `packages/common/semantic-web` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |

### Tier 3: Shared Layer (7 packages)

| # | Package | Location | Check Before | Check After |
|---|---------|----------|-------------|------------|
| 11 | `@beep/shared-domain` | `packages/shared/domain` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 12 | `@beep/shared-tables` | `packages/shared/tables` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 13 | `@beep/shared-server` | `packages/shared/server` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 14 | `@beep/shared-client` | `packages/shared/client` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 15 | `@beep/shared-ui` | `packages/shared/ui` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 16 | `@beep/shared-env` | `packages/shared/env` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 17 | `@beep/shared-ai` | `packages/shared/ai` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |

### Tier 4: Slice Packages (30 packages)

| # | Package | Location | Check Before | Check After |
|---|---------|----------|-------------|------------|
| 18 | `@beep/iam-domain` | `packages/iam/domain` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 19 | `@beep/iam-tables` | `packages/iam/tables` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 20 | `@beep/iam-server` | `packages/iam/server` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 21 | `@beep/iam-client` | `packages/iam/client` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 22 | `@beep/iam-ui` | `packages/iam/ui` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 23 | `@beep/documents-domain` | `packages/documents/domain` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 24 | `@beep/documents-tables` | `packages/documents/tables` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 25 | `@beep/documents-server` | `packages/documents/server` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 26 | `@beep/documents-client` | `packages/documents/client` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 27 | `@beep/documents-ui` | `packages/documents/ui` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 28 | `@beep/calendar-domain` | `packages/calendar/domain` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 29 | `@beep/calendar-tables` | `packages/calendar/tables` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 30 | `@beep/calendar-server` | `packages/calendar/server` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 31 | `@beep/calendar-client` | `packages/calendar/client` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 32 | `@beep/calendar-ui` | `packages/calendar/ui` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 33 | `@beep/knowledge-domain` | `packages/knowledge/domain` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 34 | `@beep/knowledge-tables` | `packages/knowledge/tables` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 35 | `@beep/knowledge-server` | `packages/knowledge/server` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 36 | `@beep/knowledge-client` | `packages/knowledge/client` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 37 | `@beep/knowledge-ui` | `packages/knowledge/ui` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 38 | `@beep/comms-domain` | `packages/comms/domain` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 39 | `@beep/comms-tables` | `packages/comms/tables` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 40 | `@beep/comms-server` | `packages/comms/server` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 41 | `@beep/comms-client` | `packages/comms/client` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 42 | `@beep/comms-ui` | `packages/comms/ui` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 43 | `@beep/customization-domain` | `packages/customization/domain` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 44 | `@beep/customization-tables` | `packages/customization/tables` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 45 | `@beep/customization-server` | `packages/customization/server` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 46 | `@beep/customization-client` | `packages/customization/client` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 47 | `@beep/customization-ui` | `packages/customization/ui` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |

### Tier 5: Integration Packages (3 packages)

| # | Package | Location | Check Before | Check After |
|---|---------|----------|-------------|------------|
| 48 | `@beep/google-workspace-domain` | `packages/integrations/google-workspace/domain` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 49 | `@beep/google-workspace-client` | `packages/integrations/google-workspace/client` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 50 | `@beep/google-workspace-server` | `packages/integrations/google-workspace/server` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |

### Tier 6: Internal Packages (1 package)

| # | Package | Location | Check Before | Check After |
|---|---------|----------|-------------|------------|
| 51 | `@beep/db-admin` | `packages/_internal/db-admin` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |

### Tier 7: UI Packages (4 packages)

| # | Package | Location | Check Before | Check After |
|---|---------|----------|-------------|------------|
| 52 | `@beep/ui-core` | `packages/ui/core` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 53 | `@beep/ui` | `packages/ui/ui` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 54 | `@beep/ui-editor` | `packages/ui/editor` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 55 | `@beep/ui-spreadsheet` | `packages/ui/spreadsheet` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |

### Tier 8: Runtime & Apps (4 packages)

| # | Package | Location | Check Before | Check After |
|---|---------|----------|-------------|------------|
| 56 | `@beep/runtime-client` | `packages/runtime/client` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 57 | `@beep/runtime-server` | `packages/runtime/server` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 58 | `@beep/server` | `apps/server` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 59 | `@beep/todox` | `apps/todox` | `tsc --noEmit` | `tsgo --noEmit` |

### Tier 9: Tooling (5 packages)

| # | Package | Location | Check Before | Check After |
|---|---------|----------|-------------|------------|
| 60 | `@beep/tooling-utils` | `tooling/utils` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 61 | `@beep/build-utils` | `tooling/build-utils` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 62 | `@beep/testkit` | `tooling/testkit` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 63 | `@beep/repo-scripts` | `tooling/repo-scripts` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |
| 64 | `@beep/repo-cli` | `tooling/cli` | `tsc -b tsconfig.json` | `tsgo --noEmit -p tsconfig.json` |

---

## Excluded Packages

**No packages are excluded from the CHECK-ONLY migration.** Since `--noEmit` resolves through `.ts` source files via `paths` rather than `.d.ts` files, the const type parameter parser bug does not apply. All 64 packages can use tsgo for type-checking.

### Scripts That Remain on tsc

The following scripts are **intentionally NOT migrated** (build/emit scripts stay on tsc):

| Script | Reason |
|--------|--------|
| `build-esm` (`tsc -b tsconfig.build.json`) | tsgo -b fails on packages downstream of @beep/utils due to const type param bug |
| `build` (tooling: `tsc -b tsconfig.build.json`) | Same as build-esm |
| `dev` (`tsc -b tsconfig.build.json --watch`) | tsgo watch lacks incremental recheck; tsc is more mature |
| `prepare` (`effect-language-service patch`) | Patches typescript package; unrelated to tsgo |

### Packages Retaining `typescript` Dependency

| Package | Reason |
|---------|--------|
| `@beep/repo-cli` | ts-morph runtime dependency for AST manipulation |
| `@beep/repo-scripts` | ts-morph + analyze-jsdoc runtime dependencies |
| `@beep/build-utils` | typescript dependency for build tooling |
| `@beep/tooling-utils` | typescript dev dependency |
| `apps/todox` | typescript dev dependency |
| Root `package.json` | effect-language-service patch + typescript dev dependency |

---

## Per-Package Acceptance Criteria

After migrating each package's `check` script, verify:

```bash
# 1. tsgo check passes
bun run check --filter @beep/<package>    # Must exit 0

# 2. Build still works (unchanged, uses tsc)
bun run build --filter @beep/<package>    # Must exit 0

# 3. Tests still pass (unchanged)
bun run test --filter @beep/<package>     # Must exit 0
```

**For batch migration**: Since all changes are uniform and independent (each package's check script only affects that package), batch verification is preferred over per-package:

```bash
# After all 64 packages are migrated at once:
bun run check     # Must exit 0 (runs tsgo --noEmit across all packages)
bun run build     # Must exit 0 (still uses tsc -b, unchanged)
bun run test      # Must exit 0 (unchanged)
```

---

## Full Repo Acceptance Criteria

After all packages are migrated, the following must pass:

```bash
bun run build      # Must exit 0 — builds all packages with tsc (unchanged)
bun run check      # Must exit 0 — type-checks all packages with tsgo (migrated)
bun run lint:fix   # Must exit 0 — biome formatting (unchanged)
bun run lint       # Must exit 0 — biome lint (unchanged)
bun run test       # Must exit 0 — bun test (unchanged)
```

### Additional Verification

```bash
# Confirm tsgo is being invoked (not tsc) for check scripts
grep -r '"check": "tsgo' packages/*/package.json packages/*/*/package.json tooling/*/package.json apps/*/package.json | wc -l
# Expected: 64

# Confirm NO check scripts still reference tsc
grep -r '"check": "tsc' packages/*/package.json packages/*/*/package.json tooling/*/package.json apps/*/package.json | wc -l
# Expected: 0

# Confirm build scripts still reference tsc (unchanged)
grep -r '"build-esm": "tsc' packages/*/package.json packages/*/*/package.json | wc -l
# Expected: 57 (all standard pattern packages)
```

---

## Rollback Procedure

### Full Rollback (Recommended)

Since all changes are in `package.json` files only:

```bash
# Option A: Git revert all package.json changes
git checkout HEAD -- $(find packages/ tooling/ apps/ -name "package.json" -not -path "*/node_modules/*")

# Option B: Batch sed reversal
find packages/ tooling/ apps/server -name "package.json" -not -path "*/node_modules/*" \
  -exec sed -i 's/"check": "tsgo --noEmit -p tsconfig.json"/"check": "tsc -b tsconfig.json"/g' {} +
sed -i 's/"check": "tsgo --noEmit"/"check": "tsc --noEmit"/g' apps/todox/package.json
```

### Per-Package Rollback

For any single package that fails:

```bash
# Revert one package
cd <package-directory>
sed -i 's/"check": "tsgo --noEmit -p tsconfig.json"/"check": "tsc -b tsconfig.json"/g' package.json
```

### Dependency Rollback

The `@typescript/native-preview` package can be removed if needed:

```bash
bun remove @typescript/native-preview
```

This does NOT affect any build scripts since they use `tsc` from the `typescript` package.

---

## Implementation Procedure (Phase 3 Instructions)

### Step 1: Verify Preconditions

```bash
# Confirm tsgo is installed and working
npx tsgo --version
# Expected: 7.0.0-dev.*

# Confirm current check scripts use tsc
grep -r '"check": "tsc' packages/*/package.json | head -5
```

### Step 2: Execute Batch Migration

```bash
# Migrate all standard check scripts
find packages/ tooling/ apps/server -name "package.json" -not -path "*/node_modules/*" \
  -exec sed -i 's/"check": "tsc -b tsconfig.json"/"check": "tsgo --noEmit -p tsconfig.json"/g' {} +

# Migrate todox special case
sed -i 's/"check": "tsc --noEmit"/"check": "tsgo --noEmit"/g' apps/todox/package.json
```

### Step 3: Verify Migration Completeness

```bash
# Count migrated packages
grep -r '"check": "tsgo' packages/*/package.json packages/*/*/package.json packages/*/*/*/package.json tooling/*/package.json apps/*/package.json 2>/dev/null | wc -l
# Expected: 64

# Confirm zero remaining tsc check scripts
grep -r '"check": "tsc' packages/*/package.json packages/*/*/package.json packages/*/*/*/package.json tooling/*/package.json apps/*/package.json 2>/dev/null | wc -l
# Expected: 0
```

### Step 4: Run Acceptance Gates

```bash
# Primary gate: type-checking with tsgo
bun run check
# Must exit 0

# Secondary gates: build and test (unchanged, but verify no regressions)
bun run build
bun run test
bun run lint
```

### Step 5: Handle Failures

If `bun run check` fails:

1. **Identify failing package(s)** from the error output
2. **Test individually**: `bun run check --filter @beep/<failing-package>`
3. **Compare with tsc**: Temporarily revert the failing package and run `tsc -b tsconfig.json` to check if the error is tsgo-specific
4. **If tsgo-specific**: Revert that package to tsc and document as a tsgo incompatibility
5. **If shared error**: The error exists in both tsc and tsgo — fix the code, not the migration

---

## Estimated Effort

| Metric | Value |
|--------|-------|
| Total packages to migrate | 64 |
| Packages with identical change pattern | 63 (`tsc -b tsconfig.json` → `tsgo --noEmit -p tsconfig.json`) |
| Packages with unique change | 1 (`apps/todox`: `tsc --noEmit` → `tsgo --noEmit`) |
| Can batch migrate | **YES** — two sed commands cover everything |
| Estimated migration time | ~2 minutes (batch sed + verification) |
| Estimated verification time | ~10-15 minutes (full `check` + `build` + `test` cycle) |
| Total estimated time | ~15-20 minutes |
| Files modified | 64 `package.json` files |
| Lines changed per file | 1 |
| tsconfig changes | 0 |
| Risk level | Low — check scripts are isolated from build/deploy |

---

## Risks and Mitigations

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| tsgo type-checking produces different errors than tsc | Low (~0.4% incompatibility) | Medium — false positives/negatives | Compare tsgo output with tsc for any discrepancies; revert individual packages if needed |
| `--noEmit -p` resolution differs from `-b` resolution | Low | Low — paths in tsconfig.base.jsonc cover all packages | Both resolve the same source files, just through different mechanisms |
| tsgo crashes on specific package | Very Low | Low — per-package rollback is trivial | Revert single package.json; tsgo has been tested on leaf and Effect-heavy packages |
| Developer confusion about check vs build tools | Low | Low — informational | Document in PR description that check uses tsgo, build uses tsc |
| `@ts-expect-error` inconsistencies | Low | Low — minor annotation differences | Fix on a case-by-case basis; P1 research noted this as a minor risk |

---

## Future Opportunities

When tsgo's const type parameter parser bug is fixed (tracked in TypeScript Go project):

1. **HYBRID migration**: Replace `build-esm` scripts with tsgo for 7-10x faster builds
2. **Watch mode**: Replace `dev` scripts when tsgo watch gets incremental recheck
3. **Full build pipeline**: Use tsgo for the entire `build` → `check` → `test` cycle

Monitor `@typescript/native-preview` releases for parser fixes. The const type parameter bug is the sole blocker for HYBRID/STRICT paths.
