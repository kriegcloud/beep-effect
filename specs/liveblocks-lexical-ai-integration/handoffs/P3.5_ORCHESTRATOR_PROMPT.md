# Phase 3.5 Orchestrator Prompt: Browser Testing & Runtime Error Fixing

> **Spec**: Liveblocks Lexical AI Integration
> **Phase**: 3.5 of 5
> **Focus**: Fix runtime errors and verify features via browser testing

Copy-paste this entire prompt to start Phase 3.5 implementation.

---

## Mission Statement

Fix the critical Lexical version mismatch error that prevents the editor from loading, then perform comprehensive browser testing using MCP tools (`claude-in-chrome`, `next-devtools`) to verify all collaborative AI features work correctly. This is a stabilization phase that ensures the implementation from Phase 3 actually runs in the browser.

---

## Context

### Phase 3 Completion Summary

| Task | Status | Notes |
|------|--------|-------|
| OpenAI environment configuration | Verified | `OPENAI_API_KEY` in root `.env` |
| Error handling in ai.ts | Verified | 5 error types + fallback implemented |
| AiActivityOverlay integration | Fixed | Now renders via portal in CollaborativeFloatingAiPanel |
| Conflict guard verification | Verified | `canProceed` check already existed |
| Typecheck | Passed | 101/101 tasks |
| Lint | Passed | Modified files clean |

### Critical Blocking Error

**The editor cannot load due to Lexical version mismatch:**

```
HeadingNode (type heading) does not subclass LexicalNode from the lexical package
used by this editor (version <unknown>). All lexical and @lexical/* packages used
by an editor must have identical versions.

Location: src/app/lexical/App.tsx:127
at LexicalExtensionComposer
```

**Root Cause**: Multiple versions of `@lexical/*` packages are installed across the workspace. The Lexical framework requires ALL packages (`lexical`, `@lexical/react`, `@lexical/rich-text`, etc.) to be the exact same version.

**Diagnosis Approach**:
1. Analyze `bun.lock` for multiple lexical version resolutions
2. Check `package.json` files across workspace for version inconsistencies
3. Run `bun pm ls lexical` to see the dependency tree
4. Check if any package imports lexical differently (ESM vs CJS)

### Testing URL

```
http://localhost:3000/lexical
```

### MCP Tools for Testing

**1. claude-in-chrome** - Browser automation:

```typescript
// Navigate to page
mcp__claude-in-chrome__navigate({ url: "http://localhost:3000/lexical" })

// Read console for errors
mcp__claude-in-chrome__read_console_messages({ pattern: "error" })

// Execute JavaScript to test features
mcp__claude-in-chrome__javascript_tool({ code: "document.querySelector('.ai-panel')" })

// Click elements
mcp__claude-in-chrome__computer({ action: "click", x: 100, y: 200 })

// Type text
mcp__claude-in-chrome__computer({ action: "type", text: "Hello world" })

// Take screenshot
mcp__claude-in-chrome__screenshot()

// Record GIF of test flow
mcp__claude-in-chrome__gif_creator({ filename: "ai-panel-test.gif" })
```

**2. next-devtools** - Next.js development tools for error monitoring

---

## Workflow: Diagnose -> Fix -> Test -> Verify

### Step 1: Diagnose Lexical Version Mismatch (BLOCKING)

**Agent**: `codebase-researcher`

```
Analyze the Lexical version mismatch error:

1. Search bun.lock for all lexical package resolutions:
   - Count unique versions of `lexical`
   - Count unique versions of `@lexical/react`
   - Count unique versions of `@lexical/rich-text`
   - Count unique versions of all `@lexical/*` packages

2. Check package.json files in workspace:
   - apps/todox/package.json
   - packages/ui/editor/package.json (if exists)
   - Any other packages with lexical dependencies

3. Identify which packages are pulling different versions

4. Document the discrepancy for fix

Output: Version discrepancy report with specific packages and their versions
```

**Verification Commands**:
```bash
# See lexical dependency tree
bun pm ls lexical

# Check for multiple resolutions
grep -E "\"lexical|@lexical" bun.lock | head -50

# Find all package.json with lexical
grep -r "lexical" --include="package.json" . 2>/dev/null | grep -v node_modules
```

### Step 2: Fix Lexical Version Mismatch

**Agent**: `effect-code-writer` or Orchestrator (depending on complexity)

**Option A: Simple Version Alignment**

If versions are close (e.g., 0.20.0 vs 0.20.1):

```
Update all @lexical/* packages to the same version:

1. Identify the target version (prefer the most common or latest stable)
2. Update all package.json files to use exact versions (no ^ or ~)
3. Run bun install to regenerate lock file
4. Verify single version in bun.lock

Pattern for package.json:
{
  "dependencies": {
    "lexical": "0.20.0",
    "@lexical/react": "0.20.0",
    "@lexical/rich-text": "0.20.0",
    "@lexical/list": "0.20.0",
    "@lexical/code": "0.20.0",
    "@lexical/link": "0.20.0",
    "@lexical/markdown": "0.20.0"
  }
}
```

**Option B: Override in Root package.json**

If transitive dependencies pull wrong versions:

```json
// Root package.json
{
  "overrides": {
    "lexical": "0.20.0",
    "@lexical/react": "0.20.0",
    "@lexical/rich-text": "0.20.0",
    "@lexical/list": "0.20.0",
    "@lexical/code": "0.20.0",
    "@lexical/link": "0.20.0",
    "@lexical/markdown": "0.20.0"
  }
}
```

**Option C: Resolutions in package.json (Bun/Yarn)**

```json
{
  "resolutions": {
    "lexical": "0.20.0",
    "@lexical/*": "0.20.0"
  }
}
```

**Post-Fix Verification**:
```bash
# Clean install
rm -rf node_modules bun.lock
bun install

# Verify single version
bun pm ls lexical | grep -E "^\s+lexical@" | sort | uniq

# Start dev server and check
cd apps/todox && bun run dev
```

### Step 3: Browser Testing with claude-in-chrome

After fixing the version mismatch, test the application:

**Test 1: Editor Loads Without Errors**

```typescript
// Navigate
mcp__claude-in-chrome__navigate({ url: "http://localhost:3000/lexical" })

// Wait for page load
await sleep(2000);

// Check console for errors
mcp__claude-in-chrome__read_console_messages({ pattern: "error" })

// Verify editor rendered
mcp__claude-in-chrome__javascript_tool({
  code: "document.querySelector('[data-lexical-editor]') ? 'Editor found' : 'Editor missing'"
})
```

**Test 2: Console Clean Check**

```typescript
// Read all console messages
mcp__claude-in-chrome__read_console_messages({})

// Filter for errors specifically
const errors = messages.filter(m => m.level === 'error');
// Expected: 0 error-level messages
```

**Test 3: AI Panel Opens**

```typescript
// Method 1: Keyboard shortcut (if implemented)
mcp__claude-in-chrome__computer({ action: "key", key: "cmd+k" })

// Method 2: Click toolbar button
mcp__claude-in-chrome__javascript_tool({
  code: "document.querySelector('[data-ai-trigger]')?.click()"
})

// Verify panel visible
mcp__claude-in-chrome__javascript_tool({
  code: "document.querySelector('.ai-panel')?.offsetHeight > 0"
})
```

**Test 4: Text Selection + AI Features**

```typescript
// Click in editor to focus
mcp__claude-in-chrome__computer({ action: "click", x: 400, y: 300 })

// Type some text
mcp__claude-in-chrome__computer({ action: "type", text: "The quick brown fox jumps over the lazy dog." })

// Select text (Cmd+A or manual selection)
mcp__claude-in-chrome__computer({ action: "key", key: "cmd+a" })

// Trigger AI panel
mcp__claude-in-chrome__computer({ action: "key", key: "cmd+k" })

// Check if selection captured
mcp__claude-in-chrome__javascript_tool({
  code: "window.getSelection()?.toString()"
})
```

**Test 5: AiActivityOverlay Renders**

```typescript
// Check overlay in DOM
mcp__claude-in-chrome__javascript_tool({
  code: `
    const overlay = document.body.querySelector('[data-ai-activity-overlay]')
      || document.querySelector('.ai-activity-indicator');
    overlay ? 'Overlay present' : 'Overlay missing'
  `
})
```

**Test 6: Record Success Flow (Optional)**

```typescript
// Start recording
mcp__claude-in-chrome__gif_creator({ filename: "ai-panel-test.gif", duration: 10 })

// Perform test flow
// ... navigation, typing, AI trigger ...

// GIF saved automatically
```

### Step 4: Fix Any Discovered Runtime Errors

**Agent**: `effect-code-writer`

For each error discovered during browser testing:

```
Error triage process:

1. Read console error message
2. Identify source file and line
3. Categorize:
   - Import error -> Check path aliases, package installation
   - Type error -> May need runtime guards
   - React error -> Check component lifecycle
   - Liveblocks error -> Check provider setup
   - AI error -> Check server action

4. Fix in order of severity:
   - Blocking errors (prevent render) FIRST
   - Functional errors (break features) SECOND
   - Warning-level issues LAST

5. Re-test after each fix
```

### Step 5: Final Verification

**Test Matrix**:

| Feature | Test Method | Expected Result | Status |
|---------|-------------|-----------------|--------|
| Editor loads | Navigate + inspect | No errors, editor visible | [ ] |
| Console clean | read_console_messages | No error-level messages | [ ] |
| Text input works | Type + verify | Text appears in editor | [ ] |
| AI panel opens | Keyboard/click | Panel component visible | [ ] |
| Text selection | Select + inspect | Selection available to AI | [ ] |
| AiActivityOverlay | DOM inspection | Overlay in document.body | [ ] |

---

## Key Files

### Primary (May Need Modification)

| File | Potential Change |
|------|------------------|
| `apps/todox/package.json` | Align lexical versions |
| `packages/ui/editor/package.json` | Align lexical versions (if exists) |
| `package.json` (root) | Add resolutions/overrides |
| Any component with runtime errors | Fix based on browser testing |

### Reference (For Debugging)

| File | Purpose |
|------|---------|
| `apps/todox/src/app/lexical/App.tsx` | Where error occurs (line 127) |
| `apps/todox/src/app/lexical/context/LiveblocksProvider.tsx` | Provider setup |
| `apps/todox/src/app/lexical/plugins/AiAssistantPlugin/components/CollaborativeFloatingAiPanel.tsx` | AI panel with overlay |
| `apps/todox/liveblocks.config.ts` | Presence types |
| `bun.lock` | Dependency resolutions |

---

## Constraints

### Version Alignment Rules

1. **ALL** `@lexical/*` packages MUST be the EXACT same version
2. Use exact versions in package.json (no `^` or `~`)
3. Prefer the version already used by most packages
4. Check `@liveblocks/react-lexical` compatibility requirements

### Effect Patterns (REQUIRED)

If fixing any TypeScript code:

```typescript
// Namespace imports
import * as Effect from "effect/Effect";
import * as A from "effect/Array";
import * as O from "effect/Option";

// No native methods
// FORBIDDEN: array.filter(x => ...)
// REQUIRED: A.filter(array, x => ...)
```

### Testing Protocol

1. **ALWAYS** clear console before testing
2. **ALWAYS** wait for page load (2+ seconds)
3. **ALWAYS** check console after each action
4. **NEVER** assume previous state is clean

---

## Agent Assignments

| Step | Agent Type | Task | Output |
|------|------------|------|--------|
| 1 | `codebase-researcher` | Analyze lexical versions in bun.lock | Version discrepancy report |
| 2 | `effect-code-writer` / Orchestrator | Fix version mismatch | Updated package.json(s) |
| 3 | Orchestrator (with claude-in-chrome) | Browser testing | Test results |
| 4 | `effect-code-writer` | Fix discovered runtime errors | Fixed components |
| 5 | Orchestrator | Final verification | Completion checklist |

---

## Success Criteria

Phase 3.5 is COMPLETE when ALL boxes checked:

### Lexical Version Fix

- [ ] All `@lexical/*` packages use identical version
- [ ] `bun install` completes without warnings
- [ ] Editor loads without version mismatch error
- [ ] HeadingNode error resolved

### Browser Testing

- [ ] Editor renders without runtime errors
- [ ] Console has no error-level messages
- [ ] AI panel opens correctly
- [ ] Text selection triggers AI features
- [ ] AiActivityOverlay component renders in DOM

### Code Quality

- [ ] Type check passes: `bun run check --filter @beep/todox`
- [ ] Lint check passes: `bun run lint --filter @beep/todox`
- [ ] No new TypeScript errors introduced

---

## Verification Commands

```bash
# Step 1: Diagnose
bun pm ls lexical
grep -E "\"lexical|@lexical" bun.lock | head -50

# Step 2: Fix
rm -rf node_modules bun.lock
bun install
bun pm ls lexical | sort | uniq

# Step 3: Build check
bun run check --filter @beep/todox

# Step 4: Start dev server
cd apps/todox && bun run dev

# Step 5: Browser test (use claude-in-chrome MCP)
# Navigate to http://localhost:3000/lexical
# Check console for errors
# Test AI features
```

---

## Post-Phase Actions

After completing Phase 3.5:

1. **Update Reflection Log**
   - Add learnings to `specs/liveblocks-lexical-ai-integration/REFLECTION_LOG.md`
   - Document the Lexical version mismatch issue and resolution
   - Note any other runtime errors fixed

2. **Update Handoff P4**
   - Note that Phase 3.5 completed
   - Update prerequisites for Phase 4

3. **Create GIF/Screenshots** (optional)
   - Record successful AI panel flow
   - Screenshot showing clean console
   - Add to `specs/liveblocks-lexical-ai-integration/outputs/`

---

## Troubleshooting Guide

### Error: Version Mismatch Persists After Fix

```bash
# Nuclear option - completely clean workspace
rm -rf node_modules bun.lock
rm -rf apps/*/node_modules packages/*/node_modules
bun install
```

### Error: Liveblocks Provider Issues

```typescript
// Check if provider is wrapping editor correctly
// LiveblocksProvider should be ancestor of LexicalComposer
```

### Error: AI Panel Not Opening

1. Check if keyboard shortcut is registered
2. Verify toolbar button exists in DOM
3. Check if panel state is managed correctly
4. Look for React hydration errors

### Error: Console Shows React Hydration Errors

```typescript
// Often caused by SSR/client mismatch
// Check for typeof window checks
// Verify dynamic imports with ssr: false
```

---

## Handoff Document

Read full context in: `specs/liveblocks-lexical-ai-integration/handoffs/HANDOFF_P4.md`

---

## Quick Reference: Testing Checklist

```
[ ] Pre-Testing Setup
    [ ] bun.lock analyzed for version discrepancies
    [ ] Lexical versions aligned
    [ ] bun install completed clean
    [ ] Dev server running

[ ] Browser Tests (claude-in-chrome)
    [ ] Navigate to /lexical
    [ ] Check console - no errors
    [ ] Editor renders
    [ ] Can type in editor
    [ ] AI panel opens
    [ ] Text selection works
    [ ] AiActivityOverlay in DOM

[ ] Post-Test
    [ ] bun run check passes
    [ ] bun run lint passes
    [ ] All features work
    [ ] Ready for Phase 4
```
