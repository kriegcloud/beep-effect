# Current Implementation Analysis

> Generated by: `codebase-researcher` agent in Phase 1
> Status: **COMPLETE**

---

## Summary

The `@beep/knowledge-server` package implements a custom `AiService` abstraction for LLM operations used in the knowledge extraction pipeline. The service uses the **legacy `Context.GenericTag` pattern** and provides 3 methods: `generateObject`, `generateObjectWithSystem`, and `generateText`. All extraction services **exclusively use `generateObjectWithSystem`** - the other 2 methods are defined but never invoked anywhere in the codebase.

---

## Relevant Files

| File | Purpose | Layer |
|------|---------|-------|
| `packages/knowledge/server/src/Ai/AiService.ts` | AiService interface, types, mock implementation | server |
| `packages/knowledge/server/src/Ai/PromptTemplates.ts` | Prompt construction templates | server |
| `packages/knowledge/server/src/Ai/index.ts` | Barrel exports | server |
| `packages/knowledge/server/src/Extraction/EntityExtractor.ts` | Entity classification using AiService | server |
| `packages/knowledge/server/src/Extraction/MentionExtractor.ts` | Mention detection using AiService | server |
| `packages/knowledge/server/src/Extraction/RelationExtractor.ts` | Relation extraction using AiService | server |
| `packages/knowledge/server/src/Extraction/ExtractionPipeline.ts` | Pipeline orchestration | server |

---

## Interface Definition

### AiService Interface

**Location**: `packages/knowledge/server/src/Ai/AiService.ts:74-116`

```typescript
export interface AiService {
  /**
   * Generate structured output matching a schema
   */
  readonly generateObject: <A, I>(
    schema: S.Schema<A, I>,
    prompt: string,
    config?: AiGenerationConfig
  ) => Effect.Effect<AiGenerationResult<A>, AiExtractionError>;

  /**
   * Generate structured output with system prompt
   */
  readonly generateObjectWithSystem: <A, I>(
    schema: S.Schema<A, I>,
    systemPrompt: string,
    userPrompt: string,
    config?: undefined | AiGenerationConfig
  ) => Effect.Effect<AiGenerationResult<A>, AiExtractionError>;

  /**
   * Generate raw text completion
   */
  readonly generateText: (
    prompt: string,
    config?: undefined | AiGenerationConfig
  ) => Effect.Effect<AiGenerationResult<string>, AiExtractionError>;
}
```

### Configuration Type

```typescript
export interface AiGenerationConfig {
  readonly maxTokens?: undefined | number;
  readonly temperature?: undefined | number;
  readonly model?: undefined | string;
}
```

### Result Type

```typescript
export interface AiGenerationResult<T> {
  readonly data: T;
  readonly usage: {
    readonly promptTokens: number;
    readonly completionTokens: number;
    readonly totalTokens: number;
  };
}
```

### Error Type

```typescript
export class AiExtractionError extends S.TaggedError<AiExtractionError>()("AiExtractionError", {
  message: S.String,
  retryable: S.Boolean,
  cause: S.optional(S.String),
}) {}
```

---

## Method Usages

### generateObject

| Location | Count |
|----------|-------|
| **TOTAL** | **0** |

The method is defined but **never called** anywhere in the codebase.

### generateObjectWithSystem

| File | Line | Schema | Purpose |
|------|------|--------|---------|
| EntityExtractor.ts | 171 | `EntityOutput` | Classify mentions using ontology types |
| MentionExtractor.ts | 100 | `MentionOutput` | Extract mentions from single chunk |
| MentionExtractor.ts | 159 | `MentionOutput` | Extract mentions from multiple chunks (batch) |
| RelationExtractor.ts | 170 | `RelationOutput` | Extract relations from single chunk |
| RelationExtractor.ts | 237 | `RelationOutput` | Extract relations from multiple chunks (batch) |
| **TOTAL** | **5** | | |

### generateText

| Location | Count |
|----------|-------|
| **TOTAL** | **0** |

The method is defined but **never called** anywhere in the codebase.

---

## Dependencies

### Services Depending on AiService

| Service | Usage |
|---------|-------|
| `MentionExtractor` | 2 calls to `generateObjectWithSystem` |
| `EntityExtractor` | 1 call to `generateObjectWithSystem` |
| `RelationExtractor` | 2 calls to `generateObjectWithSystem` |
| **Total** | **3 services, 5 calls** |

### Layer Composition

```
ExtractionPipeline
    ├── NlpService.Default
    ├── MentionExtractor.Default ─────┐
    ├── EntityExtractor.Default ──────┼── All require AiService
    ├── RelationExtractor.Default ────┘
    ├── GraphAssembler.Default
    └── OntologyService.Default
```

**Critical Observation**: `ExtractionPipeline` declares `dependencies` but **AiService is NOT in that list**. The extractors internally `yield* AiService` but the pipeline doesn't compose the AiService layer.

### Error Types

- `AiExtractionError` - Tagged error with `message`, `retryable`, and optional `cause`

---

## Legacy Patterns

### Context.GenericTag Usage

| File | Line | Tag |
|------|------|-----|
| AiService.ts | 124 | `Context.GenericTag<AiService>("@beep/knowledge-server/AiService")` |
| EmbeddingProvider.ts | 134 | `Context.GenericTag<EmbeddingProvider>("@beep/knowledge-server/EmbeddingProvider")` |
| OpenAiProvider.ts | 127 | `Context.GenericTag<OpenAiClientService>("@beep/knowledge-server/OpenAiClientService")` |

### Mock Implementation

```typescript
export const MockAiService: AiService = {
  generateObject: <A, I>(_schema: S.Schema<A, I>, _prompt: string, _config?: AiGenerationConfig) =>
    Effect.fail(
      new AiExtractionError({
        message: "MockAiService: generateObject not implemented",
        retryable: false,
      })
    ),

  generateObjectWithSystem: <A, I>(...) =>
    Effect.fail(
      new AiExtractionError({
        message: "MockAiService: generateObjectWithSystem not implemented",
        retryable: false,
      })
    ),

  generateText: (_prompt: string, _config?: AiGenerationConfig) =>
    Effect.fail(
      new AiExtractionError({
        message: "MockAiService: generateText not implemented",
        retryable: false,
      })
    ),
};

export const MockAiServiceLayer = Layer.succeed(AiService, MockAiService);
```

---

## Provider Analysis

**Status**: NO PRODUCTION PROVIDER EXISTS

The AiService has:
1. ✅ Interface definition
2. ✅ Mock implementation (fails with errors)
3. ✅ Mock layer
4. ❌ **NO actual provider implementation** connecting to OpenAI, Anthropic, or any LLM service

**Contrast with EmbeddingProvider**: The `EmbeddingProvider` abstraction DOES have a real implementation (`OpenAiProvider.ts`) that connects to OpenAI's embedding API.

---

## Testing Status

**Location**: `packages/knowledge/server/test/Dummy.test.ts`

```typescript
import { describe, expect, it } from "bun:test";

describe("@beep/knowledge-server", () => {
  it("should be defined", () => {
    expect(true).toBe(true);
  });
});
```

**Status**: PLACEHOLDER ONLY - No actual tests for AiService or any extraction services.

---

## Summary Statistics

| Metric | Value |
|--------|-------|
| Services depending on AiService | 3 |
| `generateObject` calls | 0 |
| `generateObjectWithSystem` calls | 5 |
| `generateText` calls | 0 |
| Provider implementations | 0 (mock only) |
| Test coverage | 0% (placeholder test) |
| Legacy patterns (`Context.GenericTag`) | 3 instances |

---

## Recommendations

### Patterns to Follow
- The `Effect.Service` pattern used in `MentionExtractor.ts:78` is correct and modern
- The prompt template approach in `PromptTemplates.ts` provides good separation of concerns
- The `AiGenerationResult` type capturing usage statistics is well-designed

### Patterns to Avoid
- **Context.GenericTag**: Should migrate to `Effect.Service` or `class extends Effect.Tag`
- **Missing layer composition**: The `ExtractionPipeline` doesn't include `AiService` in its `dependencies` array
- **Unused methods**: `generateObject` and `generateText` are defined but never used - remove them

### Critical Gaps
1. No production LLM provider implementation
2. No tests for extraction pipeline
3. AiService not included in ExtractionPipeline dependencies
4. Mock implementation always fails (cannot be used for testing pipeline structure)
