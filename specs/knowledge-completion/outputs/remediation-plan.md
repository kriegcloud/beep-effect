# Remediation Plan

> Generated by: Phase 2 Orchestrator
> Status: **COMPLETE**
> Date: 2026-01-22

---

## Executive Summary

**Total Violations**: 6 (0 P0, 4 P1, 2 P2)
**Blocking Issues**: None
**Recommended Action**: Proceed to Phase 3, address P1 items during P4

All identified issues are either:
- Expected legacy patterns scheduled for P4 deletion
- Intentional stubs awaiting implementation
- Minor style inconsistencies

---

## Priority Classification

| Priority | Definition | Action |
|----------|------------|--------|
| **P0** | Must fix before P4 (refactoring) | Block until resolved |
| **P1** | Should fix during P4 | Include in refactoring work |
| **P2** | Can fix in P8 (finalization) | Optional cleanup |

---

## P0 - Critical (Must Fix Before P4)

**None identified.**

---

## P1 - High Priority (Fix During P4)

### 1. AiService.ts - Context.GenericTag (DELETE)

| Attribute | Value |
|-----------|-------|
| **File** | `packages/knowledge/server/src/Ai/AiService.ts` |
| **Line** | 124 |
| **Issue** | Uses legacy `Context.GenericTag` pattern |
| **Impact** | Extractors cannot declare AiService in dependencies |
| **Action** | DELETE file in P4 (replaced by @effect/ai LanguageModel) |
| **Verification** | `grep -rn "AiService" packages/knowledge/server/src/` returns 0 results |

### 2. EmbeddingProvider.ts - Context.GenericTag (MIGRATE)

| Attribute | Value |
|-----------|-------|
| **File** | `packages/knowledge/server/src/Embedding/EmbeddingProvider.ts` |
| **Line** | 134 |
| **Issue** | Uses legacy `Context.GenericTag` pattern |
| **Impact** | EmbeddingService cannot declare dependencies |
| **Action** | Migrate to `Effect.Service<T>()` pattern |

**Before**:
```typescript
export const EmbeddingProvider = Context.GenericTag<EmbeddingProvider>(
  "@beep/knowledge-server/EmbeddingProvider"
);
```

**After**:
```typescript
export class EmbeddingProvider extends Effect.Service<EmbeddingProvider>()(
  "@beep/knowledge-server/EmbeddingProvider",
  { accessors: true }
) {
  generateEmbedding = (text: string) => Effect.gen(function* () {
    // Implementation
  });
}
```

### 3. OpenAiProvider.ts - Context.GenericTag (MIGRATE)

| Attribute | Value |
|-----------|-------|
| **File** | `packages/knowledge/server/src/Embedding/providers/OpenAiProvider.ts` |
| **Line** | 127 |
| **Issue** | Uses legacy `Context.GenericTag` pattern |
| **Impact** | Cannot use modern dependency injection |
| **Action** | Migrate to `Effect.Service<T>()` pattern |

### 4. Client Package - Incomplete (DEFER)

| Attribute | Value |
|-----------|-------|
| **Package** | `packages/knowledge/client` |
| **Issue** | Only stub implementation (index.ts) |
| **Impact** | No client-side API contracts |
| **Action** | Implement when API endpoints are exposed |
| **Blocking** | No - server-side focus for P4-P6 |

---

## P2 - Low Priority (Fix in P8)

### 5. OpenAiProvider.ts - Named Import (STYLE)

| Attribute | Value |
|-----------|-------|
| **File** | `packages/knowledge/server/src/Embedding/providers/OpenAiProvider.ts` |
| **Line** | 14 |
| **Issue** | Uses `import { pipe } from "effect/Function"` |
| **Impact** | Style inconsistency (rest of codebase uses `F.pipe`) |
| **Action** | Change to `import * as F from "effect/Function"` |

**Before**:
```typescript
import { pipe } from "effect/Function";
```

**After**:
```typescript
import * as F from "effect/Function";
```

### 6. UI Package - Undocumented (DOCUMENT)

| Attribute | Value |
|-----------|-------|
| **Package** | `packages/knowledge/ui` |
| **Issue** | Exists but not in validation scope |
| **Impact** | May contain undocumented dependencies |
| **Action** | Validate in P8 if UI features are in scope |

---

## Modification Order for P4

The following order minimizes type errors during migration:

```
1. CREATE   Runtime/LlmLayers.ts         # New provider layers
2. CREATE   Service/LlmWithRetry.ts      # Retry wrapper
3. CREATE   test/_shared/MockLlmLayer.ts # Test mocks
4. MODIFY   MentionExtractor.ts          # Simplest extractor
5. MODIFY   EntityExtractor.ts           # Second extractor
6. MODIFY   RelationExtractor.ts         # Third extractor
7. MODIFY   ExtractionPipeline.ts        # Update dependencies
8. DELETE   Ai/AiService.ts              # After all migrations
9. UPDATE   Ai/index.ts                  # Remove AiService exports
10. MIGRATE EmbeddingProvider.ts         # GenericTag → Effect.Service
11. MIGRATE OpenAiProvider.ts            # GenericTag → Effect.Service
```

**Verification after each step**:
```bash
bun run check --filter @beep/knowledge-server
```

---

## Verification Checklist

### P4 Exit Criteria

- [ ] AiService.ts deleted
- [ ] 0 results for `grep -rn "Context.GenericTag" packages/knowledge/server/src/`
- [ ] All extractors use `LanguageModel.LanguageModel`
- [ ] `bun run check --filter @beep/knowledge-server` passes

### P8 Exit Criteria

- [ ] `import { pipe }` changed to `import * as F`
- [ ] UI package validated (if in scope)
- [ ] Client package implemented (if in scope)

---

## Summary Table

| ID | File | Issue | Priority | Phase |
|----|------|-------|----------|-------|
| 1 | AiService.ts | Context.GenericTag | P1 | P4 DELETE |
| 2 | EmbeddingProvider.ts | Context.GenericTag | P1 | P4 MIGRATE |
| 3 | OpenAiProvider.ts | Context.GenericTag | P1 | P4 MIGRATE |
| 4 | knowledge-client | Stub implementation | P1 | DEFER |
| 5 | OpenAiProvider.ts | Named pipe import | P2 | P8 |
| 6 | knowledge-ui | Undocumented | P2 | P8 |

---

## Conclusion

**No blocking issues** for proceeding to Phase 3 (@effect/ai Design).

All P1 items are either:
- Scheduled deletions (AiService)
- Part of planned refactoring (EmbeddingProvider, OpenAiProvider)
- Deferred features (client package)

The architecture review confirms the knowledge package is well-structured and ready for @effect/ai integration.
