# `@beep/schema-v2` Documentation Strategy

This playbook defines how we will ship consistent JSDocs and generated docs as part of
the schema migration. It mirrors the approach used in `effect-smol` (`@effect/docgen`,
`scripts/analyze-jsdoc.mjs`, and the `docs` copier) so every migrated module lands
with high-quality documentation.

## Goals

1. **Authoritative JSDoc blocks** for every exported schema, helper, class, type, namespace.
2. **Machine-enforced coverage** via a lint-style analyzer (based on `effect-smol`’s
   `scripts/analyze-jsdoc.mjs`) that fails CI if `@category`, `@since`, or `@example`
   metadata is missing.
3. **Autogenerated reference docs** using `@effect/docgen` so docs stay in sync with source.
4. **Per-milestone prompts** that tell agents exactly how to document new modules before
   checking their checklist items off.

## Required JSDoc Shape

For every `export` in schema-v2:

```ts
/**
 * One sentence summary that explains the schema/helper.
 *
 * Longer paragraph describing usage details, invariants, and Effect wiring.
 *
 * @example
 * import { BS } from "@beep/schema-v2";
 *
 * const parsed = BS.primitives.string.email.Parse("ops@example.com");
 *
 * @category Primitives/String
 * @since 0.1.0
 */
export const Email = ...
```

- `@category` follows `{Milestone}/{Folder}` (e.g. `Core/Annotations`, `Primitives/Temporal`).
- `@since` reflects the version introduced in schema-v2 (start with `0.1.0`).
- `@example` should compile/run (docgen can type-check/run via ts-node).
- Use `@internal` for helpers living under `src/internal/**`.
- **Type exports count too.** `export type`, `export interface`, and `export namespace` blocks require the same
  documentation contract (`@category`, `@since`, `@example`). If a type alias mirrors an already documented value,
  point its `@example` at a focused snippet demonstrating its usage.

## Schema Identity Helpers

- Each schema-v2 folder contains a co-located `_id.ts` that wraps the new `@beep/identity` builders (`SchemaId`,
  `BeepId`). These files expose a ready-to-use `Id` helper that already encodes the namespace for that folder
  (for example `packages/common/schema-v2/src/builders/form/_id.ts` exports `Id = BeepId.from(...)`).
- When migrating a module, import the local `Id` (`import { Id } from "./_id";`) and use `Id.annotations("SchemaName", {
  ...metadata })` or `Id.compose("sub-scope")` to derive consistent `identifier`, `title`, `description`, and
  JSON Schema metadata.
- Uphill annotations (e.g. `DefaultAnnotations`, schema builders) should expose their IDs via the `_id.ts` helpers so
  downstream consumers always derive identifiers in a deterministic manner. Avoid ad-hoc `Symbol.for(...)` calls.
- The analyzer treats `identifier`/`title` metadata as required for user-facing schemas, so ensuring everything flows
  through `@beep/identity` keeps documentation (docgen, docs copy) consistent.


## Required JSDoc shape per file
- Each file must contain a header doc
- see packages/common/schema-v2/src/core/annotations/example-annotations.ts for header doc example
## Tooling Plan

### 1. Documentation lint

Adapt `scratchpad/effect-smol-docs/scripts/analyze-jsdoc.mjs` into
`packages/common/schema-v2/scripts/analyze-jsdoc.ts`:

- Scan `packages/common/schema-v2/src/**.ts` (skip `internal/**`).
- Ensure each export has `@category`, `@since`, and at least one `@example`.
- Output both CLI summary and `schema-jsdoc-report.json`.
- Wire into `package.json` scripts: `"docs:lint": "bunx tsx ./scripts/analyze-jsdoc.ts"`.
- Gate CI (`bun run docs:lint`) before merge.
- Internal-only modules (e.g. `src/internal/regex/regexes.ts`) are skipped unless the analyzer is
  invoked with `--include-internal`. Even if the command reports “No matching TypeScript files found,”
  it should still be executed so `jsdoc-analysis-results.json` stays current.

### 2. Codemod support

Port the `scripts/codemods/jsdoc.ts` from `effect-smol`:

- Ensures comments on call signatures created by helpers (e.g. `dual` or other wrappers)
  are preserved.
- Run via `bunx jscodeshift -t packages/common/schema-v2/scripts/codemods/jsdoc.ts` when
  migrating modules that expose higher-order APIs to backfill missing doc nodes.

### 3. Doc generation

- Add `@effect/docgen` to devDependencies of `@beep/schema-v2`.
- Create `packages/common/schema-v2/docgen.json` modeled after
  `scratchpad/effect-smol-docs/packages/effect/docgen.json`:
  - `srcDir: "src"`
  - `outDir: "docs"`
  - `exclude: ["src/internal/**", "src/experimental/contract/**"]`
  - `srcLink`: `https://github.com/kriegcloud/beep-effect/tree/main/packages/common/schema-v2/src/`
  - `examplesCompilerOptions` derived from repo `tsconfig`.
- Add scripts:
  ```json
  {
    "docgen": "bunx docgen"
  }
  ```
- Implement a `docs-copy` script similar to effect-smol’s `docs.mjs` to copy
  package docs into root `docs/schema-v2/**` with `parent` metadata per package.

### 4. Milestone prompts

Update the prompt blocks from `MIGRATION_CHECKLIST.md` (already generated by
`scripts/generate-migration-checklist.ts`) to instruct agents to:

1. Write/verify JSDoc per export.
2. Run `bun run docs:lint --file=<module>` before marking tasks complete.
3. Run `bun run docgen -- --module=<scope>` (docgen supports `--file` filter) to ensure docs render.
4. Paste new `@category`/`@example` entries into the README/Docs if necessary.

The checklist generator already emits prompts; extend it with a paragraph reminding agents to run
`docs:lint`+`docgen` before checking off their symbols.

### 5. CI/Automation

- Add a GitHub workflow or Turbo task that runs:
  ```bash
  bun run docs:lint
  bun run docgen
  ```
  when files under `packages/common/schema-v2/src/**` change.
- Cache `docs` artifacts for preview deployments if we publish them.

### 6. Status reporting

- After each milestone, update `MIGRATION_CHECKLIST.md` and append a summary block noting
  `docs:lint` status and docgen diffs.
- If `docs:lint` reports missing annotations, use the JSON output to file follow-up
  issues or block merges.

## Running Documentation Scripts

All documentation commands run from the repo root and delegate to `tooling/repo-scripts`:

- `bun run docs:lint` — scans every schema-v2 file (skipping `src/internal/**`) and writes `jsdoc-analysis-results.json`
  at the repo root. Expect “No matching TypeScript files found” for purely internal paths; the command is still
  considered successful and should be run for bookkeeping.
- `bun run docs:lint:file -- packages/common/schema/src/<file>.ts` — narrows the analyzer to one or more specific files
  (accepts multiple repo-root-relative paths). Internal files currently log the same “No matching…” hint and can be
  treated as informational.
- `bun run docgen` — executes `@effect/docgen` inside `packages/common/schema-v2` and emits Markdown into
  `packages/common/schema-v2/docs`.
- `bun run docs:site` — runs `bun run docgen` and then copies the rendered guides into `docs/schema-v2/**` via
  `tooling/repo-scripts/src/docs-copy.ts`.

> **Note:** The shared documentation scripts also build `@beep/types` and `@beep/invariant`. When linting files outside
> schema-v2, pass the appropriate scope flag (for example, `bun run docs:lint:file -- --scope invariant packages/common/invariant/src/invariant.ts`).

## Agent Workflow Summary

For each migrated module:

1. Move the code into its schema-v2 folder, replacing **all** string/array/object manipulation with Effect utilities
   (`effect/String`, `effect/Array`, `effect/Struct`, etc.).
2. Write/refine the JSDoc block with summary, `@example`, `@category`, `@since`.
3. Run `bun run docs:lint:file -- <relative-path>` to lint just the migrated modules (omit `--` to scan everything).
4. Run `bun run docgen` to render docs; inspect output under `packages/common/schema-v2/docs`.
6. Commit code + docs updates, and mark every relevant checkbox in `MIGRATION_CHECKLIST.md`.

This ensures we exit the migration with a consistent, effect-style documentation surface ready
for publishing on the repo docs site.
