# AGENTS.md — `@beep/documents-domain`

## Purpose & Fit
- Domain layer for the documents vertical: entities, value objects, and business logic for a knowledge management and document editing system.
- Supplies strongly-typed domain models for document editors, knowledge pages, discussions, comments, and versioning.
- Provides Effect-first APIs and HTTP contracts consumed by `packages/documents/infra` and application runtimes.
- Owns document structure value objects (block types, text styles, link types) while delegating persistence to infra/tables layers.

## Surface Map
- **Errors (`src/errors.ts`)** — Tagged domain errors for document operations.
- **Entities (`src/entities/`)**
  - `Document` — Core document entity with versioning and file attachments.
  - `DocumentVersion` — Version history tracking for documents.
  - `DocumentFile` — File attachments associated with documents.
  - `KnowledgePage` — Knowledge base page entity with contract for HTTP API.
  - `KnowledgeSpace` — Container for organizing knowledge pages.
  - `KnowledgeBlock` — Content blocks within knowledge pages.
  - `Discussion` — Discussion threads on documents/pages.
  - `Comment` — Individual comments in discussions.
  - `PageLink` — Links between knowledge pages.
- **Value Objects (`src/value-objects/`)**
  - `BlockType` — Enumeration of content block types.
  - `TextStyle` — Text formatting styles.
  - `ImageAlignment` — Image positioning options.
  - `LinkType` — Types of links (internal/external).
  - `PageStatus` — Publication status for pages.
- **DomainApi (`src/DomainApi.ts`)** — HTTP API definition using `@effect/platform/HttpApi`, currently exposing `KnowledgePage.Contract` under `/api/v1/documents`.

## Usage Snapshots
- `packages/runtime/server/src/server-runtime.ts` — Likely consumes `DomainApi` for HTTP routing.
- `packages/documents/infra/src/adapters/repositories.ts` — References all entity repos (CommentRepo, DiscussionRepo, DocumentFileRepo, DocumentRepo, etc.).
- `packages/documents/tables/src/tables/` — Drizzle table definitions mirror domain entities.
- `packages/_internal/db-admin/` — Migration files correspond to entity schemas.

## Authoring Guardrails
- Namespace every Effect import (`import * as Effect from "effect/Effect"`, `import * as A from "effect/Array"`, `import * as F from "effect/Function"`, etc.) and route **all** collection/string/object transforms through those modules. Do not add new native `.map`, `.split`, `for...of`, or `Object.entries` usage.
- Keep domain models pure and free of infrastructure concerns (no direct database, HTTP, or storage dependencies).
- Use `@beep/schema` for all entity schemas and validation.
- Define HTTP contracts using `@effect/platform/HttpApi` following the pattern in `DomainApi.ts`.
- Value objects should be immutable and validated through Effect Schema.
- Entity models should align with corresponding Drizzle table schemas in `@beep/documents-tables`.

## Quick Recipes
```ts
import * as Effect from "effect/Effect";
import * as F from "effect/Function";
import * as S from "effect/Schema";
import { KnowledgePage, Document } from "@beep/documents-domain/entities";
import { BlockType, PageStatus } from "@beep/documents-domain/value-objects";

// Working with domain entities
export const createKnowledgePage = (data: {
  title: string;
  content: unknown;
  status: PageStatus.Type;
}) =>
  Effect.gen(function* () {
    const page = yield* S.decodeUnknown(KnowledgePage.Model)(data);
    yield* Effect.logInfo("knowledge-page.created", { pageId: page.id });
    return page;
  });

// Using the HTTP API contract
import { DomainApi } from "@beep/documents-domain";
import * as HttpApiBuilder from "@effect/platform/HttpApiBuilder";

export const apiImplementation = HttpApiBuilder.api(DomainApi).pipe(
  // Add endpoint implementations here
);
```

## Verifications
- `bun run test --filter=@beep/documents-domain` — Vitest suites for domain logic.
- `bun run check --filter=@beep/documents-domain` — TypeScript project refs across `src` + `test`.
- `bun run lint --filter=@beep/documents-domain` / `bun run lint:fix --filter=@beep/documents-domain` — Biome + circular dependency checks.
- `bunx effect generate --cwd packages/documents/domain` — Refresh autogenerated `index.ts` / barrel exports after adding modules.

## Contributor Checklist
- [ ] All new code uses Effect namespace utilities (Array/String/Record) and avoids introducing fresh native helpers.
- [ ] Entity changes include corresponding updates to `@beep/documents-tables` schemas.
- [ ] New HTTP contracts are added to `DomainApi` and documented here.
- [ ] Domain models remain pure and infrastructure-agnostic.
- [ ] Re-ran lint/check/test targets above and regenerated Effect indices when touching exports.
- [ ] Updated downstream references in infra adapters when expanding entity surfaces.
