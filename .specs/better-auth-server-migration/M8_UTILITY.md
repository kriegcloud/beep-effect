# Milestone 8: Utility Endpoints

> **Status**: PENDING
> **Spec Reference**: [.specs/better-auth-specs/CORE.md](../better-auth-specs/CORE.md)
> **Patterns Reference**: [PATTERNS.md](./PATTERNS.md)

## Quick Start

**Current State** (from discovery):
- Domain contracts: ❌ Need creation
- Infra handlers: ❌ Need creation

**Next Action**: Start with Boilerplating Checklist → Domain Contracts

## Pre-Implementation Validation

- [ ] Read corresponding spec document (link above)
- [ ] Verify endpoint count matches spec (7 endpoints)
- [ ] Check for any custom authentication requirements
- [ ] Identify any endpoints with complex nested objects

## Overview

This milestone implements utility and infrastructure endpoints that support the authentication system. These include health checks, error pages, JWKS for OAuth/OIDC, device authorization flow, username availability checking, and one-time token generation/verification. These endpoints are essential for system monitoring, OAuth provider functionality, and auxiliary authentication features.

## Endpoints

| Method | Path | Domain File | Infra File | Better Auth Method |
|--------|------|-------------|------------|-------------------|
| GET | /ok | `v1/core/ok.ts` | `v1/core/ok.ts` | N/A (simple health check) |
| GET | /error | `v1/core/error.ts` | `v1/core/error.ts` | N/A (error page display) |
| GET | /jwks | `v1/core/jwks.ts` | `v1/core/jwks.ts` | N/A (Better Auth JWT plugin) |
| GET | /device | `v1/core/device.ts` | `v1/core/device.ts` | N/A (device flow status) |
| POST | /is-username-available | `v1/core/is-username-available.ts` | `v1/core/is-username-available.ts` | N/A (username check) |
| GET | /one-time-token/generate | `v1/core/one-time-token-generate.ts` | `v1/core/one-time-token-generate.ts` | N/A (token generation) |
| POST | /one-time-token/verify | `v1/core/one-time-token-verify.ts` | `v1/core/one-time-token-verify.ts` | N/A (token verification) |

## Phase 2.5: Boilerplating Checklist

> Complete this section BEFORE implementation. Creates stub files with JSDoc.

### Boilerplate Domain Contracts

#### `ok.ts`

- [ ] Create stub file `packages/iam/domain/src/api/v1/core/ok.ts`
- [ ] Fill module-level JSDoc with:
  - Endpoint path and method: `GET /ok`
  - Spec reference anchor: `.specs/better-auth-specs/CORE.md#get-ok`
  - Better Auth method name: N/A (simple health check response)
  - Implementation requirements from spec:
    - Return simple health check status
    - No authentication required
    - Used for monitoring/uptime checks
- [ ] Add `Success` class stub with:
  - Complete JSDoc (@category, @example, @since)
  - TODO comment listing fields from spec:
    - `ok: S.Boolean` (required) - Always true if API is working
- [ ] Add `Contract` export with complete JSDoc (GET endpoint, no payload or params)
- [ ] Update `index.ts` barrel export

#### `error.ts`

- [ ] Create stub file `packages/iam/domain/src/api/v1/core/error.ts`
- [ ] Fill module-level JSDoc with:
  - Endpoint path and method: `GET /error`
  - Spec reference anchor: `.specs/better-auth-specs/CORE.md#get-error`
  - Better Auth method name: N/A (error page display)
  - Implementation requirements from spec:
    - Display error page (spec shows generic "Success" response)
    - Likely used for OAuth error redirects
    - Consider query parameters for error details
- [ ] Add `Success` class stub with:
  - Complete JSDoc (@category, @example, @since)
  - TODO comment: Spec shows generic success - investigate actual response format
  - Placeholder: `S.Struct({ status: S.Boolean })` (update during implementation)
- [ ] Add `Contract` export with complete JSDoc (GET endpoint)
- [ ] Update `index.ts` barrel export

#### `jwks.ts`

- [ ] Create stub file `packages/iam/domain/src/api/v1/core/jwks.ts`
- [ ] Fill module-level JSDoc with:
  - Endpoint path and method: `GET /jwks`
  - Spec reference anchor: `.specs/better-auth-specs/CORE.md#get-jwks`
  - Better Auth method name: N/A (Better Auth JWT plugin provides this endpoint)
  - Implementation requirements from spec:
    - Return JSON Web Key Set for OAuth/OIDC
    - No authentication required (public endpoint)
    - Standard JWKS format (RFC 7517)
    - Dynamically generated by Better Auth when JWT plugin is enabled
- [ ] Add `Success` class stub with:
  - Complete JSDoc (@category, @example, @since)
  - TODO comment listing fields from spec:
    - `keys: S.Array(S.Unknown)` (required) - Array of public JSON Web Keys
    - Note: Consider defining proper JWK schema with kty, use, kid, etc.
- [ ] Add `Contract` export with complete JSDoc (GET endpoint, no payload or params)
- [ ] Update `index.ts` barrel export

#### `device.ts`

- [ ] Create stub file `packages/iam/domain/src/api/v1/core/device.ts`
- [ ] Fill module-level JSDoc with:
  - Endpoint path and method: `GET /device`
  - Spec reference anchor: `.specs/better-auth-specs/CORE.md#get-device`
  - Better Auth method name: N/A (device authorization status check)
  - Implementation requirements from spec:
    - Check device authorization status using user_code
    - Part of OAuth 2.0 Device Authorization Grant flow
    - Return current authorization status
- [ ] Add `UrlParams` class stub with:
  - Complete JSDoc (@category, @example, @since)
  - TODO comment listing fields from spec:
    - `user_code: S.optionalWith(S.String, { as: "Option" })` - Device user code
- [ ] Add `Success` class stub with:
  - Complete JSDoc (@category, @example, @since)
  - TODO comment listing fields from spec:
    - `user_code: S.optionalWith(S.String, { as: "Option" })` - The verified user code
    - `status: S.optionalWith(S.Literal("pending", "approved", "denied"), { as: "Option" })` - Authorization status
- [ ] Add `Contract` export with complete JSDoc (GET endpoint with URL params)
- [ ] Update `index.ts` barrel export

#### `is-username-available.ts`

- [ ] Create stub file `packages/iam/domain/src/api/v1/core/is-username-available.ts`
- [ ] Fill module-level JSDoc with:
  - Endpoint path and method: `POST /is-username-available`
  - Spec reference anchor: `.specs/better-auth-specs/CORE.md#post-is-username-available`
  - Better Auth method name: N/A (username availability check)
  - Implementation requirements from spec:
    - Check if username is available for registration
    - No authentication required (public endpoint)
    - Used during sign-up flow
- [ ] Add `Payload` class stub with:
  - Complete JSDoc (@category, @example, @since)
  - TODO comment listing fields from spec:
    - `username: S.String` (required) - Username to check
- [ ] Add `Success` class stub with:
  - Complete JSDoc (@category, @example, @since)
  - TODO comment: Spec doesn't define response - investigate actual API return
  - Placeholder: `S.Struct({ available: S.Boolean })` (update during implementation)
- [ ] Add `Contract` export with complete JSDoc
- [ ] Update `index.ts` barrel export

#### `one-time-token-generate.ts`

- [ ] Create stub file `packages/iam/domain/src/api/v1/core/one-time-token-generate.ts`
- [ ] Fill module-level JSDoc with:
  - Endpoint path and method: `GET /one-time-token/generate`
  - Spec reference anchor: `.specs/better-auth-specs/CORE.md#get-one-time-tokengenerate`
  - Better Auth method name: N/A (one-time token generation)
  - Implementation requirements from spec:
    - Generate single-use authentication token
    - Spec shows no defined response - investigate during implementation
    - Likely requires authentication
- [ ] Add `Success` class stub with:
  - Complete JSDoc (@category, @example, @since)
  - TODO comment: Spec shows no response schema - investigate actual API return
  - Placeholder: `S.Struct({ token: S.String })` (update during implementation)
- [ ] Add `Contract` export with complete JSDoc (GET endpoint, no params defined in spec)
- [ ] Update `index.ts` barrel export

#### `one-time-token-verify.ts`

- [ ] Create stub file `packages/iam/domain/src/api/v1/core/one-time-token-verify.ts`
- [ ] Fill module-level JSDoc with:
  - Endpoint path and method: `POST /one-time-token/verify`
  - Spec reference anchor: `.specs/better-auth-specs/CORE.md#post-one-time-tokenverify`
  - Better Auth method name: N/A (one-time token verification)
  - Implementation requirements from spec:
    - Verify and consume single-use authentication token
    - Token can only be used once
    - Return verification result
- [ ] Add `Payload` class stub with:
  - Complete JSDoc (@category, @example, @since)
  - TODO comment listing fields from spec:
    - `token: S.String` (required) - The token to verify (e.g., "some-token")
- [ ] Add `Success` class stub with:
  - Complete JSDoc (@category, @example, @since)
  - TODO comment: Spec shows no response schema - investigate actual API return
  - Placeholder: `S.Struct({ valid: S.Boolean })` (update during implementation)
- [ ] Add `Contract` export with complete JSDoc
- [ ] Update `index.ts` barrel export

#### Update `_group.ts`

- [ ] Import `* as Ok from "./ok.ts"`
- [ ] Import `* as Error from "./error.ts"`
- [ ] Import `* as Jwks from "./jwks.ts"`
- [ ] Import `* as Device from "./device.ts"`
- [ ] Import `* as IsUsernameAvailable from "./is-username-available.ts"`
- [ ] Import `* as OneTimeTokenGenerate from "./one-time-token-generate.ts"`
- [ ] Import `* as OneTimeTokenVerify from "./one-time-token-verify.ts"`
- [ ] Add `.add(Ok.Contract)` to Group class
- [ ] Add `.add(Error.Contract)` to Group class
- [ ] Add `.add(Jwks.Contract)` to Group class
- [ ] Add `.add(Device.Contract)` to Group class
- [ ] Add `.add(IsUsernameAvailable.Contract)` to Group class
- [ ] Add `.add(OneTimeTokenGenerate.Contract)` to Group class
- [ ] Add `.add(OneTimeTokenVerify.Contract)` to Group class

### Boilerplate Infra Handlers

**Helper Selection**: See PATTERNS.md 'Infra Handler Helpers' section for detailed usage.

#### `ok.ts`

**Recommended Helper**: `runAuthQuery` - Simple GET health check returning `{ ok: true }`

- [ ] Create stub file `packages/iam/infra/src/api/v1/core/ok.ts`
- [ ] Fill module-level JSDoc with spec references
- [ ] Add `HandlerEffect` type: `Common.HandlerEffect<void>` (no payload or params)
- [ ] Add `Handler` stub with:
  - Complete JSDoc (@category, @example, @since)
  - TODO comments with implementation template:
    - Return simple success response `{ ok: true }`
    - No Better Auth call needed
    - No cookie handling needed
  - Placeholder `Effect.fail(new Error("Not implemented"))`
- [ ] Update `index.ts` barrel export

#### `error.ts`

**Recommended Helper**: `runAuthQuery` - GET endpoint returning error page response

- [ ] Create stub file `packages/iam/infra/src/api/v1/core/error.ts`
- [ ] Fill module-level JSDoc with spec references
- [ ] Add `HandlerEffect` type: `Common.HandlerEffect<void>`
- [ ] Add `Handler` stub with:
  - Complete JSDoc (@category, @example, @since)
  - TODO comments with implementation template:
    - Investigate whether Better Auth provides error page handler
    - Consider reading error details from query params
    - Return appropriate error response or redirect
  - Placeholder `Effect.fail(new Error("Not implemented"))`
- [ ] Update `index.ts` barrel export

#### `jwks.ts`

**Recommended Helper**: `runAuthQuery` - GET endpoint returning JWKS (JSON Web Key Set)

- [ ] Create stub file `packages/iam/infra/src/api/v1/core/jwks.ts`
- [ ] Fill module-level JSDoc with spec references
- [ ] Add `HandlerEffect` type: `Common.HandlerEffect<void>`
- [ ] Add `Handler` stub with:
  - Complete JSDoc (@category, @example, @since)
  - TODO comments with implementation template:
    - Better Auth JWT plugin automatically provides `/jwks` endpoint
    - This may be a proxy/passthrough handler to Better Auth's JWKS endpoint
    - Or may be handled entirely by Better Auth routing
    - Format response according to RFC 7517 (JWKS spec)
  - Placeholder `Effect.fail(new Error("Not implemented"))`
- [ ] Update `index.ts` barrel export

#### `device.ts`

**Recommended Helper**: `runAuthQuery` - GET endpoint with URL params returning device authorization status

- [ ] Create stub file `packages/iam/infra/src/api/v1/core/device.ts`
- [ ] Fill module-level JSDoc with spec references
- [ ] Add `HandlerEffect` type: `Common.HandlerEffect<V1.Core.Device.UrlParams>`
- [ ] Add `Handler` stub with:
  - Complete JSDoc (@category, @example, @since)
  - TODO comments with implementation template:
    - Investigate Better Auth device flow implementation
    - Check device code status using `user_code` parameter
    - Return authorization status
  - Placeholder `Effect.fail(new Error("Not implemented"))`
- [ ] Update `index.ts` barrel export

#### `is-username-available.ts`

**Recommended Helper**: `runAuthEndpoint` - POST endpoint with payload (username) returning availability status

- [ ] Create stub file `packages/iam/infra/src/api/v1/core/is-username-available.ts`
- [ ] Fill module-level JSDoc with spec references
- [ ] Add `HandlerEffect` type: `Common.HandlerEffect<V1.Core.IsUsernameAvailable.Payload>`
- [ ] Add `Handler` stub with:
  - Complete JSDoc (@category, @example, @since)
  - TODO comments with implementation template:
    - Investigate Better Auth username availability check
    - Or query database directly for username uniqueness
    - Return availability status
  - Placeholder `Effect.fail(new Error("Not implemented"))`
- [ ] Update `index.ts` barrel export

#### `one-time-token-generate.ts`

**Recommended Helper**: `runAuthQuery` - GET endpoint returning generated one-time token

- [ ] Create stub file `packages/iam/infra/src/api/v1/core/one-time-token-generate.ts`
- [ ] Fill module-level JSDoc with spec references
- [ ] Add `HandlerEffect` type: `Common.HandlerEffect<void>`
- [ ] Add `Handler` stub with:
  - Complete JSDoc (@category, @example, @since)
  - TODO comments with implementation template:
    - Investigate Better Auth one-time token generation
    - Generate token with expiration
    - Return generated token (may contain Redacted token - verify during implementation)
  - Placeholder `Effect.fail(new Error("Not implemented"))`
- [ ] Update `index.ts` barrel export

#### `one-time-token-verify.ts`

**Recommended Helper**: Check for Redacted token field during implementation - use `forwardCookieResponse` if present, otherwise `runAuthEndpoint`

- [ ] Create stub file `packages/iam/infra/src/api/v1/core/one-time-token-verify.ts`
- [ ] Fill module-level JSDoc with spec references
- [ ] Add `HandlerEffect` type: `Common.HandlerEffect<V1.Core.OneTimeTokenVerify.Payload>`
- [ ] Add `Handler` stub with:
  - Complete JSDoc (@category, @example, @since)
  - TODO comments with implementation template:
    - Investigate Better Auth one-time token verification
    - Verify if token field is Redacted (check domain schema)
    - If Redacted: use manual encoding + forwardCookieResponse
    - If plain string: use runAuthEndpoint
    - Verify token and mark as consumed
    - Return verification result
  - Placeholder `Effect.fail(new Error("Not implemented"))`
- [ ] Update `index.ts` barrel export

#### Update `_group.ts`

- [ ] Import `* as Ok from "./ok.ts"`
- [ ] Import `* as Error from "./error.ts"`
- [ ] Import `* as Jwks from "./jwks.ts"`
- [ ] Import `* as Device from "./device.ts"`
- [ ] Import `* as IsUsernameAvailable from "./is-username-available.ts"`
- [ ] Import `* as OneTimeTokenGenerate from "./one-time-token-generate.ts"`
- [ ] Import `* as OneTimeTokenVerify from "./one-time-token-verify.ts"`
- [ ] Add `.handle("ok", Ok.Handler)` to Routes
- [ ] Add `.handle("error", Error.Handler)` to Routes
- [ ] Add `.handle("jwks", Jwks.Handler)` to Routes
- [ ] Add `.handle("device", Device.Handler)` to Routes
- [ ] Add `.handle("is-username-available", IsUsernameAvailable.Handler)` to Routes
- [ ] Add `.handle("one-time-token-generate", OneTimeTokenGenerate.Handler)` to Routes
- [ ] Add `.handle("one-time-token-verify", OneTimeTokenVerify.Handler)` to Routes

### Boilerplate Verification

- [ ] All stub files created with complete JSDoc
- [ ] All group files updated with imports/registrations
- [ ] `bun run check` runs (failures expected for TODO placeholders)
- [ ] Status updated to `BOILERPLATED` in PLAN.md

---

## Implementation Checklist

> Complete this section AFTER boilerplating. Fills in stub implementations.

### 1. Domain Contracts

#### `ok.ts`

- [ ] Implement `Success` class fields:
  - `ok: S.Boolean`
- [ ] Update JSDoc @example: `{ ok: true }`
- [ ] Remove TODO comments

#### `error.ts`

- [ ] Investigate actual Better Auth error endpoint behavior
- [ ] Implement `Success` class fields based on findings
- [ ] Consider adding `UrlParams` for error details if needed
- [ ] Update JSDoc @example with realistic values
- [ ] Remove TODO comments

#### `jwks.ts`

- [ ] Define proper JWK schema or use `S.Unknown` if shape varies
- [ ] Implement `Success` class fields:
  - `keys: S.Array(JwkSchema)` where JwkSchema includes kty, use, kid, alg, etc.
- [ ] Update JSDoc @example with sample JWKS
- [ ] Remove TODO comments

#### `device.ts`

- [ ] Implement `UrlParams` class fields:
  - `user_code: S.optionalWith(S.String, { as: "Option" })`
- [ ] Implement `Success` class fields:
  - `user_code: S.optionalWith(S.String, { as: "Option" })`
  - `status: S.optionalWith(S.Literal("pending", "approved", "denied"), { as: "Option" })`
- [ ] Update JSDoc @example with realistic values
- [ ] Remove TODO comments

#### `is-username-available.ts`

- [ ] Investigate actual Better Auth response format
- [ ] Implement `Payload` class fields:
  - `username: S.String`
- [ ] Implement `Success` class fields based on findings
- [ ] Update JSDoc @example with realistic values
- [ ] Remove TODO comments

#### `one-time-token-generate.ts`

- [ ] Investigate actual Better Auth response format
- [ ] Implement `Success` class fields based on findings
- [ ] Update JSDoc @example with realistic values
- [ ] Remove TODO comments

#### `one-time-token-verify.ts`

- [ ] Investigate actual Better Auth response format
- [ ] Implement `Payload` class fields:
  - `token: S.String`
- [ ] Implement `Success` class fields based on findings
- [ ] Update JSDoc @example with realistic values
- [ ] Remove TODO comments

### 2. Infra Handlers

#### `ok.ts`

**Helper**: `runAuthQuery` - No Better Auth call needed, can return static response directly

- [ ] Implement `Handler` logic:
  - Return simple JSON response: `{ ok: true }`
  - Use `HttpServerResponse.json()` directly (no auth call needed)
  - No cookie forwarding needed
- [ ] Remove placeholder `Effect.fail(...)`
- [ ] Update JSDoc @example if needed

#### `error.ts`

**Helper**: `runAuthQuery` - GET endpoint with response decoding

- [ ] Implement `Handler` logic based on Better Auth error handling:
  - Use `runAuthQuery` with Better Auth error endpoint (if available)
  - Consider rendering HTML error page vs JSON response
  - Handle error query parameters if applicable
- [ ] Remove placeholder `Effect.fail(...)`
- [ ] Update JSDoc @example if needed

#### `jwks.ts`

**Helper**: `runAuthQuery` - GET endpoint returning JWKS (public endpoint)

- [ ] Implement `Handler` logic:
  - Better Auth JWT plugin provides `/api/auth/jwks` endpoint automatically
  - Use `runAuthQuery` with Better Auth JWKS endpoint
  - Return properly formatted JWKS response according to RFC 7517
  - No authentication required (public endpoint)
- [ ] Remove placeholder `Effect.fail(...)`
- [ ] Update JSDoc @example if needed

#### `device.ts`

**Helper**: `runAuthQuery` - GET endpoint with URL params and response decoding

- [ ] Implement `Handler` logic:
  - Use `runAuthQuery` with Better Auth device flow endpoint
  - Pass `user_code` URL parameter to auth handler
  - Decode response with `V1.Core.Device.Success`
- [ ] Remove placeholder `Effect.fail(...)`
- [ ] Update JSDoc @example if needed

#### `is-username-available.ts`

**Helper**: `runAuthEndpoint` - POST endpoint with payload encoding and response decoding

- [ ] Implement `Handler` logic:
  - Use `runAuthEndpoint` with:
    - `payloadSchema: V1.Core.IsUsernameAvailable.Payload`
    - `successSchema: V1.Core.IsUsernameAvailable.Success`
    - `authHandler` calling Better Auth username check or direct DB query
  - Return availability status
- [ ] Remove placeholder `Effect.fail(...)`
- [ ] Update JSDoc @example if needed

#### `one-time-token-generate.ts`

**Helper**: `runAuthQuery` - GET endpoint with response decoding (verify if token is Redacted)

- [ ] Implement `Handler` logic:
  - Use `runAuthQuery` with Better Auth token generation endpoint
  - Generate one-time token with expiration
  - Decode response with `V1.Core.OneTimeTokenGenerate.Success`
  - NOTE: If response contains Redacted token, switch to manual handling
- [ ] Remove placeholder `Effect.fail(...)`
- [ ] Update JSDoc @example if needed

#### `one-time-token-verify.ts`

**Helper**: Check domain schema - if token is Redacted use `forwardCookieResponse`, otherwise `runAuthEndpoint`

- [ ] Implement `Handler` logic:
  - FIRST: Check domain schema for token field (Redacted vs plain string)
  - If Redacted token:
    - Manually encode payload with `S.encode(V1.Core.OneTimeTokenVerify.Payload)(payload)`
    - Call Better Auth verification endpoint
    - Use `forwardCookieResponse(headers, decodedResponse)`
  - If plain string:
    - Use `runAuthEndpoint` with automatic encoding/decoding
  - Verify token and mark as consumed
- [ ] Remove placeholder `Effect.fail(...)`
- [ ] Update JSDoc @example if needed

### 3. Verification

- [ ] `bun run check` passes
- [ ] `bun run build --filter=@beep/iam-domain --filter=@beep/iam-infra` succeeds
- [ ] Endpoints appear in OpenAPI spec at server `/docs`
- [ ] Status updated to `COMPLETE` in PLAN.md

## Notes

### Special Considerations

1. **Incomplete OpenAPI specs**: Several endpoints in this milestone have incomplete or missing response schemas in the OpenAPI spec:
   - `/error` - Shows generic "Success"
   - `/is-username-available` - No response schema
   - `/one-time-token/generate` - No response schema
   - `/one-time-token/verify` - No response schema

   **Action required**: During implementation, investigate actual Better Auth API responses or consult Better Auth documentation to determine correct schemas.

2. **Public endpoints**: Several endpoints may not require authentication:
   - `/ok` - Health check (public)
   - `/error` - Error display (public)
   - `/jwks` - JWKS for OAuth (public)
   - `/is-username-available` - Username check (public for sign-up flow)

   Verify authentication requirements during implementation.

3. **JWKS endpoint**:
   - **Critical for OAuth/OIDC provider functionality**
   - Better Auth JWT plugin automatically provides this endpoint when enabled
   - May require proxy/passthrough to Better Auth's native `/api/auth/jwks` endpoint
   - Response conforms to RFC 7517 (JSON Web Key Set) standard
   - Keys include: `kty` (key type), `use` (public key use), `kid` (key ID), `alg` (algorithm), and public key parameters (e.g., `n`, `e` for RSA)
   - Supports key rotation if configured in Better Auth JWT plugin

4. **Device flow**: The `/device` endpoint is part of OAuth 2.0 Device Authorization Grant (RFC 8628). This flow is used for devices with limited input capabilities (smart TVs, IoT devices, etc.). Ensure proper state management for device codes.

5. **One-time tokens**: These tokens should:
   - Expire after short duration (e.g., 5-15 minutes)
   - Be invalidated after single use
   - Be cryptographically secure (use crypto.randomBytes or similar)
   - Have minimal information leak in error messages

6. **Username availability**: Consider race conditions - username could become taken between check and actual registration. This endpoint is advisory only, not a reservation system.

7. **Better Auth integration**: Unlike other milestones, many of these endpoints may not have direct Better Auth API method equivalents. Some may need:
   - Direct database queries (username availability)
   - Custom token generation logic (one-time tokens)
   - Static configuration responses (JWKS)
   - Simple utility responses (/ok)
