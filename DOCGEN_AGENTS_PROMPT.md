# Docgen Agents Research Prompt

> **Purpose**: Research prompt for Claude 4.5 Opus to investigate how to enhance `beep docgen` with programmatic agent orchestration using `@anthropic-ai/claude-agent-sdk`
>
> **Deliverable**: A comprehensive markdown file (`DOCGEN_AGENTS_IMPLEMENTATION.md`) that serves as an implementation prompt for another Claude 4.5 Opus instance

---

## Research Mission

You are tasked with researching and designing a programmatic agent orchestration system that integrates with the existing `beep docgen` CLI. The goal is to enable running `bun run docgen:agents` to automatically deploy Claude agents that:

1. Analyze packages for JSDoc documentation gaps
2. Fix missing `@category`, `@example`, and `@since` tags
3. Validate that examples compile correctly
4. Report progress and results

---

## Current System Context

### Existing CLI Commands

The `beep docgen` CLI (`tooling/cli/src/commands/docgen.ts`) provides:

| Command | Purpose |
|---------|---------|
| `beep docgen analyze -p <path>` | Generate `JSDOC_ANALYSIS.md` report with missing docs |
| `beep docgen generate -p <path>` | Run `@effect/docgen` to validate examples compile |
| `beep docgen init -p <path>` | Bootstrap `docgen.json` config for a package |
| `beep docgen status` | Show docgen config status across all packages |
| `beep docgen aggregate` | Aggregate docs to central folder |

### Existing Agent Definitions

Claude Code agents exist in `.claude/agents/`:

- **`jsdoc-fixer.md`** - Fixes JSDoc issues for a single package (manual invocation)
- **`package-error-fixer.md`** - Fixes type/build/lint errors
- **`effect-researcher.md`** - Researches Effect patterns, has MCP tool access

### Analysis Report Format

The `JSDOC_ANALYSIS.md` generated by `analyze` contains:
- Package metadata (name, path, timestamp)
- Agent instructions for fixing documentation
- Prioritized checklist with `file:line` references
- Summary statistics (total exports, missing tags breakdown)
- Verification commands

### Key Types (`tooling/cli/src/commands/docgen/types.ts`)

```typescript
// Analysis results
interface ExportAnalysis {
  name: string;
  kind: "function" | "const" | "type" | "interface" | "class" | "namespace" | "enum";
  filePath: string;
  line: number;
  presentTags: string[];
  missingTags: string[];
  hasJsDoc: boolean;
  context?: string;
  priority: "high" | "medium" | "low";
}

interface PackageAnalysis {
  packageName: string;
  packagePath: string;
  timestamp: string;
  exports: ExportAnalysis[];
  summary: PackageAnalysisSummary;
}
```

---

## Research Objectives

### 1. Claude Agent SDK Architecture

Research `@anthropic-ai/claude-agent-sdk` to understand:

**Core Questions:**
- What is the agent creation and configuration API?
- How do agents communicate with the Claude API?
- What tool definition patterns exist (function calling)?
- How is agent state managed across interactions?
- What concurrency/parallelism patterns are supported?
- How do you implement multi-agent orchestration?

**Specific Areas to Investigate:**
- Agent instantiation and lifecycle
- Tool/function registration mechanisms
- Context window management
- Streaming vs batch responses
- Error handling and retries
- Rate limiting considerations
- Cost optimization strategies

### 2. MCP Tool Integration

Research how agents can leverage MCP (Model Context Protocol) servers:

**Core Questions:**
- How do you connect agents to existing MCP servers?
- Can agents use `mcp__effect_docs__effect_docs_search` and `mcp__effect_docs__get_effect_doc`?
- What's the pattern for registering MCP tools with an agent?
- How do MCP tools differ from custom function tools?

**Required Tools for Docgen Agents:**
- Effect documentation search (existing MCP)
- File system operations (read/write TypeScript files)
- Shell execution (run `docgen analyze`, `docgen generate`)
- Package discovery (list packages needing documentation)

### 3. Multi-Agent Orchestration Patterns

Research patterns for coordinating multiple agents:

**Core Questions:**
- Supervisor/Worker pattern - one orchestrator directing task-specific workers?
- Pipeline pattern - sequential handoff between specialized agents?
- Swarm pattern - parallel agents with shared state?
- How do agents share context or results?

**Proposed Agent Roles:**

| Agent | Responsibility |
|-------|---------------|
| **Coordinator** | Discover packages, assign work, aggregate results |
| **Analyzer** | Run `docgen analyze`, parse `JSDOC_ANALYSIS.md` |
| **DocFixer** | Add missing JSDoc tags to source files |
| **Validator** | Run `docgen generate`, verify examples compile |
| **Reporter** | Generate final summary report |

### 4. Effect-Based Implementation

Research how to build the orchestration using Effect patterns:

**Core Questions:**
- How to wrap the Claude Agent SDK in Effect services?
- Layer composition for agent dependencies (API client, MCP tools, file system)
- Error handling with `Schema.TaggedError` for agent failures
- Streaming responses with Effect Stream
- Resource management for API connections

**Integration Points:**
- `@effect/platform-bun` for runtime
- `@effect/cli` for command structure
- Existing `FsUtils` from `@beep/tooling-utils`
- Effect Schema for validating agent responses

### 5. Command Interface Design

Research the optimal CLI interface for `bun run docgen:agents`:

**Proposed Options:**
```bash
# Run agents on all packages needing docs
bun run docgen:agents

# Target specific package
bun run docgen:agents -p packages/common/schema

# Limit parallelism
bun run docgen:agents --parallel 4

# Dry run (analyze only, no fixes)
bun run docgen:agents --dry-run

# Verbose output
bun run docgen:agents --verbose

# Specify model
bun run docgen:agents --model claude-sonnet-4-20250514
```

---

## Research Methodology

### Phase 1: SDK Documentation Deep Dive

1. **Search for official documentation:**
   - NPM package page for `@anthropic-ai/claude-agent-sdk`
   - GitHub repository README and examples
   - Anthropic developer documentation
   - API reference and type definitions

2. **Examine package structure:**
   - Install the package: `bun add @anthropic-ai/claude-agent-sdk`
   - Explore `node_modules/@anthropic-ai/claude-agent-sdk/`
   - Read source types and JSDoc comments
   - Identify key exports and patterns

3. **Find example implementations:**
   - Search for open-source projects using the SDK
   - Look for multi-agent orchestration examples
   - Find MCP integration patterns

### Phase 2: Effect Integration Research

1. **Search Effect ecosystem:**
   - Use `mcp__effect_docs__effect_docs_search` for relevant patterns
   - Look for existing AI/agent integrations in Effect
   - Research `@effect/ai` and `@effect/ai-anthropic` packages

2. **Design service architecture:**
   - Define `ClaudeAgentService` Effect service
   - Design Layer composition for dependencies
   - Plan error types and recovery strategies

### Phase 3: Prototype Design

1. **Outline agent configurations:**
   - System prompts for each agent role
   - Tool definitions for each agent
   - Input/output schemas

2. **Design orchestration flow:**
   - Discovery → Analysis → Fixing → Validation → Reporting
   - Parallelization strategy
   - Progress reporting

### Phase 4: Compile Research into Implementation Prompt

Structure findings into a comprehensive implementation prompt that:

1. **Provides complete context** - All SDK patterns discovered
2. **Defines architecture** - Effect services, layers, error types
3. **Includes code templates** - Working starting points for each component
4. **Specifies file structure** - Where new code should live
5. **Details testing strategy** - How to verify the implementation
6. **Lists dependencies** - All packages to install

---

## Deliverable Specification

Create `DOCGEN_AGENTS_IMPLEMENTATION.md` with the following structure:

```markdown
# Docgen Agents Implementation Guide

## Executive Summary
[1-2 paragraph overview of the solution]

## Architecture Overview
[Diagram or description of agent orchestration flow]

## Dependencies
[List of packages to install with versions]

## File Structure
[Where new files should be created]

## Implementation

### 1. SDK Wrapper Service
[Effect service wrapping @anthropic-ai/claude-agent-sdk]
```typescript
// Complete, working code with imports
```

### 2. Agent Definitions
[Configuration for each agent role]
```typescript
// System prompts, tools, schemas
```

### 3. Orchestration Layer
[Coordinator logic for multi-agent workflow]
```typescript
// Effect-based orchestration
```

### 4. CLI Command
[Integration with @effect/cli]
```typescript
// Command definition and handler
```

### 5. MCP Tool Integration
[How agents access Effect docs and other MCP tools]
```typescript
// MCP tool registration
```

## Testing Strategy
[How to test the implementation]

## Cost Considerations
[Token usage estimates, optimization strategies]

## Error Handling
[Error types and recovery patterns]

## Usage Examples
[Complete examples of running the command]

## Future Enhancements
[Potential improvements and extensions]
```

---

## Research Resources

### Primary Sources
- Anthropic Developer Documentation: https://docs.anthropic.com
- Claude Agent SDK NPM: https://www.npmjs.com/package/@anthropic-ai/claude-agent-sdk
- Effect Documentation (via MCP tool)
- Effect AI packages source code

### Codebase References
- Current docgen implementation: `tooling/cli/src/commands/docgen/`
- Existing agents: `.claude/agents/`
- CLI entry point: `tooling/cli/src/index.ts`
- Effect patterns: `CLAUDE.md` (AGENTS.md section)

### Context Files to Read
- `tooling/cli/src/commands/docgen/types.ts` - Type definitions
- `tooling/cli/src/commands/docgen/analyze.ts` - Analysis command
- `tooling/cli/src/commands/docgen/shared/ast.ts` - AST parsing
- `tooling/cli/src/commands/docgen/shared/markdown.ts` - Report generation
- `.claude/agents/jsdoc-fixer.md` - Current manual agent workflow

---

## Success Criteria

The implementation prompt should enable another Claude instance to:

1. **Create a working CLI command** - `bun run docgen:agents` that executes
2. **Deploy multiple coordinated agents** - Each with specific roles
3. **Integrate with MCP tools** - Access Effect documentation
4. **Fix real documentation issues** - Actually add missing JSDoc tags
5. **Validate fixes** - Run `docgen generate` to verify examples
6. **Report results** - Clear summary of work performed
7. **Handle errors gracefully** - Recover from partial failures
8. **Follow Effect patterns** - No async/await, typed errors, proper services

---

## Output Instructions

After completing your research:

1. **Write the implementation prompt** to `DOCGEN_AGENTS_IMPLEMENTATION.md`
2. **Include complete, working code** - Not pseudocode or snippets
3. **Provide all type definitions** - Full Effect Schema types
4. **Document every decision** - Why this approach over alternatives
5. **List assumptions** - Any gaps in SDK documentation
6. **Include verification steps** - How to test each component

The output should be self-contained enough that another Claude instance can implement the solution without additional research.

---

## Notes for Researcher

- **Prioritize official documentation** over speculation
- **If SDK docs are sparse**, examine the source types and infer patterns
- **Consider Effect ecosystem packages** like `@effect/ai-anthropic` which may already solve parts of this
- **The existing `jsdoc-fixer.md` agent** demonstrates the workflow - the goal is to automate invoking it programmatically
- **Cost efficiency matters** - Prefer smaller models where possible, batch operations, minimize token usage
- **Real-world testing** - The solution needs to work on actual packages in this monorepo
