import { createRequire } from "node:module";
import path from "node:path";
import { defaultCache, withPWA } from "@beep/build-utils/pwa";
import { computeTranspilePackagesSync } from "@beep/build-utils/transpile-packages";
import type { NextConfig } from "next";

type BundleAnalyzerFactory = (
  options?:
    | {
        readonly enabled?: boolean | string | undefined;
        readonly openAnalyzer?: boolean | undefined;
      }
    | undefined
) => (config: NextConfig) => NextConfig;

type WithBundleAnalyzerConfig = Parameters<BundleAnalyzerFactory>[0];

const transpilePackages = computeTranspilePackagesSync({target: "@beep/web"});

const require = createRequire(import.meta.url);

const withBundleAnalyzer = (() => {
  if (process.env.ENV !== "dev") {
    return (config: NextConfig) => config;
  }

  try {
    const plugin = require("@next/bundle-analyzer") as BundleAnalyzerFactory;
    return plugin({
      enabled: true,
      openAnalyzer: true,
    } satisfies WithBundleAnalyzerConfig);
  } catch (error) {
    console.warn("Skipping @next/bundle-analyzer because it is not installed in this environment.", error);
    return (config: NextConfig) => config;
  }
})();

const securityHeaders = [
  {
    key: "X-DNS-Prefetch-Control",
    value: "on",
  },
  {
    key: "X-XSS-Protection",
    value: "1; mode=block",
  },
  {
    key: "X-Frame-Options",
    value: "SAMEORIGIN",
  },
  {
    key: "X-Content-Type-Options",
    value: "nosniff",
  },
  {
    key: "Referrer-Policy",
    value: "same-origin",
  },
];

const withPWAConfig = withPWA({
  dest: "public",
  disable: process.env.NODE_ENV === "development",
  register: true,
  skipWaiting: true,
  runtimeCaching: [...defaultCache],
  fallbacks: {
    document: "/_offline",
  },
});

const optimizeImports = Array.from(
  new Set([
    "@iconify/react",
    "@mui/x-date-pickers",
    "@mui/lab",
    "@mui/icons-material",
    "@mui/material",
    "@beep/ui",
    "@beep/ui-core",
    "react-phone-number-input",
    "@effect/platform",
    "@effect/opentelemetry",
  ])
);

const nextConfig = {
  reactCompiler: true,
  trailingSlash: false,
  transpilePackages,
  images: {
    remotePatterns: [
      {
        protocol: "https",
        hostname: `${process.env.NEXT_PUBLIC_STATIC_URL}`.replace("https://", ""),
        port: "",
        pathname: "/**",
      }
    ],
    // Cost
    unoptimized: true,
  },
  serverExternalPackages: ["@node-rs/argon2"],
  async headers() {
    return [
      {
        // Apply these headers to all routes in your application.
        source: "/(.*?)",
        headers: securityHeaders,
      },
    ];
  },
  turbopack: {
    rules: {
      "*.svg": {
        loaders: ["@svgr/webpack"],
        as: "*.js",
      },
    },
  },
  outputFileTracingRoot: path.join(__dirname, "../../"),
  experimental: {
    mcpServer: true,
    optimizePackageImports: optimizeImports,
    turbopackFileSystemCacheForDev: true,
  },
} satisfies NextConfig;

const config = withPWAConfig(withBundleAnalyzer(nextConfig));
export default config;
