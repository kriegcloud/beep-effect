# AGENTS.md — `apps/server`

## Purpose & Fit
- Production entry point for the Bun-hosted Effect backend runtime that launches the complete HTTP/RPC server from `@beep/runtime-server`.
- Aligns with the monorepo's Effect-first posture: all dependencies are provided via Layers, configuration comes from `@beep/shared-env/ServerEnv`, and the application NEVER directly accesses `process.env` or `Bun.env`.
- The server is a minimal wrapper: `Layer.launch(Server.layer).pipe(BunRuntime.runMain)` — all functionality is delegated to `@beep/runtime-server`.

## Surface Map
- `src/server.ts` — minimal entry point that launches `Server.layer` from `@beep/runtime-server`
- `package.json` scripts — `dev`, `start`, `build`, `check`, `lint`, `test`, `coverage`, `lint:circular`; prefer running via root scripts with `--filter=@beep/server`
- Build outputs — `build/esm/server.js`, `build/dts/server.d.ts` generated by `tsconfig.build.json`
- Runtime dependencies from `@beep/runtime-server`:
  - `Server.layer` — complete layer composition including HTTP router, auth, persistence, tooling
  - `HttpRouter.layer` — all routes (IAM API, RPC, health, docs), middleware (CORS, logging, tracing), and authentication
  - `Persistence.layer` — database clients, repositories, S3 storage
  - `Tooling.layer` — email service, tracing exporters
  - `AuthContext.layer` — Better Auth integration and session management

## How to Extend
- **IMPORTANT: Do not modify this package directly**: `apps/server` is a thin wrapper. ALWAYS add new functionality to `@beep/runtime-server` instead.
- **Adding new endpoints**: Define API contracts in domain packages, implement handlers in slice server packages, register routes in `@beep/runtime-server/HttpRouter.layer.ts`. See README for detailed examples.
- **Config via env loaders**: read ports, OTLP URLs, and log levels from `serverEnv` exported by `@beep/shared-env/ServerEnv`. NEVER reach into `process.env` or `Bun.env` directly.
- **Platform bindings**: `@beep/runtime-server` uses `@effect/platform-bun` (BunHttpServer) and `@effect/rpc` for RPC. The `Server.layer` composition already includes logging, tracing, and all infrastructure.
- **Contracts over ad-hoc parsing**: surface APIs through HttpApi contracts (`@effect/platform/HttpApi`) and validate payloads with `@beep/schema` instead of manual parsing.
- **Error + logging**: ALWAYS stick to tagged errors (`@beep/errors`, `@beep/invariant`) and JSON-safe log fields. NEVER throw raw `Error` or log request bodies with secrets.
- **Performance**: ALWAYS keep Layers memoizable (`Layer.mergeAll` / `Layer.provideMerge`) to retain Turbo cache behavior; NEVER spin new DB connections per request.

## Guardrails (critical)
- ALWAYS namespace Effect imports and obey the repo bans on native array/string helpers: use `effect/Array`, `effect/String`, `effect/Function` pipes for all transformations.
- ALWAYS keep all dependency injection through Layers; NEVER use singletons or mutable module state.
- NEVER make direct filesystem/network pokes outside platform abstractions; ALWAYS route through Effects and existing services.
- ALWAYS respect environment toggles from `serverEnv.app` (no dev-only behavior leaking into prod).

## Quick Recipe

The server entry point is minimal and rarely needs modification:

```typescript
import { Server } from "@beep/runtime-server";
import * as BunRuntime from "@effect/platform-bun/BunRuntime";
import { Layer } from "effect";

Layer.launch(Server.layer).pipe(BunRuntime.runMain);
```

To add new functionality, modify `@beep/runtime-server` instead:

```typescript
// Pattern: define route with HttpLayerRouter.use(), merge into PublicRoutes/ProtectedRoutes
const CustomRoute = HttpLayerRouter.use((router) =>
  router.add("GET", "/v1/custom", Effect.gen(function* () { /* handler */ }))
);
```

See `packages/runtime/server/src/HttpRouter.layer.ts` for full implementation examples.

## Verifications
- `bun run check --filter=@beep/server` — type-check against tsconfigs.
- `bun run lint --filter=@beep/server` / `bun run lint:fix --filter=@beep/server` — Biome + circular checks.
- `bun run test --filter=@beep/server` (or `coverage`) — Vitest placeholder suite.
- `bun run build --filter=@beep/server` — emit `build/esm` + `build/dts`.

## Contributor Checklist
- [ ] Entry point wraps work in `runServerPromise`/`runServerPromiseExit` with meaningful span names.
- [ ] Environment reads flow through `serverEnv` from `@beep/shared-env/ServerEnv`; no raw `process.env`/`Bun.env`.
- [ ] Effect imports are namespaced; no native array/string helpers.
- [ ] Logs and errors use structured, tagged forms (`@beep/errors`, `@beep/invariant`); no secrets in logs.
- [ ] New layers remain memoizable and merge cleanly with `AppLive` or its constituent layers.
