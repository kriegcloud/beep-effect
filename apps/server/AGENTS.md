# AGENTS.md — `apps/server`

## Purpose & Fit
- Bun-hosted Effect shell for backend workloads (HTTP/RPC servers, cron, workers) that should reuse the shared runtime from `@beep/runtime-server` for observability, DB access, and IAM/documents/task slice services.
- Aligns with the monorepo’s Effect-first posture: Layers supply all dependencies, `runServerPromise` wraps handlers with tracing spans, and environment comes from `@beep/core-env/server`.
- Current code is a placeholder (`src/server.ts` exports `beep`). New work should wire actual hosts through the runtime helpers below rather than adding ad-hoc bootstraps.

## Surface Map
- `src/server.ts` — entry point, to be replaced with a runtime-backed host (HTTP, worker, etc).
- `package.json` scripts — `dev`, `start`, `build`, `check`, `lint`, `test`, `coverage`, `lint:circular`; prefer running via root scripts with `--filter=@beep/server`.
- Build outputs — `build/esm/server.js`, `build/dts/server.d.ts` generated by `tsconfig.build.json`.
- Runtime dependencies live in `packages/runtime/server/src/server-runtime.ts`:
  - `serverRuntime`, `runServerPromise`, `runServerPromiseExit` for executing effects.
  - `ObservabilityLive` (logger, telemetry, devtools), `LogLevelLive` (env-driven log level).
  - `CoreServicesLive`, `RepositoriesLive`, `DatabaseInfrastructureLive` for IAM/documents/ slices.

## How to Extend
- **Use the runtime helpers**: wrap all entrypoints with `runServerPromise`/`runServerPromiseExit` so spans and logging remain consistent. Avoid bare `Effect.runPromise`.
- **Config via env loaders**: read ports, OTLP URLs, and log levels from `serverEnv` (`@beep/core-env/server`). Do not reach into `process.env` or `Bun.env` directly.
- **Platform bindings**: prefer `@effect/platform-bun` (e.g., `BunHttpServer`, sockets) or `@effect/rpc` for RPC. Provide `ObservabilityLive` and `LogLevelLive` when building servers so telemetry and logging are active.
- **Contracts over ad-hoc parsing**: surface APIs through contract kits (`@beep/contract`, slice SDKs) and validate payloads with `@beep/schema` instead of manual parsing.
- **Error + logging**: stick to tagged errors (`@beep/errors`, `@beep/invariant`) and JSON-safe log fields. Avoid throwing raw `Error` or logging request bodies with secrets.
- **Performance**: keep Layers memoizable (`Layer.mergeAll` / `Layer.provideMerge`) to retain Turbo cache behavior; avoid spinning new DB connections per request.

## Guardrails (critical)
- Namespace Effect imports and obey the repo bans on native array/string helpers: use `effect/Array`, `effect/String`, `effect/Function` pipes for all transformations.
- Keep all dependency injection through Layers; avoid singletons or mutable module state.
- No direct filesystem/network pokes outside platform abstractions; route through Effects and existing services.
- Respect environment toggles from `serverEnv.app` (no dev-only behavior leaking into prod).

## Quick Recipe
```ts
import { runServerPromise } from "@beep/runtime-server";
import * as Effect from "effect/Effect";
import * as F from "effect/Function";
import * as Str from "effect/String";

export const healthcheck = () =>
  runServerPromise(
    Effect.gen(function* () {
      const status = F.pipe("ok", Str.toUpperCase);
      yield* Effect.logInfo("server.health", { status });
      return { status };
    }).pipe(Effect.withSpan("server.health")),
    "server.health"
  );
```

## Verifications
- `bun run check --filter=@beep/server` — type-check against tsconfigs.
- `bun run lint --filter=@beep/server` / `bun run lint:fix --filter=@beep/server` — Biome + circular checks.
- `bun run test --filter=@beep/server` (or `coverage`) — Vitest placeholder suite.
- `bun run build --filter=@beep/server` — emit `build/esm` + `build/dts`.

## Contributor Checklist
- [ ] Entry point wraps work in `runServerPromise`/`runServerPromiseExit` with meaningful span names.
- [ ] Environment reads flow through `serverEnv`; no raw `process.env`/`Bun.env`.
- [ ] Effect imports are namespaced; no native array/string helpers.
- [ ] Logs and errors use structured, tagged forms (`@beep/errors`, `@beep/invariant`); no secrets in logs.
- [ ] New layers remain memoizable and merge cleanly with `ObservabilityLive` and `CoreServicesLive`.
