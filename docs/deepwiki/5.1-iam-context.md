# IAM Context | kriegcloud/beep-effect | DeepWiki

_Source: https://deepwiki.com/kriegcloud/beep-effect/5.1-iam-context_

Relevant source files
*   [apps/web/src/libs/next/index.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/apps/web/src/libs/next/index.ts)
*   [packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql)
*   [packages/_internal/db-admin/drizzle/meta/0000_snapshot.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json)
*   [packages/_internal/db-admin/drizzle/meta/_journal.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/_journal.json)
*   [packages/common/constants/src/Csp.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/constants/src/Csp.ts)
*   [packages/core/env/src/client.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/env/src/client.ts)
*   [packages/core/env/src/server.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/env/src/server.ts)
*   [packages/iam/infra/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/package.json)
*   [packages/iam/ui/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/package.json)
*   [packages/iam/ui/src/sign-up/sign-up-email.form.tsx](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/src/sign-up/sign-up-email.form.tsx)
*   [packages/iam/ui/tsconfig.build.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/tsconfig.build.json)
*   [packages/iam/ui/tsconfig.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/tsconfig.json)
*   [packages/iam/ui/tsconfig.src.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/tsconfig.src.json)
*   [packages/iam/ui/tsconfig.test.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/tsconfig.test.json)

Purpose and Scope
-----------------

The IAM (Identity and Access Management) Context is a bounded domain context responsible for all aspects of user identity, authentication, authorization, and organizational structure within the beep-effect system. This context manages users, organizations, teams, memberships, sessions, and access control throughout the application.

The IAM Context implements a complete vertical slice architecture with five distinct layers:

*   **Domain Layer** ([5.1.1](https://deepwiki.com/kriegcloud/beep-effect/5.1.1-iam-domain-layer)): Pure business logic, entities, and value objects
*   **Database Schema** ([5.1.2](https://deepwiki.com/kriegcloud/beep-effect/5.1.2-iam-database-schema)): Drizzle ORM table definitions and relationships
*   **Infrastructure Layer** ([5.1.3](https://deepwiki.com/kriegcloud/beep-effect/5.1.3-iam-infrastructure)): Repositories, better-auth integration, and external service adapters
*   **SDK Layer** ([5.1.4](https://deepwiki.com/kriegcloud/beep-effect/5.1.4-iam-sdk)): Client-side API for authentication and IAM operations
*   **UI Layer** ([5.1.5](https://deepwiki.com/kriegcloud/beep-effect/5.1.5-iam-ui-components)): React components for authentication and user management

For information about the Policy-based authorization system that consumes IAM context data, see [Policy Authorization System](https://deepwiki.com/kriegcloud/beep-effect/4.3.3-policy-authorization-system). For details about the Better-Auth integration, see [AuthService and Better-Auth](https://deepwiki.com/kriegcloud/beep-effect/4.3.1-authservice-and-better-auth).

Vertical Slice Architecture
---------------------------

The IAM Context follows a strict layered architecture where dependencies flow unidirectionally from UI down to domain, with each layer having a specific responsibility.

**Sources:**[packages/iam/ui/package.json 1-77](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/package.json#L1-L77)[packages/iam/infra/package.json 1-174](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/package.json#L1-L174)[packages/iam/ui/tsconfig.src.json 1-83](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/tsconfig.src.json#L1-L83)

Core Domain Entities
--------------------

The IAM Context manages several interconnected entities that form the foundation of the identity and access management system.

| Entity | Purpose | Key Attributes | Database Table |
| --- | --- | --- | --- |
| **User** | Individual user identity | id, email, name, role, emailVerified, banned, twoFactorEnabled | `user` |
| **Organization** | Top-level organizational container | id, name, slug, ownerUserId, type, subscriptionTier, isPersonal | `organization` |
| **Team** | Sub-groups within organizations | id, organizationId, name, slug, description | `team` |
| **Member** | Organization membership relationship | id, organizationId, userId, role, status, permissions | `member` |
| **TeamMember** | Team membership relationship | id, teamId, userId | `team_member` |
| **Account** | OAuth/credential provider linkage | id, userId, providerId, accountId, accessToken, password | `account` |
| **Session** | Active user sessions | id, userId, token, expiresAt, activeOrganizationId, activeTeamId | `session` |
| **Invitation** | Pending organization invitations | id, email, organizationId, inviterId, status, expiresAt | `invitation` |

### Entity Relationships

**Sources:**[packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 1-2825](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L1-L2825)[packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 1-618](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L1-L618)

Database Schema Overview
------------------------

The IAM database schema uses the dual-identifier pattern with `id` (public UUID) and `_row_id` (internal serial) for all tables. All entities include standard audit fields: `created_at`, `updated_at`, `deleted_at`, `created_by`, `updated_by`, `deleted_by`, `version`, and `source`.

### Core IAM Tables

**Sources:**[packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 6-1008](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L6-L1008)[packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 10-503](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L10-L503)

### Enumerations

The schema defines several PostgreSQL enums for type-safe status and role management:

| Enum Type | Values | Usage |
| --- | --- | --- |
| `user_role_enum` | admin, super_admin, user, tenant, guest | User permission level |
| `user_gender_enum` | male, female | User demographic data |
| `organization_type_enum` | individual, team, enterprise | Organization classification |
| `subscription_tier_enum` | free, plus, pro, enterprise | Billing tier |
| `subscription_status_enum` | active, canceled | Subscription state |
| `member_role_enum` | owner, admin, member, viewer | Organization role |
| `member_status_enum` | active, inactive, offline, suspended, deleted, invited | Membership state |
| `invitation_status_enum` | pending, accepted, rejected, cancelled | Invitation lifecycle |

**Sources:**[packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 1-9](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L1-L9)

Layer Responsibilities
----------------------

### Domain Layer (`@beep/iam-domain`)

Contains pure business logic with no dependencies on infrastructure or frameworks. Defines entities, value objects, domain errors, and business rules.

**Key Responsibilities:**

*   Entity definitions and validation logic
*   Domain-specific error types
*   Business rule enforcement
*   Value object transformations

**Sources:**[packages/iam/ui/tsconfig.src.json 13-14](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/tsconfig.src.json#L13-L14)[packages/iam/ui/package.json 44](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/package.json#L44-L44)

### Tables Layer (`@beep/iam-tables`)

Defines Drizzle ORM schemas that map domain entities to database tables. Uses the EntityId pattern for type-safe identifiers.

**Key Responsibilities:**

*   Drizzle table definitions
*   Foreign key relationships
*   Index configurations
*   Schema migrations via Drizzle Kit

**Sources:**[packages/iam/infra/package.json 88](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/package.json#L88-L88)[packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 1-2825](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L1-L2825)

### Infrastructure Layer (`@beep/iam-infra`)

Implements repositories, adapters, and external service integrations. This layer bridges the domain to concrete implementations.

**Key Components:**

**Sources:**[packages/iam/infra/package.json 1-174](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/package.json#L1-L174)

### SDK Layer (`@beep/iam-sdk`)

Provides client-side API for authentication and IAM operations. Used by both web and server applications to interact with IAM functionality.

**Key Responsibilities:**

*   Client-side authentication flows
*   Session management utilities
*   Organization and team selection
*   Type-safe API clients

**Sources:**[packages/iam/ui/tsconfig.src.json 10-11](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/tsconfig.src.json#L10-L11)[packages/iam/ui/package.json 43](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/package.json#L43-L43)

### UI Layer (`@beep/iam-ui`)

React components for authentication, user management, and organization administration.

**Key Components:**

| Component File | Purpose |
| --- | --- |
| `sign-up-email.form.tsx` | Email-based registration form |
| `sign-in-*.tsx` | Various sign-in component variants |
| `profile-*.tsx` | User profile management |
| `organization-*.tsx` | Organization administration |
| `team-*.tsx` | Team management |

**Dependencies:**

*   `@beep/ui` - Shared UI component library
*   `@beep/iam-sdk` - Client-side IAM API
*   `@tanstack/react-form` - Form state management
*   `react-google-recaptcha-v3` - CAPTCHA integration
*   `better-auth` - Authentication client

**Sources:**[packages/iam/ui/package.json 1-77](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/package.json#L1-L77)[packages/iam/ui/src/sign-up/sign-up-email.form.tsx 1-87](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/src/sign-up/sign-up-email.form.tsx#L1-L87)

Authentication Flow
-------------------

The IAM Context integrates with better-auth for session-based authentication, supporting multiple authentication methods.

### Sign-Up Form Implementation

The sign-up form demonstrates the integration between UI, SDK, and authentication layers:

```
// From packages/iam/ui/src/sign-up/sign-up-email.form.tsx
const form = useAppForm(
  formOptionsWithSubmit({
    schema: SignUpValue,
    defaultValues: {
      email: "",
      password: "",
      gender: SharedEntities.User.UserGenderEnum.male,
      passwordConfirm: "",
      firstName: "",
      captchaResponse: "",
      lastName: "",
      rememberMe: false,
    },
    onSubmit,
  })
);
```

**Sources:**[packages/iam/ui/src/sign-up/sign-up-email.form.tsx 1-87](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/src/sign-up/sign-up-email.form.tsx#L1-L87)[packages/core/env/src/client.ts 1-58](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/env/src/client.ts#L1-L58)

Environment Configuration
-------------------------

The IAM Context relies on environment configuration for both client and server contexts.

### Client Configuration

Client-side configuration includes authentication URLs, OAuth provider settings, and security keys:

```
// From packages/core/env/src/client.ts
const ClientEnvSchema = S.Struct({
  env: EnvValue,
  appName: S.NonEmptyTrimmedString,
  appDomain: S.NonEmptyTrimmedString,
  authProviderNames: AuthProviderNames,
  appUrl: BS.URLString,
  apiUrl: BS.URLString,
  authUrl: BS.URLString,
  authPath: BS.URLPath,
  captchaSiteKey: S.Redacted(S.String),
  googleClientId: S.String,
  // ...
});
```

**Environment Variables:**

*   `NEXT_PUBLIC_AUTH_URL` - Better-auth base URL
*   `NEXT_PUBLIC_AUTH_PATH` - Authentication endpoint path
*   `NEXT_PUBLIC_AUTH_PROVIDER_NAMES` - Enabled OAuth providers
*   `NEXT_PUBLIC_CAPTCHA_SITE_KEY` - Google reCAPTCHA site key
*   `NEXT_PUBLIC_GOOGLE_CLIENT_ID` - Google OAuth client ID

**Sources:**[packages/core/env/src/client.ts 14-57](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/env/src/client.ts#L14-L57)

### Server Configuration

Server-side configuration includes database credentials, OAuth secrets, and external service keys:

```
// From packages/core/env/src/server.ts
export const ServerConfig = Config.all({
  auth: Config.all({
    secret: Config.redacted(Config.nonEmptyString("BETTER_AUTH_SECRET")),
  }),
  oauth: Config.nested("OAUTH")(
    Config.all({
      authProviderNames: Config.array(S.Config("PROVIDER_NAMES", AuthProviderNameValue)),
      provider: Config.nested("PROVIDER")(
        Config.all({
          google: Config.nested("GOOGLE")(
            Config.all({
              clientId: Config.redacted(Config.nonEmptyString("CLIENT_ID")).pipe(Config.option),
              clientSecret: Config.redacted(Config.nonEmptyString("CLIENT_SECRET")).pipe(Config.option),
            })
          ),
          // ... other providers
        })
      ),
    })
  ),
  // ...
});
```

**Key Environment Variables:**

*   `BETTER_AUTH_SECRET` - Session encryption secret
*   `OAUTH_PROVIDER_NAMES` - Comma-separated provider list
*   `OAUTH_PROVIDER_GOOGLE_CLIENT_ID` - Google OAuth client ID
*   `OAUTH_PROVIDER_GOOGLE_CLIENT_SECRET` - Google OAuth client secret
*   `OAUTH_PROVIDER_MICROSOFT_CLIENT_ID` - Microsoft OAuth client ID
*   `OAUTH_PROVIDER_GITHUB_CLIENT_ID` - GitHub OAuth client ID
*   `CLOUD_GOOGLE_CAPTCHA_SECRET_KEY` - reCAPTCHA secret key
*   `PAYMENT_STRIPE_KEY` - Stripe API key (for billing integration)
*   `EMAIL_RESEND_API_KEY` - Resend API key (for transactional emails)

**Sources:**[packages/core/env/src/server.ts 24-208](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/env/src/server.ts#L24-L208)

Security Considerations
-----------------------

### Content Security Policy

The IAM UI components must operate within the application's Content Security Policy. The CSP configuration allows authentication-related resources:

```
// From packages/common/constants/src/Csp.ts
const cspDirectives = (nonce: string) =>
  ({
    "script-src-elem": [
      "'self'",
      `'unsafe-inline'`,
      `https://www.googletagmanager.com`,
      "https://www.gstatic.com",
      "https://www.google.com",
    ],
    "frame-src": [
      "'self'",
      "https://www.google.com",
    ],
    // ...
  });
```

**Allowed Origins:**

*   Google reCAPTCHA ([www.google.com](http://www.google.com/), [www.gstatic.com](http://www.gstatic.com/))
*   OAuth redirect URLs (configured per provider)
*   Application domains (from environment configuration)

**Sources:**[packages/common/constants/src/Csp.ts 28-69](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/constants/src/Csp.ts#L28-L69)

### Session Management

Sessions use the dual-identifier pattern with token-based authentication. The `session` table includes:

*   **Token-based authentication:** Unique session tokens stored hashed in database
*   **Expiration tracking:**`expires_at` timestamp with check constraint ensuring expiry is after creation
*   **Active context tracking:**`active_organization_id` and `active_team_id` for multi-tenancy
*   **Impersonation support:**`impersonated_by` for admin user impersonation
*   **Audit trail:** IP address and user agent tracking

**Database Constraints:**

```
CONSTRAINT "session_expires_after_created_check"
CHECK ("session"."expires_at" > "session"."created_at")
```

**Sources:**[packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 364-386](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L364-L386)[packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 1363-1414](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L1363-L1414)

Integration Points
------------------

### With Shared Domain

The IAM Context depends on `@beep/shared-domain` for common entity definitions like EntityId patterns and Policy structures. User roles and permissions integrate with the Policy authorization system.

### With Files Context

Organizations, teams, and users can own files. The Files Context references IAM entities via `created_by`, `updated_by`, and `organization_id` foreign keys.

### With Core Email

The `AuthEmailService` from `@beep/core-email` handles transactional emails:

*   Email verification links
*   Password reset emails
*   Invitation emails
*   Two-factor authentication codes

### With External Services

*   **Stripe:** Organization subscriptions and billing management
*   **Resend:** Transactional email delivery
*   **Google reCAPTCHA:** Bot protection for registration and login
*   **OAuth Providers:** Google, Microsoft, GitHub, Discord, LinkedIn, Twitter

**Sources:**[packages/iam/infra/package.json 35-94](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/package.json#L35-L94)[packages/core/env/src/server.ts 96-182](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/env/src/server.ts#L96-L182)

Build Configuration
-------------------

The IAM packages use a standard build pipeline with both ESM and CJS outputs:

```
// From packages/iam/ui/package.json
"build": "pnpm build-esm && pnpm build-cjs && pnpm build-annotate",
"build-esm": "tsc -b tsconfig.build.json",
"build-cjs": "babel build/esm --plugins babel-plugin-transform-next-use-client --plugins @babel/transform-export-namespace-from --plugins @babel/transform-modules-commonjs --presets @babel/preset-react --out-dir build/cjs --source-maps",
"build-annotate": "babel build/esm --plugins babel-plugin-transform-next-use-client --plugins annotate-pure-calls --presets @babel/preset-react --out-dir build/esm --source-maps"
```

**Build Steps:**

1.   **TypeScript compilation** to ESM format with type declarations
2.   **Babel transformation** to CJS for Node.js compatibility
3.   **Pure call annotation** for tree-shaking optimization
4.   **Next.js "use client" directive** transformation for React Server Components

**Sources:**[packages/iam/ui/package.json 22-26](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/package.json#L22-L26)[packages/iam/infra/package.json 22-26](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/package.json#L22-L26)
