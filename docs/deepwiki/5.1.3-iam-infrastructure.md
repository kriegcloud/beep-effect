# IAM Infrastructure | kriegcloud/beep-effect | DeepWiki

_Source: https://deepwiki.com/kriegcloud/beep-effect/5.1.3-iam-infrastructure_

Relevant source files
*   [apps/web/src/libs/next/index.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/apps/web/src/libs/next/index.ts)
*   [docker-compose.yml](https://github.com/kriegcloud/beep-effect/blob/b64126f6/docker-compose.yml)
*   [packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql)
*   [packages/_internal/db-admin/drizzle/meta/0000_snapshot.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json)
*   [packages/_internal/db-admin/drizzle/meta/_journal.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/_journal.json)
*   [packages/common/constants/src/Csp.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/constants/src/Csp.ts)
*   [packages/common/constants/src/paths/asset-paths.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/constants/src/paths/asset-paths.ts)
*   [packages/common/constants/src/paths/generated/asset-paths.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/constants/src/paths/generated/asset-paths.ts)
*   [packages/core/env/src/client.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/env/src/client.ts)
*   [packages/core/env/src/server.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/env/src/server.ts)
*   [packages/iam/infra/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/package.json)
*   [packages/iam/infra/src/adapters/better-auth/Auth.service.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts)
*   [packages/iam/sdk/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/package.json)
*   [packages/iam/sdk/src/clients/sign-in/sign-in.client.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/src/clients/sign-in/sign-in.client.ts)
*   [packages/iam/sdk/src/index.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/src/index.ts)
*   [packages/iam/ui/src/sign-up/sign-up-email.form.tsx](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/src/sign-up/sign-up-email.form.tsx)
*   [packages/iam/ui/src/sign-up/sign-up.view.tsx](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/src/sign-up/sign-up.view.tsx)
*   [packages/runtime/client/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/package.json)
*   [packages/runtime/client/src/services/runtime/live-layer.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts)
*   [packages/runtime/server/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/package.json)
*   [packages/runtime/server/src/server-runtime.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts)

Purpose and Scope
-----------------

This document describes the infrastructure layer of the IAM (Identity and Access Management) context, which implements repository patterns, external service adapters, and database lifecycle management. The infrastructure layer bridges the domain layer with external systems including PostgreSQL, Redis, email services, and authentication providers.

For information about the IAM domain models and business logic, see [IAM Domain Layer](https://deepwiki.com/kriegcloud/beep-effect/5.1.1-iam-domain-layer). For database schema definitions, see [IAM Database Schema](https://deepwiki.com/kriegcloud/beep-effect/5.1.2-iam-database-schema). For client-side authentication flows, see [IAM SDK](https://deepwiki.com/kriegcloud/beep-effect/5.1.4-iam-sdk).

Architecture Overview
---------------------

The IAM infrastructure follows a layered architecture with clear separation between repositories, service adapters, and external integrations:

**Sources:**[packages/iam/infra/src/adapters/better-auth/Auth.service.ts 1-250](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L1-L250)[packages/runtime/server/src/server-runtime.ts 1-123](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L1-L123)

Service Layer Components
------------------------

### Component Dependencies

The IAM infrastructure layer exposes three primary Effect services that compose into the runtime:

| Service | Type | Purpose | Dependencies |
| --- | --- | --- | --- |
| `AuthService` | `Effect.Service` | better-auth wrapper and configuration | `AuthEmailService`, `IamDb.IamDb` |
| `AuthEmailService` | `Effect.Service` | Email delivery for auth flows | `ResendService` |
| `IamRepos.layer` | `Layer` | Repository pattern implementations | `IamDb.IamDb` |

**Sources:**[packages/iam/infra/src/adapters/better-auth/Auth.service.ts 241-249](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L241-L249)[packages/runtime/server/src/server-runtime.ts 69-89](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L69-L89)

AuthService Implementation
--------------------------

### Service Configuration

The `AuthService` wraps the better-auth library and provides Effect-native integration. The service is defined using Effect's service pattern:

The configuration pipeline at [packages/iam/infra/src/adapters/better-auth/Auth.service.ts 27-237](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L27-L237) constructs a comprehensive `BetterAuthOptions` object through an Effect generator that:

1.   Obtains dependencies (`IamDb`, `AuthEmailService`, `AllPlugins`)
2.   Determines debug mode based on log level
3.   Configures telemetry, database adapter, and runtime settings
4.   Sets up authentication methods and OAuth providers
5.   Defines database lifecycle hooks

**Sources:**[packages/iam/infra/src/adapters/better-auth/Auth.service.ts 27-237](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L27-L237)[packages/iam/infra/src/adapters/better-auth/Auth.service.ts 241-249](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L241-L249)

### Database Adapter Configuration

The service uses the Drizzle adapter to bridge better-auth with the Effect SQL layer:

```
database: drizzleAdapter(drizzle, {
  debugLogs: isDebug,
  provider: "pg",
  usePlural: false,
  schema: IamDbSchema,
  camelCase: true,
})
```

Configuration details at [packages/iam/infra/src/adapters/better-auth/Auth.service.ts 40-46](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L40-L46):

| Option | Value | Purpose |
| --- | --- | --- |
| `debugLogs` | `isDebug` | Enable query logging in development |
| `provider` | `"pg"` | PostgreSQL dialect |
| `usePlural` | `false` | Table naming convention (singular) |
| `schema` | `IamDbSchema` | Drizzle schema from @beep/iam-tables |
| `camelCase` | `true` | Convert snake_case to camelCase |

**Sources:**[packages/iam/infra/src/adapters/better-auth/Auth.service.ts 40-46](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L40-L46)

### Authentication Methods

The service configures multiple authentication strategies:

**Email and Password Configuration**[packages/iam/infra/src/adapters/better-auth/Auth.service.ts 91-105](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L91-L105):

*   Verification not required on signup (users can verify later)
*   Password reset emails sent via `sendResetPassword` callback
*   Executes as Effect wrapped in `Runtime.runPromise`

**Email Verification Configuration**[packages/iam/infra/src/adapters/better-auth/Auth.service.ts 76-90](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L76-L90):

*   Automatically sends verification email on signup
*   Email content generated by `AuthEmailService.sendVerification`
*   Verification URL constructed with client URL + token

**Social Providers**[packages/iam/infra/src/adapters/better-auth/Auth.service.ts 106-117](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L106-L117):

*   Dynamically configured from `serverEnv.oauth.authProviderNames`
*   Only includes providers with valid `clientId` and `clientSecret`
*   Supports: google, microsoft, discord, github, linkedin, twitter

**Sources:**[packages/iam/infra/src/adapters/better-auth/Auth.service.ts 76-117](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L76-L117)

### Session Management

Session configuration with cookie-based caching and organization context:

```
session: {
  modelName: IamEntityIds.SessionId.tableName,
  additionalFields: commonExtraFields,
  cookieCache: {
    enabled: true,
    maxAge: Duration.days(30).pipe(Duration.toSeconds),
  },
  expiresIn: Duration.days(30).pipe(Duration.toSeconds),
  updateAge: Duration.days(1).pipe(Duration.toSeconds),
}
```

Session settings at [packages/iam/infra/src/adapters/better-auth/Auth.service.ts 66-75](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L66-L75):

| Property | Value | Description |
| --- | --- | --- |
| `modelName` | `SessionId.tableName` | "session" table reference |
| `cookieCache.enabled` | `true` | Client-side session caching |
| `cookieCache.maxAge` | 30 days | Cookie expiration |
| `expiresIn` | 30 days | Session lifetime |
| `updateAge` | 1 day | Minimum time between session updates |

**Sources:**[packages/iam/infra/src/adapters/better-auth/Auth.service.ts 66-75](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L66-L75)

Database Lifecycle Hooks
------------------------

### User Creation Hook

When a new user is created, the system automatically provisions a personal organization and initial membership:

Implementation at [packages/iam/infra/src/adapters/better-auth/Auth.service.ts 121-158](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L121-L158):

**Organization Creation:**

*   ID: `SharedEntityIds.OrganizationId.create()`
*   Name: `"${user.name || 'User'}'s Organization"`
*   Slug: `"${sanitizedName}-${userIdSuffix}"`
*   Type: `"individual"`
*   Owner: User who was created
*   `isPersonal`: `true`
*   Subscription: `tier: "free"`, `status: "active"`

**Member Creation:**

*   ID: `IamEntityIds.MemberId.create()`
*   Role: `"owner"`
*   Status: `MemberStatusEnum.active`
*   Links user to their personal organization

The entire operation runs as a single Effect program with tracing via `Effect.withSpan`.

**Sources:**[packages/iam/infra/src/adapters/better-auth/Auth.service.ts 119-158](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L119-L158)

### Session Creation Hook

Sessions are enriched with organization context before persistence:

Hook implementation at [packages/iam/infra/src/adapters/better-auth/Auth.service.ts 162-216](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L162-L216):

**Query Logic:**

1.   Fetch all organizations where user has active membership
2.   Join `member` and `organization` tables
3.   Select org details, role, status, subscription tier
4.   Order by `isPersonal DESC` (personal org first)

**Context Construction:** The `organizationContext` field stores a JSON-serialized map:

```
{
  [orgId]: {
    name: string,
    type: string,
    role: string,
    isPersonal: boolean,
    subscriptionTier: string
  }
}
```

**Active Organization:**

*   `activeOrganizationId` set to first organization (typically personal org)
*   Used for multi-tenant resource access control

**Sources:**[packages/iam/infra/src/adapters/better-auth/Auth.service.ts 161-218](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L161-L218)

Email Service Integration
-------------------------

### AuthEmailService

The `AuthEmailService` wraps email delivery for authentication flows. Service structure:

**Verification Email Contract**[packages/iam/infra/src/adapters/better-auth/Auth.service.ts 81-88](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L81-L88):

```
S.decode(SendVerificationEmailPayload)({
  email: params.user.email,
  url: BS.URLString.make(
    `${serverEnv.app.clientUrl}${paths.auth.verification.email.verify(params.token)}`
  ).toString(),
})
```

**Password Reset Contract**[packages/iam/infra/src/adapters/better-auth/Auth.service.ts 96-103](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L96-L103):

```
S.decode(SendResetPasswordEmailPayload)({
  username: params.user.name,
  url: params.url,
  email: params.user.email,
})
```

Both email operations:

*   Use Effect Schema validation via `S.decode`
*   Execute via `Runtime.runPromise` to bridge async boundaries
*   Include OpenTelemetry spans for observability
*   Are wrapped in `void` to satisfy better-auth's fire-and-forget signature

**Sources:**[packages/iam/infra/src/adapters/better-auth/Auth.service.ts 78-104](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L78-L104)

Repository Layer
----------------

### IamRepos Composition

The repository layer provides domain-specific data access patterns. Repository structure:

The `IamRepos.layer` at [packages/runtime/server/src/server-runtime.ts 70](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L70-L70) composes all IAM-specific repositories into a single Layer that can be provided to the runtime. Each repository depends on `IamDb.IamDb` for database access.

**Sources:**[packages/runtime/server/src/server-runtime.ts 69-79](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L69-L79)

Runtime Integration
-------------------

### Server Runtime Assembly

The IAM infrastructure integrates into the server runtime through a hierarchical layer composition:

**Layer Composition Hierarchy:**

1.   **SliceDatabasesLive**[packages/runtime/server/src/server-runtime.ts 73](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L73-L73): Merges `IamDb.IamDb.Live` and `FilesDb.FilesDb.Live`
2.   **DatabaseInfrastructureLive**[packages/runtime/server/src/server-runtime.ts 76](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L76-L76): Provides slice databases to common `Db.Live`
3.   **RepositoriesLive**[packages/runtime/server/src/server-runtime.ts 79](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L79-L79): Provides database infra to slice repositories
4.   **AuthEmailLive**[packages/runtime/server/src/server-runtime.ts 86](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L86-L86): Provides `ResendService` to `AuthEmailService`
5.   **CoreServicesLive**[packages/runtime/server/src/server-runtime.ts 89](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L89-L89): Merges repositories and email service
6.   **AuthLive**[packages/runtime/server/src/server-runtime.ts 91](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L91-L91): Provides core services to `AuthService`
7.   **AppLive**[packages/runtime/server/src/server-runtime.ts 93](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L93-L93): Merges auth and logger
8.   **serverRuntime**[packages/runtime/server/src/server-runtime.ts 102](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L102-L102): Final runtime with observability

**Sources:**[packages/runtime/server/src/server-runtime.ts 68-102](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L68-L102)

### Dependency Resolution

The Effect Layer system handles dependency injection automatically. For example, `AuthService` declares its dependencies:

```
export class AuthService extends Effect.Service<AuthService>()("AuthService", {
  accessors: true,
  dependencies: [AuthEmailService.DefaultWithoutDependencies, IamDb.IamDb.Live],
  effect: Effect.flatMap(AuthOptions, (opts) =>
    Effect.succeed({
      auth: betterAuth(opts),
    })
  ),
})
```

At [packages/iam/infra/src/adapters/better-auth/Auth.service.ts 241-249](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L241-L249) the service:

*   Declares dependencies on `AuthEmailService` and `IamDb.IamDb`
*   Uses `Effect.flatMap` to access the constructed `AuthOptions`
*   Returns the initialized `betterAuth` instance

The runtime automatically resolves these dependencies when providing `AuthLive` to the application layer.

**Sources:**[packages/iam/infra/src/adapters/better-auth/Auth.service.ts 241-249](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L241-L249)

Environment Configuration
-------------------------

### OAuth Provider Configuration

OAuth providers are dynamically configured based on environment variables:

```
socialProviders: A.reduce(
  serverEnv.oauth.authProviderNames,
  {} as BetterAuthOptions["socialProviders"],
  (acc, provider) => ({
    ...acc,
    ...F.pipe(serverEnv.oauth.provider[provider], (providerParams) =>
      O.isSome(providerParams.clientSecret) && O.isSome(providerParams.clientId)
        ? { [provider]: providerParams }
        : {}
    ),
  })
)
```

At [packages/iam/infra/src/adapters/better-auth/Auth.service.ts 106-117](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L106-L117) the configuration:

1.   Iterates over `authProviderNames` array
2.   Checks if both `clientId` and `clientSecret` are present (as `Option.Some`)
3.   Only includes providers with valid credentials
4.   Returns empty object for unconfigured providers

**Server Environment Variables**[packages/core/env/src/server.ts 139-181](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/env/src/server.ts#L139-L181):

```
oauth: Config.nested("OAUTH")(
  Config.all({
    authProviderNames: Config.array(S.Config("PROVIDER_NAMES", AuthProviderNameValue)),
    provider: Config.nested("PROVIDER")(
      Config.all({
        microsoft: Config.nested("MICROSOFT")(...),
        google: Config.nested("GOOGLE")(...),
        discord: Config.nested("DISCORD")(...),
        github: Config.nested("GITHUB")(...),
        linkedin: Config.nested("LINKEDIN")(...),
        twitter: Config.nested("TWITTER")(...),
      })
    ),
  })
)
```

Each provider requires:

*   `clientId`: Redacted config, optional
*   `clientSecret`: Redacted config, optional
*   Additional provider-specific fields (e.g., `tenantId` for Microsoft)

**Sources:**[packages/iam/infra/src/adapters/better-auth/Auth.service.ts 106-117](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L106-L117)[packages/core/env/src/server.ts 137-181](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/env/src/server.ts#L137-L181)

### Security Configuration

Security settings from environment:

```
secret: Redacted.value(serverEnv.auth.secret),
trustedOrigins: [...serverEnv.security.trustedOrigins],
rateLimit: {
  enabled: true,
  window: 10, // seconds
  max: 100, // max requests in window
}
```

Configuration at [packages/iam/infra/src/adapters/better-auth/Auth.service.ts 50-56](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L50-L56):

| Setting | Value | Description |
| --- | --- | --- |
| `secret` | `BETTER_AUTH_SECRET` | JWT signing secret, redacted |
| `trustedOrigins` | `SECURITY_TRUSTED_ORIGINS` | CORS whitelist |
| `rateLimit.enabled` | `true` | Enable request throttling |
| `rateLimit.window` | 10 seconds | Rate limit time window |
| `rateLimit.max` | 100 requests | Maximum requests per window |

**Sources:**[packages/iam/infra/src/adapters/better-auth/Auth.service.ts 47-56](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L47-L56)[packages/core/env/src/server.ts 189-193](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/env/src/server.ts#L189-L193)

Package Dependencies
--------------------

### External Dependencies

Key external packages required by IAM infrastructure:

```
{
  "better-auth": "*",
  "@better-auth/core": "*",
  "@better-auth/stripe": "*",
  "@dub/better-auth": "*",
  "stripe": "*",
  "resend": "*",
  "drizzle-orm": "*",
  "postgres": "*",
  "@effect/sql": "*",
  "@effect/sql-pg": "*",
  "@effect/sql-drizzle": "*"
}
```

From [packages/iam/infra/package.json 36-94](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/package.json#L36-L94):

| Package | Purpose |
| --- | --- |
| `better-auth` | Core authentication framework |
| `@better-auth/stripe` | Stripe integration plugin |
| `@dub/better-auth` | Dub link shortening plugin |
| `stripe` | Payment processing |
| `resend` | Email delivery service |
| `drizzle-orm` | Type-safe SQL query builder |
| `@effect/sql-pg` | PostgreSQL client for Effect |

**Sources:**[packages/iam/infra/package.json 36-94](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/package.json#L36-L94)

### Internal Dependencies

Workspace packages consumed by IAM infrastructure:

```
{
  "@beep/core-db": "workspace:^",
  "@beep/core-env": "workspace:^",
  "@beep/core-email": "workspace:^",
  "@beep/iam-domain": "workspace:^",
  "@beep/iam-tables": "workspace:^",
  "@beep/shared-domain": "workspace:^",
  "@beep/shared-tables": "workspace:^",
  "@beep/schema": "workspace:^",
  "@beep/errors": "workspace:^"
}
```

From [packages/iam/infra/package.json 77-89](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/package.json#L77-L89):

| Package | Usage |
| --- | --- |
| `@beep/core-db` | Database factory and utilities |
| `@beep/core-env` | Environment configuration schemas |
| `@beep/core-email` | Email service abstraction |
| `@beep/iam-domain` | Domain entities and value objects |
| `@beep/iam-tables` | Drizzle schema definitions |
| `@beep/shared-domain` | Cross-domain entities and types |
| `@beep/schema` | Effect Schema utilities |

**Sources:**[packages/iam/infra/package.json 77-89](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/package.json#L77-L89)

Error Handling
--------------

### Better-Auth Error Bridge

Since better-auth uses async/await patterns and Effect uses `Effect` monads, errors must be bridged carefully:

```
sendResetPassword: async (params) =>
  void (await runPromise(
    Effect.flatMap(
      S.decode(SendResetPasswordEmailPayload)({...}),
      sendResetPassword
    ).pipe(Effect.withSpan("AuthService.emailAndPassword.sendResetPassword"))
  ))
```

At [packages/iam/infra/src/adapters/better-auth/Auth.service.ts 94-104](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L94-L104):

1.   Effect program is constructed with schema validation
2.   `Runtime.runPromise` executes the Effect
3.   Result is wrapped in `void` (better-auth expects fire-and-forget)
4.   Errors bubble up through Effect's error channel
5.   OpenTelemetry span captures execution context

This pattern ensures:

*   Schema validation failures are caught
*   Email delivery errors are traceable
*   Better-auth continues execution regardless of email status

**Sources:**[packages/iam/infra/src/adapters/better-auth/Auth.service.ts 78-104](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L78-L104)

### Runtime Error Propagation

The runtime provides helpers for executing Effects with proper error handling:

```
export const runServerPromise = <A, E>(
  effect: Effect.Effect<A, E, ServerRuntimeEnv>,
  spanName = "serverRuntime.runPromise",
  options?: Parameters<typeof serverRuntime.runPromise>[1]
) => serverRuntime.runPromise(Effect.withSpan(effect, spanName), options);
```

At [packages/runtime/server/src/server-runtime.ts 109-113](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L109-L113):

*   Wraps Effect execution with observability span
*   Uses `ManagedRuntime.runPromise` for resource management
*   Provides type-safe environment inference
*   Allows optional configuration via `options` parameter

**Sources:**[packages/runtime/server/src/server-runtime.ts 108-122](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L108-L122)
