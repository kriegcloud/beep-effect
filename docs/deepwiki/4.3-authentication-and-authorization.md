# Authentication and Authorization | kriegcloud/beep-effect | DeepWiki

_Source: https://deepwiki.com/kriegcloud/beep-effect/4.3-authentication-and-authorization_

Relevant source files
*   [apps/mcp/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/apps/mcp/package.json)
*   [apps/mcp/src/server.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/apps/mcp/src/server.ts)
*   [apps/server/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/apps/server/package.json)
*   [docker-compose.yml](https://github.com/kriegcloud/beep-effect/blob/b64126f6/docker-compose.yml)
*   [packages/common/constants/src/paths/asset-paths.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/constants/src/paths/asset-paths.ts)
*   [packages/common/constants/src/paths/generated/asset-paths.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/constants/src/paths/generated/asset-paths.ts)
*   [packages/common/schema/src/annotations/default.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/annotations/default.ts)
*   [packages/iam/infra/src/adapters/better-auth/Auth.service.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts)
*   [packages/iam/sdk/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/package.json)
*   [packages/iam/sdk/src/clients/sign-in/sign-in.client.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/src/clients/sign-in/sign-in.client.ts)
*   [packages/iam/sdk/src/index.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/src/index.ts)
*   [packages/iam/ui/src/sign-up/sign-up.view.tsx](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/src/sign-up/sign-up.view.tsx)
*   [packages/runtime/client/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/package.json)
*   [packages/runtime/client/src/services/runtime/live-layer.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts)
*   [packages/runtime/server/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/package.json)
*   [packages/runtime/server/src/server-runtime.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts)
*   [packages/shared/domain/src/Policy.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts)
*   [packages/shared/domain/test/internal/policy.test.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/test/internal/policy.test.ts)
*   [packages/shared/domain/test/policy.test.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/test/policy.test.ts)

Purpose and Scope
-----------------

This document covers the authentication and authorization systems in the beep-effect repository. Authentication verifies user identity using the better-auth library, while authorization controls access to resources using an Effect-based policy system.

For details on the specific better-auth configuration and plugins, see [4.3.1](https://deepwiki.com/kriegcloud/beep-effect/4.3.1-authservice-and-better-auth) and [4.3.2](https://deepwiki.com/kriegcloud/beep-effect/4.3.2-better-auth-plugins). For policy implementation details, see [4.3.3](https://deepwiki.com/kriegcloud/beep-effect/4.3.3-policy-authorization-system). For IAM domain entities and database schemas, see [5.1](https://deepwiki.com/kriegcloud/beep-effect/5.1-iam-context).

* * *

System Architecture
-------------------

The authentication and authorization system separates identity verification (authentication) from access control (authorization). Authentication is handled by better-auth with database and session management, while authorization uses Effect's context system to provide policy-based access control.

### Authentication and Authorization Flow

**Sources**: [packages/iam/infra/src/adapters/better-auth/Auth.service.ts 27-237](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L27-L237)[packages/shared/domain/src/Policy.ts 1-123](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L1-L123)

* * *

Authentication System
---------------------

The authentication system uses better-auth for identity management, with database-backed session storage and email verification flows.

### AuthService Configuration

The `AuthService` is an Effect service that wraps better-auth configuration and provides authentication functionality to the application.

**Sources**: [packages/iam/infra/src/adapters/better-auth/Auth.service.ts 27-249](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L27-L249)

#### Key Configuration Elements

| Configuration | Purpose | Location |
| --- | --- | --- |
| `drizzleAdapter` | Database adapter using Drizzle ORM with IamDbSchema | [Auth.service.ts 40-46](https://github.com/kriegcloud/beep-effect/blob/b64126f6/Auth.service.ts#L40-L46) |
| `session` | 30-day session expiry with cookie cache | [Auth.service.ts 66-75](https://github.com/kriegcloud/beep-effect/blob/b64126f6/Auth.service.ts#L66-L75) |
| `emailVerification` | Email verification on sign-up | [Auth.service.ts 76-90](https://github.com/kriegcloud/beep-effect/blob/b64126f6/Auth.service.ts#L76-L90) |
| `emailAndPassword` | Password reset email delivery | [Auth.service.ts 91-105](https://github.com/kriegcloud/beep-effect/blob/b64126f6/Auth.service.ts#L91-L105) |
| `socialProviders` | OAuth provider configuration | [Auth.service.ts 106-117](https://github.com/kriegcloud/beep-effect/blob/b64126f6/Auth.service.ts#L106-L117) |
| `databaseHooks` | Post-creation hooks for users and sessions | [Auth.service.ts 119-219](https://github.com/kriegcloud/beep-effect/blob/b64126f6/Auth.service.ts#L119-L219) |

**Sources**: [packages/iam/infra/src/adapters/better-auth/Auth.service.ts 36-236](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L36-L236)

### Database Hooks

Better-auth database hooks execute Effect programs during user and session lifecycle events.

#### User Creation Hook

When a user is created, the system automatically:

1.   Generates a personal organization with a unique slug
2.   Creates a member record associating the user as owner

**Sources**: [packages/iam/infra/src/adapters/better-auth/Auth.service.ts 122-158](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L122-L158)

#### Session Creation Hook

Before a session is created, the system:

1.   Queries all active organizations for the user
2.   Sets the first organization (preferring personal) as active
3.   Stores organization context in the session as JSON

**Sources**: [packages/iam/infra/src/adapters/better-auth/Auth.service.ts 162-217](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L162-L217)

### Email Verification and Password Reset

The authentication system integrates with `AuthEmailService` to send verification and password reset emails.

| Flow | Trigger | Email Content | Verification URL |
| --- | --- | --- | --- |
| Email Verification | Sign-up with email | Verification link | `${clientUrl}${paths.auth.verification.email.verify(token)}` |
| Password Reset | Forgot password request | Reset link with username | Provided by better-auth |

**Sources**: [packages/iam/infra/src/adapters/better-auth/Auth.service.ts 76-104](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L76-L104)

OAuth providers are configured from `serverEnv.oauth.provider` and dynamically included if both `clientId` and `clientSecret` are present.

**Sources**: [packages/iam/infra/src/adapters/better-auth/Auth.service.ts 106-117](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L106-L117)

* * *

Authorization System
--------------------

Authorization is implemented using the Effect-based Policy system, which provides composable access control through the `CurrentUser` context.

### CurrentUser Context

The `CurrentUser` context tag provides authenticated user information to Effect programs.

```
// Type definition
class CurrentUser extends Context.Tag("CurrentUser")<
  CurrentUser,
  {
    readonly sessionId: IamEntityIds.SessionId.Type;
    readonly userId: SharedEntityIds.UserId.Type;
    readonly permissions: Set<Permission>;
  }
>() {}
```

**Sources**: [packages/shared/domain/src/Policy.ts 52-59](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L52-L59)

### Permission System

Permissions are defined using a domain-action pattern: `{domain}:{action}`.

**Sources**: [packages/shared/domain/src/Policy.ts 13-46](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L13-L46)

#### Domain Permissions

Permissions are generated for each entity table with common actions:

| Domain | Table Name | Common Actions |
| --- | --- | --- |
| `organization` | organization | read, manage, delete |
| `team` | team | read, manage, delete |
| `file` | file | read, manage, delete |
| `member` | member | read, manage, delete |
| `user` | user | read, manage, delete |
| `session` | session | read, manage, delete |
| `account` | account | read, manage, delete |
| `api-key` | apiKey | read, manage, delete |

**Sources**: [packages/shared/domain/src/Policy.ts 15-41](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L15-L41)[packages/shared/domain/test/internal/policy.test.ts 5-30](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/test/internal/policy.test.ts#L5-L30)

### Policy Definition and Evaluation

A `Policy` is an Effect that succeeds with `void` if access is granted, or fails with `BeepError.Forbidden` if access is denied.

```
// Policy type
type Policy<E = never, R = never> = Effect.Effect<void, BeepError.Forbidden | E, CurrentUser | R>;
```

**Sources**: [packages/shared/domain/src/Policy.ts 75](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L75-L75)

#### Creating Policies

The `policy` function creates a policy from a predicate:

**Sources**: [packages/shared/domain/src/Policy.ts 80-90](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L80-L90)

#### Permission-Based Policy

The `permission` function creates a policy that checks for a specific permission:

```
// Usage example
const canReadOrganization = Policy.permission("organization:read");
```

**Sources**: [packages/shared/domain/src/Policy.ts 121-122](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L121-L122)

### Policy Combinators

Policies can be composed using logical operators.

#### Policy.all - AND Semantics

All policies must pass for the combined policy to succeed:

**Sources**: [packages/shared/domain/src/Policy.ts 105-109](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L105-L109)

#### Policy.any - OR Semantics

At least one policy must pass for the combined policy to succeed:

**Sources**: [packages/shared/domain/src/Policy.ts 115-116](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L115-L116)

### Applying Policies

The `withPolicy` operator applies a policy as a precondition to an Effect:

```
// Usage example
const protectedOperation = Effect.succeed("data").pipe(
  Policy.withPolicy(Policy.permission("organization:read"))
);
```

**Sources**: [packages/shared/domain/src/Policy.ts 96-99](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L96-L99)[packages/shared/domain/test/policy.test.ts 94-110](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/test/policy.test.ts#L94-L110)

### Policy Composition Example

Complex authorization rules can be built by nesting combinators:

```
// (canRead AND canManage) OR canDelete OR isSelf
const complexPolicy = Policy.any(
  Policy.all(
    Policy.permission("organization:read"),
    Policy.permission("organization:manage")
  ),
  Policy.permission("organization:delete"),
  Policy.policy((user) => Effect.succeed(user.userId === targetUserId))
);
```

**Sources**: [packages/shared/domain/test/policy.test.ts 216-227](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/test/policy.test.ts#L216-L227)

* * *

Client-Side Authentication
--------------------------

The IAM SDK provides client-side authentication operations with Effect-based error handling.

### Authentication Methods

**Sources**: [packages/iam/sdk/src/clients/sign-in/sign-in.client.ts 1-103](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/src/clients/sign-in/sign-in.client.ts#L1-L103)[packages/iam/ui/src/sign-up/sign-up.view.tsx 1-132](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/src/sign-up/sign-up.view.tsx#L1-L132)

### Sign-In Flow

**Sources**: [packages/iam/ui/src/sign-up/sign-up.view.tsx 104-120](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/src/sign-up/sign-up.view.tsx#L104-L120)

### Sign-In Client Structure

Each authentication method is wrapped with `AuthHandler.make` which provides:

| Feature | Description |
| --- | --- |
| Schema validation | Input/output validation with Effect Schema |
| Toast notifications | User feedback for waiting, success, failure states |
| Error handling | Structured error propagation |
| Telemetry | Automatic span creation with annotations |

**Sources**: [packages/iam/sdk/src/clients/sign-in/sign-in.client.ts 5-21](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/src/clients/sign-in/sign-in.client.ts#L5-L21)

* * *

Runtime Integration
-------------------

Authentication and authorization services are integrated into the Effect runtime layers.

### Server Runtime

The server runtime provides authentication services through layered composition:

**Sources**: [packages/runtime/server/src/server-runtime.ts 1-123](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L1-L123)

### Client Runtime

The client runtime does not include `AuthService` directly, as authentication is handled through HTTP requests to the server:

**Sources**: [packages/runtime/client/src/services/runtime/live-layer.ts 1-146](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts#L1-L146)

### UserAuthMiddleware

The `UserAuthMiddleware` is an HTTP middleware that provides the `CurrentUser` context to route handlers:

```
class UserAuthMiddleware extends HttpApiMiddleware.Tag<UserAuthMiddleware>()(
  "UserAuthMiddleware",
  {
    failure: BeepError.Unauthorized,
    provides: CurrentUser,
  }
) {}
```

This middleware:

1.   Extracts session information from the HTTP request
2.   Queries user permissions from the database
3.   Provides `CurrentUser` context to the Effect
4.   Fails with `BeepError.Unauthorized` if authentication fails

**Sources**: [packages/shared/domain/src/Policy.ts 61-64](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L61-L64)

* * *

External Dependencies
---------------------

The authentication system relies on external services configured through Docker Compose:

| Service | Purpose | Port | Configuration |
| --- | --- | --- | --- |
| PostgreSQL | User, session, organization storage | 5432 | `IamDbSchema` tables |
| Redis | Session caching | 6379 | Better-auth session store |

**Sources**: [docker-compose.yml 1-37](https://github.com/kriegcloud/beep-effect/blob/b64126f6/docker-compose.yml#L1-L37)

* * *

Summary
-------

The authentication and authorization system in beep-effect provides:

1.   **Better-auth integration** for identity management with database-backed sessions
2.   **Effect-based authorization** using the Policy system with composable access control
3.   **Database hooks** for automatic organization and member creation
4.   **Client SDK** with structured error handling and telemetry
5.   **Runtime integration** through Effect layers for dependency injection
6.   **Permission system** using domain:action pattern for fine-grained access control

The separation between authentication (identity verification via `AuthService`) and authorization (access control via `Policy`) enables flexible security patterns while maintaining type safety through Effect's context system.
