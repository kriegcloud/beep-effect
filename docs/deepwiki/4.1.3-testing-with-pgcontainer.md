# Testing with PgContainer | kriegcloud/beep-effect | DeepWiki

_Source: https://deepwiki.com/kriegcloud/beep-effect/4.1.3-testing-with-pgcontainer_

Relevant source files
*   [.github/workflows/check.yml](https://github.com/kriegcloud/beep-effect/blob/b64126f6/.github/workflows/check.yml)
*   [apps/web/src/app/api/auth/[...all]/route.ts](https://deepwiki.com/kriegcloud/beep-effect/apps/web/src/app/api/auth/%5B...all%5D/route.ts)
*   [packages/_internal/db-admin/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/package.json)
*   [packages/_internal/db-admin/src/Db.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/src/Db.ts)
*   [packages/_internal/db-admin/src/execute.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/src/execute.ts)
*   [packages/_internal/db-admin/test/pg-container.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts)
*   [packages/_internal/db-admin/tsconfig.test.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/tsconfig.test.json)
*   [packages/common/errors/src/shared.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/errors/src/shared.ts)
*   [packages/core/db/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/package.json)
*   [packages/core/db/src/db.factory.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts)
*   [packages/core/db/src/errors.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/errors.ts)
*   [packages/core/db/src/index.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/index.ts)
*   [packages/core/db/src/postgres/common.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/postgres/common.ts)
*   [packages/core/db/src/postgres/postgres-error.enum.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/postgres/postgres-error.enum.ts)
*   [packages/core/db/src/types.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/types.ts)
*   [packages/files/infra/src/adapters/repos/_common.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/infra/src/adapters/repos/_common.ts)
*   [packages/files/infra/src/db/Db.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/infra/src/db/Db.ts)
*   [packages/iam/infra/src/adapters/repos/_common.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/repos/_common.ts)
*   [packages/iam/infra/src/db/Db.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/db/Db.ts)

This document describes the Docker-based PostgreSQL test infrastructure provided by the `PgContainer` service. This system enables isolated database testing by automatically managing PostgreSQL container lifecycle, running migrations, and seeding test data.

For information about the database factory pattern and service creation, see [Db.make Factory](https://deepwiki.com/kriegcloud/beep-effect/4.1.1-db.make-factory). For details on database error handling, see [Database Error Handling](https://deepwiki.com/kriegcloud/beep-effect/4.1.2-database-error-handling).

Purpose and Architecture
------------------------

The `PgContainer` system provides a complete test database infrastructure using Docker containers. It handles container lifecycle management, migration execution, test data seeding, and service layer composition, allowing tests to run against a real PostgreSQL instance with full schema and extensions.

### System Overview

**Sources:**[packages/_internal/db-admin/test/pg-container.ts 1-266](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L1-L266)

### Error Types

The system defines two error types for container-related failures:

| Error Class | Purpose | Properties |
| --- | --- | --- |
| `PgContainerError` | Container initialization or operation failures | `message`, `cause` |
| `PgContainerUnsupported` | Docker unavailable or unsupported environment | `message`, `cause?` |

**Sources:**[packages/_internal/db-admin/test/pg-container.ts 29-37](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L29-L37)

Preflight Checks
----------------

Before attempting to start a container, the system performs comprehensive preflight checks to determine if Docker is available and operational.

### Preflight Logic

The preflight check evaluates three conditions:

1.   **Explicit Skip Environment Variables**: Checks for `BEEP_SKIP_PG_CONTAINER_TESTS`, `SKIP_DOCKER_TESTS`, or `TESTCONTAINERS_DISABLED`
2.   **Docker Availability**: Attempts to run a minimal Alpine container
3.   **Error Classification**: Categorizes failures into user-friendly messages

**Sources:**[packages/_internal/db-admin/test/pg-container.ts 43-135](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L43-L135)

### Environment Variable Skip Logic

```
const EXPLICIT_SKIP_ENV_VARS = [
  "BEEP_SKIP_PG_CONTAINER_TESTS",
  "SKIP_DOCKER_TESTS",
  "TESTCONTAINERS_DISABLED"
];
```

Any of these variables, when set to a truthy value (non-empty string other than "false"), will skip container tests.

**Sources:**[packages/_internal/db-admin/test/pg-container.ts 43-53](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L43-L53)

### Error Classification

The `classifyUnsupportedCause` function maps low-level Docker errors to user-friendly messages:

| Error Code/Pattern | Classification |
| --- | --- |
| `ENOENT` | Docker socket not found (daemon not running) |
| `ECONNREFUSED` | Docker daemon refused the connection |
| `EACCES` | Access to Docker socket was denied |
| `"operation not supported"` | Docker networking not supported in environment |
| `"permission denied"` | Access to Docker daemon was denied |
| `"unable to find image"` | Required Docker image not available locally |

**Sources:**[packages/_internal/db-admin/test/pg-container.ts 57-89](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L57-L89)

Container Setup
---------------

The `setupDocker` function orchestrates the complete container initialization process.

### Setup Workflow

**Sources:**[packages/_internal/db-admin/test/pg-container.ts 141-212](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L141-L212)

### Container Configuration

The PostgreSQL container is configured with:

```
const POSTGRES_USER = "test";
const POSTGRES_PASSWORD = "test";
const POSTGRES_DB = "test";
```

Docker image: `ghcr.io/fboulnois/pg_uuidv7:1.6.0` (PostgreSQL with pg_uuidv7 extension pre-installed)

**Sources:**[packages/_internal/db-admin/test/pg-container.ts 137-145](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L137-L145)[packages/_internal/db-admin/test/pg-container.ts 158-165](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L158-L165)

### Extension Installation

After the container starts, the `pg_uuidv7` extension is created:

`CREATE EXTENSION IF NOT EXISTS pg_uuidv7`
This extension provides UUID v7 generation capabilities required by the schema's entity ID system.

**Sources:**[packages/_internal/db-admin/test/pg-container.ts 179-186](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L179-L186)

### Migration Execution

Migrations are located relative to the test file:

```
const migrationPath = path.resolve(
  path.dirname(fileURLToPath(import.meta.url)),
  "../drizzle"
);
```

The `migrate` function from `drizzle-orm/postgres-js/migrator` applies all migration files in order.

**Sources:**[packages/_internal/db-admin/test/pg-container.ts 188-198](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L188-L198)

### Database Readiness Confirmation

After migrations complete, a simple query confirms the database is operational:

`SELECT 1`
**Sources:**[packages/_internal/db-admin/test/pg-container.ts 200-209](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L200-L209)

PgContainer Service
-------------------

The `PgContainer` class is an Effect Service that manages the container lifecycle using scoped resource management.

### Service Definition

The service uses `Effect.acquireRelease` to ensure the container is properly stopped when the scope ends:

```
export class PgContainer extends Effect.Service<PgContainer>()("PgContainer", {
  scoped: Effect.acquireRelease(
    setupDocker,
    ({ container }) => Effect.promise(() => container.stop())
  ),
}) {}
```

**Sources:**[packages/_internal/db-admin/test/pg-container.ts 214-216](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L214-L216)

PgContainer.Live Layer
----------------------

The `PgContainer.Live` layer provides a complete testing environment by composing all necessary database services.

### Layer Composition Architecture

**Sources:**[packages/_internal/db-admin/test/pg-container.ts 217-265](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L217-L265)

### Test Data Seeding

The Live layer includes test data seeding as part of its initialization:

```
const mockedUser = Entities.User.Model.insert.make({
  email: BS.Email.make("test@example.com"),
  name: "beep",
  emailVerified: false,
  gender: "male",
  image: O.some(faker.image.avatar()),
  createdAt: now,
  updatedAt: now,
});
```

This creates a standard test user available in all tests using the layer.

**Sources:**[packages/_internal/db-admin/test/pg-container.ts 222-231](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L222-L231)

### Service Layer Composition

The layer composition follows this hierarchy:

1.   **PgClient Layer**: Creates connection to the container's PostgreSQL instance
2.   **Database Service Layers**: Merges `IamDb.IamDb.Live` and `FilesDb.FilesDb.Live`
3.   **Repository Layers**: Merges `IamRepos.layer` and `FilesRepos.layer`
4.   **Platform Layers**: Provides `NodeFileSystem`, `Path`, and `NodeContext`
5.   **Container Layer**: Provides the `PgContainer.Default` service

The composition uses `Layer.provideMerge` to stack dependencies:

```
const sliceDbLayer = Layer.mergeAll(IamDb.IamDb.Live, FilesDb.FilesDb.Live);
const reposLayer = Layer.mergeAll(IamRepos.layer, FilesRepos.layer);
const verticalSlicesLayer = Layer.provideMerge(reposLayer, sliceDbLayer);
return Layer.provideMerge(verticalSlicesLayer, pgClient);
```

**Sources:**[packages/_internal/db-admin/test/pg-container.ts 238-256](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L238-L256)

### Connection URI Construction

The `PgClient.layer` is configured with the container's connection URI:

```
const pgClient = PgClient.layer({
  url: Redacted.make(container.getConnectionUri()),
  ssl: false,
  transformQueryNames: Str.camelToSnake,
  transformResultNames: Str.snakeToCamel,
});
```

This ensures database queries use the container's dynamically allocated port.

**Sources:**[packages/_internal/db-admin/test/pg-container.ts 242-247](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L242-L247)

Usage in Tests
--------------

Tests can use the `PgContainer.Live` layer to access a fully configured database environment.

### Test Pattern

```
import { PgContainer } from "@beep/db-admin/test/pg-container";
import { Effect, Layer } from "effect";

const testEffect = Effect.gen(function* () {
  const userRepo = yield* UserRepo;
  const user = yield* userRepo.findByEmail("test@example.com");
  // Assertions...
});

// Run test with PgContainer.Live layer
await Effect.runPromise(
  testEffect.pipe(Effect.provide(PgContainer.Live))
);
```

The layer automatically:

*   Checks Docker availability (skips if unavailable)
*   Starts a PostgreSQL container
*   Creates the pg_uuidv7 extension
*   Runs all migrations
*   Seeds test data
*   Provides all repository services
*   Stops the container when the scope ends

### CI/CD Integration

The GitHub Actions workflow currently has PgContainer tests commented out, but the infrastructure supports them:

```
# test:
#   name: Test
#   runs-on: ubuntu-latest
#   timeout-minutes: 20
#   steps:
#     - uses: actions/checkout@v4
#     - name: Install dependencies
#       uses: ./.github/actions/setup
#     - run: pnpm test
```

To enable, the Docker daemon must be available in the CI environment.

**Sources:**[.github/workflows/check.yml 49-59](https://github.com/kriegcloud/beep-effect/blob/b64126f6/.github/workflows/check.yml#L49-L59)

Error Handling
--------------

The system uses Effect's error handling mechanisms throughout the container lifecycle.

### Error Flow

Each operation that can fail is wrapped in `Effect.tryPromise` with appropriate error constructors:

```
yield* Effect.tryPromise({
  try: () => new PostgreSqlContainer(...).start(),
  catch: (error) => new PgContainerError({
    message: `Failed to initialize new PgContainer`,
    cause: error,
  }),
});
```

**Sources:**[packages/_internal/db-admin/test/pg-container.ts 156-171](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L156-L171)

### Preflight Skip Handling

When Docker is unavailable, the system fails with `PgContainerUnsupported`:

```
if (preflight.type === "skip") {
  return yield* Effect.fail(
    new PgContainerUnsupported({
      message: preflight.reason,
      cause: preflight.cause,
    })
  );
}
```

This allows tests to gracefully skip when running in environments without Docker.

**Sources:**[packages/_internal/db-admin/test/pg-container.ts 146-154](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L146-L154)

Package Dependencies
--------------------

The PgContainer system requires the following dependencies:

| Package | Purpose |
| --- | --- |
| `@testcontainers/postgresql` | PostgreSQL container management |
| `@effect/sql-pg` | PostgreSQL client integration |
| `@effect/sql-drizzle` | Drizzle ORM Effect integration |
| `drizzle-orm` | Query builder and migrations |
| `postgres` | PostgreSQL driver |
| `@faker-js/faker` | Test data generation |
| `@beep/iam-domain` | IAM domain entities |
| `@beep/iam-infra` | IAM database and repositories |
| `@beep/files-infra` | Files database and repositories |
| `@beep/schema` | Schema definitions and validation |

**Sources:**[packages/_internal/db-admin/package.json 38-74](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/package.json#L38-L74)

Migration Path Resolution
-------------------------

Migrations are located relative to the test file using Node.js path utilities:

```
import { fileURLToPath } from "node:url";
import path from "path";

const migrationPath = path.resolve(
  path.dirname(fileURLToPath(import.meta.url)),
  "../drizzle"
);
```

This ensures migrations are found regardless of the working directory when tests run.

**Sources:**[packages/_internal/db-admin/test/pg-container.ts 2](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L2-L2)[packages/_internal/db-admin/test/pg-container.ts 26](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L26-L26)[packages/_internal/db-admin/test/pg-container.ts 188-189](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L188-L189)

Lifecycle Management
--------------------

The PgContainer uses Effect's scoped resource management to ensure proper cleanup:

The `Effect.acquireRelease` pattern guarantees that `container.stop()` is called when the scope ends, even if tests fail or are interrupted.

**Sources:**[packages/_internal/db-admin/test/pg-container.ts 214-216](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L214-L216)
