# Files Context | kriegcloud/beep-effect | DeepWiki

_Source: https://deepwiki.com/kriegcloud/beep-effect/5.2-files-context_

Relevant source files
*   [apps/web/src/app/api/auth/[...all]/route.ts](https://deepwiki.com/kriegcloud/beep-effect/apps/web/src/app/api/auth/%5B...all%5D/route.ts)
*   [packages/_internal/db-admin/src/Db.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/src/Db.ts)
*   [packages/_internal/db-admin/test/pg-container.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts)
*   [packages/_internal/db-admin/tsconfig.test.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/tsconfig.test.json)
*   [packages/core/db/src/index.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/index.ts)
*   [packages/core/db/src/types.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/types.ts)
*   [packages/files/domain/src/utils/bytes-to-size.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/domain/src/utils/bytes-to-size.ts)
*   [packages/files/domain/src/utils/compress-file-name.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/domain/src/utils/compress-file-name.ts)
*   [packages/files/infra/src/adapters/repos/_common.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/infra/src/adapters/repos/_common.ts)
*   [packages/files/infra/src/db/Db.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/infra/src/db/Db.ts)
*   [packages/iam/infra/src/adapters/better-auth/plugins/one-tap/one-tap.plugin.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/plugins/one-tap/one-tap.plugin.ts)
*   [packages/iam/infra/src/adapters/better-auth/plugins/organization/organization.plugin.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/plugins/organization/organization.plugin.ts)
*   [packages/iam/infra/src/adapters/repos/_common.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/repos/_common.ts)
*   [packages/iam/infra/src/db/Db.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/db/Db.ts)
*   [packages/ui/src/theme/with-settings/update-core.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/ui/src/theme/with-settings/update-core.ts)

Purpose and Scope
-----------------

The Files Context is a bounded context responsible for file storage, upload management, and file metadata operations. It provides a vertical slice architecture for managing files in AWS S3 with metadata tracked in PostgreSQL. The context handles file uploads, storage, retrieval, and organization within the application.

For identity and access management concerns, see [IAM Context](https://deepwiki.com/kriegcloud/beep-effect/5.1-iam-context). For shared domain concepts used across contexts, see [Shared Domain](https://deepwiki.com/kriegcloud/beep-effect/5.3-shared-domain).

**Sources:**[packages/files/infra/src/db/Db.ts 1-15](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/infra/src/db/Db.ts#L1-L15)[packages/files/infra/src/adapters/repos/_common.ts 1-3](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/infra/src/adapters/repos/_common.ts#L1-L3)

Architecture Overview
---------------------

The Files Context follows the vertical slice architecture pattern with five distinct layers. Unlike the IAM context which has its own database schema, the Files Context uses the `SharedDbSchema` for its database operations.

**Key Characteristics:**

| Layer | Package | Responsibilities |
| --- | --- | --- |
| Domain | `@beep/files-domain` | File/Upload entities, domain logic, utility functions |
| Tables | `@beep/files-tables` | Database schemas (stored in `shared-tables`) |
| Infrastructure | `@beep/files-infra` | FilesDb service, repositories, S3 adapter |
| SDK | `@beep/files-sdk` | Client-side API for file operations |
| UI | `@beep/files-ui` | React components for file management |

**Sources:**[packages/files/infra/src/db/Db.ts 1-15](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/infra/src/db/Db.ts#L1-L15)[packages/_internal/db-admin/test/pg-container.ts 4-5](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L4-L5)

Domain Layer
------------

### Domain Entities

The Files domain includes two primary entities:

1.   **File**: Represents a stored file with metadata
2.   **Upload**: Tracks file upload operations and state

These entities are defined in `@beep/files-domain` and include business logic for file operations, validation, and lifecycle management.

### Domain Utilities

The domain layer provides utility functions for file handling:

#### File Name Compression

The `compressFileName` utility truncates long file names while preserving the extension:

**Algorithm:**

*   Maximum substring length: 18 characters
*   Preserves file extension
*   Inserts ellipsis (`...`) in the middle
*   Returns original name if under limit

**Sources:**[packages/files/domain/src/utils/compress-file-name.ts 1-27](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/domain/src/utils/compress-file-name.ts#L1-L27)

#### Byte Size Formatting

The `bytesToSize` utility converts byte counts to human-readable sizes:

| Input (bytes) | Output |
| --- | --- |
| 0 | "0 Byte" |
| 1024 | "1.00 KB" |
| 1048576 | "1.00 MB" |
| 1073741824 | "1.00 GB" |

**Implementation Details:**

*   Uses base-1024 calculation (binary)
*   Formats to 2 decimal places
*   Supports: Bytes, KB, MB, GB, TB

**Sources:**[packages/files/domain/src/utils/bytes-to-size.ts 1-10](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/domain/src/utils/bytes-to-size.ts#L1-L10)

Database Layer
--------------

### FilesDb Service

The `FilesDb` service is created using the `Db.make` factory pattern but wraps `SharedDbSchema` instead of a Files-specific schema. This design decision allows file-related tables to be part of the shared database schema.

**Service Definition:**

The `FilesDb` service provides:

*   `execute`: Execute database queries
*   `transaction`: Run transactional operations
*   `makeQuery`: Create reusable query functions
*   Access to `SharedDbSchema` tables

**Type Signature:**

`Layer.Layer<FilesDb, SqlError | ConfigError, SqlClient>`
**Sources:**[packages/files/infra/src/db/Db.ts 1-15](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/infra/src/db/Db.ts#L1-L15)[packages/core/db/src/db.factory.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts) (referenced)

### Database Schema

File-related tables are defined in `@beep/shared-tables` as part of the `SharedDbSchema`. This includes:

*   **Files table**: File metadata, storage location, size, MIME type
*   **Uploads table**: Upload tracking, status, progress
*   Foreign key relationships to users and organizations

The schema uses Drizzle ORM for type-safe database operations and follows the dual-identifier pattern (PublicId/PrivateId) for entity references.

**Sources:**[packages/files/infra/src/db/Db.ts 2](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/infra/src/db/Db.ts#L2-L2)[packages/shared/tables/tsconfig.build.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/tables/tsconfig.build.json) (package reference)

Infrastructure Layer
--------------------

### Repository Pattern

The Files infrastructure layer follows the repository pattern with Effect-based implementations:

**Repository Dependencies:**

The repository layer depends on `FilesDb.FilesDb.Live`:

`export const dependencies = [FilesDb.FilesDb.Live] as const;`
This establishes the dependency on the database service that must be provided when composing the repository layer.

**Sources:**[packages/files/infra/src/adapters/repos/_common.ts 1-3](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/infra/src/adapters/repos/_common.ts#L1-L3)[packages/_internal/db-admin/test/pg-container.ts 4-251](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L4-L251)

### Layer Composition

The Files infrastructure is composed with other layers in the application runtime:

**Test Environment Setup:**

In test environments (e.g., PgContainer tests), the Files infrastructure is composed alongside IAM infrastructure:

```
const sliceDbLayer = Layer.mergeAll(IamDb.IamDb.Live, FilesDb.FilesDb.Live);
const reposLayer = Layer.mergeAll(IamRepos.layer, FilesRepos.layer);
const verticalSlicesLayer = Layer.provideMerge(reposLayer, sliceDbLayer);
```

**Sources:**[packages/_internal/db-admin/test/pg-container.ts 249-255](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L249-L255)

### S3 Integration

The Files infrastructure integrates with AWS S3 for file storage. From the high-level architecture diagrams, `FilesDb` connects to S3 for storing actual file content, while PostgreSQL stores file metadata.

**Storage Flow:**

1.   File upload initiated â†’ Upload record created
2.   File content streamed to S3
3.   S3 returns storage location
4.   File metadata record created with S3 reference
5.   Upload record marked complete

**Sources:** Based on Diagram 4 from high-level architecture

SDK Layer
---------

The Files SDK (`@beep/files-sdk`) provides a client-side API for interacting with file operations. This layer abstracts the underlying HTTP/RPC communication and provides Effect-based APIs for:

*   File upload initiation
*   Upload progress tracking
*   File retrieval
*   File deletion
*   File listing and filtering

The SDK integrates with the client runtime's `HttpClient` service for communication with the server.

**Sources:** Based on vertical slice architecture pattern

UI Components
-------------

The Files UI (`@beep/files-ui`) provides React components for file management functionality:

*   **File Upload Components**: Drag-and-drop, file selection, progress indicators
*   **File List Components**: Display files with metadata
*   **File Actions**: Download, delete, share
*   **File Preview**: Thumbnail and preview generation

These components use the Files SDK for data operations and integrate with the application's UI library (`@beep/ui`) for consistent styling and behavior.

**Sources:** Based on vertical slice architecture pattern

Testing Infrastructure
----------------------

The Files Context is tested using the `PgContainer` infrastructure, which provides isolated PostgreSQL instances for integration testing:

**Test Setup Process:**

1.   Docker container starts with `ghcr.io/fboulnois/pg_uuidv7:1.6.0` image
2.   `pg_uuidv7` extension is created for UUID generation
3.   Drizzle migrations are executed
4.   Test data is seeded
5.   `FilesDb` and `FilesRepos` layers are provided

**Sources:**[packages/_internal/db-admin/test/pg-container.ts 1-266](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L1-L266)

Integration Points
------------------

### Cross-Context Dependencies

The Files Context integrates with other contexts:

| Dependency | Purpose |
| --- | --- |
| `@beep/shared-domain` | Shared entity IDs, policies, filters |
| `@beep/schema` | Effect Schema validation |
| `@beep/core-db` | Database factory and utilities |
| IAM Context | User and organization associations |

### External Service Dependencies

| Service | Purpose | Configuration |
| --- | --- | --- |
| AWS S3 | File storage backend | Bucket name, region, credentials |
| PostgreSQL | Metadata storage | Connection string via PgClient |
| Redis | Cache layer (optional) | Upload state caching |

**Sources:** Based on high-level architecture diagrams and layer composition patterns

Error Handling
--------------

The Files Context uses Effect's error handling system with typed errors:

*   **DbError**: Database operation failures (see [Database Error Handling](https://deepwiki.com/kriegcloud/beep-effect/4.1.2-database-error-handling))
*   **S3Error**: Storage operation failures
*   **ValidationError**: File validation failures (size, type, etc.)
*   **NotFoundError**: File or upload not found

All errors are properly tagged and can be handled using Effect's error handling combinators (`catchTag`, `catchAll`, etc.).

**Sources:**[packages/core/db/src/errors.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/errors.ts) (referenced for DbError pattern)
