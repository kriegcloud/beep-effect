# IAM Domain Layer | kriegcloud/beep-effect | DeepWiki

_Source: https://deepwiki.com/kriegcloud/beep-effect/5.1.1-iam-domain-layer_

Relevant source files
*   [apps/web/src/libs/next/index.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/apps/web/src/libs/next/index.ts)
*   [packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql)
*   [packages/_internal/db-admin/drizzle/meta/0000_snapshot.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json)
*   [packages/_internal/db-admin/drizzle/meta/_journal.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/_journal.json)
*   [packages/common/constants/src/Csp.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/constants/src/Csp.ts)
*   [packages/common/errors/src/errors.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/errors/src/errors.ts)
*   [packages/common/schema/src/custom/Bool.schema.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/custom/Bool.schema.ts)
*   [packages/common/schema/src/custom/UUID.schema.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/custom/UUID.schema.ts)
*   [packages/common/schema/src/custom/dates/Month.schema.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/custom/dates/Month.schema.ts)
*   [packages/common/schema/src/utils/mergeFields.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/utils/mergeFields.ts)
*   [packages/core/env/src/client.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/env/src/client.ts)
*   [packages/core/env/src/server.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/env/src/server.ts)
*   [packages/iam/domain/src/IamError.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/domain/src/IamError.ts)
*   [packages/iam/domain/src/index.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/domain/src/index.ts)
*   [packages/iam/infra/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/package.json)
*   [packages/iam/ui/src/sign-up/sign-up-email.form.tsx](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/src/sign-up/sign-up-email.form.tsx)

Purpose and Scope
-----------------

The IAM Domain Layer contains the core business logic and domain models for Identity and Access Management. This layer defines entities, value objects, domain errors, and business rules that are independent of infrastructure concerns. The domain layer follows Domain-Driven Design principles and is implemented using Effect Schema for type-safe validation and transformation.

For database schema details, see [IAM Database Schema](https://deepwiki.com/kriegcloud/beep-effect/5.1.2-iam-database-schema). For infrastructure implementations (repositories, adapters), see [IAM Infrastructure](https://deepwiki.com/kriegcloud/beep-effect/5.1.3-iam-infrastructure). For client-side integration, see [IAM SDK](https://deepwiki.com/kriegcloud/beep-effect/5.1.4-iam-sdk).

**Sources:**[packages/iam/domain/src/index.ts 1-4](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/domain/src/index.ts#L1-L4)

* * *

Package Structure
-----------------

The IAM domain package is located at `@beep/iam-domain` and exports two primary namespaces:

| Export | Description |
| --- | --- |
| `Entities` | Domain entities including User, Organization, Team, Member, Session, etc. |
| `IamError` | Domain-specific error classes for IAM operations |

The package depends on:

*   `@beep/schema` - Effect Schema utilities and custom types
*   `@beep/shared-domain` - Common domain entities and value objects
*   `@beep/errors` - Base error classes
*   `effect` - Effect-TS core library

**Sources:**[packages/iam/domain/src/index.ts 1-4](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/domain/src/index.ts#L1-L4)[packages/iam/infra/package.json 77-95](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/package.json#L77-L95)

* * *

Domain Entities Overview
------------------------

### Entity Architecture

**Sources:**[packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 6-753](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L6-L753)

* * *

Core Entity: User
-----------------

The `User` entity represents an authenticated identity in the system. It is the central entity in the IAM domain, referenced by most other entities.

### User Entity Schema

### User Role Enumeration

| Role | Description | Typical Permissions |
| --- | --- | --- |
| `super_admin` | System administrator | Full system access, tenant management |
| `admin` | Organization administrator | Organization-wide permissions |
| `user` | Standard user | Basic authenticated access |
| `tenant` | Multi-tenant user | Scoped to specific tenants |
| `guest` | Limited access user | Read-only or temporary access |

### User Status Indicators

| Field | Type | Purpose |
| --- | --- | --- |
| `banned` | boolean | Whether user is banned from the system |
| `banReason` | string | Reason for ban (if applicable) |
| `banExpires` | Date | Optional expiration date for temporary bans |
| `emailVerified` | boolean | Email verification status |
| `phoneNumberVerified` | boolean | Phone number verification status |
| `twoFactorEnabled` | boolean | 2FA enrollment status |
| `isAnonymous` | boolean | Anonymous/guest session indicator |

**Sources:**[packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 462-753](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L462-L753)[packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 58-90](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L58-L90)

* * *

Core Entity: Organization
-------------------------

The `Organization` entity represents a workspace or tenant that contains users, teams, and resources. It is the primary boundary for multi-tenancy.

### Organization Entity Schema

### Organization Types

| Type | Description | Use Case |
| --- | --- | --- |
| `individual` | Personal workspace | Single-user organizations, personal projects |
| `team` | Small team workspace | Collaborative teams with multiple members |
| `enterprise` | Enterprise workspace | Large organizations with complex hierarchies |

### Organization Features

The `features` JSONB field contains capability flags:

**Sources:**[packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 7-278](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L7-L278)[packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 10-35](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L10-L35)

* * *

Core Entity: Member
-------------------

The `Member` entity represents a user's membership within an organization, including their role and status.

### Member Entity Schema

### Member Role Hierarchy

### Member Lifecycle States

| Status | Description | Transitions To |
| --- | --- | --- |
| `invited` | Invitation sent, not yet accepted | `active`, `deleted` |
| `active` | Active member with full access | `inactive`, `suspended`, `deleted` |
| `inactive` | Temporarily inactive | `active`, `deleted` |
| `offline` | Currently offline | `active` |
| `suspended` | Access suspended | `active`, `deleted` |
| `deleted` | Soft-deleted member | (terminal state) |

**Sources:**[packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 214-236](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L214-L236)[packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 214-235](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L214-L235)

* * *

Core Entity: Session
--------------------

The `Session` entity represents an authenticated user session with context about the active organization and team.

### Session Entity Schema

### Session Features

| Feature | Field | Description |
| --- | --- | --- |
| Token-based | `token` | Unique session token for authentication |
| Expiration | `expiresAt` | Automatic session expiration |
| Context switching | `activeOrganizationId`, `activeTeamId` | User can switch between organizations/teams |
| Impersonation | `impersonatedBy` | Support for admin impersonation |
| Tracking | `ipAddress`, `userAgent` | Security audit trail |

**Sources:**[packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 364-386](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L364-L386)[packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 364-386](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L364-L386)

* * *

Authentication Entities
-----------------------

### Account Entity

The `Account` entity links a user to external OAuth providers (Google, GitHub, Microsoft, etc.).

| Provider ID | Description |
| --- | --- |
| `google` | Google OAuth |
| `github` | GitHub OAuth |
| `microsoft` | Microsoft/Azure AD |
| `discord` | Discord OAuth |
| `linkedin` | LinkedIn OAuth |
| `twitter` | Twitter/X OAuth |
| `credential` | Email/password authentication |

### Verification Entity

Temporary codes for email/phone verification.

| Field | Type | Purpose |
| --- | --- | --- |
| `identifier` | string | Email or phone number |
| `value` | string | Verification code |
| `expiresAt` | Date | Code expiration timestamp |

### TwoFactor Entity

2FA configuration for a user.

| Field | Type | Purpose |
| --- | --- | --- |
| `secret` | string | TOTP secret key |
| `backupCodes` | string | Encrypted backup codes |
| `userId` | UserId | Associated user |

### Passkey Entity

WebAuthn/FIDO2 credential storage.

| Field | Type | Purpose |
| --- | --- | --- |
| `name` | string | User-friendly credential name |
| `publicKey` | string | WebAuthn public key |
| `credentialId` | string | WebAuthn credential ID |
| `counter` | number | Signature counter (replay protection) |
| `deviceType` | string | Device type (platform/cross-platform) |
| `backedUp` | boolean | Credential backup status |
| `transports` | string | Supported transports (USB, NFC, BLE) |

**Sources:**[packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 754-1008](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L754-L1008)[packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 92-175](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L92-L175)

* * *

### Invitation Entity

Pending membership invitations to organizations.

| Field | Type | Purpose |
| --- | --- | --- |
| `email` | Email | Invitee's email address |
| `role` | string | Role to assign upon acceptance |
| `status` | InvitationStatus | Current invitation status |
| `expiresAt` | Date | Invitation expiration |
| `inviterId` | UserId | User who sent the invitation |
| `organizationId` | OrganizationId | Target organization |
| `teamId` | TeamId | Optional target team |

### Team and TeamMember Entities

Teams are sub-organizational units within an organization.

### ApiKey Entity

API keys for programmatic access to the platform.

| Field | Type | Purpose |
| --- | --- | --- |
| `name` | string | Human-friendly name |
| `key` | string | Actual API key (hashed) |
| `prefix` | string | Key prefix for identification |
| `enabled` | boolean | Enable/disable key |
| `rateLimitEnabled` | boolean | Rate limiting flag |
| `rateLimitTimeWindow` | number | Rate limit window (ms) |
| `rateLimitMax` | number | Max requests per window |
| `expiresAt` | Date | Optional expiration |
| `permissions` | string | JSON-encoded permissions |

**Sources:**[packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 1009-1246](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L1009-L1246)[packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 177-196](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L177-L196)

* * *

Entity Relationships
--------------------

### Primary Relationships

**Sources:**[packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 532-618](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L532-L618)

* * *

Domain Errors
-------------

### IamError Classes

The IAM domain defines tagged errors using Effect Schema for type-safe error handling.

### Error Usage Pattern

### Error Hierarchy

**Sources:**[packages/iam/domain/src/IamError.ts 1-6](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/domain/src/IamError.ts#L1-L6)

* * *

Audit Pattern
-------------

### Audit Fields

All IAM entities include standardized audit fields for change tracking and compliance.

| Field | Type | Purpose |
| --- | --- | --- |
| `createdAt` | Date | Entity creation timestamp |
| `updatedAt` | Date | Last modification timestamp |
| `deletedAt` | Date | Soft deletion timestamp (null if active) |
| `createdBy` | UserId | User who created the entity |
| `updatedBy` | UserId | User who last updated the entity |
| `deletedBy` | UserId | User who soft-deleted the entity |
| `version` | number | Optimistic locking version counter |
| `source` | string | Optional source/origin identifier |

### Audit Trail Example

### Optimistic Locking

The `version` field enables optimistic concurrency control:

1.   Entity is loaded with version N
2.   Client modifies entity
3.   Client submits update with version N
4.   Database updates only if current version == N
5.   If version mismatch, concurrent modification detected

**Sources:**[packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 11-70](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L11-L70)

* * *

Soft Delete Pattern
-------------------

### Implementation

All IAM entities support soft deletion via the `deletedAt` timestamp:

### Soft Delete Benefits

| Benefit | Description |
| --- | --- |
| **Data Recovery** | Deleted entities can be restored |
| **Audit Compliance** | Deletion history is preserved |
| **Referential Integrity** | Foreign keys remain valid |
| **Cascade Behavior** | Child entities can be soft-deleted together |

### Database Indexes

Soft delete patterns use partial indexes for active records:

**Sources:**[packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 34-40](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L34-L40)[packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 575-577](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L575-L577)

* * *

Value Objects and Enumerations
------------------------------

### EntityId Pattern

All entity identifiers use the branded `EntityId` pattern from `@beep/schema`:

This provides:

*   Type safety (cannot mix different ID types)
*   Dual-identifier support (public/private IDs)
*   UUID validation
*   Database integration

See [EntityId Pattern](https://deepwiki.com/kriegcloud/beep-effect/6.1.1-entityid-pattern) for complete details.

### Common Value Objects

| Value Object | Schema | Validation |
| --- | --- | --- |
| Email | `BS.Email` | RFC 5322 email format |
| UUID | `S.UUID` | UUID v4 format |
| URL | `BS.URLString` | Valid URL format |
| NonEmptyString | `S.NonEmptyTrimmedString` | Non-empty after trimming |
| PhoneNumber | `S.String` | Phone number format |

### Role and Status Enumerations

**Sources:**[packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 1-9](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L1-L9)[packages/common/schema/src/custom/UUID.schema.ts 1-49](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/custom/UUID.schema.ts#L1-L49)

* * *

Integration with Shared Domain
------------------------------

The IAM domain layer depends on `@beep/shared-domain` for common entities and value objects:

### Shared Dependencies

| Package | Purpose |
| --- | --- |
| `@beep/shared-domain` | Common entity IDs, filters, policies |
| `@beep/schema` | Effect Schema types, custom schemas |
| `@beep/errors` | Base error classes |
| `@beep/constants` | Static values and enumerations |

See [Shared Domain](https://deepwiki.com/kriegcloud/beep-effect/5.3-shared-domain) for details on shared domain concepts.

**Sources:**[packages/iam/infra/package.json 84-88](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/package.json#L84-L88)

* * *

Design Principles
-----------------

### Pure Domain Logic

The IAM domain layer contains **only pure business logic** with no infrastructure concerns:

*   ✅ Entity definitions
*   ✅ Value objects
*   ✅ Domain errors
*   ✅ Business rules and validations
*   ❌ Database queries
*   ❌ HTTP handlers
*   ❌ External service calls
*   ❌ UI components

### Effect Schema Integration

All entities use Effect Schema for:

1.   **Type safety** - Compile-time type checking
2.   **Runtime validation** - Parse and validate data
3.   **Transformation** - Encode/decode between formats
4.   **Documentation** - Self-documenting schemas

### Dependency Direction

Dependencies flow **inward** toward the domain, never outward.

**Sources:**[packages/iam/domain/src/index.ts 1-4](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/domain/src/index.ts#L1-L4)[packages/iam/infra/package.json 87-88](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/package.json#L87-L88)
