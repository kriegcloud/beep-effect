# Client Runtime | kriegcloud/beep-effect | DeepWiki

_Source: https://deepwiki.com/kriegcloud/beep-effect/4.2.1-client-runtime_

Relevant source files
*   [apps/web/src/app-config.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/apps/web/src/app-config.ts)
*   [apps/web/src/app/layout.tsx](https://github.com/kriegcloud/beep-effect/blob/b64126f6/apps/web/src/app/layout.tsx)
*   [apps/web/src/libs/tanstack-query/query-data-helpers.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/apps/web/src/libs/tanstack-query/query-data-helpers.ts)
*   [docker-compose.yml](https://github.com/kriegcloud/beep-effect/blob/b64126f6/docker-compose.yml)
*   [packages/common/constants/src/paths/asset-paths.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/constants/src/paths/asset-paths.ts)
*   [packages/common/constants/src/paths/generated/asset-paths.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/constants/src/paths/generated/asset-paths.ts)
*   [packages/iam/infra/src/adapters/better-auth/Auth.service.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts)
*   [packages/iam/sdk/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/package.json)
*   [packages/iam/sdk/src/clients/sign-in/sign-in.client.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/src/clients/sign-in/sign-in.client.ts)
*   [packages/iam/sdk/src/index.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/src/index.ts)
*   [packages/iam/ui/src/sign-up/sign-up.view.tsx](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/src/sign-up/sign-up.view.tsx)
*   [packages/runtime/client/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/package.json)
*   [packages/runtime/client/src/services/runtime/live-layer.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts)
*   [packages/runtime/server/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/package.json)
*   [packages/runtime/server/src/server-runtime.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts)

Purpose and Scope
-----------------

The Client Runtime provides the foundational service layer for browser-based applications in the beep-effect monorepo. It assembles and manages all Effect services required by the client, including HTTP communication, observability, network monitoring, and TanStack Query integration. This document covers the client-side runtime configuration and service composition. For server-side runtime infrastructure, see [Server Runtime](https://deepwiki.com/kriegcloud/beep-effect/4.2.2-server-runtime).

**Sources:**[packages/runtime/client/src/services/runtime/live-layer.ts 1-146](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts#L1-L146)

* * *

Architecture Overview
---------------------

The client runtime uses Effect's Layer system to compose services hierarchically. Each service is provided as a Layer, which can declare dependencies on other layers. The runtime assembles these layers into a complete execution environment that is consumed by React components.

**Sources:**[packages/runtime/client/src/services/runtime/live-layer.ts 23-96](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts#L23-L96)

* * *

Service Layers
--------------

### Observability Layer

The observability layer configures telemetry export, logging, and developer tooling based on the runtime environment.

#### TelemetryLive

`TelemetryLive` configures the WebSdk from `@effect/opentelemetry` to export traces and logs to an OTLP collector via HTTP.

| Configuration | Source | Description |
| --- | --- | --- |
| `serviceName` | `clientEnv.appName` | Service identifier in telemetry data |
| `spanProcessor` | `BatchSpanProcessor` | Batches spans before export |
| `logRecordProcessor` | `BatchLogRecordProcessor` | Batches logs before export |
| `url` (traces) | `clientEnv.otlpTraceExportedUrl` | OTLP trace endpoint |
| `url` (logs) | `clientEnv.otlpLogExportedUrl` | OTLP log endpoint |

**Sources:**[packages/runtime/client/src/services/runtime/live-layer.ts 36-43](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts#L36-L43)

#### LoggerLive

`LoggerLive` provides environment-appropriate logging formatters:

*   **Development**: `Logger.pretty` - colorized console output
*   **Production**: `Logger.json` - structured JSON logs

**Sources:**[packages/runtime/client/src/services/runtime/live-layer.ts 45-46](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts#L45-L46)

#### LogLevelLive

`LogLevelLive` sets the minimum log level based on environment:

*   **Development**: `LogLevel.Debug`
*   **Production**: `LogLevel.Info`

**Sources:**[packages/runtime/client/src/services/runtime/live-layer.ts 48-49](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts#L48-L49)

#### DevToolsLive

`DevToolsLive` conditionally enables Effect DevTools via WebSocket in development. The layer is `Layer.empty` in production to avoid overhead.

**Sources:**[packages/runtime/client/src/services/runtime/live-layer.ts 51-54](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts#L51-L54)

#### ObservabilityLive

`ObservabilityLive` merges all observability layers into a single layer:

**Sources:**[packages/runtime/client/src/services/runtime/live-layer.ts 56-57](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts#L56-L57)

* * *

### Infrastructure Layer

The infrastructure layer provides HTTP communication, network monitoring, worker transport, and query client integration.

#### HttpClientLive

`HttpClientLive` provides the `FetchHttpClient` implementation from `@effect/platform`, which wraps the browser's native `fetch` API with Effect types.

**Sources:**[packages/runtime/client/src/services/runtime/live-layer.ts 63-64](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts#L63-L64)

#### NetworkMonitorLive

`NetworkMonitorLive` provides the `NetworkMonitor` service, which observes browser connectivity changes through the `navigator.onLine` property and `online`/`offline` events.

**Sources:**[packages/runtime/client/src/services/runtime/live-layer.ts 66-67](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts#L66-L67)

#### WorkerClientLive

`WorkerClientLive` provides access to the worker transport used by the runtime for background task processing.

**Sources:**[packages/runtime/client/src/services/runtime/live-layer.ts 69-70](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts#L69-L70)

#### QueryClientLive

`makeQueryClientLayer` converts a TanStack `QueryClient` instance into an Effect Layer, bridging Effect-based code with React Query functionality.

**Sources:**[packages/runtime/client/src/services/runtime/live-layer.ts 72-73](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts#L72-L73)

* * *

Runtime Composition
-------------------

### createClientRuntimeLayer

`createClientRuntimeLayer` is the main factory function that assembles all client runtime services into a single layer. It accepts a `QueryClient` instance and returns a `ClientRuntimeLayer` providing all required services.

**Type Signature:**

**Sources:**[packages/runtime/client/src/services/runtime/live-layer.ts 79-96](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts#L79-L96)

* * *

Runtime Execution
-----------------

The runtime provides helper functions for executing Effect programs within the configured runtime environment. All helpers automatically wrap effects in telemetry spans.

### runClientPromise

Executes an Effect within the client runtime and returns a Promise. The effect is automatically wrapped in an observability span with a configurable name.

| Parameter | Type | Description |
| --- | --- | --- |
| `runtime` | `LiveManagedRuntime` | The managed runtime instance |
| `effect` | `Effect.Effect<A, E, ClientRuntimeEnv>` | The effect to execute |
| `spanName` | `string` | Name for the telemetry span (default: `"clientRuntime.runPromise"`) |
| `options` | `RunPromiseOptions` | Optional runtime options |

**Sources:**[packages/runtime/client/src/services/runtime/live-layer.ts 114-119](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts#L114-L119)

### makeRunClientPromise

Returns a bound helper function for repeated invocations with the same runtime and span configuration.

**Usage Example:**

**Sources:**[packages/runtime/client/src/services/runtime/live-layer.ts 124-127](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts#L124-L127)[packages/iam/ui/src/sign-up/sign-up.view.tsx 28-30](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/src/sign-up/sign-up.view.tsx#L28-L30)

### runClientPromiseExit

Executes an Effect within the client runtime and returns an `Exit` value, which contains either success or failure information without throwing.

**Sources:**[packages/runtime/client/src/services/runtime/live-layer.ts 132-137](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts#L132-L137)

### makeRunClientPromiseExit

Returns a bound helper function that captures `Exit` values from effects run in the client runtime.

**Sources:**[packages/runtime/client/src/services/runtime/live-layer.ts 142-145](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts#L142-L145)

* * *

Usage Patterns
--------------

### React Component Integration

The client runtime is typically accessed in React components via a `useRuntime()` hook and consumed with `makeRunClientPromise` or `runClientPromise`.

**Real-World Example:**

In the sign-up view, the runtime is used to execute authentication effects:

**Sources:**[packages/iam/ui/src/sign-up/sign-up.view.tsx 28-119](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/src/sign-up/sign-up.view.tsx#L28-L119)

### Query Client Integration

The runtime integrates TanStack Query with Effect through the `RuntimeQueryClient` service, enabling query data manipulation from Effect programs.

**Example: Query Data Helpers**

**Sources:**[apps/web/src/libs/tanstack-query/query-data-helpers.ts 91-158](https://github.com/kriegcloud/beep-effect/blob/b64126f6/apps/web/src/libs/tanstack-query/query-data-helpers.ts#L91-L158)

* * *

Environment Configuration
-------------------------

The client runtime behavior is controlled by environment variables accessed through `clientEnv` from `@beep/core-env/client`.

| Variable | Purpose | Values | Default |
| --- | --- | --- | --- |
| `clientEnv.env` | Environment mode | `"dev"` | `"prod"` | - |
| `clientEnv.appName` | Service name for telemetry | string | - |
| `clientEnv.otlpTraceExportedUrl` | OTLP trace endpoint URL | URL string | - |
| `clientEnv.otlpLogExportedUrl` | OTLP log endpoint URL | URL string | - |
| `clientEnv.captchaSiteKey` | ReCAPTCHA site key | Redacted string | - |

**Environment-Dependent Behavior:**

**Sources:**[packages/runtime/client/src/services/runtime/live-layer.ts 27-54](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts#L27-L54)[packages/iam/ui/src/sign-up/sign-up.view.tsx 43](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/src/sign-up/sign-up.view.tsx#L43-L43)

* * *

Type Definitions
----------------

### LiveManagedRuntime

A managed runtime instance that automatically handles resource lifecycle.

**Sources:**[packages/runtime/client/src/services/runtime/live-layer.ts 104](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts#L104-L104)

### LiveRuntimeContext

The context type provided by the managed runtime, containing all services.

**Sources:**[packages/runtime/client/src/services/runtime/live-layer.ts 105](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts#L105-L105)

### ClientRuntimeEnv

The environment type representing all services available in the client runtime.

This type includes:

*   `HttpClient` - for HTTP requests
*   `NetworkMonitor` - for connectivity status
*   `WorkerClient` - for worker communication
*   `RuntimeQueryClient` - for TanStack Query integration

**Sources:**[packages/runtime/client/src/services/runtime/live-layer.ts 107](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts#L107-L107)
