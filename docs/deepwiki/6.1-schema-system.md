# Schema System | kriegcloud/beep-effect | DeepWiki

_Source: https://deepwiki.com/kriegcloud/beep-effect/6.1-schema-system_

Relevant source files
*   [packages/common/errors/src/errors.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/errors/src/errors.ts)
*   [packages/common/schema/src/EntityId.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/EntityId.ts)
*   [packages/common/schema/src/custom/Bool.schema.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/custom/Bool.schema.ts)
*   [packages/common/schema/src/custom/UUID.schema.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/custom/UUID.schema.ts)
*   [packages/common/schema/src/custom/dates/Month.schema.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/custom/dates/Month.schema.ts)
*   [packages/common/schema/src/utils/mergeFields.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/utils/mergeFields.ts)
*   [packages/iam/domain/src/IamError.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/domain/src/IamError.ts)
*   [packages/iam/domain/src/index.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/domain/src/index.ts)
*   [packages/shared/domain/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/package.json)
*   [packages/shared/domain/src/execute.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/execute.ts)
*   [packages/shared/domain/tsconfig.build.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/tsconfig.build.json)
*   [packages/shared/domain/tsconfig.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/tsconfig.json)
*   [packages/shared/domain/tsconfig.src.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/tsconfig.src.json)
*   [packages/shared/domain/tsconfig.test.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/tsconfig.test.json)

The Schema System provides a type-safe, Effect Schema-based foundation for defining, validating, and transforming data structures throughout the beep-effect codebase. This system establishes consistent patterns for entity identification, custom type definitions, error handling, and schema composition that are used across all domain contexts and applications.

For database-specific schema definitions using Drizzle ORM, see [IAM Database Schema](https://deepwiki.com/kriegcloud/beep-effect/5.1.2-iam-database-schema) and [Files Context](https://deepwiki.com/kriegcloud/beep-effect/5.2-files-context). For the rules engine schema system, see [Logos Rules Engine](https://deepwiki.com/kriegcloud/beep-effect/6.3-logos-rules-engine).

Purpose and Scope
-----------------

The Schema System serves as the central type system infrastructure, providing:

*   **Type-safe entity identification** through the EntityId pattern with dual-identifier support
*   **Custom schema types** for common data patterns (UUIDs, dates, booleans)
*   **Validation and transformation** pipelines using Effect Schema
*   **Metadata and annotations** for documentation, JSON Schema generation, and arbitrary value generation
*   **Error schemas** with HTTP status code annotations and tagged error types
*   **Schema composition utilities** for merging and extending schemas

This system is located in `packages/common/schema` and is consumed by all domain contexts (IAM, Files, Shared) and infrastructure layers.

Effect Schema Integration
-------------------------

The Schema System is built on `effect/Schema`, which provides runtime type validation, transformation, and metadata capabilities. All schemas in the codebase extend Effect Schema's base classes and utilities.

**Sources:**[packages/common/schema/src/EntityId.ts 1-166](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/EntityId.ts#L1-L166) High-Level Architecture Diagram 1

EntityId Pattern
----------------

The EntityId pattern provides a standardized approach to entity identification using a dual-identifier system that combines public UUID-based IDs with private integer row IDs. This pattern is detailed in [EntityId Pattern](https://deepwiki.com/kriegcloud/beep-effect/6.1.1-entityid-pattern).

### Factory Pattern

The `EntityId.make` factory function creates type-safe, branded entity identifiers with integrated Drizzle ORM column definitions:

| Component | Type | Purpose |
| --- | --- | --- |
| `Factory` | `Data.TaggedClass` | Configuration container for table name and brand |
| `SchemaType` | `S.TemplateLiteral` | Type-safe template literal schema |
| `PublicId` | Drizzle column | UUID-based public identifier |
| `PrivateId` | Drizzle column | Integer-based private row identifier |

**Sources:**[packages/common/schema/src/EntityId.ts 16-162](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/EntityId.ts#L16-L162)

### EntityId Schema Instance

Each EntityId instance created by `EntityId.make` includes both schema definitions and utility methods:

**Sources:**[packages/common/schema/src/EntityId.ts 67-162](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/EntityId.ts#L67-L162)

Custom Schema Types
-------------------

The Schema System provides several custom schema types that extend Effect Schema with domain-specific validation and transformation logic. These are detailed in [Custom Schema Types](https://deepwiki.com/kriegcloud/beep-effect/6.1.2-custom-schema-types).

### UUID Schemas

UUID schemas provide type-safe UUID handling with template literal validation:

| Schema | Purpose | Example Type |
| --- | --- | --- |
| `UUIDLiteralEncoded` | Template literal UUID format | ``${string}-${string}-${string}-${string}-${string}`` |
| `UUIDLiteral` | Validated UUID with transformation | `string` (validated UUID) |
| `BrandedUUID` | Branded UUID with custom brand | `UUID & Brand<T>` |

The `UUIDLiteralEncoded` class includes a `make()` static method for generating new UUIDs:

**Sources:**[packages/common/schema/src/custom/UUID.schema.ts 1-49](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/custom/UUID.schema.ts#L1-L49)

### Month Schemas

Month schemas provide multiple representations of month values with bidirectional transformations:

Each month schema is built using `stringLiteralKit`, which provides:

*   `Enum` object with all month values
*   `Options` array for UI selection
*   Validation with exhaustive pattern matching

**Sources:**[packages/common/schema/src/custom/dates/Month.schema.ts 1-134](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/custom/dates/Month.schema.ts#L1-L134)

### Boolean Schemas

Boolean schemas provide optional boolean properties with default values:

| Schema | Default | Type Signature |
| --- | --- | --- |
| `BoolWithDefault(value)` | `value` | `PropertySignature<":", boolean, never, "?:", boolean | undefined, true, never>` |
| `BoolTrue` | `true` | Same as above |
| `BoolFalse` | `false` | Same as above |

These schemas use `toOptionalWithDefault` to create property signatures that accept undefined input and provide a default value during decoding.

**Sources:**[packages/common/schema/src/custom/Bool.schema.ts 1-38](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/custom/Bool.schema.ts#L1-L38)

Error Schemas
-------------

The Schema System defines a comprehensive error hierarchy using Effect Schema's `TaggedError` pattern. Error schemas are detailed in [Error Schemas](https://deepwiki.com/kriegcloud/beep-effect/6.1.3-error-schemas).

### Tagged Error Pattern

All error schemas extend `S.TaggedError` and include HTTP status code annotations via `HttpApiSchema.annotations`:

Each error class includes:

*   A unique `_tag` field for discriminated union matching
*   Field schemas defining error properties
*   HTTP status code annotation for API responses
*   Namespace with `Type` and `Encoded` type exports

**Sources:**[packages/common/errors/src/errors.ts 1-130](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/errors/src/errors.ts#L1-L130)

### Error Schema Structure

Example error schema definition pattern:

```
class NotFoundError extends S.TaggedError<NotFoundError>()(
  "NotFoundError",                              // Tag for discriminated unions
  { id: S.String, resource: S.String },        // Field schemas
  HttpApiSchema.annotations({ status: 404 })   // HTTP metadata
) {}
```

The namespace pattern provides type extraction:

```
namespace NotFoundError {
  export type Type = S.Schema.Type<typeof NotFoundError>;      // Decoded type
  export type Encoded = S.Schema.Encoded<typeof NotFoundError>; // Encoded type
}
```

**Sources:**[packages/common/errors/src/errors.ts 23-32](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/errors/src/errors.ts#L23-L32)

Schema Annotations
------------------

Schema annotations provide metadata for documentation, code generation, and runtime behavior. All schemas support the Effect Schema annotation system.

### Standard Annotations

| Annotation | Purpose | Example |
| --- | --- | --- |
| `schemaId` | Unique symbol identifier | `Symbol.for("@beep/schema/custom/UUID")` |
| `identifier` | String name for the schema | `"UUIDLiteralEncoded"` |
| `title` | Human-readable title | `"UUID Literal Encoded"` |
| `description` | Documentation string | `"UUID Literal Encoded"` |
| `jsonSchema` | JSON Schema metadata | `{ type: "string", format: "uuid" }` |
| `arbitrary` | Fast-check arbitrary generator | `() => (fc) => fc.uuid()` |
| `pretty` | Pretty-print function | `() => (i) =>`UUID(${i})`` |

### Custom Annotations

The `DefaultAnnotations` type (referenced in EntityId) extends standard annotations with domain-specific metadata. EntityId schemas include:

*   `identifier`: Generated from brand name
*   `title`: Generated from table name
*   `jsonSchema.format`: Custom format string combining table name and UUID
*   `arbitrary`: Generates valid entity IDs for property-based testing
*   `pretty`: Branded pretty-printing for debugging

**Sources:**[packages/common/schema/src/EntityId.ts 28-49](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/EntityId.ts#L28-L49)

Schema Composition
------------------

### Field Merging

The `mergeFields` utility enables schema composition by combining `Struct.Fields`:

The function supports both curried and direct invocation:

*   `mergeFields(a, b)`: Direct merge with right-bias
*   `mergeFields(a)(b)`: Curried for composition

Right-bias means that field `b` overwrites field `a` on key conflicts. The implementation uses `mutative` for immutable updates.

**Sources:**[packages/common/schema/src/utils/mergeFields.ts 1-25](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/utils/mergeFields.ts#L1-L25)

Integration Points
------------------

### Database Layer Integration

EntityId schemas integrate with the database layer through:

1.   **Drizzle Column Definitions**: `publicId()` and `privateId()` methods return configured Drizzle columns
2.   **Model Schemas**: `modelIdSchema` and `modelRowIdSchema` work with `@effect/sql/Model`
3.   **Type Safety**: Branded types ensure EntityIds cannot be confused across different entities

**Sources:**[packages/common/schema/src/EntityId.ts 122-129](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/EntityId.ts#L122-L129)

### Domain Layer Integration

Domain entities use schemas for:

*   **Entity Identity**: EntityId instances define unique identifiers
*   **Value Objects**: Custom schemas validate domain-specific values
*   **Domain Errors**: Tagged error schemas represent domain failures

The `@beep/shared-domain`, `@beep/iam-domain`, and `@beep/files-domain` packages all depend on `@beep/schema` for their type definitions.

**Sources:**[packages/shared/domain/package.json 36-48](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/package.json#L36-L48)[packages/iam/domain/src/IamError.ts 1-6](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/domain/src/IamError.ts#L1-L6)

### API Layer Integration

Error schemas with HTTP status annotations integrate with the API layer through:

*   `HttpApiSchema.annotations({ status: number })`: Maps errors to HTTP status codes
*   Tagged error pattern: Enables discriminated union handling in API endpoints
*   Type/Encoded exports: Support serialization for API responses

**Sources:**[packages/common/errors/src/errors.ts 11-120](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/errors/src/errors.ts#L11-L120)

Schema Validation Pipeline
--------------------------

The validation pipeline processes data through multiple stages:

1.   **Structural Validation**: Checks if input matches schema structure
2.   **Transformation**: Applies `decode` functions for schema transformations
3.   **Branding**: Applies branded types for nominal typing
4.   **Filters**: Runs refinement predicates (e.g., `NonNegativeInt`)

Validation failures produce `ParseResult` errors containing:

*   Structural path to the error
*   Expected vs. actual type information
*   Custom error messages from transformations

**Sources:**[packages/common/schema/src/custom/UUID.schema.ts 31-43](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/custom/UUID.schema.ts#L31-L43)[packages/common/schema/src/custom/dates/Month.schema.ts 67-80](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/custom/dates/Month.schema.ts#L67-L80)

Schema Variance and Type Identity
---------------------------------

The Schema System uses Effect's variance markers and type identities to ensure correct type inference:

```
const variance = /* internal variance marker */;

class WithStatics extends schema {
  [TypeId] = variance;           // Instance-level type identity
  static [TypeId] = variance;    // Static-level type identity
}
```

This pattern ensures:

*   Schemas are recognized as proper Effect Schema instances
*   Type inference works correctly in generic contexts
*   Schema composition maintains type safety

**Sources:**[packages/common/schema/src/EntityId.ts 131-133](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/EntityId.ts#L131-L133)
