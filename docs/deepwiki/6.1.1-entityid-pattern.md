# EntityId Pattern | kriegcloud/beep-effect | DeepWiki

_Source: https://deepwiki.com/kriegcloud/beep-effect/6.1.1-entityid-pattern_

Relevant source files
*   [apps/web/src/app/api/auth/[...all]/route.ts](https://deepwiki.com/kriegcloud/beep-effect/apps/web/src/app/api/auth/%5B...all%5D/route.ts)
*   [packages/_internal/db-admin/src/Db.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/src/Db.ts)
*   [packages/_internal/db-admin/test/pg-container.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts)
*   [packages/_internal/db-admin/tsconfig.test.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/tsconfig.test.json)
*   [packages/common/schema/src/EntityId.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/EntityId.ts)
*   [packages/core/db/src/index.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/index.ts)
*   [packages/core/db/src/types.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/types.ts)
*   [packages/files/infra/src/adapters/repos/_common.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/infra/src/adapters/repos/_common.ts)
*   [packages/files/infra/src/db/Db.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/infra/src/db/Db.ts)
*   [packages/iam/infra/src/adapters/repos/_common.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/repos/_common.ts)
*   [packages/iam/infra/src/db/Db.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/db/Db.ts)
*   [packages/shared/domain/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/package.json)
*   [packages/shared/domain/src/execute.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/execute.ts)
*   [packages/shared/domain/tsconfig.build.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/tsconfig.build.json)
*   [packages/shared/domain/tsconfig.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/tsconfig.json)
*   [packages/shared/domain/tsconfig.src.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/tsconfig.src.json)
*   [packages/shared/domain/tsconfig.test.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/tsconfig.test.json)

Purpose and Scope
-----------------

This document explains the `EntityId` pattern, a factory-based system for creating type-safe, dual-identifier entity IDs throughout the beep-effect codebase. The pattern provides both public UUIDs for external use and private serial integers for internal database operations, integrated with Effect Schema validation and Drizzle ORM.

For database service creation using these entity IDs, see [Db.make Factory](https://deepwiki.com/kriegcloud/beep-effect/4.1.1-db.make-factory). For the broader schema system that EntityId builds upon, see [Schema System](https://deepwiki.com/kriegcloud/beep-effect/6.1-schema-system).

**Sources:**[packages/common/schema/src/EntityId.ts 1-163](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/EntityId.ts#L1-L163)

Dual-Identifier Architecture
----------------------------

The EntityId pattern implements a dual-identifier system where each entity has two distinct identifiers:

| Identifier Type | Purpose | Format | Visibility | Database Column |
| --- | --- | --- | --- | --- |
| **Public ID** | External API exposure | `{table_name}__{uuid}` | Public | `id` (text, unique) |
| **Private ID** | Internal database operations | Auto-incrementing integer | Internal | `_row_id` (serial, primary key) |

This separation allows the codebase to use efficient integer-based joins and foreign keys internally while exposing opaque, non-sequential UUIDs externally for security and API stability.

**Sources:**[packages/common/schema/src/EntityId.ts 16-90](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/EntityId.ts#L16-L90)

The EntityId.make Factory
-------------------------

The `EntityId.make()` function creates a complete entity ID system from a table name and brand identifier. It returns an `EntityIdSchemaInstance` that extends Effect Schema while providing additional database and validation utilities.

### Factory Signature

```
EntityId.make<TableName, Brand>(
  tableName: SnakeTag.Literal<TableName>,
  options: {
    brand: Brand,
    annotations: DefaultAnnotations
  }
): EntityIdSchemaInstance<TableName, Brand>
```

The factory enforces snake_case table names at runtime and generates:

1.   **Schema**: Effect Schema with template literal validation
2.   **Public/Private ID Drizzle columns**: Ready-to-use column definitions
3.   **Type guards**: `is()` predicate and `make()` constructor
4.   **Model schemas**: For @effect/sql Model integration
5.   **Static metadata**: Column names, brands, table references

**Sources:**[packages/common/schema/src/EntityId.ts 91-162](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/EntityId.ts#L91-L162)

### Generated Public ID Column

The public ID column definition includes default value generation and type branding:

```
// Generated by EntityId.make
const publicId = pg.text("id")
  .notNull()
  .unique()
  .$type<typeof schema.Type>()
  .$defaultFn(() => create());
```

Format: `{tableName}__{uuid}`, e.g., `user__550e8400-e29b-41d4-a716-446655440000`

**Sources:**[packages/common/schema/src/EntityId.ts 122-127](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/EntityId.ts#L122-L127)

### Generated Private ID Column

The private ID uses PostgreSQL's serial type for auto-incrementing behavior:

```
// Generated by EntityId.make
const privateId = pg.serial("_row_id")
  .notNull()
  .primaryKey()
  .$type<B.Branded<number, Brand>>();
```

The branded number type ensures type safety across repository operations.

**Sources:**[packages/common/schema/src/EntityId.ts 129](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/EntityId.ts#L129-L129)

Schema Type Structure
---------------------

The EntityId schema extends Effect Schema's `TemplateLiteral` type with custom annotations and static utilities.

### Template Literal Validation

The schema validates that IDs match the pattern `{table_name}__{uuid}`:

```
S.TemplateLiteral(
  S.Literal(tableName),
  "__",
  UUIDLiteralEncoded
)
```

This provides compile-time and runtime validation of ID format correctness.

**Sources:**[packages/common/schema/src/EntityId.ts 42](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/EntityId.ts#L42-L42)

### Type Annotations

The factory applies several annotations for IDE support, JSON schema generation, and testing:

| Annotation | Purpose | Example Value |
| --- | --- | --- |
| `identifier` | Type name in generated code | `"UserId"` |
| `title` | Human-readable label | `"User Id"` |
| `jsonSchema` | OpenAPI/JSON Schema descriptor | `{type: "string", format: "user__uuid"}` |
| `arbitrary` | Fast-check generator | `() => fc => fc.constantFrom(null).map(() => create())` |
| `pretty` | Debug representation | `(i) => "User(user__abc-123)"` |

**Sources:**[packages/common/schema/src/EntityId.ts 42-49](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/EntityId.ts#L42-L49)

Integration with Domain Databases
---------------------------------

The EntityId pattern integrates with the database layer through the `Db.make` factory, which consumes entity ID schemas from table definitions.

**Sources:**[packages/iam/infra/src/db/Db.ts 1-22](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/db/Db.ts#L1-L22)[packages/files/infra/src/db/Db.ts 1-16](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/infra/src/db/Db.ts#L1-L16)

Type Safety Features
--------------------

The EntityId system leverages TypeScript's type system and Effect's branded types to prevent ID misuse.

### Branded Types

Both public and private IDs use branded types to prevent accidental mixing:

```
// Public ID: Template literal brand
type PublicUserId = `user__${string}-${string}-${string}-${string}-${string}`;

// Private ID: Numeric brand
type PrivateUserId = Brand.Branded<number, "User">;
```

These types ensure you cannot pass a `FileId` where a `UserId` is expected, even though both are ultimately strings (public) or numbers (private).

**Sources:**[packages/common/schema/src/EntityId.ts 53-65](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/EntityId.ts#L53-L65)

### Type Guards and Constructors

The generated schema includes runtime validation utilities:

| Function | Signature | Purpose |
| --- | --- | --- |
| `is(u: unknown)` | `(u: unknown) => u is Type<TableName>` | Runtime type predicate |
| `make(input: string)` | `(input: string) => Type<TableName>` | Validated constructor |
| `create()` | `() => Type<TableName>` | Generate new ID |

The `make()` function throws an invariant error if the input doesn't match the schema, making it safe to use for parsing untrusted input.

**Sources:**[packages/common/schema/src/EntityId.ts 137-157](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/EntityId.ts#L137-L157)

Model Integration
-----------------

EntityId provides specialized schemas for @effect/sql Model integration:

### modelIdSchema

Optional schema with automatic default generation for inserts:

```
S.optionalWith(schema, {
  exact: true,
  default: () => create()
})
```

This allows omitting the ID field when creating new entities, with automatic UUID generation.

**Sources:**[packages/common/schema/src/EntityId.ts 145-148](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/EntityId.ts#L145-L148)

### modelRowIdSchema

Generated schema for private IDs using `M.Generated`:

`M.Generated(S.NonNegativeInt.pipe(S.brand(brand)))`
This marks the field as auto-generated by the database, preventing manual assignment.

**Sources:**[packages/common/schema/src/EntityId.ts 109](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/EntityId.ts#L109-L109)

Column Name Conventions
-----------------------

The EntityId system standardizes column naming across SQL and JavaScript contexts:

| Context | Public ID Column | Private ID Column |
| --- | --- | --- |
| SQL (snake_case) | `id` | `_row_id` |
| JavaScript (camelCase) | `id` | `_rowId` |

Static properties expose these names for programmatic access:

```
EntityIdSchema.publicIdColumnNameSql;    // "id"
EntityIdSchema.publicIdColumnName;       // "id"
EntityIdSchema.privateIdColumnNameSql;   // "_row_id"
EntityIdSchema.privateIdColumnName;      // "_rowId"
```

**Sources:**[packages/common/schema/src/EntityId.ts 141-144](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/EntityId.ts#L141-L144)

Usage in Testing
----------------

The EntityId pattern integrates with the test infrastructure, particularly in PgContainer setup where entity IDs are used to seed test data:

Test data generation uses the `create()` method for deterministic ID generation while maintaining format compliance.

**Sources:**[packages/_internal/db-admin/test/pg-container.ts 222-235](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L222-L235)

Factory Class Implementation
----------------------------

The `EntityId.Factory` class encapsulates the configuration and schema generation logic:

```
class Factory<TableName, Brand> extends Data.TaggedClass("EntityId")<Config> {
  readonly Schema: (annotations) => SchemaType<TableName>;

  constructor(tableName, brand) {
    const create = () =>
      F.pipe(tableName, Str.concat("__"), Str.concat(UUIDLiteralEncoded.make()));

    this.Schema = (annotations) =>
      S.TemplateLiteral(S.Literal(tableName), "__", UUIDLiteralEncoded)
        .annotations({ ...annotations, /* ... */ });
  }
}
```

The Factory class is instantiated internally by `EntityId.make()` and used to generate the schema with proper annotations.

**Sources:**[packages/common/schema/src/EntityId.ts 30-51](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/EntityId.ts#L30-L51)

Invariant Validation
--------------------

The system uses the `@beep/invariant` package to enforce runtime constraints:

1.   **Table name validation**: Ensures snake_case format
2.   **ID format validation**: Ensures generated IDs match the template

```
invariant(S.is(SnakeTag)(tableName),
  "TableName must be a lowercase snake case string",
  { file: "./packages/common/schema/EntityId.ts", line: 91, args: [tableName] }
);
```

These invariants catch configuration errors early during service initialization.

**Sources:**[packages/common/schema/src/EntityId.ts 101-105](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/EntityId.ts#L101-L105)[packages/common/schema/src/EntityId.ts 151-155](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/EntityId.ts#L151-L155)

Static Type Utilities
---------------------

The `EntityId` namespace exports utility types for working with entity IDs:

```
namespace EntityId {
  type SchemaType<TableName>
  type Type<TableName>        // Resolved type after validation
  type Encoded<TableName>     // Encoded form (same as Type for strings)
  type PublicId<TableName, Brand>   // Drizzle column type
  type PrivateId<Brand>             // Drizzle column type
  type EntityIdSchemaInstance<...>  // Full schema with utilities
}
```

These types enable type-safe references to entity IDs throughout the application without importing concrete instances.

**Sources:**[packages/common/schema/src/EntityId.ts 16-89](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/EntityId.ts#L16-L89)
