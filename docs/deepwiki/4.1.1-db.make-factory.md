# Db.make Factory | kriegcloud/beep-effect | DeepWiki

_Source: https://deepwiki.com/kriegcloud/beep-effect/4.1.1-db.make-factory_

Relevant source files
*   [.github/workflows/check.yml](https://github.com/kriegcloud/beep-effect/blob/b64126f6/.github/workflows/check.yml)
*   [apps/web/src/app/api/auth/[...all]/route.ts](https://deepwiki.com/kriegcloud/beep-effect/apps/web/src/app/api/auth/%5B...all%5D/route.ts)
*   [packages/_internal/db-admin/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/package.json)
*   [packages/_internal/db-admin/src/Db.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/src/Db.ts)
*   [packages/_internal/db-admin/src/execute.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/src/execute.ts)
*   [packages/_internal/db-admin/test/pg-container.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts)
*   [packages/_internal/db-admin/tsconfig.test.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/tsconfig.test.json)
*   [packages/common/errors/src/shared.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/errors/src/shared.ts)
*   [packages/core/db/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/package.json)
*   [packages/core/db/src/db.factory.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts)
*   [packages/core/db/src/errors.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/errors.ts)
*   [packages/core/db/src/index.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/index.ts)
*   [packages/core/db/src/postgres/common.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/postgres/common.ts)
*   [packages/core/db/src/postgres/postgres-error.enum.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/postgres/postgres-error.enum.ts)
*   [packages/core/db/src/types.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/types.ts)
*   [packages/files/infra/src/adapters/repos/_common.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/infra/src/adapters/repos/_common.ts)
*   [packages/files/infra/src/db/Db.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/infra/src/db/Db.ts)
*   [packages/iam/infra/src/adapters/repos/_common.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/repos/_common.ts)
*   [packages/iam/infra/src/db/Db.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/db/Db.ts)

Purpose and Scope
-----------------

The `Db.make` factory is a generic database service factory that transforms Drizzle ORM schemas into type-safe Effect services. It provides a standardized interface for database operations across all domain contexts in the application, including query execution, transaction management, and automatic transaction context detection.

For information about database error handling and PostgreSQL error codes, see [Database Error Handling](https://deepwiki.com/kriegcloud/beep-effect/4.1.2-database-error-handling). For testing infrastructure using Docker containers, see [Testing with PgContainer](https://deepwiki.com/kriegcloud/beep-effect/4.1.3-testing-with-pgcontainer).

**Sources:**[packages/core/db/src/db.factory.ts 30-186](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts#L30-L186)[packages/core/db/src/types.ts 1-37](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/types.ts#L1-L37)

* * *

Factory Function Signature
--------------------------

The `Db.make` factory accepts a Drizzle schema and returns a service effect along with a transaction context tag. This factory is the central mechanism for creating domain-specific database services throughout the application.

The factory signature:

| Component | Type | Purpose |
| --- | --- | --- |
| Input: `schema` | `TFullSchema extends Record<string, unknown>` | Drizzle table definitions for a domain |
| Output: `serviceEffect` | `Effect<Db<TFullSchema>, SqlError | ConfigError, SqlClient>` | Effect that produces the database service |
| Output: `TransactionContext` | `Context.Tag<TransactionContextShape<TFullSchema>>` | Context tag for tracking active transactions |

**Sources:**[packages/core/db/src/db.factory.ts 81-89](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts#L81-L89)[packages/core/db/src/types.ts 8-37](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/types.ts#L8-L37)

* * *

Domain Service Pattern
----------------------

Each domain context uses `Db.make` to create its own scoped database service. The pattern involves calling the factory with a domain-specific schema and wrapping the result in an Effect service class.

### IAM Domain Example

The IAM domain creates its database service by passing the IAM schema to `Db.make` and wrapping it in an Effect service:

```
// Simplified from packages/iam/infra/src/db/Db.ts:8-21
export namespace IamDb {
  const factory = Db.make<typeof IamDbSchema>(IamDbSchema);

  export class IamDb extends Effect.Service<IamDb>()("@beep/iam-infra/IamDb", {
    effect: factory.serviceEffect,
    accessors: true,
  }) {
    static readonly Live = IamDb.Default;
  }

  export const TransactionContext = factory.TransactionContext;
}
```

**Sources:**[packages/iam/infra/src/db/Db.ts 1-22](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/db/Db.ts#L1-L22)[packages/files/infra/src/db/Db.ts 1-16](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/infra/src/db/Db.ts#L1-L16)[packages/_internal/db-admin/src/Db.ts 1-21](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/src/Db.ts#L1-L21)

* * *

Service Components
------------------

The `Db.make` factory returns a service effect that provides five key components for database operations. Each component serves a specific purpose in the database access layer.

### Component Overview

| Component | Type | Description |
| --- | --- | --- |
| `db` | `PgDrizzle.make<TFullSchema>` | Effect SQL client for functional query building |
| `drizzle` | `PostgresJsDatabase<TFullSchema>` | Direct Drizzle ORM instance for schema-aware queries |
| `execute` | `ExecuteFn<TFullSchema>` | Wrapper for executing database operations with error handling |
| `transaction` | `Transaction<TFullSchema>` | Transaction management with Effect runtime integration |
| `makeQuery` | `MakeQuery<TFullSchema>` | Query builder with automatic transaction context detection |

**Sources:**[packages/core/db/src/db.factory.ts 68-74](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts#L68-L74)[packages/core/db/src/db.factory.ts 91-179](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts#L91-L179)

* * *

ExecuteFn: Query Execution
--------------------------

The `execute` function wraps database operations in Effect error handling, automatically converting Drizzle and PostgreSQL errors into typed `DbError` instances.

### Implementation Details

The `execute` function uses `Effect.tryPromise` to convert promise-based Drizzle operations into Effect workflows:

*   **Input**: A function that takes a `DbClient<TFullSchema>` and returns a `Promise<T>`
*   **Output**: An `Effect<T, DbError>` that either succeeds with the query result or fails with a typed database error
*   **Error Handling**: Catches all errors, attempts to match them to `DbError` types, and re-throws if no match is found

The function is created as an `Effect.fn` to enable proper tracing and debugging in Effect workflows.

**Sources:**[packages/core/db/src/db.factory.ts 99-110](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts#L99-L110)[packages/core/db/src/types.ts 26-28](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/types.ts#L26-L28)

* * *

Transaction Management
----------------------

The `transaction` function manages database transactions by bridging Drizzle's callback-based transaction API with Effect's runtime and error handling model.

### Transaction Context Pattern

The transaction system uses an Effect Context to track whether code is executing within a transaction:

1.   **TransactionContext Tag**: Created by `Db.make` for each schema, this context tag stores a reference to the active transaction wrapper
2.   **Transaction Wrapper**: A function that wraps query operations to use the transaction client instead of the main database client
3.   **Automatic Detection**: Queries built with `makeQuery` automatically detect and use the transaction context when available

| Step | Action | Purpose |
| --- | --- | --- |
| 1. Capture Runtime | `Effect.runtime<R>()` | Get the current Effect runtime for executing effects within the transaction |
| 2. Create Async Effect | `Effect.async((resume) => ...)` | Bridge callback-based transaction API to Effect |
| 3. Start Transaction | `drizzle.transaction(async (tx) => ...)` | Begin Drizzle transaction with isolated client |
| 4. Create Wrapper | `txWrapper: (fn) => Effect.tryPromise(...)` | Wrap transaction client for type-safe operations |
| 5. Provide Context | `Effect.provideService(TransactionContext, txWrapper)` | Make transaction available to nested queries |
| 6. Execute Logic | `await runPromiseExit(provided)` | Run the user's transaction logic |
| 7. Match Result | `Exit.match(result, { onSuccess, onFailure })` | Resume with appropriate Effect based on outcome |

**Sources:**[packages/core/db/src/db.factory.ts 116-161](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts#L116-L161)[packages/core/db/src/types.ts 22-32](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/types.ts#L22-L32)

* * *

MakeQuery: Context-Aware Queries
--------------------------------

The `makeQuery` utility creates query functions that automatically use the transaction context when executing within a transaction, or fall back to the standard execution context otherwise.

### Type Signature and Behavior

The `makeQuery` function has a sophisticated type signature that handles optional input parameters:

```
type MakeQuery<TFullSchema> = <A, E, R, Input = never>(
  queryFn: (execute: ExecuteFn<TFullSchema>, input: Input) => Effect.Effect<A, E, R>
) => (...args: [Input] extends [never] ? [] : [input: Input]) => Effect.Effect<A, E, R>
```

This signature ensures:

*   If `Input = never`, the resulting function takes no arguments
*   Otherwise, the function requires a single input parameter
*   The query function receives the appropriate `execute` function (transaction or standard) automatically

### Example Usage

```
// In a repository layer
const findUserById = iamDb.makeQuery(
  (execute, userId: string) =>
    execute((db) => db.select().from(user).where(eq(user.id, userId)))
);

// Usage outside transaction - uses standard execute
const user1 = await Effect.runPromise(findUserById("user-123"));

// Usage inside transaction - automatically uses transaction execute
const result = await Effect.runPromise(
  iamDb.transaction((tx) =>
    Effect.gen(function* () {
      const user = yield* findUserById("user-123");  // Uses tx automatically
      // ... more operations
      return user;
    })
  )
);
```

**Sources:**[packages/core/db/src/db.factory.ts 162-170](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts#L162-L170)[packages/core/db/src/types.ts 34-36](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/types.ts#L34-L36)

* * *

Database Layer Configuration
----------------------------

The `Db` namespace provides static configuration and layer construction utilities for establishing database connections with standard settings.

### Configuration Options

The factory provides default configuration for PostgreSQL client connections:

| Setting | Value | Purpose |
| --- | --- | --- |
| `transformQueryNames` | `Str.camelToSnake` | Convert JavaScript camelCase to SQL snake_case for queries |
| `transformResultNames` | `Str.snakeToCamel` | Convert SQL snake_case to JavaScript camelCase for results |

### Connection Layer Construction

Two layer construction methods are available:

1.   **`Db.layer(config)`**: Creates a PgClient layer from explicit connection options

    *   Takes a `ConnectionOptions` object with `url` and `ssl` properties
    *   Returns a basic `PgClient.layer` without retry logic

2.   **`Db.Live`**: Creates a production-ready layer with retry capabilities

    *   Reads connection config from environment variables (`DB_PG_URL`, `DB_PG_SSL`)
    *   Implements exponential backoff retry strategy for connection failures
    *   Retries up to 3 times with 1-second base delay
    *   Logs retry attempts with duration information

**Sources:**[packages/core/db/src/db.factory.ts 30-66](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts#L30-L66)[packages/core/db/src/db.factory.ts 44-66](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts#L44-L66)

* * *

Dual Database Client Architecture
---------------------------------

The service provides two parallel database clients: the Effect SQL client (`db`) and the direct Drizzle client (`drizzle`). This dual-client approach balances functional programming patterns with pragmatic database access.

### Client Usage Patterns

| Client | Use Case | Access Pattern |
| --- | --- | --- |
| `db` (Effect SQL) | Functional query composition, complex Effect pipelines | Via Effect operators, used with `@effect/sql` utilities |
| `drizzle` (Drizzle ORM) | Standard CRUD operations, schema-aware queries | Via `execute` and `transaction` wrappers |

The `execute` and `transaction` functions primarily use the `drizzle` client, wrapping its operations in Effect error handling. The Effect SQL client (`db`) is available for direct use when deeper Effect integration is needed.

**Sources:**[packages/core/db/src/db.factory.ts 91-98](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts#L91-L98)[packages/core/db/src/db.factory.ts 172-178](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts#L172-L178)

* * *

Error Handling Integration
--------------------------

All database operations produced by `Db.make` integrate with the centralized error handling system. The factory automatically converts PostgreSQL errors, Drizzle query errors, and SQL errors into typed `DbError` instances.

### Error Matching Process

The `DbError.match` function (referenced in the factory) performs a multi-step extraction process:

1.   Checks if the error is already a `DbError` instance
2.   Attempts to extract `DrizzleQueryError` from the cause chain
3.   Extracts nested `PostgresError` through JSON round-tripping (due to non-enumerable symbols)
4.   Maps PostgreSQL error codes to typed error categories (e.g., `UNIQUE_VIOLATION`, `FOREIGN_KEY_VIOLATION`)
5.   Returns a typed `DbError` with the original PostgreSQL error as the cause

This error handling pattern is applied in both `execute` and `transaction` functions, ensuring consistent error reporting across all database operations.

**Sources:**[packages/core/db/src/db.factory.ts 102-108](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts#L102-L108)[packages/core/db/src/db.factory.ts 128-135](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts#L128-L135)[packages/core/db/src/errors.ts 151-205](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/errors.ts#L151-L205)

* * *

Transaction Context Propagation
-------------------------------

The `TransactionContext` tag enables transparent transaction propagation through nested Effect calls without explicit parameter passing. This context-based approach allows repository functions to automatically participate in transactions.

### Context Lifecycle

| Phase | Action | Effect on Context |
| --- | --- | --- |
| **Outside Transaction** | `makeQuery` checks context | `serviceOption` returns `None`, uses standard `execute` |
| **Start Transaction** | `transaction(txExecute)` called | Creates `txWrapper` function |
| **Provide Context** | `Effect.provideService(TransactionContext, txWrapper)` | Context now contains transaction executor |
| **Execute Queries** | Nested `makeQuery` calls | `serviceOption` returns `Some(txWrapper)`, uses transaction client |
| **End Transaction** | Transaction completes | Context scope ends, future queries use standard execute |

This pattern eliminates the need for manual transaction client threading and ensures that all operations within a transaction block automatically use the same database transaction, maintaining ACID properties.

**Sources:**[packages/core/db/src/db.factory.ts 90](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts#L90-L90)[packages/core/db/src/db.factory.ts 138](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts#L138-L138)[packages/core/db/src/db.factory.ts 165-169](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts#L165-L169)
