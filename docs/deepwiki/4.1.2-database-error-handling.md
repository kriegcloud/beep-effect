# Database Error Handling | kriegcloud/beep-effect | DeepWiki

_Source: https://deepwiki.com/kriegcloud/beep-effect/4.1.2-database-error-handling_

Relevant source files
*   [.github/workflows/check.yml](https://github.com/kriegcloud/beep-effect/blob/b64126f6/.github/workflows/check.yml)
*   [packages/_internal/db-admin/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/package.json)
*   [packages/_internal/db-admin/src/execute.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/src/execute.ts)
*   [packages/common/errors/src/errors.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/errors/src/errors.ts)
*   [packages/common/errors/src/shared.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/errors/src/shared.ts)
*   [packages/common/schema/src/custom/Bool.schema.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/custom/Bool.schema.ts)
*   [packages/common/schema/src/custom/UUID.schema.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/custom/UUID.schema.ts)
*   [packages/common/schema/src/custom/dates/Month.schema.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/custom/dates/Month.schema.ts)
*   [packages/common/schema/src/utils/mergeFields.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/utils/mergeFields.ts)
*   [packages/core/db/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/package.json)
*   [packages/core/db/src/db.factory.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts)
*   [packages/core/db/src/errors.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/errors.ts)
*   [packages/core/db/src/postgres/common.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/postgres/common.ts)
*   [packages/core/db/src/postgres/postgres-error.enum.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/postgres/postgres-error.enum.ts)
*   [packages/iam/domain/src/IamError.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/domain/src/IamError.ts)
*   [packages/iam/domain/src/index.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/domain/src/index.ts)

Purpose and Scope
-----------------

This page documents the database error handling system in the beep-effect codebase, which provides type-safe extraction, classification, and propagation of PostgreSQL errors through the Effect layer system. The error handling architecture converts raw PostgreSQL errors into structured, tagged Effect errors with comprehensive error code enumeration.

For information about the database factory pattern that produces these errors, see [Db.make Factory](https://deepwiki.com/kriegcloud/beep-effect/4.1.1-db.make-factory). For testing error scenarios in isolation, see [Testing with PgContainer](https://deepwiki.com/kriegcloud/beep-effect/4.1.3-testing-with-pgcontainer).

Error Class Hierarchy
---------------------

The database error system uses a three-tier hierarchy to represent errors at different levels of abstraction:

**Sources:**[packages/core/db/src/errors.ts 151-212](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/errors.ts#L151-L212)[packages/core/db/src/db.factory.ts 99-110](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts#L99-L110)

### DbError Class

The `DbError` class is the primary error type exposed by the database layer. It extends `Data.TaggedError` and contains:

| Field | Type | Description |
| --- | --- | --- |
| `_tag` | `"DbError"` | Tagged union discriminator |
| `type` | `PostgresErrorType | "UNKNOWN"` | Semantic error classification |
| `cause` | `postgres.PostgresError` | Original PostgreSQL error |
| `message` | `string` | Formatted error message |

The class provides a static `match` method for converting various error shapes into `DbError` instances:

[packages/core/db/src/errors.ts 163-205](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/errors.ts#L163-L205)

**Sources:**[packages/core/db/src/errors.ts 151-212](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/errors.ts#L151-L212)

### PostgresError Structure

The underlying `postgres.PostgresError` contains detailed PostgreSQL diagnostic information:

| Field | Description |
| --- | --- |
| `severity` | Error severity level (ERROR, FATAL, PANIC) |
| `code` | PostgreSQL SQLSTATE code |
| `detail` | Additional error details |
| `hint` | Suggestion for resolving the error |
| `position` | Character position in query |
| `table_name` | Affected table name |
| `column_name` | Affected column name |
| `constraint_name` | Violated constraint name |

**Sources:**[packages/core/db/src/errors.ts 123-149](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/errors.ts#L123-L149)

PostgreSQL Error Code Enumeration
---------------------------------

The `PostgresErrorEnum` provides a comprehensive mapping of PostgreSQL SQLSTATE codes to semantic error types. This enumeration covers all standard PostgreSQL error classes:

### Error Class Categories

The enumeration is organized by PostgreSQL error class:

| Class | Category | Example Types |
| --- | --- | --- |
| `00` | Successful Completion | `SUCCESSFUL_COMPLETION` |
| `01` | Warning | `WARNING_DEPRECATED_FEATURE` |
| `08` | Connection Exception | `CONNECTION_FAILURE` |
| `22` | Data Exception | `DIVISION_BY_ZERO`, `NUMERIC_VALUE_OUT_OF_RANGE` |
| `23` | Integrity Constraint Violation | `UNIQUE_VIOLATION`, `FOREIGN_KEY_VIOLATION` |
| `40` | Transaction Rollback | `T_R_DEADLOCK_DETECTED`, `T_R_SERIALIZATION_FAILURE` |
| `42` | Syntax Error or Access Rule Violation | `SYNTAX_ERROR`, `UNDEFINED_TABLE` |
| `53` | Insufficient Resources | `OUT_OF_MEMORY`, `TOO_MANY_CONNECTIONS` |
| `XX` | Internal Error | `INTERNAL_ERROR`, `DATA_CORRUPTED` |

The full enumeration contains 200+ error types. [packages/core/db/src/postgres/postgres-error.enum.ts 3-534](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/postgres/postgres-error.enum.ts#L3-L534)

### Type Conversion

Two complementary mappings enable bidirectional conversion:

```
// Code → Type name
PostgresErrorEnum: Record<string, string>

// Type name → Code
PostgresErrorTypeEnum: Record<string, string>
```

**Sources:**[packages/core/db/src/postgres/postgres-error.enum.ts 3-544](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/postgres/postgres-error.enum.ts#L3-L544)

The error extraction system handles the complexity of deeply nested error structures that arise from the Effect → SQL → Drizzle → PostgreSQL call chain.

The system provides two primary extraction functions:

**`extractPostgresErrorFromCause`** - Extracts from Effect Cause structures: [packages/core/db/src/errors.ts 34-43](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/errors.ts#L34-L43)

**`extractPostgresErrorFromSqlError`** - Extracts from SQL error hierarchies: [packages/core/db/src/errors.ts 48-50](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/errors.ts#L48-L50)

Both delegate to the internal `extractPostgresError` function, which implements a breadth-first search through the error object graph:

[packages/core/db/src/errors.ts 52-121](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/errors.ts#L52-L121)

### Type Guards

The extraction logic uses multiple type guards to identify error shapes:

| Guard Function | Purpose |
| --- | --- |
| `isPostgresErrorInstance` | Checks `instanceof postgres.PostgresError` |
| `isPostgresErrorLike` | Checks plain object with `name="PostgresError"` |
| `isSqlErrorInstance` | Checks `instanceof SqlError` |
| `isSqlErrorLike` | Checks plain object with `_tag="SqlError"` |
| `isDbErrorLike` | Checks plain object with `_tag="DbError"` |
| `isFiberFailureLike` | Checks plain object with `_id="FiberFailure"` |

**Sources:**[packages/core/db/src/errors.ts 12-30](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/errors.ts#L12-L30)

Error Matching and Conversion
-----------------------------

The `DbError.match` static method provides a unified interface for converting any supported error type into a `DbError`:

### DrizzleQueryError Handling

Due to Effect's `FiberFailure` hiding nested errors behind non-enumerable symbols, the system uses JSON round-tripping to expose the nested `PostgresError`:

[packages/core/db/src/errors.ts 168-182](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/errors.ts#L168-L182)

This pattern appears both in the `match` method and in the example execution script: [packages/_internal/db-admin/src/execute.ts 70-80](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/src/execute.ts#L70-L80)

### Error Type Lookup

Once a `PostgresError` is extracted, its code is mapped to a semantic type:

```
const code = postgresError.code as keyof typeof PostgresErrorEnum;
const type = PostgresErrorTypeEnum[code] ?? "UNKNOWN";
```

[packages/core/db/src/errors.ts 208-210](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/errors.ts#L208-L210)

**Sources:**[packages/core/db/src/errors.ts 163-212](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/errors.ts#L163-L212)[packages/_internal/db-admin/src/execute.ts 40-89](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/src/execute.ts#L40-L89)

Error Propagation in the Effect Layer
-------------------------------------

Database errors flow through multiple Effect layer boundaries before reaching application code:

### ExecuteFn Error Handling

The `ExecuteFn` wrapper converts promise rejections to Effect failures:

[packages/core/db/src/db.factory.ts 99-110](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts#L99-L110)

The `catch` clause invokes `DbError.match` to classify the error:

```
catch: (cause) => {
  const error = DbErrors.DbError.match(cause);
  if (error !== null) {
    return error;
  }
  throw cause;
}
```

### Transaction Error Handling

Transaction execution follows a similar pattern but with additional complexity due to async callback boundaries:

[packages/core/db/src/db.factory.ts 116-161](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts#L116-L161)

The transaction wrapper applies the same error matching logic: [packages/core/db/src/db.factory.ts 127-136](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts#L127-L136)

And the outer transaction catch block: [packages/core/db/src/db.factory.ts 154-157](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts#L154-L157)

**Sources:**[packages/core/db/src/db.factory.ts 99-161](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts#L99-L161)

Error Handling Patterns
-----------------------

### Pattern 1: Catching Specific Error Types

Using `Effect.catchTag` to handle specific database errors:

```
Effect.gen(function* () {
  yield* insertUser(userData);
}).pipe(
  Effect.catchTag("DbError", (error) =>
    error.type === "UNIQUE_VIOLATION"
      ? Effect.succeed(existingUser)
      : Effect.fail(error)
  )
);
```

Accessing detailed constraint information from the cause:

```
Effect.catchTag("DbError", (error) => {
  const pgError = error.cause;
  if (pgError.constraint_name === "users_email_key") {
    return Effect.fail(new UniqueViolationError({
      field: "email",
      value: pgError.detail ?? "unknown"
    }));
  }
  return Effect.fail(error);
});
```

### Pattern 3: Transaction Error Recovery

Handling transaction-specific errors:

```
db.transaction((tx) =>
  Effect.gen(function* () {
    yield* tx((client) => client.insert(...));
    yield* tx((client) => client.update(...));
  })
).pipe(
  Effect.catchTags({
    DbError: (error) =>
      error.type === "T_R_DEADLOCK_DETECTED"
        ? Effect.retry(Schedule.exponential("100 millis"))
        : Effect.fail(error)
  })
);
```

### Pattern 4: Cause Inspection

Manual cause inspection for advanced error handling:

[packages/_internal/db-admin/src/execute.ts 48-89](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/src/execute.ts#L48-L89)

This pattern demonstrates:

*   Extracting nested errors from Effect Causes
*   Identifying specific error types in the chain
*   Converting between error representations
*   Building diagnostic information

**Sources:**[packages/_internal/db-admin/src/execute.ts 40-107](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/src/execute.ts#L40-L107)[packages/core/db/src/errors.ts 163-212](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/errors.ts#L163-L212)

Common Error Types Reference
----------------------------

### Integrity Constraint Violations (Class 23)

| Type | Code | Typical Cause | Recovery Strategy |
| --- | --- | --- | --- |
| `UNIQUE_VIOLATION` | `23505` | Duplicate key | Check existence first or update instead |
| `FOREIGN_KEY_VIOLATION` | `23503` | Invalid reference | Verify referenced record exists |
| `NOT_NULL_VIOLATION` | `23502` | Missing required field | Validate input before insert |
| `CHECK_VIOLATION` | `23514` | Failed CHECK constraint | Validate business rules in application |

### Transaction Errors (Class 40)

| Type | Code | Typical Cause | Recovery Strategy |
| --- | --- | --- | --- |
| `T_R_DEADLOCK_DETECTED` | `40P01` | Concurrent conflicting transactions | Retry with exponential backoff |
| `T_R_SERIALIZATION_FAILURE` | `40001` | Isolation level conflict | Retry transaction |
| `T_R_STATEMENT_COMPLETION_UNKNOWN` | `40003` | Network interruption | Check state and retry |

### Connection Errors (Class 08)

| Type | Code | Typical Cause | Recovery Strategy |
| --- | --- | --- | --- |
| `CONNECTION_FAILURE` | `08006` | Network issue | Implement connection pooling retry |
| `SQLCLIENT_UNABLE_TO_ESTABLISH_SQLCONNECTION` | `08001` | Connection refused | Check database availability |
| `TOO_MANY_CONNECTIONS` | `53300` | Pool exhausted | Increase pool size or add queuing |

**Sources:**[packages/core/db/src/postgres/postgres-error.enum.ts 206-220](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/postgres/postgres-error.enum.ts#L206-L220)[packages/core/db/src/postgres/postgres-error.enum.ts 302-311](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/postgres/postgres-error.enum.ts#L302-L311)[packages/core/db/src/postgres/postgres-error.enum.ts 28-41](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/postgres/postgres-error.enum.ts#L28-L41)

Integration with Common Errors
------------------------------

The core database errors integrate with the application-level error system defined in `@beep/errors`:

| Core DB Error | Maps To | HTTP Status |
| --- | --- | --- |
| `DbError` (UNIQUE_VIOLATION) | `UniqueViolationError` | 409 Conflict |
| `DbError` (FOREIGN_KEY_VIOLATION) | `NotFoundError` | 404 Not Found |
| `DbError` (other) | `DatabaseError` | 500 Internal Server Error |
| Transaction timeout | `TransactionError` | 500 Internal Server Error |
| Connection pool exhausted | `ConnectionError` | 500 Internal Server Error |

Application code typically catches `DbError` and converts to domain-specific errors:

[packages/common/errors/src/errors.ts 34-56](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/errors/src/errors.ts#L34-L56)

**Sources:**[packages/common/errors/src/errors.ts 34-78](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/errors/src/errors.ts#L34-L78)[packages/core/db/src/errors.ts 151-212](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/errors.ts#L151-L212)
