# Monorepo Structure | kriegcloud/beep-effect | DeepWiki

_Source: https://deepwiki.com/kriegcloud/beep-effect/2.1-monorepo-structure_

Relevant source files
*   [apps/web/next.config.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/apps/web/next.config.ts)
*   [apps/web/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/apps/web/package.json)
*   [apps/web/tsconfig.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/apps/web/tsconfig.json)
*   [apps/web/tsconfig.test.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/apps/web/tsconfig.test.json)
*   [package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/package.json)
*   [packages/common/invariant/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/invariant/package.json)
*   [packages/common/schema/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/package.json)
*   [packages/common/types/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/types/package.json)
*   [packages/common/utils/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/utils/package.json)
*   [packages/ui/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/ui/package.json)
*   [pnpm-lock.yaml](https://github.com/kriegcloud/beep-effect/blob/b64126f6/pnpm-lock.yaml)
*   [tooling/repo-config/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/tooling/repo-config/package.json)
*   [tooling/repo-scripts/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/tooling/repo-scripts/package.json)
*   [tooling/testkit/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/tooling/testkit/package.json)
*   [tooling/utils/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/tooling/utils/package.json)
*   [tsconfig.base.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/tsconfig.base.json)
*   [tsconfig.build.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/tsconfig.build.json)
*   [tsconfig.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/tsconfig.json)

This document details the workspace organization, package management, and build orchestration of the beep-effect monorepo. It covers the pnpm workspace configuration, Turbo task execution, TypeScript project references, and the dual-format (ESM/CJS) build pipeline used across all packages.

For information about domain-level organization within packages, see [Domain-Driven Design](https://deepwiki.com/kriegcloud/beep-effect/2.3-domain-driven-design). For build tooling specifics and code generation, see [Build System and Tooling](https://deepwiki.com/kriegcloud/beep-effect/8.2-build-system-and-tooling).

* * *

Workspace Organization
----------------------

The monorepo uses **pnpm workspaces** with three top-level directories that partition the codebase by purpose. The workspace configuration is defined in [package.json 9-13](https://github.com/kriegcloud/beep-effect/blob/b64126f6/package.json#L9-L13)

**Workspace Structure:**

| Directory | Purpose | Package Count | Naming Pattern |
| --- | --- | --- | --- |
| `apps/*` | Deployable applications | 3 | `@beep/web`, `@beep/server`, `@beep/mcp` |
| `packages/**` | Domain logic and shared libraries | ~30 | `@beep/<category>-<name>` |
| `tooling/*` | Development and build utilities | 4 | `@beep/tooling-<name>`, `@beep/testkit` |

The pnpm package manager is pinned to version `10.18.0` via the `packageManager` field and enforced through the `engines` configuration [package.json 5-8](https://github.com/kriegcloud/beep-effect/blob/b64126f6/package.json#L5-L8)

**Sources:**[package.json 9-13](https://github.com/kriegcloud/beep-effect/blob/b64126f6/package.json#L9-L13)[tsconfig.base.json 49-341](https://github.com/kriegcloud/beep-effect/blob/b64126f6/tsconfig.base.json#L49-L341)

* * *

Package Categories
------------------

### Common Packages

Foundation libraries used across all other packages. These have minimal or no internal dependencies.

| Package | Location | Purpose |
| --- | --- | --- |
| `@beep/types` | `packages/common/types` | Core TypeScript type definitions |
| `@beep/invariant` | `packages/common/invariant` | Runtime assertion utilities |
| `@beep/utils` | `packages/common/utils` | General utility functions |
| `@beep/schema` | `packages/common/schema` | Effect Schema definitions and custom types |
| `@beep/constants` | `packages/common/constants` | Static configuration values |
| `@beep/errors` | `packages/common/errors` | Tagged error types with subpaths `client`, `server`, `shared` |
| `@beep/rules` | `packages/common/rules` | Workflow and form validation rules |
| `@beep/logos` | `packages/common/logos` | Rules engine for business logic |
| `@beep/rete` | `packages/common/rete` | Graph-based workflow system |

**Sources:**[tsconfig.base.json 49-133](https://github.com/kriegcloud/beep-effect/blob/b64126f6/tsconfig.base.json#L49-L133)[packages/common/schema/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/package.json)[packages/common/utils/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/utils/package.json)

### Core Infrastructure Packages

Provide database access, environment configuration, and email services.

| Package | Location | Purpose | Key Exports |
| --- | --- | --- | --- |
| `@beep/core-db` | `packages/core/db` | Database service factory (`Db.make`) | `ExecuteFn`, `Transaction`, `DbClient` |
| `@beep/core-env` | `packages/core/env` | Environment configuration with subpaths `client`, `server` | `ClientEnv`, `ServerEnv` |
| `@beep/core-email` | `packages/core/email` | Resend email integration | `AuthEmailService` |

**Sources:**[tsconfig.base.json 152-178](https://github.com/kriegcloud/beep-effect/blob/b64126f6/tsconfig.base.json#L152-L178)

### Domain Packages

Implement vertical slices following DDD patterns. Each bounded context has five layers:

| Layer | Suffix | Purpose | Example Exports |
| --- | --- | --- | --- |
| domain | `-domain` | Entities, value objects, domain logic | `User`, `Organization`, `File` |
| tables | `-tables` | Drizzle schema definitions | `usersTable`, `organizationsTable` |
| infra | `-infra` | Repositories, external service adapters | `UserRepo`, `AuthAdapter` |
| sdk | `-sdk` | Client-side API and state management | `authClient`, `useSignIn` |
| ui | `-ui` | React components | `SignInForm`, `ProfileCard` |

**IAM Context:**`packages/iam/`

*   `@beep/iam-domain`, `@beep/iam-tables`, `@beep/iam-infra`, `@beep/iam-sdk`, `@beep/iam-ui`

**Files Context:**`packages/files/`

*   `@beep/files-domain`, `@beep/files-tables`, `@beep/files-infra`, `@beep/files-sdk`, `@beep/files-ui`

**Shared Context:**`packages/shared/`

*   `@beep/shared-domain`, `@beep/shared-tables`

**Sources:**[tsconfig.base.json 185-274](https://github.com/kriegcloud/beep-effect/blob/b64126f6/tsconfig.base.json#L185-L274)

### Application Packages

Executable applications that compose domain packages.

| Application | Location | Framework | Port |
| --- | --- | --- | --- |
| `@beep/web` | `apps/web` | Next.js 15 with Turbopack | 3000 |
| `@beep/server` | `apps/server` | Effect Platform Node | - |
| `@beep/mcp` | `apps/mcp` | Effect AI + MCP Protocol | - |

**Sources:**[apps/web/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/apps/web/package.json)[apps/web/next.config.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/apps/web/next.config.ts)

### Tooling Packages

Development utilities and code generation tools.

| Package | Location | Purpose |
| --- | --- | --- |
| `@beep/tooling-utils` | `tooling/utils` | File system operations, glob utilities |
| `@beep/repo-config` | `tooling/repo-config` | Configuration schemas and validation |
| `@beep/repo-scripts` | `tooling/repo-scripts` | Code generators (secrets, asset paths) |
| `@beep/testkit` | `tooling/testkit` | Testing utilities and helpers |

**Sources:**[tooling/repo-scripts/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/tooling/repo-scripts/package.json)[tooling/utils/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/tooling/utils/package.json)[tooling/testkit/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/tooling/testkit/package.json)

* * *

Package Management with pnpm
----------------------------

The monorepo uses **pnpm** for fast, space-efficient dependency management. Key features include workspace protocol, dependency overrides, and selective dependency installation.

### Workspace Protocol

Packages reference each other using the `workspace:^` protocol, ensuring local packages are always used during development [apps/web/package.json 23-49](https://github.com/kriegcloud/beep-effect/blob/b64126f6/apps/web/package.json#L23-L49)

```
{
  "dependencies": {
    "@beep/schema": "workspace:^",
    "@beep/iam-domain": "workspace:^"
  }
}
```

### Dependency Overrides

The root `package.json` defines global version overrides for shared dependencies to ensure consistency across the monorepo [package.json 84-289](https://github.com/kriegcloud/beep-effect/blob/b64126f6/package.json#L84-L289)

**Critical Overrides:**

| Dependency | Version | Reason |
| --- | --- | --- |
| `effect` | `3.18.2` | Core library version lock |
| `@effect/platform` | `0.92.1` | Platform API compatibility |
| `typescript` | `5.9.3` | Compiler version consistency |
| `drizzle-orm` | `0.44.6` | Database ORM version |
| `react` / `react-dom` | `19.2.0` | UI framework version |

The overrides section uses pnpm's catalog feature to prevent version drift across packages [package.json 85](https://github.com/kriegcloud/beep-effect/blob/b64126f6/package.json#L85-L85)

### Selective Build Dependencies

The `onlyBuiltDependencies` configuration restricts which native modules are built from source [package.json 290-302](https://github.com/kriegcloud/beep-effect/blob/b64126f6/package.json#L290-L302):

```
"onlyBuiltDependencies": [
  "@parcel/watcher",
  "@tailwindcss/oxide",
  "esbuild",
  "sharp",
  "exifreader"
]
```

**Sources:**[package.json 5-8](https://github.com/kriegcloud/beep-effect/blob/b64126f6/package.json#L5-L8)[package.json 84-302](https://github.com/kriegcloud/beep-effect/blob/b64126f6/package.json#L84-L302)[apps/web/package.json 23-169](https://github.com/kriegcloud/beep-effect/blob/b64126f6/apps/web/package.json#L23-L169)

* * *

Build Orchestration with Turbo
------------------------------

**Turbo** orchestrates parallel task execution across packages with intelligent caching and dependency-aware scheduling.

### Task Pipeline

The root package defines shared scripts that delegate to Turbo [package.json 21-53](https://github.com/kriegcloud/beep-effect/blob/b64126f6/package.json#L21-L53):

| Script | Command | Purpose |
| --- | --- | --- |
| `build` | `pnpm dotenvx turbo run build` | Compile all packages |
| `dev` | `pnpm dotenvx turbo run dev --concurrency=36` | Start development servers |
| `test` | `turbo run test` | Execute test suites |
| `lint` | `turbo run lint lint:circular` | Run code quality checks |
| `db:generate` | `turbo run db:generate` | Generate Drizzle schemas |

### Environment Variable Injection

All build and runtime tasks are wrapped with `dotenvx` to inject environment variables from `.env` files [package.json 45](https://github.com/kriegcloud/beep-effect/blob/b64126f6/package.json#L45-L45):

`pnpm dotenvx turbo run build`
This pattern ensures consistent environment configuration across all tasks.

### Concurrency Control

Development tasks use high concurrency (`--concurrency=36`) to parallelize compilation and hot-reload operations [package.json 40-41](https://github.com/kriegcloud/beep-effect/blob/b64126f6/package.json#L40-L41):

`pnpm dotenvx turbo run dev --concurrency=36`
**Dependency Graph Execution:**

Turbo analyzes `package.json` dependencies and TypeScript project references to determine the correct execution order.

**Sources:**[package.json 21-53](https://github.com/kriegcloud/beep-effect/blob/b64126f6/package.json#L21-L53)[tsconfig.build.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/tsconfig.build.json)

* * *

TypeScript Project References
-----------------------------

The monorepo uses **TypeScript project references** to enable incremental compilation and enforce dependency boundaries.

### Base Configuration

[tsconfig.base.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/tsconfig.base.json) defines shared compiler options and path mappings for all packages:

```
{
  "compilerOptions": {
    "composite": true,        // Enable project references
    "incremental": true,      // Enable incremental builds
    "declaration": true,      // Generate .d.ts files
    "declarationMap": true,   // Generate .d.ts.map files
    "target": "ES2022",
    "module": "esnext",
    "moduleResolution": "bundler",
    "paths": {
      "@beep/schema": ["./packages/common/schema/src/index"],
      "@beep/iam-domain": ["./packages/iam/domain/src/index"]
      // ... 40+ path mappings
    }
  }
}
```

### Project Reference Graph

Each package has three TypeScript configurations:

| File | Purpose | Root Dir | Output Dir |
| --- | --- | --- | --- |
| `tsconfig.json` | Type checking and IDE support | `src/`, `test/` | None (noEmit) |
| `tsconfig.build.json` | Production build | `src/` | `build/dts/` |
| `tsconfig.test.json` | Test type checking | `test/` | None (noEmit) |

The root [tsconfig.json 12-118](https://github.com/kriegcloud/beep-effect/blob/b64126f6/tsconfig.json#L12-L118) aggregates all package references:

```
{
  "references": [
    { "path": "packages/common/types" },
    { "path": "packages/common/schema" },
    { "path": "packages/iam/domain" },
    { "path": "apps/web/tsconfig.json" }
  ]
}
```

### Path Mapping Resolution

The base configuration provides 40+ path mappings [tsconfig.base.json 49-341](https://github.com/kriegcloud/beep-effect/blob/b64126f6/tsconfig.base.json#L49-L341) that resolve workspace packages:

```
// Import from source during development
import { User } from '@beep/iam-domain' // -> packages/iam/domain/src/index

// Import from build during production
import { User } from '@beep/iam-domain' // -> packages/iam/domain/build/esm/index
```

Applications like `apps/web` override these paths to point to local source directories [apps/web/tsconfig.json 41-97](https://github.com/kriegcloud/beep-effect/blob/b64126f6/apps/web/tsconfig.json#L41-L97)

**Sources:**[tsconfig.base.json 1-344](https://github.com/kriegcloud/beep-effect/blob/b64126f6/tsconfig.base.json#L1-L344)[tsconfig.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/tsconfig.json)[tsconfig.build.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/tsconfig.build.json)[apps/web/tsconfig.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/apps/web/tsconfig.json)

* * *

Build Pipeline
--------------

All packages (except applications) follow a **dual-format build pipeline** that generates both ESM and CJS outputs with pure call annotations.

### Build Script Pattern

Each package defines three build steps [packages/common/schema/package.json 22-26](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/package.json#L22-L26):

```
{
  "scripts": {
    "build": "pnpm build-esm && pnpm build-cjs && pnpm build-annotate",
    "build-esm": "tsc -b tsconfig.build.json",
    "build-cjs": "babel build/esm --plugins @babel/transform-export-namespace-from --plugins @babel/transform-modules-commonjs --out-dir build/cjs --source-maps",
    "build-annotate": "babel build/esm --plugins annotate-pure-calls --out-dir build/esm --source-maps"
  }
}
```

**Build Flow:**

### Output Structure

Each package produces three output directories:

```
packages/common/schema/
├── src/                    # Source TypeScript
├── build/
│   ├── esm/               # ES Modules (tree-shakeable)
│   │   ├── index.js
│   │   ├── index.js.map
│   │   └── ...
│   ├── cjs/               # CommonJS (Node.js compatibility)
│   │   ├── index.js
│   │   ├── index.js.map
│   │   └── ...
│   └── dts/               # Type declarations
│       ├── index.d.ts
│       ├── index.d.ts.map
│       └── ...
```

### Package Exports

The `exports` field in `package.json` configures dual-format resolution [packages/common/schema/package.json 11-15](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/package.json#L11-L15):

```
{
  "exports": {
    ".": "./src/index.ts",
    "./package.json": "./package.json",
    "./*": "./src/*.ts"
  }
}
```

**During Development:** Imports resolve directly to `.ts` source files for fast feedback.

**During Production:** Build tools resolve to `build/esm/` or `build/cjs/` depending on module format.

### Pure Call Annotations

The `babel-plugin-annotate-pure-calls` plugin adds `/*#__PURE__*/` comments to function calls, enabling better tree-shaking [package.json 71](https://github.com/kriegcloud/beep-effect/blob/b64126f6/package.json#L71-L71):

```
// Before
const schema = Schema.struct({ name: Schema.string })

// After
const schema = /*#__PURE__*/ Schema.struct({
  name: /*#__PURE__*/ Schema.string
})
```

**Sources:**[packages/common/schema/package.json 22-34](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/package.json#L22-L34)[packages/ui/package.json 18-21](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/ui/package.json#L18-L21)[package.json 58-71](https://github.com/kriegcloud/beep-effect/blob/b64126f6/package.json#L58-L71)

* * *

UI Package Special Handling
---------------------------

The `@beep/ui` package requires additional build steps for CSS assets and React component handling.

### CSS Copy Step

The UI package copies its global CSS file to all output directories [packages/ui/package.json 14](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/ui/package.json#L14-L14):

```
copyfiles -f src/styles/globals.css build/src &&
copyfiles -f src/styles/globals.css build/esm &&
copyfiles -f src/styles/globals.css build/cjs
```

### React Transform

Babel applies React-specific transforms during CJS compilation [packages/ui/package.json 20](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/ui/package.json#L20-L20):

```
babel build/esm
  --plugins babel-plugin-transform-next-use-client
  --plugins @babel/transform-export-namespace-from
  --plugins @babel/transform-modules-commonjs
  --presets @babel/preset-react
  --out-dir build/cjs
```

The `babel-plugin-transform-next-use-client` handles Next.js `"use client"` directives.

### Package Exports

The UI package exports CSS and multiple component directories [packages/ui/package.json 31-171](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/ui/package.json#L31-L171):

```
{
  "exports": {
    "./globals.css": "./src/styles/globals.css",
    "./components/*": {
      "import": "./build/esm/components/*",
      "require": "./build/cjs/components/*",
      "types": "./build/dts/components/*"
    },
    "./theme/*": { ... },
    "./hooks/*": { ... }
  }
}
```

**Sources:**[packages/ui/package.json 1-275](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/ui/package.json#L1-L275)

* * *

Quality Gates
-------------

The monorepo enforces code quality through multiple automated checks orchestrated by Turbo.

### Linting with Biome

**Biome** performs linting and formatting [package.json 36-37](https://github.com/kriegcloud/beep-effect/blob/b64126f6/package.json#L36-L37):

```
pnpm lint      # Check all files
pnpm lint:fix  # Auto-fix issues
```

Configuration applies to all packages via `lint-staged`[package.json 304-311](https://github.com/kriegcloud/beep-effect/blob/b64126f6/package.json#L304-L311):

```
{
  "lint-staged": {
    "**/*.{ts,tsx,js,jsx,cjs,mjs}": ["biome check"]
  }
}
```

### Circular Dependency Detection

**Madge** detects circular dependencies in each package [package.json 49](https://github.com/kriegcloud/beep-effect/blob/b64126f6/package.json#L49-L49):

`turbo run lint:circular`
Each package defines `lint:circular` as:

`pnpm madge -c .`
### Dependency Version Sync

**Syncpack** ensures consistent versions across `pnpm.overrides`[package.json 46-48](https://github.com/kriegcloud/beep-effect/blob/b64126f6/package.json#L46-L48):

```
pnpm lint:deps           # Check for mismatches
pnpm lint:deps:fix       # Auto-fix versions
pnpm deps:update         # Update to latest versions
```

### Type Checking

Each package runs `tsc --noEmit` via the `check` script:

`turbo run check`
### Testing

**Vitest** executes unit tests in each package:

```
turbo run test          # Run all tests
turbo run coverage      # Generate coverage reports
```

**Sources:**[package.json 36-50](https://github.com/kriegcloud/beep-effect/blob/b64126f6/package.json#L36-L50)[package.json 304-311](https://github.com/kriegcloud/beep-effect/blob/b64126f6/package.json#L304-L311)

* * *

Development Workflow
--------------------

### Initial Setup

1.   **Clone repository**
2.   **Install dependencies:**`pnpm install`
3.   **Generate environment files:**`pnpm gen:secrets`
4.   **Build all packages:**`pnpm build`

### Daily Development

**Start all development servers:**

`pnpm dev`
This starts:

*   `apps/web` on port 3000 (Next.js with Turbopack)
*   All packages in watch mode (`tsc --watch`)

**Run specific package:**

```
cd packages/iam/domain
pnpm dev
```

### Code Generation

| Script | Command | Purpose |
| --- | --- | --- |
| Database schemas | `pnpm db:generate` | Run Drizzle Kit to generate types |
| Environment secrets | `pnpm gen:secrets` | Generate `.env` template files |
| Asset paths | `pnpm gen:beep-paths` | Generate static asset path constants |

**Sources:**[package.json 21-53](https://github.com/kriegcloud/beep-effect/blob/b64126f6/package.json#L21-L53)

* * *

Key Files Reference
-------------------

| File | Purpose |
| --- | --- |
| [package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/package.json) | Root workspace configuration, scripts, overrides |
| [pnpm-lock.yaml](https://github.com/kriegcloud/beep-effect/blob/b64126f6/pnpm-lock.yaml) | Locked dependency versions |
| [tsconfig.base.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/tsconfig.base.json) | Shared TypeScript configuration |
| [tsconfig.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/tsconfig.json) | Root project references |
| [tsconfig.build.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/tsconfig.build.json) | Build-time project references |
| [turbo.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/turbo.json) | Turbo pipeline configuration (not shown) |
| [.env](https://github.com/kriegcloud/beep-effect/blob/b64126f6/.env) | Environment variables (git-ignored) |

**Sources:**[package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/package.json)[pnpm-lock.yaml 1-100](https://github.com/kriegcloud/beep-effect/blob/b64126f6/pnpm-lock.yaml#L1-L100)[tsconfig.base.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/tsconfig.base.json)[tsconfig.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/tsconfig.json)[tsconfig.build.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/tsconfig.build.json)
