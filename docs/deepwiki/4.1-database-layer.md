# Database Layer | kriegcloud/beep-effect | DeepWiki

_Source: https://deepwiki.com/kriegcloud/beep-effect/4.1-database-layer_

Relevant source files
*   [.github/workflows/check.yml](https://github.com/kriegcloud/beep-effect/blob/b64126f6/.github/workflows/check.yml)
*   [apps/web/src/app/api/auth/[...all]/route.ts](https://deepwiki.com/kriegcloud/beep-effect/apps/web/src/app/api/auth/%5B...all%5D/route.ts)
*   [packages/_internal/db-admin/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/package.json)
*   [packages/_internal/db-admin/src/Db.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/src/Db.ts)
*   [packages/_internal/db-admin/src/execute.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/src/execute.ts)
*   [packages/_internal/db-admin/test/pg-container.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts)
*   [packages/_internal/db-admin/tsconfig.test.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/tsconfig.test.json)
*   [packages/common/errors/src/shared.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/errors/src/shared.ts)
*   [packages/core/db/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/package.json)
*   [packages/core/db/src/db.factory.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts)
*   [packages/core/db/src/errors.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/errors.ts)
*   [packages/core/db/src/index.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/index.ts)
*   [packages/core/db/src/postgres/common.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/postgres/common.ts)
*   [packages/core/db/src/postgres/postgres-error.enum.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/postgres/postgres-error.enum.ts)
*   [packages/core/db/src/types.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/types.ts)
*   [packages/files/infra/src/adapters/repos/_common.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/infra/src/adapters/repos/_common.ts)
*   [packages/files/infra/src/db/Db.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/infra/src/db/Db.ts)
*   [packages/iam/infra/src/adapters/repos/_common.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/repos/_common.ts)
*   [packages/iam/infra/src/db/Db.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/db/Db.ts)

The Database Layer provides a standardized factory-based approach for creating type-safe, domain-scoped database services throughout the application. It combines Effect's functional programming patterns with Drizzle ORM's type-safe query building, enabling structured access to PostgreSQL through domain-specific database contexts. This layer handles connection management, transaction coordination, error transformation, and query execution patterns that are consistent across all domain contexts.

For detailed information about the factory implementation, see [Db.make Factory](https://deepwiki.com/kriegcloud/beep-effect/4.1.1-db.make-factory). For error handling specifics, see [Database Error Handling](https://deepwiki.com/kriegcloud/beep-effect/4.1.2-database-error-handling). For testing infrastructure, see [Testing with PgContainer](https://deepwiki.com/kriegcloud/beep-effect/4.1.3-testing-with-pgcontainer).

Architecture Overview
---------------------

The Database Layer employs a factory pattern that transforms Drizzle schema definitions into Effect services with built-in transaction support, query execution utilities, and standardized error handling. Each domain context (IAM, Files, Shared) creates its own database service using the `Db.make` factory, which provides a consistent interface while maintaining domain isolation.

**Database Layer Architecture**

Sources: [packages/core/db/src/db.factory.ts 1-186](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts#L1-L186)[packages/iam/infra/src/db/Db.ts 1-22](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/db/Db.ts#L1-L22)[packages/files/infra/src/db/Db.ts 1-16](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/infra/src/db/Db.ts#L1-L16)

Factory Pattern: Db.make
------------------------

The `Db.make` factory function is the central component that transforms a Drizzle schema into a complete database service. It accepts a schema object and returns an Effect service that includes query execution, transaction management, and query composition utilities.

**Db.make Factory Output Structure**

The factory produces two key artifacts:

| Artifact | Type | Purpose |
| --- | --- | --- |
| `serviceEffect` | `Effect.Effect<Db<TSchema>, SqlError | ConfigError, SqlClient>` | The main service implementation that provides database access |
| `TransactionContext` | `Context.Tag<TransactionContextShape<TSchema>>` | A context tag used to detect and propagate transaction boundaries |

Sources: [packages/core/db/src/db.factory.ts 81-185](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts#L81-L185)

Domain-Specific Database Services
---------------------------------

Each bounded context creates its own database service by invoking `Db.make` with its domain schema. This creates isolated, type-safe database access that respects domain boundaries.

### IamDb Service

```
// Pattern used in packages/iam/infra/src/db/Db.ts
const factory = Db.make<typeof IamDbSchema>(IamDbSchema);

export class IamDb extends Effect.Service<IamDb>()("@beep/iam-infra/IamDb", {
  effect: factory.serviceEffect,
  accessors: true,
}) {
  static readonly Live = IamDb.Default;
}

export const TransactionContext = factory.TransactionContext;
```

### FilesDb Service

```
// Pattern used in packages/files/infra/src/db/Db.ts
const { serviceEffect } = Db.make(SharedDbSchema);

export class FilesDb extends Context.Tag("@beep/files-infra/FilesDb")<
  FilesDb,
  Db.Db<typeof SharedDbSchema>
>() {
  static readonly Live: Layer = Layer.scoped(this, serviceEffect);
}
```

Both services expose the same interface despite different implementation details:

| Component | Description |
| --- | --- |
| `db` | The Effect SQL Drizzle client instance for advanced queries |
| `drizzle` | The raw Drizzle PostgresJsDatabase instance for direct access |
| `execute` | Function to execute queries with automatic error transformation |
| `transaction` | Function to execute operations within a database transaction |
| `makeQuery` | Higher-order function to create transaction-aware queries |

Sources: [packages/iam/infra/src/db/Db.ts 1-22](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/db/Db.ts#L1-L22)[packages/files/infra/src/db/Db.ts 1-16](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/infra/src/db/Db.ts#L1-L16)

Connection Layer Configuration
------------------------------

The database layer provides two methods for establishing PostgreSQL connections: a configuration-based layer and an environment-based layer with retry logic.

**Connection Layer Configuration Flow**

The `Db.Live` layer includes exponential backoff retry logic with a maximum of 2 retries, starting at 1 second intervals. This ensures resilience during application startup when the database may not be immediately available.

Sources: [packages/core/db/src/db.factory.ts 30-66](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts#L30-L66)[packages/core/db/src/types.ts 8-11](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/types.ts#L8-L11)

Query Execution Patterns
------------------------

The database layer provides three primary execution patterns: direct execution, transaction execution, and transaction-aware queries.

### ExecuteFn: Direct Query Execution

The `execute` function wraps Drizzle queries in Effect's error handling:

**ExecuteFn Error Transformation Flow**

The `execute` function automatically catches and transforms Drizzle query errors into typed `DbError` instances, which include the PostgreSQL error code classification.

Sources: [packages/core/db/src/db.factory.ts 99-110](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts#L99-L110)

### Transaction Function

The `transaction` function enables atomic multi-query operations with automatic rollback on failure:

**Transaction Execution Flow**

The transaction function runs user code within a Drizzle transaction context while providing the `TransactionContext` service, allowing nested queries to detect and reuse the transaction automatically.

Sources: [packages/core/db/src/db.factory.ts 116-161](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts#L116-L161)

### MakeQuery: Transaction-Aware Queries

The `makeQuery` utility creates functions that automatically participate in existing transactions:

```
// Usage pattern for transaction-aware queries
const makeQuery: MakeQuery<TFullSchema> = (queryFn, input) => {
  return Effect.serviceOption(TransactionContext).pipe(
    Effect.map(Option.getOrNull),
    Effect.flatMap((txOrNull) => queryFn(txOrNull ?? execute, input))
  );
};
```

This pattern enables repository methods to work correctly both inside and outside of transactions without manual coordination.

| Context | Behavior |
| --- | --- |
| Outside Transaction | Uses `execute` function, creates new connection |
| Inside Transaction | Uses transaction context, reuses transaction connection |
| Nested Transactions | Automatically detects parent transaction via context |

Sources: [packages/core/db/src/db.factory.ts 162-170](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts#L162-L170)

Type System Integration
-----------------------

The database layer leverages TypeScript's type system to provide compile-time guarantees about query correctness and result types.

**Type Flow Through Database Layer**

The schema type parameter flows through the entire database service, ensuring that:

*   Query builders have access to all table definitions
*   Result types match the schema structure
*   Transaction clients maintain the same type safety as direct clients

Sources: [packages/core/db/src/types.ts 1-37](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/types.ts#L1-L37)[packages/core/db/src/db.factory.ts 68-74](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts#L68-L74)

Connection Pooling and Configuration
------------------------------------

The database layer configures PostgreSQL connections with specific naming transformations and SSL settings:

| Configuration | Value | Purpose |
| --- | --- | --- |
| `transformQueryNames` | `Str.camelToSnake` | Converts JavaScript camelCase to PostgreSQL snake_case |
| `transformResultNames` | `Str.snakeToCamel` | Converts PostgreSQL snake_case to JavaScript camelCase |
| `ssl` | Environment-based | Enables TLS for production connections |
| `url` | Redacted config | PostgreSQL connection string (secured in logs) |

These transformations enable idiomatic naming conventions in both JavaScript/TypeScript code and SQL schema definitions without manual mapping.

Sources: [packages/core/db/src/db.factory.ts 31-42](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts#L31-L42)

Error Handling Integration
--------------------------

Database errors are transformed into structured `DbError` instances that include PostgreSQL error code classification. The error transformation process extracts nested `PostgresError` instances from various error wrapper types (SqlError, DrizzleQueryError, FiberFailure).

For complete details on error extraction, classification, and the PostgreSQL error code enumeration, see [Database Error Handling](https://deepwiki.com/kriegcloud/beep-effect/4.1.2-database-error-handling).

**Error Transformation Pipeline**

The error matcher performs breadth-first search through nested error structures to locate the underlying `PostgresError`, then classifies it using the error code enumeration.

Sources: [packages/core/db/src/errors.ts 1-213](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/errors.ts#L1-L213)[packages/core/db/src/postgres/postgres-error.enum.ts 1-544](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/postgres/postgres-error.enum.ts#L1-L544)

Testing Infrastructure
----------------------

The database layer includes Docker-based testing infrastructure via `PgContainer`, which provides isolated PostgreSQL instances for integration tests. This includes automatic migration execution, extension installation (pg_uuidv7), and test data seeding.

For complete details on container lifecycle, migration execution, and test data management, see [Testing with PgContainer](https://deepwiki.com/kriegcloud/beep-effect/4.1.3-testing-with-pgcontainer).

The test infrastructure provides preflight checks to detect Docker availability and skip tests gracefully in environments where Docker is not available or not permitted.

Sources: [packages/_internal/db-admin/test/pg-container.ts 1-266](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L1-L266)

Repository Integration Pattern
------------------------------

Database services integrate with repository layers through dependency injection:

```
// Pattern from packages/iam/infra/src/adapters/repos/_common.ts
export const dependencies = [IamDb.IamDb.Live] as const;

// Usage in repository layers
const layer = Layer.mergeAll(UserRepo.Live, OrgRepo.Live /* ... */)
  .pipe(Layer.provide(Layer.mergeAll(...dependencies)));
```

This pattern ensures repositories receive the appropriate database service while maintaining testability through layer composition.

Sources: [packages/iam/infra/src/adapters/repos/_common.ts 1-3](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/repos/_common.ts#L1-L3)[packages/files/infra/src/adapters/repos/_common.ts 1-3](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/infra/src/adapters/repos/_common.ts#L1-L3)

Service Composition Example
---------------------------

The following demonstrates how database services compose with repository layers in a complete vertical slice:

**Vertical Slice Service Composition**

The database layer serves as the foundation for repository services, which in turn support application-level business logic through Effect's layer-based dependency injection.

Sources: [packages/_internal/db-admin/test/pg-container.ts 249-255](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L249-L255)
