# Domain-Driven Design | kriegcloud/beep-effect | DeepWiki

_Source: https://deepwiki.com/kriegcloud/beep-effect/2.3-domain-driven-design_

Relevant source files
*   [apps/web/src/app/api/auth/[...all]/route.ts](https://deepwiki.com/kriegcloud/beep-effect/apps/web/src/app/api/auth/%5B...all%5D/route.ts)
*   [apps/web/src/libs/next/index.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/apps/web/src/libs/next/index.ts)
*   [packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql)
*   [packages/_internal/db-admin/drizzle/meta/0000_snapshot.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json)
*   [packages/_internal/db-admin/drizzle/meta/_journal.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/_journal.json)
*   [packages/_internal/db-admin/src/Db.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/src/Db.ts)
*   [packages/_internal/db-admin/test/pg-container.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts)
*   [packages/_internal/db-admin/tsconfig.test.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/tsconfig.test.json)
*   [packages/common/constants/src/Csp.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/constants/src/Csp.ts)
*   [packages/core/db/src/index.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/index.ts)
*   [packages/core/db/src/types.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/types.ts)
*   [packages/core/env/src/client.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/env/src/client.ts)
*   [packages/core/env/src/server.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/env/src/server.ts)
*   [packages/files/infra/src/adapters/repos/_common.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/infra/src/adapters/repos/_common.ts)
*   [packages/files/infra/src/db/Db.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/infra/src/db/Db.ts)
*   [packages/iam/infra/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/package.json)
*   [packages/iam/infra/src/adapters/repos/_common.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/repos/_common.ts)
*   [packages/iam/infra/src/db/Db.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/db/Db.ts)
*   [packages/iam/ui/src/sign-up/sign-up-email.form.tsx](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/src/sign-up/sign-up-email.form.tsx)

Purpose and Scope
-----------------

This document describes how Domain-Driven Design (DDD) principles are applied in the beep-effect repository through bounded contexts and vertical slice architecture. It covers the organization of domain logic, the layering strategy within each context, and how contexts maintain clear boundaries while sharing common infrastructure.

For information about the Effect ecosystem integration that supports this architecture, see [Effect Ecosystem Integration](https://deepwiki.com/kriegcloud/beep-effect/2.2-effect-ecosystem-integration). For details on specific domain implementations, see [IAM Context](https://deepwiki.com/kriegcloud/beep-effect/5.1-iam-context), [Files Context](https://deepwiki.com/kriegcloud/beep-effect/5.2-files-context), and [Shared Domain](https://deepwiki.com/kriegcloud/beep-effect/5.3-shared-domain).

Bounded Contexts
----------------

The codebase is organized into three primary bounded contexts, each representing a distinct area of business functionality:

| Context | Package Prefix | Purpose | Key Entities |
| --- | --- | --- | --- |
| **IAM** | `@beep/iam-*` | Identity and access management | User, Organization, Team, Member, Account |
| **Files** | `@beep/files-*` | File storage and management | File, Upload |
| **Shared** | `@beep/shared-*` | Common domain concepts | EntityId types, Policies, Filters |

Each bounded context is isolated into its own set of packages, with dependencies flowing in one direction to prevent coupling between contexts.

**Diagram: Bounded Context Package Structure**

Sources: [packages/iam/infra/package.json 1-174](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/package.json#L1-L174)[packages/files/infra/src/db/Db.ts 1-16](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/infra/src/db/Db.ts#L1-L16)[packages/_internal/db-admin/tsconfig.test.json 1-76](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/tsconfig.test.json#L1-L76)

Vertical Slice Architecture
---------------------------

Each bounded context implements a five-layer vertical slice architecture, where each layer is a separate package with well-defined responsibilities:

| Layer | Package Suffix | Responsibility | Exports |
| --- | --- | --- | --- |
| **Domain** | `-domain` | Pure business logic, entities, value objects | Entity schemas, domain errors, business rules |
| **Tables** | `-tables` | Database schema definitions | Drizzle table definitions, SQL types |
| **Infrastructure** | `-infra` | External integrations, repositories | Database services, repository implementations, adapters |
| **SDK** | `-sdk` | Client API surface | Client functions, API wrappers |
| **UI** | `-ui` | React components | Domain-specific UI components |

Dependencies flow unidirectionally from UI down to domain, ensuring that business logic remains independent of infrastructure and presentation concerns.

**Diagram: Vertical Slice Layer Dependencies (IAM Context)**

Sources: [packages/iam/infra/package.json 77-93](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/package.json#L77-L93)[packages/_internal/db-admin/tsconfig.test.json 36-67](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/tsconfig.test.json#L36-L67)

Layer Responsibilities
----------------------

### Domain Layer

The domain layer contains pure business logic with no dependencies on infrastructure or frameworks. It defines:

*   **Entity Models**: Effect Schema definitions for domain entities
*   **Value Objects**: Branded types and validation logic
*   **Domain Errors**: Tagged errors specific to the context
*   **Business Rules**: Pure functions expressing domain invariants

The domain layer depends only on `@beep/schema` for Effect Schema primitives and `@beep/shared-domain` for common domain concepts.

### Tables Layer

The tables layer contains Drizzle ORM schema definitions that map domain entities to database tables. Each table definition includes:

*   Column definitions with types matching domain schemas
*   Primary keys (dual-identifier pattern: `id` and `_row_id`)
*   Foreign key relationships
*   Indexes for query optimization
*   Database constraints

The tables layer depends on the domain layer to ensure database schemas align with domain models.

Sources: [packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 1-1403](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L1-L1403)[packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 1-618](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L1-L618)

### Infrastructure Layer

The infrastructure layer implements repositories, external service adapters, and database operations. Key components include:

*   **Database Services**: Created via `Db.make` factory pattern
*   **Repositories**: Data access abstractions using `Repo` class
*   **External Adapters**: Integrations with third-party services
*   **Service Layers**: Effect services providing infrastructure capabilities

Example of the database service factory pattern:

[packages/iam/infra/src/db/Db.ts 1-22](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/db/Db.ts#L1-L22)

```
export namespace IamDb {
  const factory = Db.make<typeof IamDbSchema>(IamDbSchema);

  export class IamDb extends Effect.Service<IamDb>()("@beep/iam-infra/IamDb", {
    effect: factory.serviceEffect,
    accessors: true,
  }) {
    static readonly Live = IamDb.Default;
  }

  export const TransactionContext = factory.TransactionContext;
}
```

The infrastructure layer provides Effect `Layer` instances that can be composed into application runtimes.

Sources: [packages/iam/infra/src/db/Db.ts 1-22](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/db/Db.ts#L1-L22)[packages/files/infra/src/db/Db.ts 1-16](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/infra/src/db/Db.ts#L1-L16)[packages/_internal/db-admin/src/Db.ts 1-21](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/src/Db.ts#L1-L21)

### SDK Layer

The SDK layer provides the client-facing API for interacting with the domain. It includes:

*   **Client Functions**: Public API functions for domain operations
*   **Type-Safe Wrappers**: Effect-based API wrappers
*   **Schema Definitions**: Request/response schemas

Example SDK usage pattern from a UI form:

[packages/iam/ui/src/sign-up/sign-up-email.form.tsx 14-16](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/src/sign-up/sign-up-email.form.tsx#L14-L16)

```
type Props = {
  onSubmit: (values: Effect.Effect<SignUpValue.Type, ParseError, never>) => Promise<void>;
};
```

The SDK layer depends on the infrastructure layer but hides implementation details from consumers.

Sources: [packages/iam/ui/src/sign-up/sign-up-email.form.tsx 1-87](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/src/sign-up/sign-up-email.form.tsx#L1-L87)[apps/web/src/app/api/auth/[...all]/route.ts:1-19](https://deepwiki.com/kriegcloud/beep-effect/2.3-domain-driven-design)

### UI Layer

The UI layer contains React components specific to the domain context. Components:

*   Use the SDK layer for data operations
*   Import shared UI components from `@beep/ui`
*   Implement domain-specific user interactions
*   Handle form validation using Effect Schemas

UI components are framework-aware (React) but domain-specific in functionality.

Sources: [packages/iam/ui/src/sign-up/sign-up-email.form.tsx 1-87](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/src/sign-up/sign-up-email.form.tsx#L1-L87)

Database Service Factory Pattern
--------------------------------

The `Db.make` factory creates type-safe database services for each bounded context. The factory:

1.   Accepts a Drizzle schema definition
2.   Returns a service factory with `serviceEffect`
3.   Provides `ExecuteFn`, `Transaction`, and `MakeQuery` utilities
4.   Creates a `TransactionContext` for managing database transactions

**Diagram: Database Service Creation Pattern**

Each context creates its own database service:

| Context | Service Class | Schema | Live Layer |
| --- | --- | --- | --- |
| IAM | `IamDb.IamDb` | `IamDbSchema` | `IamDb.IamDb.Live` |
| Files | `FilesDb.FilesDb` | `SharedDbSchema` | `FilesDb.FilesDb.Live` |
| Admin | `AdminDb.AdminDb` | `DbSchema` | `AdminDb.AdminDb.Live` |

The database services are composed with repository layers in test infrastructure:

[packages/_internal/db-admin/test/pg-container.ts 249-254](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L249-L254)

```
const sliceDbLayer = Layer.mergeAll(IamDb.IamDb.Live, FilesDb.FilesDb.Live);
const reposLayer = Layer.mergeAll(IamRepos.layer, FilesRepos.layer);
const verticalSlicesLayer = Layer.provideMerge(reposLayer, sliceDbLayer);
```

Sources: [packages/iam/infra/src/db/Db.ts 1-22](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/db/Db.ts#L1-L22)[packages/files/infra/src/db/Db.ts 1-16](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/infra/src/db/Db.ts#L1-L16)[packages/_internal/db-admin/src/Db.ts 1-21](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/src/Db.ts#L1-L21)[packages/_internal/db-admin/test/pg-container.ts 1-266](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L1-L266)[packages/core/db/src/index.ts 1-5](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/index.ts#L1-L5)[packages/core/db/src/types.ts 1-37](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/types.ts#L1-L37)

Repository Layer Pattern
------------------------

Repositories within each context depend on their corresponding database service. The dependency is declared in a common file:

[packages/iam/infra/src/adapters/repos/_common.ts 1-3](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/repos/_common.ts#L1-L3)

`export const dependencies = [IamDb.IamDb.Live] as const;`
[packages/files/infra/src/adapters/repos/_common.ts 1-3](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/infra/src/adapters/repos/_common.ts#L1-L3)

`export const dependencies = [FilesDb.FilesDb.Live] as const;`
This pattern ensures repositories are type-safe and can only access their own context's database service.

Sources: [packages/iam/infra/src/adapters/repos/_common.ts 1-3](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/repos/_common.ts#L1-L3)[packages/files/infra/src/adapters/repos/_common.ts 1-3](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/infra/src/adapters/repos/_common.ts#L1-L3)

Cross-Cutting Concerns
----------------------

### Shared Domain

The `@beep/shared-domain` package contains domain concepts used across multiple contexts:

*   **EntityId Types**: `UserId`, `OrganizationId`, `TeamId`, etc.
*   **Common Value Objects**: Shared across contexts
*   **Policy Abstractions**: Authorization primitives
*   **Filter Types**: Query building blocks

Bounded contexts depend on shared domain for common types but maintain independence for context-specific logic.

### Common Infrastructure

Core infrastructure packages provide foundational capabilities:

| Package | Purpose | Used By |
| --- | --- | --- |
| `@beep/core-db` | Database factory and error handling | All infra layers |
| `@beep/core-env` | Environment configuration | Server and client runtimes |
| `@beep/core-email` | Email service integration | IAM infrastructure |
| `@beep/schema` | Effect Schema primitives | All domain layers |
| `@beep/constants` | Static values and enums | All layers |

Sources: [packages/core/env/src/client.ts 1-58](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/env/src/client.ts#L1-L58)[packages/core/env/src/server.ts 1-214](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/env/src/server.ts#L1-L214)[packages/common/constants/src/Csp.ts 1-70](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/constants/src/Csp.ts#L1-L70)

Context Integration Pattern
---------------------------

Bounded contexts integrate through:

1.   **Shared Database Schema**: Common tables in `@beep/shared-tables`
2.   **Cross-Context References**: Via `EntityId` types from `@beep/shared-domain`
3.   **Layer Composition**: Contexts are composed in application runtimes

Example of multi-context runtime composition:

**Diagram: Multi-Context Runtime Composition**

The test infrastructure demonstrates this composition:

[packages/_internal/db-admin/test/pg-container.ts 217-264](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L217-L264)

The `PgContainer` service provides a complete runtime with both IAM and Files contexts integrated, while maintaining clear boundaries between them through the Effect Layer system.

Sources: [packages/_internal/db-admin/test/pg-container.ts 141-266](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L141-L266)[apps/web/src/app/api/auth/[...all]/route.ts:1-19](https://deepwiki.com/kriegcloud/beep-effect/2.3-domain-driven-design)

Package Naming Conventions
--------------------------

Package names follow a consistent pattern to indicate their context and layer:

```
@beep/{context}-{layer}
```

Examples:

*   `@beep/iam-domain` - IAM domain layer
*   `@beep/iam-tables` - IAM database schemas
*   `@beep/iam-infra` - IAM infrastructure
*   `@beep/files-domain` - Files domain layer
*   `@beep/shared-domain` - Shared domain concepts

Core packages use the prefix `@beep/core-*` and common utilities use descriptive names without the layer suffix (e.g., `@beep/schema`, `@beep/utils`).

Dependency Isolation
--------------------

Each bounded context maintains strict dependency isolation:

**Diagram: Context Dependency Isolation**

Note the absence of direct dependencies between IAM and Files contexts - they communicate only through shared abstractions or via application-level orchestration.

Sources: [packages/iam/infra/package.json 77-94](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/package.json#L77-L94)[packages/_internal/db-admin/tsconfig.test.json 1-76](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/tsconfig.test.json#L1-L76)
