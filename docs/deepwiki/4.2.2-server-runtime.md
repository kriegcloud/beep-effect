# Server Runtime | kriegcloud/beep-effect | DeepWiki

_Source: https://deepwiki.com/kriegcloud/beep-effect/4.2.2-server-runtime_

Relevant source files
*   [apps/web/src/app/api/auth/[...all]/route.ts](https://deepwiki.com/kriegcloud/beep-effect/apps/web/src/app/api/auth/%5B...all%5D/route.ts)
*   [docker-compose.yml](https://github.com/kriegcloud/beep-effect/blob/b64126f6/docker-compose.yml)
*   [packages/_internal/db-admin/src/Db.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/src/Db.ts)
*   [packages/_internal/db-admin/test/pg-container.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts)
*   [packages/_internal/db-admin/tsconfig.test.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/tsconfig.test.json)
*   [packages/common/constants/src/paths/asset-paths.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/constants/src/paths/asset-paths.ts)
*   [packages/common/constants/src/paths/generated/asset-paths.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/constants/src/paths/generated/asset-paths.ts)
*   [packages/core/db/src/index.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/index.ts)
*   [packages/core/db/src/types.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/types.ts)
*   [packages/files/infra/src/adapters/repos/_common.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/infra/src/adapters/repos/_common.ts)
*   [packages/files/infra/src/db/Db.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/infra/src/db/Db.ts)
*   [packages/iam/infra/src/adapters/better-auth/Auth.service.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts)
*   [packages/iam/infra/src/adapters/repos/_common.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/repos/_common.ts)
*   [packages/iam/infra/src/db/Db.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/db/Db.ts)
*   [packages/iam/sdk/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/package.json)
*   [packages/iam/sdk/src/clients/sign-in/sign-in.client.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/src/clients/sign-in/sign-in.client.ts)
*   [packages/iam/sdk/src/index.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/src/index.ts)
*   [packages/iam/ui/src/sign-up/sign-up.view.tsx](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/src/sign-up/sign-up.view.tsx)
*   [packages/runtime/client/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/package.json)
*   [packages/runtime/client/src/services/runtime/live-layer.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts)
*   [packages/runtime/server/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/package.json)
*   [packages/runtime/server/src/server-runtime.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts)

Purpose and Scope
-----------------

The Server Runtime configures and manages the Effect-based runtime environment for the server application. It orchestrates all backend services through Effect's Layer system, including observability infrastructure, database connections, repository layers, and domain services. This runtime provides the execution context for all server-side Effect programs.

For client-side runtime configuration, see [Client Runtime](https://deepwiki.com/kriegcloud/beep-effect/4.2.1-client-runtime). For database service creation patterns, see [Db.make Factory](https://deepwiki.com/kriegcloud/beep-effect/4.1.1-db.make-factory).

**Sources:**[packages/runtime/server/src/server-runtime.ts 1-123](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L1-L123)

Runtime Architecture
--------------------

The server runtime uses Effect's `ManagedRuntime` pattern to create a long-lived runtime that provides services to all server-side code. The runtime is assembled through hierarchical Layer composition, with each layer providing specific services and dependencies.

**Diagram: Server Runtime Layer Hierarchy**

The runtime composition follows a dependency hierarchy where higher layers depend on lower layers. The `ManagedRuntime` manages service lifecycle and ensures proper initialization and cleanup.

**Sources:**[packages/runtime/server/src/server-runtime.ts 69-102](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L69-L102)

Observability Infrastructure
----------------------------

### Telemetry Configuration

The `TelemetryLive` layer configures OpenTelemetry instrumentation using the Node SDK with OTLP exporters for both traces and logs.

**Diagram: Telemetry Export Pipeline**

**Sources:**[packages/runtime/server/src/server-runtime.ts 36-43](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L36-L43)

### Logger Configuration

The logging layer adapts based on the environment:

| Environment | Logger Type | Description |
| --- | --- | --- |
| Development | `makePrettyConsoleLoggerLayer()` | Human-readable console output with colors and formatting |
| Production | `Logger.json` | Structured JSON logs for log aggregation systems |

**Sources:**[packages/runtime/server/src/server-runtime.ts 49-50](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L49-L50)

### Log Level Management

The `LogLevelLive` layer dynamically sets the minimum log level:

*   **Development**: `LogLevel.Debug` - Verbose logging for debugging
*   **Production**: `LogLevel.Info` - Essential operational logs only

**Sources:**[packages/runtime/server/src/server-runtime.ts 52-53](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L52-L53)

### Developer Tools

The `DevToolsLive` layer conditionally provides Effect DevTools in development for debugging and inspection:

```
// Enabled only in development to avoid production overhead
DevTools.layerWebSocket().pipe(Layer.provide(NodeSocket.layerWebSocketConstructor))
```

**Sources:**[packages/runtime/server/src/server-runtime.ts 55-60](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L55-L60)

### Observability Composition

All observability services are merged into a single layer:

**Diagram: Observability Layer Composition**

**Sources:**[packages/runtime/server/src/server-runtime.ts 62-63](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L62-L63)

Database Infrastructure
-----------------------

### Database Service Layers

The database infrastructure is organized into vertical slices, with each domain having its own database service:

**Diagram: Database Service Architecture**

Each database service is created using the `Db.make` factory pattern, which generates type-safe database operations for a specific schema.

**Sources:**

*   [packages/runtime/server/src/server-runtime.ts 72-76](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L72-L76)
*   [packages/iam/infra/src/db/Db.ts 8-21](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/db/Db.ts#L8-L21)
*   [packages/files/infra/src/db/Db.ts 8-15](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/infra/src/db/Db.ts#L8-L15)

### Service Factory Pattern

Both `IamDb` and `FilesDb` use the same factory pattern:

```
// IAM Database Service
const factory = Db.make<typeof IamDbSchema>(IamDbSchema);
export class IamDb extends Effect.Service<IamDb>()("@beep/iam-infra/IamDb", {
  effect: factory.serviceEffect,
  accessors: true,
})
```

This pattern provides:

*   Type-safe database operations for the domain schema
*   Transaction context management
*   Error handling with `DbError`
*   Automatic service registration with Effect's DI system

**Sources:**

*   [packages/iam/infra/src/db/Db.ts 9-18](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/db/Db.ts#L9-L18)
*   [packages/files/infra/src/db/Db.ts 9-14](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/infra/src/db/Db.ts#L9-L14)

Repository Layer
----------------

### Repository Service Composition

Repository services provide higher-level data access abstractions over the database services:

**Diagram: Repository Layer Dependencies**

Each domain repository depends on its corresponding database service. The repository layer is provided with the full database infrastructure through `Layer.provideMerge`.

**Sources:**

*   [packages/runtime/server/src/server-runtime.ts 69-79](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L69-L79)
*   [packages/iam/infra/src/adapters/repos/_common.ts 1-3](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/repos/_common.ts#L1-L3)
*   [packages/files/infra/src/adapters/repos/_common.ts 1-3](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/infra/src/adapters/repos/_common.ts#L1-L3)

Domain Services
---------------

### Authentication Services

The authentication layer integrates better-auth with email delivery capabilities:

**Diagram: Authentication Service Composition**

**Sources:**

*   [packages/runtime/server/src/server-runtime.ts 85-91](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L85-L91)
*   [packages/iam/infra/src/adapters/better-auth/Auth.service.ts 241-249](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L241-L249)

### AuthService Configuration

The `AuthService` is configured with extensive better-auth options including:

| Configuration Area | Details |
| --- | --- |
| Database Adapter | Drizzle adapter with `IamDbSchema` |
| Session Management | 30-day expiration with cookie caching |
| Email Verification | Automatic verification emails on signup |
| OAuth Providers | Dynamic provider configuration from environment |
| Database Hooks | User creation triggers personal org setup |
| Rate Limiting | 100 requests per 10-second window |

**Sources:**[packages/iam/infra/src/adapters/better-auth/Auth.service.ts 27-237](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L27-L237)

### Database Hooks Integration

The authentication service includes lifecycle hooks that execute within the Effect runtime:

```
databaseHooks: {
  user: {
    create: {
      after: async (user) => {
        const program = Effect.gen(function* () {
          // Create personal organization
          yield* db.insert(IamDbSchema.organization).values({...});
          // Add user as owner
          yield* db.insert(IamDbSchema.member).values({...});
        });
        await runPromise(program.pipe(Effect.withSpan("AuthService.databaseHooks.user.create.after")));
      }
    }
  }
}
```

This bridges better-auth's callback system with the Effect runtime, allowing database operations to be traced and logged.

**Sources:**[packages/iam/infra/src/adapters/better-auth/Auth.service.ts 119-160](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L119-L160)

Runtime Assembly
----------------

### Application Layer Composition

The final application layer merges authentication with logging:

`const AppLive = AuthLive.pipe(Layer.provideMerge(LoggerLive));`
This represents the complete service graph for the server application.

**Sources:**[packages/runtime/server/src/server-runtime.ts 93](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L93-L93)

### ManagedRuntime Creation

The `serverRuntime` is created as a `ManagedRuntime`:

```
export const serverRuntime = ManagedRuntime.make(
  AppLive.pipe(Layer.provide([ObservabilityLive, LogLevelLive]))
);
```

The `ManagedRuntime` pattern provides:

*   **Automatic lifecycle management**: Services are initialized on first use and cleaned up on shutdown
*   **Scoped resource handling**: Resources like database connections are properly acquired and released
*   **Error boundary**: Runtime errors are properly contained and reported
*   **Context preservation**: Service context is maintained across async boundaries

**Sources:**[packages/runtime/server/src/server-runtime.ts 102](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L102-L102)

The runtime exposes the complete service environment type:

`type ServerRuntimeEnv = Layer.Layer.Success<typeof AppLive>;`
This type represents all services available to Effect programs running in the server runtime, including:

*   `AuthService`
*   `AuthEmailService`
*   `IamDb.IamDb`
*   `FilesDb.FilesDb`
*   `IamRepos` (all repository services)
*   `FilesRepos` (all repository services)
*   All observability services

**Sources:**[packages/runtime/server/src/server-runtime.ts 104](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L104-L104)

Runtime Execution Helpers
-------------------------

### runServerPromise

Executes an Effect within the server runtime and returns a Promise:

```
export const runServerPromise = <A, E>(
  effect: Effect.Effect<A, E, ServerRuntimeEnv>,
  spanName = "serverRuntime.runPromise",
  options?: Parameters<typeof serverRuntime.runPromise>[1]
) => serverRuntime.runPromise(Effect.withSpan(effect, spanName), options);
```

**Features:**

*   Automatically wraps the effect in a tracing span
*   Accepts custom span name for observability
*   Supports runtime options (signal, onExit, etc.)
*   Returns a Promise for interop with non-Effect code

**Sources:**[packages/runtime/server/src/server-runtime.ts 109-113](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L109-L113)

### runServerPromiseExit

Similar to `runServerPromise` but returns the full `Exit` value:

```
export const runServerPromiseExit = <A, E>(
  effect: Effect.Effect<A, E, ServerRuntimeEnv>,
  spanName = "serverRuntime.runPromiseExit",
  options?: Parameters<typeof serverRuntime.runPromiseExit>[1]
) => serverRuntime.runPromiseExit(Effect.withSpan(effect, spanName), options);
```

**Use cases:**

*   When you need to inspect failure details
*   For custom error handling logic
*   When you want to distinguish between different failure modes
*   For testing scenarios where you need the full exit information

**Sources:**[packages/runtime/server/src/server-runtime.ts 117-122](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L117-L122)

Integration Patterns
--------------------

### Next.js API Route Integration

The runtime is commonly used in Next.js API routes:

```
// apps/web/src/app/api/auth/[...all]/route.ts
const program = Effect.flatMap(AuthService, ({ auth }) =>
  Effect.gen(function* () {
    return yield* Effect.succeed(auth.handler);
  })
);

const route = async (req: Request) => {
  const handler = await runServerPromise(program, "auth.route");
  return handler(req);
};

export const POST = route;
export const GET = route;
```

This pattern:

1.   Defines an Effect program that uses services from the runtime
2.   Uses `runServerPromise` to execute the program with tracing
3.   Returns a standard Next.js route handler

**Sources:**[apps/web/src/app/api/auth/[...all]/route.ts:5-18](https://deepwiki.com/kriegcloud/beep-effect/4.2.2-server-runtime)

### Service Access Pattern

Services are accessed using Effect's service locator pattern:

```
Effect.gen(function* () {
  const { db, drizzle } = yield* IamDb.IamDb;
  const { sendResetPassword, sendVerification } = yield* AuthEmailService;
  const runtime = yield* Effect.runtime();

  // Use services...
});
```

The `yield*` syntax retrieves services from the runtime context, ensuring type-safe access with proper dependency tracking.

**Sources:**[packages/iam/infra/src/adapters/better-auth/Auth.service.ts 27-35](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L27-L35)

### Test Environment Setup

The runtime configuration is replicated in test environments using `PgContainer`:

**Diagram: Test Runtime Configuration**

The test setup mirrors the production runtime structure but uses a Docker-based PostgreSQL container with automated migrations.

**Sources:**[packages/_internal/db-admin/test/pg-container.ts 237-264](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L237-L264)

Environment Configuration
-------------------------

The server runtime reads configuration from the `serverEnv` object, which provides:

| Configuration | Usage |
| --- | --- |
| `serverEnv.app.env` | Determines dev/prod behavior for logging and telemetry |
| `serverEnv.app.name` | Service name for OpenTelemetry resource attributes |
| `serverEnv.otlp.traceExporterUrl` | OTLP endpoint for trace export |
| `serverEnv.otlp.logExporterUrl` | OTLP endpoint for log export |
| `serverEnv.app.authUrl` | Base URL for better-auth configuration |
| `serverEnv.auth.secret` | Secret key for session signing |
| `serverEnv.oauth.authProviderNames` | Enabled OAuth providers |

**Sources:**[packages/runtime/server/src/server-runtime.ts 27-30](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L27-L30)

Docker Infrastructure
---------------------

The server runtime connects to infrastructure services defined in `docker-compose.yml`:

**Diagram: Docker Infrastructure**

**Sources:**[docker-compose.yml 1-36](https://github.com/kriegcloud/beep-effect/blob/b64126f6/docker-compose.yml#L1-L36)
