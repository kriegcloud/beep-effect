# Better-Auth Plugins | kriegcloud/beep-effect | DeepWiki

_Source: https://deepwiki.com/kriegcloud/beep-effect/4.3.2-better-auth-plugins_

Relevant source files
*   [docker-compose.yml](https://github.com/kriegcloud/beep-effect/blob/b64126f6/docker-compose.yml)
*   [packages/common/constants/src/paths/asset-paths.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/constants/src/paths/asset-paths.ts)
*   [packages/common/constants/src/paths/generated/asset-paths.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/constants/src/paths/generated/asset-paths.ts)
*   [packages/files/domain/src/utils/bytes-to-size.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/domain/src/utils/bytes-to-size.ts)
*   [packages/files/domain/src/utils/compress-file-name.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/domain/src/utils/compress-file-name.ts)
*   [packages/iam/infra/src/adapters/better-auth/Auth.service.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts)
*   [packages/iam/infra/src/adapters/better-auth/plugins/one-tap/one-tap.plugin.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/plugins/one-tap/one-tap.plugin.ts)
*   [packages/iam/infra/src/adapters/better-auth/plugins/organization/organization.plugin.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/plugins/organization/organization.plugin.ts)
*   [packages/iam/sdk/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/package.json)
*   [packages/iam/sdk/src/clients/sign-in/sign-in.client.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/src/clients/sign-in/sign-in.client.ts)
*   [packages/iam/sdk/src/index.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/src/index.ts)
*   [packages/iam/ui/src/sign-up/sign-up.view.tsx](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/src/sign-up/sign-up.view.tsx)
*   [packages/runtime/client/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/package.json)
*   [packages/runtime/client/src/services/runtime/live-layer.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts)
*   [packages/runtime/server/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/package.json)
*   [packages/runtime/server/src/server-runtime.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts)
*   [packages/ui/src/theme/with-settings/update-core.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/ui/src/theme/with-settings/update-core.ts)

This document covers the better-auth plugin system implementation in the beep-effect repository, including the organization plugin for multi-tenant management and the one-tap plugin for Google authentication. These plugins extend the core better-auth functionality with domain-specific features.

For information about the core AuthService configuration and better-auth setup, see [4.3.1](https://deepwiki.com/kriegcloud/beep-effect/4.3.1-authservice-and-better-auth). For authorization and policy-based access control, see [4.3.3](https://deepwiki.com/kriegcloud/beep-effect/4.3.3-policy-authorization-system).

Purpose and Scope
-----------------

The better-auth plugin system allows modular extension of authentication functionality. This page documents:

*   The two plugins implemented: `organization` and `oneTap`
*   Plugin configuration patterns using Effect
*   Database hooks and lifecycle management
*   Integration with the IAM domain context
*   Email notification integration for invitations

Plugin Architecture
-------------------

Better-auth plugins are configured as Effect-wrapped modules that provide additional authentication features. The codebase implements a type-safe plugin composition pattern where each plugin is an `Effect` that yields the plugin instance.

**Sources:**[packages/iam/infra/src/adapters/better-auth/Auth.service.ts 27-36](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L27-L36)[packages/iam/infra/src/adapters/better-auth/plugins/organization/organization.plugin.ts 16-174](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/plugins/organization/organization.plugin.ts#L16-L174)[packages/iam/infra/src/adapters/better-auth/plugins/one-tap/one-tap.plugin.ts 1-23](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/plugins/one-tap/one-tap.plugin.ts#L1-L23)

### Plugin Type System

Each plugin follows a consistent type pattern:

| Type | Description | Example |
| --- | --- | --- |
| `{Plugin}Effect` | The Effect that yields the plugin instance | `OrganizationPluginEffect` |
| `{Plugin}` | The success type of the plugin effect | `OrganizationPlugin` |
| `Options` | The configuration type for the plugin | `OrganizationOptions` |
| `Context` | The Effect context requirements | `Effect.Effect.Context<typeof options>` |

**Sources:**[packages/iam/infra/src/adapters/better-auth/plugins/organization/organization.plugin.ts 160-174](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/plugins/organization/organization.plugin.ts#L160-L174)[packages/iam/infra/src/adapters/better-auth/plugins/one-tap/one-tap.plugin.ts 9-10](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/plugins/one-tap/one-tap.plugin.ts#L9-L10)

Organization Plugin
-------------------

The organization plugin enables multi-tenant functionality with support for teams, members, invitations, and role-based access control. It integrates with the IAM domain's organization and member entities.

### Plugin Configuration

**Sources:**[packages/iam/infra/src/adapters/better-auth/plugins/organization/organization.plugin.ts 16-158](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/plugins/organization/organization.plugin.ts#L16-L158)

### Organization Limits and Roles

The plugin enforces configurable limits on organizations and memberships:

*   `allowUserToCreateOrganization`: `true` - Users can create organizations
*   `organizationLimit`: `1` - Each user can create one organization
*   `creatorRole`: `"owner"` - Organization creators receive the owner role
*   `membershipLimit`: `2` - Maximum members per organization (configurable by tier)

**Sources:**[packages/iam/infra/src/adapters/better-auth/plugins/organization/organization.plugin.ts 22-25](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/plugins/organization/organization.plugin.ts#L22-L25)

### Schema Extensions

The organization plugin extends the default better-auth schemas with domain-specific fields:

#### Organization Additional Fields

| Field | Type | Required | Description |
| --- | --- | --- | --- |
| `type` | enum | Yes | `individual` or `team` from `Organization.OrganizationTypeEnum` |
| `ownerUserId` | string | No | User ID of the organization owner |
| `isPersonal` | boolean | Yes | Whether this is a user's personal organization |
| `maxMembers` | number | No | Maximum members allowed |
| `features` | json | No | JSONB field for feature flags |
| `settings` | json | No | JSONB field for organization settings |
| `subscriptionTier` | enum | No | Subscription tier (free, pro, etc.) |
| `subscriptionStatus` | enum | No | Subscription status (active, cancelled, etc.) |

**Sources:**[packages/iam/infra/src/adapters/better-auth/plugins/organization/organization.plugin.ts 44-82](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/plugins/organization/organization.plugin.ts#L44-L82)

#### Member Additional Fields

| Field | Type | Required | Description |
| --- | --- | --- | --- |
| `status` | string | Yes | Member status (active, suspended, etc.) |
| `invitedBy` | string | No | User ID who sent the invitation |
| `invitedAt` | date | No | Timestamp of invitation |
| `joinedAt` | date | No | Timestamp when member joined |
| `lastActiveAt` | date | No | Last activity timestamp |
| `permissions` | string | No | JSON string of custom permissions |

**Sources:**[packages/iam/infra/src/adapters/better-auth/plugins/organization/organization.plugin.ts 84-94](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/plugins/organization/organization.plugin.ts#L84-L94)

### Database Hooks

The organization plugin implements lifecycle hooks that execute during organization creation:

**Sources:**[packages/iam/infra/src/adapters/better-auth/plugins/organization/organization.plugin.ts 119-156](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/plugins/organization/organization.plugin.ts#L119-L156)

#### Before Create Hook

The `beforeCreateOrganization` hook transforms the organization data before database insertion:

*   Sets `type` to `Organization.OrganizationTypeEnum.team` for user-created organizations
*   Sets `ownerUserId` to the creating user's ID
*   Sets `isPersonal` to `false` (distinguishes from auto-created personal orgs)
*   Sets `subscriptionTier` to `Organization.SubscriptionTierEnum.free`
*   Sets `subscriptionStatus` to `Organization.SubscriptionStatusEnum.active`
*   Sets `source` to `"user_created"` for tracking creation method

**Sources:**[packages/iam/infra/src/adapters/better-auth/plugins/organization/organization.plugin.ts 120-133](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/plugins/organization/organization.plugin.ts#L120-L133)

#### After Create Hook

The `afterCreateOrganization` hook updates the member record with tracking fields:

*   Sets member `status` to `active`
*   Sets `joinedAt` to current UTC timestamp
*   Sets `lastActiveAt` to current UTC timestamp
*   Uses Effect's `DateTime.now` for UTC timestamp generation
*   Executes asynchronously using `runPromise`

**Sources:**[packages/iam/infra/src/adapters/better-auth/plugins/organization/organization.plugin.ts 134-154](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/plugins/organization/organization.plugin.ts#L134-L154)

### Email Integration

The organization plugin integrates with `AuthEmailService` to send invitation emails:

```
sendInvitationEmail: async (params) =>
  void (await Effect.flatMap(
    S.decode(InvitationEmailPayload)({
      email: params.email,
      invitedByUsername: params.inviter.user.name,
      invitedByEmail: params.inviter.user.email,
      teamName: params.organization.name,
    }),
    sendInvitation
  ).pipe(runPromise))
```

The invitation payload includes:

*   Invitee email address
*   Inviter's username and email
*   Organization/team name

**Sources:**[packages/iam/infra/src/adapters/better-auth/plugins/organization/organization.plugin.ts 26-35](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/plugins/organization/organization.plugin.ts#L26-L35)

### Team Support

The plugin enables hierarchical team structures within organizations:

*   `teams.enabled`: `true` - Enables team functionality
*   `maximumTeams`: `10` - Maximum teams per organization
*   `allowRemovingAllTeams`: `false` - Prevents removing all teams
*   Team additional fields: `description`, `metadata`, `logo`

**Sources:**[packages/iam/infra/src/adapters/better-auth/plugins/organization/organization.plugin.ts 36-109](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/plugins/organization/organization.plugin.ts#L36-L109)

One-Tap Plugin
--------------

The one-tap plugin enables Google's One Tap sign-in experience, allowing users to authenticate with a single click using their Google account.

**Sources:**[packages/iam/infra/src/adapters/better-auth/plugins/one-tap/one-tap.plugin.ts 1-23](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/plugins/one-tap/one-tap.plugin.ts#L1-L23)[packages/iam/sdk/src/clients/sign-in/sign-in.client.ts 73-95](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/src/clients/sign-in/sign-in.client.ts#L73-L95)

### Configuration

The one-tap plugin configuration is minimal, requiring only the Google OAuth client ID:

```
export const oneTapPlugin: OneTapPluginEffect = Effect.succeed(
  oneTap({
    clientId: F.pipe(
      serverEnv.oauth.provider.google.clientId,
      O.match({
        onNone: () => "not a real client id",
        onSome: (id) => Redacted.value(id),
      })
    ),
  } satisfies OneTapOptions)
);
```

The configuration:

*   Retrieves Google client ID from `serverEnv.oauth.provider.google.clientId`
*   Uses `Option.match` to handle missing client ID gracefully
*   Unwraps the `Redacted` type using `Redacted.value`
*   Provides a fallback value if client ID is not configured

**Sources:**[packages/iam/infra/src/adapters/better-auth/plugins/one-tap/one-tap.plugin.ts 12-22](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/plugins/one-tap/one-tap.plugin.ts#L12-L22)

### Client Integration

The one-tap functionality is exposed through the IAM SDK's `signInClient`:

```
const signInOneTap = AuthHandler.make<void>({
  name: "signInOneTap",
  plugin: "sign-in",
  method: "oneTap",
  run: AuthHandler.map(async () => {
    try {
      await client.oneTap();
      return { data: null, error: null } as const;
    } catch (error) {
      throw error;
    }
  }),
  toast: {
    onWaiting: "Signing in...",
    onSuccess: "Signed in successfully",
    onFailure: {
      onNone: () => "Failed to signin",
      onSome: (e) => e.message,
    },
  },
  defaultErrorMessage: "Failed to signin",
  annotations: { action: "sign-in", method: "oneTap" },
});
```

The client handler:

*   Wraps the `client.oneTap()` call in an `AuthHandler`
*   Provides toast notifications for user feedback
*   Includes telemetry annotations for observability
*   Returns a consistent response structure

**Sources:**[packages/iam/sdk/src/clients/sign-in/sign-in.client.ts 73-95](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/src/clients/sign-in/sign-in.client.ts#L73-L95)

Plugin Integration
------------------

The plugins are composed into the `AuthService` through the `AllPlugins` effect:

**Sources:**[packages/iam/infra/src/adapters/better-auth/Auth.service.ts 27-249](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L27-L249)

### Runtime Composition

The `AuthOptions` effect orchestrates plugin integration:

1.   **Dependency Resolution**: Yields `IamDb`, `AuthEmailService`, and runtime
2.   **Plugin Loading**: Yields `AllPlugins` which combines all plugin effects
3.   **Configuration Building**: Constructs the `BetterAuthOptions` object with plugins
4.   **Instance Creation**: Passes options to `betterAuth()` constructor

```
const AuthOptions = Effect.gen(function* () {
  const { db, drizzle } = yield* IamDb.IamDb;
  const { sendResetPassword, sendVerification } = yield* AuthEmailService;
  const plugins = yield* AllPlugins;
  // ... configuration
  return yield* Effect.succeed({
    // ... other options
    plugins,
    // ... more options
  } satisfies BetterAuthOptions);
});
```

**Sources:**[packages/iam/infra/src/adapters/better-auth/Auth.service.ts 27-237](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L27-L237)

### AuthService Layer

The `AuthService` is defined as an Effect service with explicit dependencies:

```
export class AuthService extends Effect.Service<AuthService>()("AuthService", {
  accessors: true,
  dependencies: [AuthEmailService.DefaultWithoutDependencies, IamDb.IamDb.Live],
  effect: Effect.flatMap(AuthOptions, (opts) =>
    Effect.succeed({
      auth: betterAuth(opts),
    })
  ),
}) {}
```

Key characteristics:

*   Declares dependencies on `AuthEmailService` and `IamDb` layers
*   Uses `Effect.flatMap` to transform options into the service
*   Exposes the `auth` property containing the better-auth instance
*   Enables dependency injection through Effect's Layer system

**Sources:**[packages/iam/infra/src/adapters/better-auth/Auth.service.ts 241-249](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L241-L249)

Configuration Patterns
----------------------

### Effect-Based Configuration

All plugin configurations follow the Effect pattern:

1.   **Option Resolution**: Use `Effect.gen` to resolve dependencies
2.   **Type Safety**: Define explicit type aliases for plugin effects
3.   **Error Handling**: Plugins can fail with `SqlError` or `ConfigError`
4.   **Runtime Integration**: Access runtime for executing database operations

**Sources:**[packages/iam/infra/src/adapters/better-auth/plugins/organization/organization.plugin.ts 160-174](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/plugins/organization/organization.plugin.ts#L160-L174)

### Database Hook Execution

Database hooks execute Effect programs within the better-auth lifecycle:

```
const runtime = yield* Effect.runtime();
const runPromise = Runtime.runPromise(runtime);

// In hook:
await runPromise(program.pipe(Effect.withSpan("spanName")));
```

This pattern:

*   Captures the Effect runtime during configuration
*   Creates a `runPromise` helper bound to that runtime
*   Executes Effect programs asynchronously within hooks
*   Wraps operations in telemetry spans for observability

**Sources:**[packages/iam/infra/src/adapters/better-auth/plugins/organization/organization.plugin.ts 19-20](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/plugins/organization/organization.plugin.ts#L19-L20)[packages/iam/infra/src/adapters/better-auth/plugins/organization/organization.plugin.ts 154](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/plugins/organization/organization.plugin.ts#L154-L154)

### Additional Fields Pattern

Both plugins extend better-auth schemas using the `additionalFields` pattern:

```
schema: {
  [tableName]: {
    additionalFields: {
      fieldName: {
        type: "string" | "number" | "boolean" | "date" | "json" | [...enums],
        required: true | false,
        defaultValue?: any,
      },
      ...commonExtraFields,
    },
  },
}
```

The `commonExtraFields` import provides shared tracking fields:

*   `createdBy`: User ID who created the record
*   `createdAt`: Creation timestamp
*   `updatedAt`: Last update timestamp
*   `source`: Origin/method of creation

**Sources:**[packages/iam/infra/src/adapters/better-auth/plugins/organization/organization.plugin.ts 43-115](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/plugins/organization/organization.plugin.ts#L43-L115)[packages/iam/infra/src/adapters/better-auth/Auth.service.ts 24](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L24-L24)
