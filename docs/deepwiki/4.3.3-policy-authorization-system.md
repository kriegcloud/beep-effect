# Policy Authorization System | kriegcloud/beep-effect | DeepWiki

_Source: https://deepwiki.com/kriegcloud/beep-effect/4.3.3-policy-authorization-system_

Relevant source files
*   [apps/mcp/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/apps/mcp/package.json)
*   [apps/mcp/src/server.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/apps/mcp/src/server.ts)
*   [apps/server/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/apps/server/package.json)
*   [docker-compose.yml](https://github.com/kriegcloud/beep-effect/blob/b64126f6/docker-compose.yml)
*   [packages/common/constants/src/paths/asset-paths.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/constants/src/paths/asset-paths.ts)
*   [packages/common/constants/src/paths/generated/asset-paths.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/constants/src/paths/generated/asset-paths.ts)
*   [packages/common/schema/src/annotations/default.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/annotations/default.ts)
*   [packages/iam/infra/src/adapters/better-auth/Auth.service.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts)
*   [packages/iam/sdk/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/package.json)
*   [packages/iam/sdk/src/clients/sign-in/sign-in.client.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/src/clients/sign-in/sign-in.client.ts)
*   [packages/iam/sdk/src/index.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/src/index.ts)
*   [packages/iam/ui/src/sign-up/sign-up.view.tsx](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/src/sign-up/sign-up.view.tsx)
*   [packages/runtime/client/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/package.json)
*   [packages/runtime/client/src/services/runtime/live-layer.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts)
*   [packages/runtime/server/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/package.json)
*   [packages/runtime/server/src/server-runtime.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts)
*   [packages/shared/domain/src/Policy.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts)
*   [packages/shared/domain/test/internal/policy.test.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/test/internal/policy.test.ts)
*   [packages/shared/domain/test/policy.test.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/test/policy.test.ts)

Purpose and Scope
-----------------

The Policy Authorization System provides a declarative, composable framework for enforcing access control in the beep-effect application. It builds on Effect's functional programming primitives to create type-safe authorization checks that integrate seamlessly with the authentication layer.

This document covers the `Policy` abstraction, the `CurrentUser` context, permission definitions, policy combinators, and how policies are applied to protect effects. For authentication mechanisms (session management, OAuth, etc.), see [AuthService and Better-Auth](https://deepwiki.com/kriegcloud/beep-effect/4.3.1-authservice-and-better-auth).

**Sources:**[packages/shared/domain/src/Policy.ts 1-123](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L1-L123)

* * *

Overview
--------

The Policy system represents authorization checks as `Effect` values that either succeed (granting access) or fail with `BeepError.Forbidden` (denying access). Policies are composable, allowing complex authorization rules to be built from simpler components.

A policy is a function that:

1.   Accesses the `CurrentUser` context to inspect user identity and permissions
2.   Evaluates authorization logic
3.   Returns `Effect<void, BeepError.Forbidden, CurrentUser>` on success
4.   Fails with `BeepError.Forbidden` if access should be denied

**Key characteristics:**

*   **Declarative**: Policies describe _what_ access is allowed, not _how_ to enforce it
*   **Composable**: Complex policies are built from simpler ones using combinators
*   **Type-safe**: All permissions and policies are type-checked at compile time
*   **Effect-integrated**: Policies are applied using Effect operators and run within the Effect runtime

**Sources:**[packages/shared/domain/src/Policy.ts 70-75](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L70-L75)

* * *

Core Concepts
-------------

### CurrentUser Context

The `CurrentUser` service tag carries authenticated user information throughout the Effect runtime. It is provided by the authentication middleware and consumed by policies.

```
class CurrentUser extends Context.Tag("CurrentUser")<
  CurrentUser,
  {
    readonly sessionId: IamEntityIds.SessionId.Type;
    readonly userId: SharedEntityIds.UserId.Type;
    readonly permissions: Set<Permission>;
  }
>() {}
```

**Properties:**

| Property | Type | Description |
| --- | --- | --- |
| `sessionId` | `SessionId.Type` | The current session identifier |
| `userId` | `UserId.Type` | The authenticated user's identifier |
| `permissions` | `Set<Permission>` | The set of permissions granted to the user |

The `CurrentUser` context is thread-safe and flows through the Effect context automatically, similar to React Context but for server-side Effect programs.

**Sources:**[packages/shared/domain/src/Policy.ts 52-59](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L52-L59)

* * *

### Permissions

Permissions are string literals following the format `"resource:action"`. They are statically defined and type-checked at compile time.

The permission system is generated by `makePermissions()`, which takes a record of resource names to action arrays:

```
const Permissions = internal.makePermissions({
  __test: ["read", "manage", "delete"],
  [SharedEntityIds.OrganizationId.tableName]: commonPermissions,
  [SharedEntityIds.TeamId.tableName]: commonPermissions,
  [SharedEntityIds.FileId.tableName]: commonPermissions,
  // ... more resources
} as const);
```

**Example permissions:**

*   `"organization:read"` - Read organization data
*   `"team:manage"` - Manage team settings
*   `"file:delete"` - Delete files
*   `"user:read"` - Read user profiles

The `Permission` schema enforces that only valid permission strings are accepted:

```
export const Permission = Schema.Literal(...Permissions).annotations({
  identifier: "Permission",
});
export type Permission = typeof Permission.Type;
```

**Sources:**[packages/shared/domain/src/Policy.ts 11-46](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L11-L46)[packages/shared/domain/test/internal/policy.test.ts 5-30](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/test/internal/policy.test.ts#L5-L30)

* * *

### Policy Type

A policy is defined as an Effect that requires `CurrentUser` and either succeeds with `void` or fails with `BeepError.Forbidden`:

`type Policy<E = never, R = never> = Effect.Effect<void, BeepError.Forbidden | E, CurrentUser | R>;`
**Type parameters:**

*   `E` - Additional error types the policy may produce
*   `R` - Additional context requirements beyond `CurrentUser`

Policies are lazy and only evaluated when run. They can compose with other Effects, enabling complex authorization flows.

**Sources:**[packages/shared/domain/src/Policy.ts 75](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L75-L75)

* * *

Creating Policies
-----------------

### policy() Function

The `policy()` function creates a policy from a predicate that evaluates the current user:

```
export const policy = <E, R>(
  predicate: (user: CurrentUser["Type"]) => Effect.Effect<boolean, E, R>,
  message?: string
): Policy<E, R>
```

**Parameters:**

| Parameter | Type | Description |
| --- | --- | --- |
| `predicate` | `(user) => Effect<boolean>` | Function that returns true to grant access |
| `message` | `string` (optional) | Custom error message for denial |

**Example:**

```
const isTestUser = policy((user) =>
  Effect.succeed(user.userId === "user__117a5b57-21d9-44d9-a76b-13136af7c0ae")
);
```

The predicate receives the `CurrentUser` and can perform synchronous or asynchronous checks. If the predicate returns `false`, the policy fails with `BeepError.Forbidden`.

**Sources:**[packages/shared/domain/src/Policy.ts 80-90](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L80-L90)[packages/shared/domain/test/policy.test.ts 24-65](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/test/policy.test.ts#L24-L65)

* * *

### permission() Helper

The `permission()` helper creates a policy that checks for a specific permission:

```
export const permission = (requiredPermission: Permission): Policy =>
  policy((user) => Effect.succeed(user.permissions.has(requiredPermission)));
```

This is the most common way to create permission-based policies.

**Example:**

```
const canReadOrganization = permission("organization:read");
const canManageTeam = permission("team:manage");
const canDeleteFile = permission("file:delete");
```

**Sources:**[packages/shared/domain/src/Policy.ts 121-122](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L121-L122)[packages/shared/domain/test/policy.test.ts 68-88](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/test/policy.test.ts#L68-L88)

* * *

Policy Combinators
------------------

### all() - AND Semantics

The `all()` combinator requires all provided policies to pass. It uses sequential evaluation with short-circuit failure.

```
export const all = <E, R>(...policies: NonEmptyReadonlyArray<Policy<E, R>>): Policy<E, R> =>
  Effect.all(policies, {
    concurrency: 1,
    discard: true,
  });
```

**Behavior:**

*   Evaluates policies sequentially
*   Short-circuits on first failure
*   Succeeds only if all policies succeed

**Example:**

```
const canAdmin = all(
  permission("organization:read"),
  permission("organization:manage")
);
```

**Sources:**[packages/shared/domain/src/Policy.ts 105-109](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L105-L109)[packages/shared/domain/test/policy.test.ts 132-174](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/test/policy.test.ts#L132-L174)

* * *

### any() - OR Semantics

The `any()` combinator requires at least one policy to pass. It uses sequential evaluation with short-circuit success.

```
export const any = <E, R>(...policies: NonEmptyReadonlyArray<Policy<E, R>>): Policy<E, R> =>
  Effect.firstSuccessOf(policies);
```

**Behavior:**

*   Evaluates policies sequentially
*   Short-circuits on first success
*   Fails only if all policies fail

**Example:**

```
const canAccess = any(
  permission("file:read"),
  permission("file:manage")
);
```

**Sources:**[packages/shared/domain/src/Policy.ts 115-116](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L115-L116)[packages/shared/domain/test/policy.test.ts 176-214](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/test/policy.test.ts#L176-L214)

* * *

Diagram: Policy Composition Patterns
------------------------------------

**Sources:**[packages/shared/domain/src/Policy.ts 105-122](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L105-L122)[packages/shared/domain/test/policy.test.ts 216-305](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/test/policy.test.ts#L216-L305)

* * *

Applying Policies
-----------------

### withPolicy() Operator

The `withPolicy()` operator applies a policy to an Effect, ensuring the policy passes before the Effect executes:

```
export const withPolicy =
  <E, R>(policy: Policy<E, R>) =>
  <A, E2, R2>(self: Effect.Effect<A, E2, R2>) =>
    Effect.zipRight(policy, self);
```

**Usage pattern:**

```
const protectedEffect = Effect.succeed("sensitive data").pipe(
  withPolicy(permission("resource:read"))
);
```

If the policy fails, the Effect is never executed, preventing unauthorized side effects.

**Sources:**[packages/shared/domain/src/Policy.ts 96-99](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L96-L99)[packages/shared/domain/test/policy.test.ts 90-130](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/test/policy.test.ts#L90-L130)

* * *

Diagram: Policy Evaluation Flow
-------------------------------

**Sources:**[packages/shared/domain/src/Policy.ts 80-99](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L80-L99)[packages/iam/infra/src/adapters/better-auth/Auth.service.ts 161-192](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L161-L192)

* * *

Integration with Authentication
-------------------------------

### UserAuthMiddleware

The `UserAuthMiddleware` connects the authentication layer to the policy system by providing the `CurrentUser` context:

```
export class UserAuthMiddleware extends HttpApiMiddleware.Tag<UserAuthMiddleware>()("UserAuthMiddleware", {
  failure: BeepError.Unauthorized,
  provides: CurrentUser,
}) {}
```

This middleware:

1.   Authenticates the incoming request
2.   Queries the user's session and permissions from the database
3.   Provides the `CurrentUser` context to downstream effects
4.   Fails with `BeepError.Unauthorized` if authentication fails

**Sources:**[packages/shared/domain/src/Policy.ts 61-64](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L61-L64)

* * *

### Better-Auth Integration

The authentication system uses better-auth database hooks to populate permissions when sessions are created:

**Session Creation Hook:**[packages/iam/infra/src/adapters/better-auth/Auth.service.ts 161-218](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L161-L218)

When a session is created, the system:

1.   Queries all organizations the user is a member of
2.   Extracts role information for each organization
3.   Stores organization context in the session
4.   Sets the active organization ID

This session data is then transformed into the `CurrentUser` context by the authentication middleware, making permissions available to policies.

**Sources:**[packages/iam/infra/src/adapters/better-auth/Auth.service.ts 161-218](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L161-L218)

* * *

Diagram: Permission Flow
------------------------

**Sources:**[packages/iam/infra/src/adapters/better-auth/Auth.service.ts 161-218](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L161-L218)[packages/shared/domain/src/Policy.ts 52-122](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L52-L122)

* * *

Error Handling
--------------

Policies fail with `BeepError.Forbidden` when access is denied. This error:

*   Is a tagged error type that can be pattern-matched
*   Integrates with the HTTP error handling system
*   Maps to HTTP 403 Forbidden status codes
*   Can carry custom error messages

**Default behavior:**

```
policy((user) => Effect.succeed(false))
// Fails with: new BeepError.Forbidden()
```

**Custom message:**

```
policy(
  (user) => Effect.succeed(false),
  "You must be an organization admin"
)
// Fails with: new BeepError.Forbidden({ message: "You must be an organization admin" })
```

The error system distinguishes between:

*   **Unauthorized (401)**: Authentication failed - no `CurrentUser` context exists
*   **Forbidden (403)**: Authentication succeeded but authorization failed - user lacks required permissions

**Sources:**[packages/shared/domain/src/Policy.ts 86-89](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L86-L89)[packages/shared/domain/test/policy.test.ts 34-56](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/test/policy.test.ts#L34-L56)

* * *

Usage Examples
--------------

### Example 1: Simple Permission Check

```
const readOrganization = Effect.gen(function* () {
  const db = yield* IamDb;
  return yield* db.query.organization.findMany();
}).pipe(
  withPolicy(permission("organization:read"))
);
```

**Sources:**[packages/shared/domain/test/policy.test.ts 68-88](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/test/policy.test.ts#L68-L88)

* * *

### Example 2: Admin or Self Access

```
const canEditUser = (targetUserId: UserId.Type) => {
  const isAdmin = all(
    permission("user:read"),
    permission("user:manage")
  );

  const isSelf = policy((user) =>
    Effect.succeed(user.userId === targetUserId)
  );

  return any(isAdmin, isSelf);
};

const updateUserProfile = (userId: UserId.Type, data: ProfileData) =>
  Effect.gen(function* () {
    const db = yield* IamDb;
    return yield* db.update(users)
      .set(data)
      .where(eq(users.id, userId));
  }).pipe(
    withPolicy(canEditUser(userId))
  );
```

**Sources:**[packages/shared/domain/test/policy.test.ts 262-305](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/test/policy.test.ts#L262-L305)

* * *

### Example 3: Complex Nested Policy

```
// Rule: (CanRead AND CanManage) OR CanDelete OR IsTestUser
const complexAccess = any(
  all(
    permission("resource:read"),
    permission("resource:manage")
  ),
  permission("resource:delete"),
  policy((user) => Effect.succeed(user.userId === testUserId))
);

const sensitiveOperation = Effect.succeed("data").pipe(
  withPolicy(complexAccess)
);
```

**Sources:**[packages/shared/domain/test/policy.test.ts 216-248](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/test/policy.test.ts#L216-L248)

* * *

Summary
-------

The Policy Authorization System provides:

| Feature | Implementation |
| --- | --- |
| **Context Management** | `CurrentUser` service tag with user identity and permissions |
| **Permission Model** | Type-safe string literals in `"resource:action"` format |
| **Policy Creation** | `policy()` function for custom logic, `permission()` helper for permission checks |
| **Composition** | `all()` for AND semantics, `any()` for OR semantics |
| **Integration** | `withPolicy()` operator applies policies to protected effects |
| **Error Handling** | `BeepError.Forbidden` for authorization failures |
| **Authentication** | `UserAuthMiddleware` bridges authentication to authorization |

The system leverages Effect's functional programming model to create declarative, composable, and type-safe authorization rules that prevent unauthorized access at the type and runtime levels.

**Sources:**[packages/shared/domain/src/Policy.ts 1-123](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L1-L123)[packages/shared/domain/test/policy.test.ts 1-307](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/test/policy.test.ts#L1-L307)
