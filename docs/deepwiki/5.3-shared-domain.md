# Shared Domain | kriegcloud/beep-effect | DeepWiki

_Source: https://deepwiki.com/kriegcloud/beep-effect/5.3-shared-domain_

Relevant source files
*   [apps/mcp/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/apps/mcp/package.json)
*   [apps/mcp/src/server.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/apps/mcp/src/server.ts)
*   [apps/server/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/apps/server/package.json)
*   [packages/common/schema/src/EntityId.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/EntityId.ts)
*   [packages/common/schema/src/annotations/default.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/annotations/default.ts)
*   [packages/shared/domain/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/package.json)
*   [packages/shared/domain/src/Policy.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts)
*   [packages/shared/domain/src/execute.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/execute.ts)
*   [packages/shared/domain/test/internal/policy.test.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/test/internal/policy.test.ts)
*   [packages/shared/domain/test/policy.test.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/test/policy.test.ts)
*   [packages/shared/domain/tsconfig.build.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/tsconfig.build.json)
*   [packages/shared/domain/tsconfig.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/tsconfig.json)
*   [packages/shared/domain/tsconfig.src.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/tsconfig.src.json)
*   [packages/shared/domain/tsconfig.test.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/tsconfig.test.json)

Purpose and Scope
-----------------

The Shared Domain package (`@beep/shared-domain`) provides foundational domain concepts, value objects, and authorization primitives that are used across multiple bounded contexts in the application. This includes the EntityId factory pattern for creating type-safe domain identifiers, the Policy authorization framework, permission definitions, and the CurrentUser authentication context.

This page documents the shared abstractions and common domain logic. For context-specific domain models, see [IAM Context](https://deepwiki.com/kriegcloud/beep-effect/5.1-iam-context) and [Files Context](https://deepwiki.com/kriegcloud/beep-effect/5.2-files-context). For the technical implementation of the EntityId pattern at the schema level, see [EntityId Pattern](https://deepwiki.com/kriegcloud/beep-effect/6.1.1-entityid-pattern).

**Sources:**[packages/shared/domain/package.json 1-64](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/package.json#L1-L64)

* * *

Package Structure
-----------------

The `@beep/shared-domain` package is organized as a standard TypeScript library package with ESM and CJS output formats. It depends on the Effect ecosystem and common packages for type safety and functional composition.

**Sources:**[packages/shared/domain/package.json 1-64](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/package.json#L1-L64)[packages/shared/domain/tsconfig.src.json 1-49](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/tsconfig.src.json#L1-L49)

* * *

Entity Identifier System
------------------------

While the EntityId factory implementation resides in `@beep/schema`, the Shared Domain package defines the specific entity ID instances used across contexts. The EntityId system provides type-safe, branded identifiers for all domain entities with both public (UUID-based) and private (serial integer) identifiers.

### EntityId Factory Pattern

The `EntityId.make` factory creates type-safe schema instances for entity identifiers. Each entity ID is a template literal combining a snake_case table name with a UUID suffix.

**Format:**`{table_name}__{uuid}`

**Example:**`user__117a5b57-21d9-44d9-a76b-13136af7c0ae`

**Sources:**[packages/common/schema/src/EntityId.ts 91-162](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/EntityId.ts#L91-L162)

### Dual-Identifier Pattern

Each entity in the system has two identifiers:

| Identifier | Type | Purpose | Column Name | Visibility |
| --- | --- | --- | --- | --- |
| Public ID | `text` (UUID-based) | External references, API responses, URLs | `id` | Exposed to clients |
| Private ID | `serial` (integer) | Database joins, internal queries, foreign keys | `_row_id` | Internal only |

This pattern provides security by exposing only opaque UUIDs externally while maintaining efficient integer-based joins internally.

**Sources:**[packages/common/schema/src/EntityId.ts 53-75](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/schema/src/EntityId.ts#L53-L75)

### Shared Entity IDs

The Shared Domain defines entity IDs for entities that appear across multiple contexts:

```
// Examples from the codebase
SharedEntityIds.UserId           // user__{uuid}
SharedEntityIds.OrganizationId   // organization__{uuid}
SharedEntityIds.TeamId           // team__{uuid}
SharedEntityIds.FileId           // file__{uuid}
SharedEntityIds.AuditLogId       // audit_log__{uuid}
```

These IDs are imported and used by both IAM and Files contexts, ensuring consistent identifier formats across bounded contexts.

**Sources:**[packages/shared/domain/src/Policy.ts 8](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L8-L8)

* * *

The Policy system provides a declarative, composable authorization framework built on Effect. Policies are pure functions that evaluate access control rules against the current authenticated user.

### Policy Architecture

**Sources:**[packages/shared/domain/src/Policy.ts 70-122](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L70-L122)

### Policy Type Definition

A `Policy` is an Effect that:

*   Returns `void` on success (access granted)
*   Fails with `BeepError.Forbidden` on access denial
*   Requires `CurrentUser` in its context

```
type Policy<E = never, R = never> = Effect.Effect<
  void,
  BeepError.Forbidden | E,
  CurrentUser | R
>;
```

**Sources:**[packages/shared/domain/src/Policy.ts 75](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L75-L75)

### Creating Policies

Policies are created using the `policy` factory function, which takes a predicate that evaluates the current user:

```
const policy = <E, R>(
  predicate: (user: CurrentUser["Type"]) => Effect.Effect<boolean, E, R>,
  message?: string
): Policy<E, R>
```

The predicate receives the `CurrentUser` and returns an Effect of boolean. If the predicate returns `false`, the policy fails with `Forbidden`.

**Sources:**[packages/shared/domain/src/Policy.ts 80-90](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L80-L90)

### Policy Combinators

#### All Combinator (AND)

The `all` combinator creates a policy that succeeds only if all provided policies succeed. Policies are evaluated sequentially with short-circuit behavior on the first failure.

`const all = <E, R>(...policies: NonEmptyReadonlyArray<Policy<E, R>>): Policy<E, R>`
**Sources:**[packages/shared/domain/src/Policy.ts 105-109](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L105-L109)

#### Any Combinator (OR)

The `any` combinator creates a policy that succeeds if at least one provided policy succeeds. It uses `Effect.firstSuccessOf` for short-circuit behavior on the first success.

`const any = <E, R>(...policies: NonEmptyReadonlyArray<Policy<E, R>>): Policy<E, R>`
**Sources:**[packages/shared/domain/src/Policy.ts 115-116](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L115-L116)

### Applying Policies to Effects

The `withPolicy` operator applies a policy as a pre-check to any Effect. If the policy passes, the Effect executes normally. If the policy fails, the Effect never executes and fails with `Forbidden`.

```
const withPolicy = <E, R>(policy: Policy<E, R>) =>
  <A, E2, R2>(self: Effect.Effect<A, E2, R2>) =>
    Effect.zipRight(policy, self)
```

**Sources:**[packages/shared/domain/src/Policy.ts 96-99](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L96-L99)

* * *

CurrentUser and Permissions
---------------------------

### CurrentUser Context

The `CurrentUser` service provides the authenticated user context to all policies and protected effects.

**Sources:**[packages/shared/domain/src/Policy.ts 52-59](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L52-L59)

### Permission System

Permissions are defined as string literals in the format `{table_name}:{action}`. The permission system uses the `makePermissions` internal utility to generate all valid permission strings from a permission schema.

#### Permission Definition

**Sources:**[packages/shared/domain/src/Policy.ts 13-46](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L13-L46)

#### Common Permissions

The codebase defines common permissions for all entities:

| Action | Description |
| --- | --- |
| `read` | View/retrieve entity data |
| `manage` | Update/modify entity data |
| `delete` | Remove/delete entity |

Each entity table in the system has these three permission types automatically generated.

**Sources:**[packages/shared/domain/src/Policy.ts 13-41](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L13-L41)

#### Permission Checking

The `permission` helper creates a policy that checks if the current user has a specific permission:

```
const permission = (requiredPermission: Permission): Policy =>
  policy((user) => Effect.succeed(user.permissions.has(requiredPermission)))
```

**Sources:**[packages/shared/domain/src/Policy.ts 121-122](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L121-L122)

* * *

UserAuthMiddleware
------------------

The `UserAuthMiddleware` is an HTTP middleware tag that provides the `CurrentUser` service to the request context. It integrates with the better-auth authentication system.

**Sources:**[packages/shared/domain/src/Policy.ts 61-64](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L61-L64)

* * *

Policy Composition Examples
---------------------------

### AND Logic (All Must Pass)

```
// Both read AND manage permissions required
const adminPolicy = Policy.all(
  Policy.permission("user:read"),
  Policy.permission("user:manage")
);
```

### OR Logic (Any Must Pass)

```
// Either admin permissions OR accessing own data
const accessPolicy = Policy.any(
  adminPolicy,
  Policy.policy((user) => Effect.succeed(user.userId === targetUserId))
);
```

### Complex Nested Logic

```
// (Read AND Manage) OR Delete OR IsOwner
const complexPolicy = Policy.any(
  Policy.all(
    Policy.permission("resource:read"),
    Policy.permission("resource:manage")
  ),
  Policy.permission("resource:delete"),
  Policy.policy((user) => Effect.succeed(user.userId === ownerId))
);
```

**Sources:**[packages/shared/domain/test/policy.test.ts 226-304](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/test/policy.test.ts#L226-L304)

* * *

Internal Utilities
------------------

The `_internal` directory contains internal implementation details not exposed in the public API.

### makePermissions Utility

The `makePermissions` function generates permission string literals from a permission schema. It takes a record of table names to action arrays and produces a flat array of `"table:action"` strings.

```
makePermissions({
  users: ["read", "manage"],
  posts: ["delete"]
})
// Returns: ["users:read", "users:manage", "posts:delete"]
```

**Sources:**[packages/shared/domain/test/internal/policy.test.ts 1-30](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/test/internal/policy.test.ts#L1-L30)

* * *

Integration with Bounded Contexts
---------------------------------

The Shared Domain provides foundational types and utilities used by both IAM and Files contexts:

**Sources:**[packages/shared/domain/src/Policy.ts 1-123](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/shared/domain/src/Policy.ts#L1-L123)
