# Database Setup | kriegcloud/beep-effect | DeepWiki

_Source: https://deepwiki.com/kriegcloud/beep-effect/3.3-database-setup_

Relevant source files
*   [.github/workflows/check.yml](https://github.com/kriegcloud/beep-effect/blob/b64126f6/.github/workflows/check.yml)
*   [apps/web/src/app/api/auth/[...all]/route.ts](https://deepwiki.com/kriegcloud/beep-effect/apps/web/src/app/api/auth/%5B...all%5D/route.ts)
*   [packages/_internal/db-admin/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/package.json)
*   [packages/_internal/db-admin/src/Db.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/src/Db.ts)
*   [packages/_internal/db-admin/src/execute.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/src/execute.ts)
*   [packages/_internal/db-admin/test/pg-container.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts)
*   [packages/_internal/db-admin/tsconfig.test.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/tsconfig.test.json)
*   [packages/common/errors/src/shared.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/errors/src/shared.ts)
*   [packages/core/db/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/package.json)
*   [packages/core/db/src/db.factory.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts)
*   [packages/core/db/src/errors.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/errors.ts)
*   [packages/core/db/src/index.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/index.ts)
*   [packages/core/db/src/postgres/common.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/postgres/common.ts)
*   [packages/core/db/src/postgres/postgres-error.enum.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/postgres/postgres-error.enum.ts)
*   [packages/core/db/src/types.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/types.ts)
*   [packages/files/infra/src/adapters/repos/_common.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/infra/src/adapters/repos/_common.ts)
*   [packages/files/infra/src/db/Db.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/infra/src/db/Db.ts)
*   [packages/iam/infra/src/adapters/repos/_common.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/repos/_common.ts)
*   [packages/iam/infra/src/db/Db.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/db/Db.ts)

This page provides instructions for setting up PostgreSQL, running database migrations, and using development tools for the beep-effect repository. It covers the installation of required database extensions, migration execution with Drizzle Kit, and the Docker-based testing infrastructure.

For information about the database layer architecture and factory pattern, see [Database Layer](https://deepwiki.com/kriegcloud/beep-effect/4.1-database-layer). For environment variable configuration, see [Environment Configuration](https://deepwiki.com/kriegcloud/beep-effect/3.2-environment-configuration).

Purpose and Scope
-----------------

This guide walks through the practical steps required to:

*   Install and configure PostgreSQL with required extensions
*   Execute database migrations using Drizzle Kit
*   Use the database studio for schema inspection and data management
*   Set up the Docker-based test infrastructure with PgContainer

Prerequisites
-------------

Before setting up the database, ensure you have:

*   PostgreSQL 15 or later installed
*   Access to create databases and extensions
*   Environment variables configured (see [Environment Configuration](https://deepwiki.com/kriegcloud/beep-effect/3.2-environment-configuration))
*   pnpm installed with dependencies (see [Installation and Setup](https://deepwiki.com/kriegcloud/beep-effect/3.1-installation-and-setup))

**Sources:**[packages/_internal/db-admin/test/pg-container.ts 142-146](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L142-L146)

PostgreSQL Installation
-----------------------

### Local Installation

The codebase requires PostgreSQL with the `pg_uuidv7` extension. You can install PostgreSQL through:

**Option 1: System Package Manager**

```
# macOS (Homebrew)
brew install postgresql@15

# Ubuntu/Debian
sudo apt-get install postgresql-15

# Start the service
brew services start postgresql@15  # macOS
sudo systemctl start postgresql     # Linux
```

**Option 2: Docker**

```
# Using the pg_uuidv7-enabled image
docker run -d \
  --name beep-postgres \
  -e POSTGRES_USER=postgres \
  -e POSTGRES_PASSWORD=postgres \
  -e POSTGRES_DB=beep \
  -p 5432:5432 \
  ghcr.io/fboulnois/pg_uuidv7:1.6.0
```

**Sources:**[packages/_internal/db-admin/test/pg-container.ts 158-165](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L158-L165)

### Database Creation

Create the application database:

```
# Connect to PostgreSQL
psql -U postgres

# Create database
CREATE DATABASE beep;

# Connect to the database
\c beep
```

Required Extensions
-------------------

### pg_uuidv7 Extension

The codebase uses the `pg_uuidv7` extension for generating UUIDs with time-ordering properties. This extension must be installed before running migrations.

`CREATE EXTENSION IF NOT EXISTS pg_uuidv7;`
**Diagram: Extension Dependencies**

The extension is automatically created during test container setup and should be manually created in local/production databases before running migrations.

**Sources:**[packages/_internal/db-admin/test/pg-container.ts 179-186](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L179-L186)

Migration Management with Drizzle Kit
-------------------------------------

The `@beep/db-admin` package manages all database migrations using Drizzle Kit. Migrations are stored in the `packages/_internal/db-admin/drizzle` directory.

### Available Migration Scripts

| Script | Command | Purpose |
| --- | --- | --- |
| `db:generate` | `pnpm dotenvx drizzle-kit generate` | Generate migration files from schema changes |
| `db:migrate` | `pnpm dotenvx drizzle-kit migrate` | Execute pending migrations |
| `db:push` | `pnpm dotenvx drizzle-kit push` | Push schema changes directly (development only) |
| `db:studio` | `pnpm dotenvx drizzle-kit studio` | Launch Drizzle Studio UI |
| `db:reset` | `bun src/scripts/ResetDatabase.ts` | Reset database to initial state |

**Sources:**[packages/_internal/db-admin/package.json 28-32](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/package.json#L28-L32)

### Running Migrations

**Diagram: Migration Execution Flow**

**Sources:**[packages/_internal/db-admin/package.json 29](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/package.json#L29-L29)[packages/_internal/db-admin/test/pg-container.ts 188-198](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L188-L198)

### Generate New Migrations

When schema definitions change in `*-tables` packages:

```
cd packages/_internal/db-admin
pnpm db:generate
```

This generates SQL migration files in `drizzle/` based on schema changes detected in:

*   `@beep/iam-tables/schema`
*   `@beep/files-tables/schema`
*   `@beep/shared-tables/schema`

**Sources:**[packages/_internal/db-admin/package.json 28](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/package.json#L28-L28)

### Execute Migrations

Apply pending migrations to the database:

```
cd packages/_internal/db-admin
pnpm db:migrate
```

The migration executor:

1.   Reads migration files from `drizzle/` directory
2.   Checks the `__drizzle_migrations` table for applied migrations
3.   Executes pending migrations in order
4.   Records successful migrations

**Sources:**[packages/_internal/db-admin/package.json 29](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/package.json#L29-L29)[packages/_internal/db-admin/test/pg-container.ts 191-197](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L191-L197)

### Development Schema Push

For rapid iteration during development, push schema changes directly without generating migration files:

```
cd packages/_internal/db-admin
pnpm db:push
```

⚠️ **Warning:** This bypasses migration history and should only be used in development environments.

**Sources:**[packages/_internal/db-admin/package.json 30](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/package.json#L30-L30)

Database Studio
---------------

Drizzle Studio provides a web-based UI for inspecting schemas and managing data.

### Launching Studio

```
cd packages/_internal/db-admin
pnpm db:studio
```

This starts a local server (typically at `http://localhost:4983`) with:

*   Schema visualization
*   Table data browser
*   Query editor
*   Relationship explorer

**Diagram: Studio Architecture**

**Sources:**[packages/_internal/db-admin/package.json 31](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/package.json#L31-L31)

Connection Configuration
------------------------

### Connection String Format

The database connection is configured via environment variables:

```
DB_PG_URL="postgresql://username:password@host:port/database"
DB_PG_SSL="false"  # Set to true for production
```

**Diagram: Connection Layer**

**Sources:**[packages/core/db/src/db.factory.ts 44-51](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts#L44-L51)[packages/iam/infra/src/db/Db.ts 9-18](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/db/Db.ts#L9-L18)[packages/files/infra/src/db/Db.ts 9-14](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/infra/src/db/Db.ts#L9-L14)

### Connection Options

The `PgClient.layer` accepts configuration options:

| Option | Type | Description |
| --- | --- | --- |
| `url` | `Redacted<string>` | PostgreSQL connection URL |
| `ssl` | `boolean` | Enable SSL/TLS connection |
| `transformQueryNames` | `(str: string) => string` | Transform column names in queries (camelToSnake) |
| `transformResultNames` | `(str: string) => string` | Transform column names in results (snakeToCamel) |

**Sources:**[packages/core/db/src/db.factory.ts 36-42](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts#L36-L42)[packages/_internal/db-admin/test/pg-container.ts 242-247](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L242-L247)

### Retry Configuration

The database layer includes exponential backoff retry logic for connection failures:

```
Schedule.identity<Layer.Layer.Error<typeof self>>().pipe(
  Schedule.check((input) => input._tag === "SqlError"),
  Schedule.intersect(Schedule.exponential("1 second")),
  Schedule.intersect(Schedule.recurs(2)),
  Schedule.onDecision(([[_error, duration], attempt], decision) =>
    decision._tag === "Continue"
      ? Effect.logInfo(`Retrying database connection in ${Duration.format(duration)} (attempt #${++attempt})`)
      : Effect.void
  )
)
```

This retries connection errors up to 2 times with exponential backoff starting at 1 second.

**Sources:**[packages/core/db/src/db.factory.ts 52-65](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts#L52-L65)

Testing Infrastructure
----------------------

### PgContainer Service

The codebase includes a Docker-based PostgreSQL test infrastructure using Testcontainers. The `PgContainer` service automatically:

1.   Checks if Docker is available
2.   Starts a PostgreSQL container with `pg_uuidv7` extension
3.   Runs migrations
4.   Seeds test data
5.   Provides isolated database instances for tests

**Diagram: PgContainer Lifecycle**

**Sources:**[packages/_internal/db-admin/test/pg-container.ts 141-212](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L141-L212)[packages/_internal/db-admin/test/pg-container.ts 214-265](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L214-L265)

### Preflight Checks

The test infrastructure performs preflight checks to determine if Docker is available:

```
const EXPLICIT_SKIP_ENV_VARS = [
  "BEEP_SKIP_PG_CONTAINER_TESTS",
  "SKIP_DOCKER_TESTS",
  "TESTCONTAINERS_DISABLED"
];
```

Tests are automatically skipped if:

*   Any skip environment variable is set
*   Docker daemon is not running
*   Docker socket is inaccessible
*   Docker networking is not supported

**Sources:**[packages/_internal/db-admin/test/pg-container.ts 43-53](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L43-L53)[packages/_internal/db-admin/test/pg-container.ts 91-135](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L91-L135)

### Container Configuration

The test container is configured with:

```
new PostgreSqlContainer("ghcr.io/fboulnois/pg_uuidv7:1.6.0")
  .withEnvironment({
    POSTGRES_USER: "test",
    POSTGRES_PASSWORD: "test",
    POSTGRES_DB: "test",
  })
  .withExposedPorts(5432)
  .start()
```

**Sources:**[packages/_internal/db-admin/test/pg-container.ts 158-165](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L158-L165)

### Test Layer Composition

The `PgContainer.Live` layer composes all necessary database services:

```
const pgClient = PgClient.layer({
  url: Redacted.make(container.getConnectionUri()),
  ssl: false,
  transformQueryNames: Str.camelToSnake,
  transformResultNames: Str.snakeToCamel,
});

const sliceDbLayer = Layer.mergeAll(IamDb.IamDb.Live, FilesDb.FilesDb.Live);
const reposLayer = Layer.mergeAll(IamRepos.layer, FilesRepos.layer);
const verticalSlicesLayer = Layer.provideMerge(reposLayer, sliceDbLayer);

return Layer.provideMerge(verticalSlicesLayer, pgClient);
```

This creates a complete test runtime with database access and repositories.

**Sources:**[packages/_internal/db-admin/test/pg-container.ts 242-255](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L242-L255)

Verification
------------

### Connection Test

Verify database connectivity:

```
# Using psql
psql -U postgres -d beep -c "SELECT version();"

# Using the application
cd packages/_internal/db-admin
pnpm execute
```

**Sources:**[packages/_internal/db-admin/test/pg-container.ts 200-209](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L200-L209)[packages/_internal/db-admin/package.json 36](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/package.json#L36-L36)

### Schema Verification

Confirm migrations are applied:

```
-- Check migration history
SELECT * FROM __drizzle_migrations ORDER BY created_at DESC;

-- Verify extensions
SELECT * FROM pg_extension WHERE extname = 'pg_uuidv7';

-- List tables
\dt
```

### Test Suite Execution

Run the test suite to verify the complete database setup:

`pnpm test --filter=@beep/db-admin`
This executes tests using the PgContainer infrastructure, validating:

*   Container startup and teardown
*   Extension installation
*   Migration execution
*   Data seeding
*   Query operations

**Sources:**[packages/_internal/db-admin/package.json 24](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/package.json#L24-L24)[.github/workflows/check.yml 49-58](https://github.com/kriegcloud/beep-effect/blob/b64126f6/.github/workflows/check.yml#L49-L58)

Troubleshooting
---------------

### Common Issues

| Issue | Symptoms | Solution |
| --- | --- | --- |
| Extension not found | `ERROR: extension "pg_uuidv7" does not exist` | Install pg_uuidv7 extension manually |
| Connection refused | `ECONNREFUSED` error | Verify PostgreSQL is running on correct port |
| Permission denied | `permission denied for database` | Grant necessary privileges to database user |
| Migration failed | SQL syntax error | Check migration file for compatibility issues |
| Docker unavailable | `PgContainerUnsupported` | Install Docker or set skip environment variable |

### Error Handling

The database layer provides typed error handling through `DbError`:

```
class DbError extends Data.TaggedError("DbError")<{
  readonly type: PostgresErrorType | "UNKNOWN";
  readonly cause: postgres.PostgresError;
}>
```

Database errors include:

*   PostgreSQL error codes (see `PostgresErrorEnum`)
*   Original error cause
*   Query and parameters (when available)

**Sources:**[packages/core/db/src/errors.ts 151-206](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/errors.ts#L151-L206)[packages/core/db/src/postgres/postgres-error.enum.ts 3-535](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/postgres/postgres-error.enum.ts#L3-L535)

### Debug Mode

Enable detailed logging for database operations:

```
# Set log level to Debug
LOG_LEVEL=Debug pnpm db:migrate

# View query execution
DB_DEBUG=true pnpm dev
```

**Sources:**[packages/core/db/src/errors.ts 145-149](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/errors.ts#L145-L149)
