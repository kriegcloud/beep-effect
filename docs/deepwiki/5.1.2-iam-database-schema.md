# IAM Database Schema | kriegcloud/beep-effect | DeepWiki

_Source: https://deepwiki.com/kriegcloud/beep-effect/5.1.2-iam-database-schema_

Relevant source files
*   [apps/web/src/app/api/auth/[...all]/route.ts](https://deepwiki.com/kriegcloud/beep-effect/apps/web/src/app/api/auth/%5B...all%5D/route.ts)
*   [apps/web/src/libs/next/index.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/apps/web/src/libs/next/index.ts)
*   [packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql)
*   [packages/_internal/db-admin/drizzle/meta/0000_snapshot.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json)
*   [packages/_internal/db-admin/drizzle/meta/_journal.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/_journal.json)
*   [packages/_internal/db-admin/src/Db.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/src/Db.ts)
*   [packages/_internal/db-admin/test/pg-container.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts)
*   [packages/_internal/db-admin/tsconfig.test.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/tsconfig.test.json)
*   [packages/common/constants/src/Csp.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/constants/src/Csp.ts)
*   [packages/core/db/src/index.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/index.ts)
*   [packages/core/db/src/types.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/types.ts)
*   [packages/core/env/src/client.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/env/src/client.ts)
*   [packages/core/env/src/server.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/env/src/server.ts)
*   [packages/files/infra/src/adapters/repos/_common.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/infra/src/adapters/repos/_common.ts)
*   [packages/files/infra/src/db/Db.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/files/infra/src/db/Db.ts)
*   [packages/iam/infra/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/package.json)
*   [packages/iam/infra/src/adapters/repos/_common.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/repos/_common.ts)
*   [packages/iam/infra/src/db/Db.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/db/Db.ts)
*   [packages/iam/ui/src/sign-up/sign-up-email.form.tsx](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/src/sign-up/sign-up-email.form.tsx)

This document provides a comprehensive reference for the IAM (Identity and Access Management) database schema, including table structures, relationships, indexes, and constraints. The schema is managed through Drizzle ORM migrations and follows a multi-tenant, organization-centric design.

For information about the IAM domain models and business logic, see [IAM Domain Layer](https://deepwiki.com/kriegcloud/beep-effect/5.1.1-iam-domain-layer). For implementation details of repositories and services that interact with these tables, see [IAM Infrastructure](https://deepwiki.com/kriegcloud/beep-effect/5.1.3-iam-infrastructure).

* * *

Schema Overview
---------------

The IAM database schema consists of 22 tables organized into six functional groups:

| Group | Tables | Purpose |
| --- | --- | --- |
| **Core Identity** | `user`, `account` | User profiles and authentication accounts |
| **Organization Management** | `organization`, `member`, `team`, `team_member` | Multi-tenant organization structure |
| **Session Management** | `session`, `verification` | Session tracking and verification tokens |
| **Authentication** | `passkey`, `two_factor`, `device_code`, `wallet_address`, `sso_provider` | Multi-factor and alternative authentication methods |
| **Authorization** | `invitation`, `organization_role`, `apikey`, `rate_limit` | Access control and API management |
| **OAuth Integration** | `oauth_application`, `oauth_consent`, `oauth_access_token`, `jwks` | OAuth2/OIDC provider functionality |
| **Billing** | `subscription` | Payment and subscription management |

The schema is created and managed through Drizzle Kit migrations, with the initial migration located at [packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 1-618](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L1-L618)

**Sources:**

*   [packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 1-618](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L1-L618)
*   [packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 1-3500](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L1-L3500)

* * *

Database Service Architecture
-----------------------------

The IAM database service is created using the `Db.make` factory pattern, which transforms the Drizzle schema into an Effect-based database service. The service provides type-safe query execution and transaction management.

**Sources:**

*   [packages/iam/infra/src/db/Db.ts 1-22](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/db/Db.ts#L1-L22)
*   [packages/core/db/src/db.factory.ts 1-50](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/db/src/db.factory.ts#L1-L50) (implied)

* * *

Entity Relationship Diagram
---------------------------

This diagram shows the core relationships in the IAM schema. All entity tables (those with an `organization_id` column) are scoped to organizations, implementing a multi-tenant architecture.

**Sources:**

*   [packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 6-3500](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L6-L3500)
*   [packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 532-564](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L532-L564)

* * *

Common Patterns
---------------

### Dual-Identifier Pattern

Every table uses a dual-identifier system combining public and private identifiers:

| Column | Type | Purpose | Example |
| --- | --- | --- | --- |
| `id` | `text` | Public identifier (UUIDv7), exposed in APIs | `"usr_01H2X3Y4Z5..."` |
| `_row_id` | `serial` | Private auto-incrementing primary key for internal joins | `12345` |

The `_row_id` is the actual primary key for performance, while `id` is the unique public identifier used in business logic and external APIs.

**Example from user table:**

```
"id" text NOT NULL,
"_row_id" serial PRIMARY KEY NOT NULL,
CONSTRAINT "user_id_unique" UNIQUE("id")
```

**Sources:**

*   [packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 58-60](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L58-L60)
*   [packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 466-477](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L466-L477)

### Audit Columns

All tables include a standard set of audit columns for tracking entity lifecycle and provenance:

```
created_at    timestamp with time zone NOT NULL
updated_at    timestamp with time zone NOT NULL
deleted_at    timestamp with time zone          -- Soft delete timestamp
created_by    text                               -- User ID who created
updated_by    text                               -- User ID who last updated
deleted_by    text                               -- User ID who deleted
version       integer DEFAULT 1 NOT NULL         -- Optimistic locking
source        text                               -- Import/migration source
```

These columns enable:

*   **Soft deletes**: Entities are marked as deleted rather than physically removed
*   **Audit trails**: Complete history of who created/modified/deleted records
*   **Optimistic locking**: Version field prevents concurrent update conflicts
*   **Data provenance**: Source field tracks data origin for migrations

**Sources:**

*   [packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 13-20](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L13-L20)
*   [packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 23-72](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L23-L72)

### Organization-Scoped Tables

Tables that are scoped to organizations include an `organization_id` foreign key:

```
organization_id text NOT NULL,
FOREIGN KEY ("organization_id") REFERENCES "organization"("id")
  ON DELETE cascade ON UPDATE cascade
```

The cascade delete ensures that when an organization is deleted, all related data is automatically removed.

**Tables with organization scope:**

*   `team`, `member`, `apikey`, `subscription`, `oauth_application`, `oauth_access_token`, `oauth_consent`, `organization_role`, `passkey`, `two_factor`, `team_member`, `file`

**Sources:**

*   [packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 533-564](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L533-L564)

* * *

Core Identity Tables
--------------------

### user

The central table for user identity. Stores user profile information and authentication state.

| Column | Type | Description |
| --- | --- | --- |
| `email` | `text` | Unique email address (unique constraint) |
| `email_verified` | `boolean` | Email verification status (default: `false`) |
| `name` | `text` | Display name |
| `role` | `user_role_enum` | Global role: `admin`, `super_admin`, `user`, `tenant`, `guest` |
| `gender` | `user_gender_enum` | `male` or `female` |
| `image` | `text` | Avatar URL |
| `banned` | `boolean` | Account banned status |
| `ban_reason` | `text` | Reason for ban |
| `ban_expires` | `timestamp` | Expiration of temporary ban |
| `is_anonymous` | `boolean` | Anonymous user flag |
| `phone_number` | `text` | Unique phone number (optional) |
| `phone_number_verified` | `boolean` | Phone verification status |
| `two_factor_enabled` | `boolean` | 2FA enabled status |
| `username` | `text` | Unique username (optional) |
| `display_username` | `text` | Display version of username |
| `stripe_customer_id` | `text` | Stripe customer reference |
| `last_login_method` | `text` | Last authentication method used |

**Indexes:**

*   `user_email_idx`: B-tree on `email`
*   `user_active_idx`: Partial index on active, verified users
*   `user_role_idx`: Partial index on role (where not null)
*   `user_banned_expires_idx`: Partial index for temporary bans
*   `user_2fa_enabled_idx`: Partial index for 2FA users

**Sources:**

*   [packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 58-90](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L58-L90)
*   [packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 462-752](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L462-L752)

### account

Links users to authentication providers (OAuth, password, etc.). Multiple accounts can exist for one user.

| Column | Type | Description |
| --- | --- | --- |
| `account_id` | `text` | Provider-specific account ID |
| `provider_id` | `text` | Provider identifier (e.g., `google`, `github`, `credential`) |
| `user_id` | `text` | Foreign key to `user.id` |
| `access_token` | `text` | OAuth access token |
| `refresh_token` | `text` | OAuth refresh token |
| `id_token` | `text` | OIDC ID token |
| `access_token_expires_at` | `timestamp` | Token expiration |
| `refresh_token_expires_at` | `timestamp` | Refresh token expiration |
| `scope` | `text` | OAuth scopes granted |
| `password` | `text` | Hashed password (for credential provider) |

**Unique constraint:**`(provider_id, account_id)` - one account per provider

**Indexes:**

*   `account_user_id_idx`: B-tree on `user_id`
*   `account_provider_account_unique_idx`: Unique on `(provider_id, account_id)`
*   `account_user_provider_idx`: Composite on `(user_id, provider_id)`
*   `account_access_token_expires_idx`: Partial index for token expiration cleanup
*   `account_refresh_token_expires_idx`: Partial index for refresh token cleanup

**Sources:**

*   [packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 92-114](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L92-L114)
*   [packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 754-1007](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L754-L1007)

* * *

Organization Management Tables
------------------------------

### organization

Root table for the multi-tenant structure. Each organization can be a personal workspace or a team workspace.

| Column | Type | Description |
| --- | --- | --- |
| `name` | `text` | Organization name |
| `slug` | `text` | URL-friendly unique slug |
| `logo` | `text` | Logo URL |
| `metadata` | `text` | Additional JSON metadata |
| `type` | `organization_type_enum` | `individual`, `team`, or `enterprise` |
| `owner_user_id` | `text` | Foreign key to owner `user.id` |
| `is_personal` | `boolean` | Personal workspace flag |
| `max_members` | `integer` | Maximum member limit |
| `features` | `jsonb` | Feature flags |
| `settings` | `jsonb` | Organization settings |
| `subscription_tier` | `subscription_tier_enum` | `free`, `plus`, `pro`, or `enterprise` |
| `subscription_status` | `subscription_status_enum` | `active` or `canceled` |

**Indexes:**

*   `organization_name_idx`: B-tree on `name`
*   `organization_slug_idx`: B-tree on `slug`
*   `organization_type_idx`: B-tree on `type`
*   `organization_owner_idx`: B-tree on `owner_user_id`
*   `organization_personal_idx`: Partial index for personal orgs
*   `organization_subscription_idx`: Composite on `(subscription_tier, subscription_status)`

**Sources:**

*   [packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 10-35](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L10-L35)
*   [packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 7-277](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L7-L277)

### member

Junction table linking users to organizations with roles and permissions.

| Column | Type | Description |
| --- | --- | --- |
| `organization_id` | `text` | Foreign key to `organization.id` |
| `user_id` | `text` | Foreign key to `user.id` |
| `role` | `member_role_enum` | `owner`, `admin`, `member`, or `viewer` |
| `status` | `member_status_enum` | `active`, `inactive`, `offline`, `suspended`, `deleted`, or `invited` |
| `invited_by` | `text` | User ID who invited this member |
| `invited_at` | `timestamp with time zone` | Invitation timestamp |
| `joined_at` | `timestamp with time zone` | Join timestamp |
| `last_active_at` | `timestamp with time zone` | Last activity timestamp |
| `permissions` | `text` | Custom permissions JSON |

**Unique constraint:**`(organization_id, user_id)` - one membership per user per org

**Indexes:**

*   `member_organization_id_idx`: B-tree on `organization_id`
*   `member_user_id_idx`: B-tree on `user_id`
*   `member_org_user_unique_idx`: Unique on `(organization_id, user_id)`
*   `member_org_role_idx`: Composite on `(organization_id, role)`
*   `member_role_idx`: B-tree on `role`
*   `member_status_idx`: B-tree on `status`
*   `member_org_status_idx`: Composite on `(organization_id, status)`
*   `member_invited_by_idx`: B-tree on `invited_by`
*   `member_last_active_idx`: B-tree on `last_active_at`

**Sources:**

*   [packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 214-235](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L214-L235)
*   [packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 2115-2368](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L2115-L2368)

### team

Sub-groups within an organization for organizing members.

| Column | Type | Description |
| --- | --- | --- |
| `organization_id` | `text` | Foreign key to `organization.id` |
| `name` | `text` | Team name (unique within organization) |
| `slug` | `text` | Globally unique slug |
| `description` | `text` | Team description |
| `logo` | `text` | Team logo URL |
| `metadata` | `text` | Additional JSON metadata |

**Unique constraints:**

*   `slug` is globally unique
*   `(organization_id, name)` is unique within organization

**Indexes:**

*   `team_organization_id_idx`: B-tree on `organization_id`
*   `team_org_name_unique_idx`: Unique on `(organization_id, name)`
*   `team_name_idx`: B-tree on `name`

**Sources:**

*   [packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 37-56](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L37-L56)
*   [packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 279-460](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L279-L460)

### team_member

Junction table linking users to teams within an organization.

| Column | Type | Description |
| --- | --- | --- |
| `organization_id` | `text` | Foreign key to `organization.id` |
| `team_id` | `text` | Foreign key to `team.id` |
| `user_id` | `text` | Foreign key to `user.id` |

**Unique constraint:**`(team_id, user_id)` - one membership per user per team

**Indexes:**

*   `team_member_team_id_idx`: B-tree on `team_id`
*   `team_member_user_id_idx`: B-tree on `user_id`
*   `team_member_team_user_unique_idx`: Unique on `(team_id, user_id)`
*   `team_member_team_user_idx`: Composite on `(team_id, user_id)`

**Sources:**

*   [packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 434-449](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L434-L449)
*   [packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 3102-3255](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L3102-L3255)

* * *

Session Management Tables
-------------------------

### session

Active user sessions with context about the user's current organization and team.

| Column | Type | Description |
| --- | --- | --- |
| `token` | `text` | Unique session token |
| `user_id` | `text` | Foreign key to `user.id` |
| `expires_at` | `timestamp` | Session expiration |
| `ip_address` | `text` | Client IP address |
| `user_agent` | `text` | Client user agent |
| `impersonated_by` | `text` | Admin user ID if impersonating (nullable) |
| `active_organization_id` | `text` | Current organization context (nullable) |
| `active_team_id` | `text` | Current team context (nullable) |

**Check constraint:**`expires_at > created_at`

**Indexes:**

*   `session_token_idx`: B-tree on `token`
*   `session_user_id_idx`: B-tree on `user_id`
*   `session_expires_at_idx`: B-tree on `expires_at` (for cleanup)
*   `session_user_expires_idx`: Composite on `(user_id, expires_at)`
*   `session_active_org_idx`: B-tree on `active_organization_id`
*   `session_active_team_idx`: B-tree on `active_team_id`
*   `session_impersonated_by_idx`: B-tree on `impersonated_by`
*   `session_user_org_active_idx`: Composite on `(user_id, active_organization_id, expires_at)`

**Sources:**

*   [packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 364-386](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L364-L386)
*   [packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 2744-2959](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L2744-L2959)

### verification

Temporary verification tokens for email verification, password resets, etc.

| Column | Type | Description |
| --- | --- | --- |
| `identifier` | `text` | Email or identifier being verified |
| `value` | `text` | Token value |
| `expires_at` | `timestamp` | Token expiration |

**Indexes:**

*   `verification_identifier_idx`: B-tree on `identifier`
*   `verification_identifier_value_idx`: Composite on `(identifier, value)`
*   `verification_expires_at_idx`: B-tree on `expires_at` (for cleanup)
*   `verification_active_idx`: Composite on `(identifier, expires_at)`

**Sources:**

*   [packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 469-484](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L469-L484)
*   [packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 3467-3571](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L3467-L3571)

* * *

Authentication Tables
---------------------

### passkey

WebAuthn/FIDO2 passkey credentials for passwordless authentication.

| Column | Type | Description |
| --- | --- | --- |
| `organization_id` | `text` | Foreign key to `organization.id` |
| `user_id` | `text` | Foreign key to `user.id` |
| `name` | `text` | User-defined credential name |
| `public_key` | `text` | COSE public key |
| `credential_i_d` | `text` | WebAuthn credential ID |
| `counter` | `integer` | Signature counter (must be non-negative) |
| `device_type` | `text` | Device type (e.g., `platform`, `cross-platform`) |
| `backed_up` | `boolean` | Credential backup status |
| `transports` | `text` | Supported transports JSON array |
| `aaguid` | `text` | Authenticator AAGUID |

**Check constraint:**`counter >= 0` (prevents replay attacks)

**Sources:**

*   [packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 322-345](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L322-L345)
*   [packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 2562-2739](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L2562-L2739)

### two_factor

TOTP (Time-based One-Time Password) secrets for 2FA.

| Column | Type | Description |
| --- | --- | --- |
| `organization_id` | `text` | Foreign key to `organization.id` |
| `user_id` | `text` | Foreign key to `user.id` |
| `secret` | `text` | TOTP shared secret |
| `backup_codes` | `text` | Backup recovery codes |

**Sources:**

*   [packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 451-467](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L451-L467)
*   [packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 3257-3390](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L3257-L3390)

### device_code

OAuth 2.0 Device Authorization Grant flow codes for device authentication.

| Column | Type | Description |
| --- | --- | --- |
| `device_code` | `text` | Device verification code |
| `user_code` | `text` | User-friendly code to enter |
| `user_id` | `text` | Foreign key to `user.id` (nullable until approved) |
| `expires_at` | `timestamp` | Code expiration |
| `status` | `device_code_status_enum` | `pending`, `approved`, or `denied` |
| `last_polled_at` | `timestamp` | Last polling timestamp |
| `polling_interval` | `integer` | Seconds between polling attempts |
| `client_id` | `text` | OAuth client ID |
| `scope` | `text` | Requested scopes |

**Sources:**

*   [packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 154-175](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L154-L175)
*   [packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 1557-1734](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L1557-L1734)

### wallet_address

Blockchain wallet addresses for Web3 authentication.

| Column | Type | Description |
| --- | --- | --- |
| `user_id` | `text` | Foreign key to `user.id` |
| `address` | `text` | Wallet address |
| `chain_id` | `integer` | Blockchain chain ID |
| `is_primary` | `boolean` | Primary wallet flag |

**Unique constraint:**`(user_id, address, chain_id)` - one address per chain per user

**Sources:**

*   [packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 486-502](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L486-L502)
*   [packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 3573-3691](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L3573-L3691)

### sso_provider

Enterprise SSO provider configurations (SAML/OIDC).

| Column | Type | Description |
| --- | --- | --- |
| `issuer` | `text` | SSO provider issuer URL |
| `oidc_config` | `text` | OIDC configuration JSON |
| `saml_config` | `text` | SAML configuration XML |
| `user_id` | `text` | Foreign key to `user.id` (owner) |
| `provider_id` | `text` | Unique provider identifier |
| `organization_id` | `text` | Foreign key to `organization.id` |
| `domain` | `text` | Email domain for this SSO provider |

**Sources:**

*   [packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 388-408](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L388-L408)
*   [packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 2961-3099](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L2961-L3099)

* * *

### invitation

Pending invitations to join organizations or teams.

| Column | Type | Description |
| --- | --- | --- |
| `email` | `text` | Invitee email address |
| `role` | `text` | Role to assign upon acceptance |
| `team_id` | `text` | Foreign key to `team.id` (nullable) |
| `status` | `invitation_status_enum` | `pending`, `accepted`, `rejected`, or `cancelled` |
| `expires_at` | `timestamp` | Invitation expiration |
| `inviter_id` | `text` | Foreign key to `user.id` (who sent invite) |
| `organization_id` | `text` | Foreign key to `organization.id` |

**Unique constraint:**`(organization_id, email)` where `status = 'pending'` (prevents duplicate pending invites)

**Indexes:**

*   `invitation_organization_id_idx`: B-tree on `organization_id`
*   `invitation_inviter_id_idx`: B-tree on `inviter_id`
*   `invitation_email_idx`: B-tree on `email`
*   `invitation_org_email_unique_idx`: Partial unique on `(organization_id, email)` for pending
*   `invitation_status_idx`: B-tree on `status`
*   `invitation_expires_at_idx`: B-tree on `expires_at`
*   `invitation_pending_idx`: Composite on `(organization_id, status, expires_at)` for pending invites
*   `invitation_team_id_idx`: Partial on `team_id` where not null

**Sources:**

*   [packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 177-196](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L177-L196)
*   [packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 1736-1900](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L1736-L1900)

### organization_role

Custom role definitions with permissions for organizations.

| Column | Type | Description |
| --- | --- | --- |
| `organization_id` | `text` | Foreign key to `organization.id` |
| `role` | `text` | Role name |
| `permission` | `text` | Permission identifier or JSON |

**Sources:**

*   [packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 305-320](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L305-L320)
*   [packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 2422-2560](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L2422-L2560)

### apikey

API keys for programmatic access with rate limiting.

| Column | Type | Description |
| --- | --- | --- |
| `organization_id` | `text` | Foreign key to `organization.id` |
| `user_id` | `text` | Foreign key to `user.id` (owner) |
| `name` | `text` | Key name/description |
| `start` | `text` | Visible prefix of key |
| `prefix` | `text` | Key prefix |
| `key` | `text` | Hashed key value |
| `enabled` | `boolean` | Key enabled status |
| `rate_limit_enabled` | `boolean` | Rate limiting enabled |
| `rate_limit_time_window` | `integer` | Window in milliseconds (default: 86400000 = 24h) |
| `rate_limit_max` | `integer` | Max requests in window (default: 10) |
| `request_count` | `integer` | Current request count (must be >= 0) |
| `remaining` | `integer` | Remaining requests (must be >= 0) |
| `last_request` | `timestamp` | Last request timestamp |
| `refill_interval` | `integer` | Refill interval in milliseconds |
| `refill_amount` | `integer` | Amount to refill (must be >= 0) |
| `last_refill_at` | `timestamp` | Last refill timestamp |
| `expires_at` | `timestamp` | Key expiration |
| `permissions` | `text` | Permissions JSON |
| `metadata` | `text` | Additional metadata JSON |

**Check constraints:**

*   `request_count >= 0`
*   `refill_amount >= 0`
*   `rate_limit_time_window > 0`
*   `rate_limit_max > 0`
*   `remaining >= 0`

**Sources:**

*   [packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 116-152](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L116-L152)
*   [packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 1009-1245](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L1009-L1245)

### rate_limit

Generic rate limiting table for tracking request counts by key.

| Column | Type | Description |
| --- | --- | --- |
| `key` | `text` | Rate limit key (e.g., IP, user ID) |
| `count` | `integer` | Request count |
| `last_request` | `bigint` | Last request timestamp (Unix milliseconds) |

**Sources:**

*   [packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 347-362](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L347-L362)
*   [packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 2741-2842](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L2741-L2842)

* * *

OAuth Integration Tables
------------------------

The system can act as an OAuth 2.0/OIDC provider, allowing external applications to authenticate users.

### oauth_application

OAuth 2.0 client application registrations.

| Column | Type | Description |
| --- | --- | --- |
| `organization_id` | `text` | Foreign key to `organization.id` |
| `user_id` | `text` | Foreign key to `user.id` (app owner) |
| `name` | `text` | Application name |
| `icon` | `text` | Application icon URL |
| `metadata` | `text` | Additional metadata JSON |
| `client_id` | `text` | Unique OAuth client ID |
| `client_secret` | `text` | Client secret (hashed) |
| `redirect_u_r_ls` | `text` | Allowed redirect URLs JSON |
| `type` | `text` | Application type (`confidential`, `public`) |
| `disabled` | `boolean` | Application disabled flag |

**Sources:**

*   [packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 261-284](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L261-L284)
*   [packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 2224-2420](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L2224-L2420)

### oauth_consent

Records of user consent for OAuth applications.

| Column | Type | Description |
| --- | --- | --- |
| `organization_id` | `text` | Foreign key to `organization.id` |
| `client_id` | `text` | OAuth client ID |
| `user_id` | `text` | Foreign key to `user.id` |
| `scopes` | `text` | Granted scopes |
| `consent_given` | `boolean` | Consent status |

**Sources:**

*   [packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 286-303](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L286-L303)
*   [packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 2224-2420](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L2224-L2420)

### oauth_access_token

Issued OAuth access and refresh tokens.

| Column | Type | Description |
| --- | --- | --- |
| `organization_id` | `text` | Foreign key to `organization.id` |
| `access_token` | `text` | Unique access token |
| `refresh_token` | `text` | Unique refresh token |
| `access_token_expires_at` | `timestamp` | Access token expiration |
| `refresh_token_expires_at` | `timestamp` | Refresh token expiration |
| `client_id` | `text` | OAuth client ID |
| `user_id` | `text` | Foreign key to `user.id` |
| `scopes` | `text` | Granted scopes |

**Sources:**

*   [packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 237-259](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L237-L259)
*   [packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 2370-2562](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L2370-L2562)

### jwks

JSON Web Key Set for signing JWTs.

| Column | Type | Description |
| --- | --- | --- |
| `public_key` | `text` | Public key (PEM format) |
| `private_key` | `text` | Private key (PEM format, encrypted) |

**Sources:**

*   [packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 198-212](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L198-L212)
*   [packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 1902-2021](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L1902-L2021)

* * *

Billing Tables
--------------

### subscription

Stripe subscription management for organizations.

| Column | Type | Description |
| --- | --- | --- |
| `organization_id` | `text` | Foreign key to `organization.id` |
| `plan` | `text` | Subscription plan identifier |
| `reference_id` | `text` | External reference ID |
| `stripe_customer_id` | `text` | Stripe customer ID |
| `stripe_subscription_id` | `text` | Stripe subscription ID |
| `status` | `text` | Subscription status (default: `incomplete`) |
| `period_start` | `timestamp` | Billing period start |
| `period_end` | `timestamp` | Billing period end |
| `cancel_at_period_end` | `boolean` | Cancel flag |
| `seats` | `integer` | Number of seats |

**Sources:**

*   [packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 410-432](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L410-L432)
*   [packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 3101-3255](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L3101-L3255)

* * *

Enum Types
----------

The schema defines several PostgreSQL enum types for type-safe column values:

| Enum Type | Values | Usage |
| --- | --- | --- |
| `organization_type_enum` | `individual`, `team`, `enterprise` | `organization.type` |
| `subscription_status_enum` | `active`, `canceled` | `organization.subscription_status` |
| `subscription_tier_enum` | `free`, `plus`, `pro`, `enterprise` | `organization.subscription_tier` |
| `user_gender_enum` | `male`, `female` | `user.gender` |
| `user_role_enum` | `admin`, `super_admin`, `user`, `tenant`, `guest` | `user.role` |
| `device_code_status_enum` | `pending`, `approved`, `denied` | `device_code.status` |
| `invitation_status_enum` | `pending`, `rejected`, `cancelled`, `accepted` | `invitation.status` |
| `member_role_enum` | `admin`, `member`, `viewer`, `owner` | `member.role` |
| `member_status_enum` | `active`, `inactive`, `offline`, `suspended`, `deleted`, `invited` | `member.status` |

**Sources:**

*   [packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 1-9](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L1-L9)

* * *

Database Migration and Testing
------------------------------

### Migration Management

Migrations are managed using Drizzle Kit and stored in [packages/_internal/db-admin/drizzle/](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/)

The migration journal tracks applied migrations:

```
{
  "version": "7",
  "dialect": "postgresql",
  "entries": [
    {
      "idx": 0,
      "version": "7",
      "when": 1759729057008,
      "tag": "0000_melted_killer_shrike",
      "breakpoints": true
    }
  ]
}
```

**Sources:**

*   [packages/_internal/db-admin/drizzle/meta/_journal.json 1-14](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/_journal.json#L1-L14)

### Test Infrastructure

The codebase includes a Docker-based PostgreSQL test container using `pg_uuidv7` extension:

```
// packages/_internal/db-admin/test/pg-container.ts
export class PgContainer extends Effect.Service<PgContainer>()("PgContainer", {
  scoped: Effect.acquireRelease(setupDocker, ({ container }) =>
    Effect.promise(() => container.stop())
  )
})
```

The test container:

1.   Starts a PostgreSQL 15 Docker container with `pg_uuidv7` extension
2.   Runs migrations automatically
3.   Seeds test data (a mock user)
4.   Provides `IamDb.Live` and `FilesDb.Live` layers for testing
5.   Automatically cleans up after tests

**Preflight checks** ensure Docker is available before running tests:

*   Checks for explicit skip environment variables (`BEEP_SKIP_PG_CONTAINER_TESTS`, `SKIP_DOCKER_TESTS`)
*   Verifies Docker daemon is running
*   Validates required Docker image is available

**Sources:**

*   [packages/_internal/db-admin/test/pg-container.ts 1-266](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L1-L266)
*   [packages/_internal/db-admin/test/pg-container.ts 91-135](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/test/pg-container.ts#L91-L135)

* * *

Connection Configuration
------------------------

Database connections are configured through environment variables and the Effect Config system:

```
// Server configuration
db: Config.nested("DB")(
  Config.all({
    pg: Config.nested("PG")(
      Config.all({
        url: Config.redacted(Config.nonEmptyString("URL")),
        ssl: Config.boolean("SSL").pipe(Config.withDefault(false)),
        port: Config.port("PORT").pipe(Config.withDefault(5432)),
        user: Config.nonEmptyString("USER").pipe(Config.withDefault("postgres")),
        password: Config.redacted(Config.nonEmptyString("PASSWORD")),
        host: Config.nonEmptyString("HOST").pipe(Config.withDefault("localhost")),
        database: Config.nonEmptyString("DATABASE").pipe(Config.withDefault("postgres")),
      })
    )
  })
)
```

Environment variables:

*   `DB_PG_URL`: Full PostgreSQL connection string
*   `DB_PG_HOST`: Database host
*   `DB_PG_PORT`: Database port (default: 5432)
*   `DB_PG_USER`: Database user (default: postgres)
*   `DB_PG_PASSWORD`: Database password
*   `DB_PG_DATABASE`: Database name (default: postgres)
*   `DB_PG_SSL`: Enable SSL (default: false)

**Sources:**

*   [packages/core/env/src/server.ts 81-95](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/core/env/src/server.ts#L81-L95)

* * *

Performance Considerations
--------------------------

### Index Strategy

The schema implements comprehensive indexing for common query patterns:

1.   **Lookup indexes**: Single-column B-tree indexes on frequently queried foreign keys
2.   **Composite indexes**: Multi-column indexes for common join patterns (e.g., `(organization_id, user_id)`)
3.   **Partial indexes**: Conditional indexes for specific query patterns (e.g., active users, pending invitations)
4.   **Unique indexes**: Enforce uniqueness constraints while enabling fast lookups

### Query Optimization

*   **Dual-identifier pattern**: Uses serial `_row_id` as primary key for fast joins while exposing stable `id` for external APIs
*   **Cascade deletes**: Automatic cleanup of related records improves delete performance
*   **Partial indexes**: Reduce index size and improve write performance by indexing only relevant rows

### Data Integrity

*   **Check constraints**: Validate data at the database level (e.g., `expires_at > created_at`, `counter >= 0`)
*   **Unique constraints**: Prevent duplicate data (e.g., one pending invitation per email per org)
*   **Foreign key constraints**: Ensure referential integrity with cascade behavior

**Sources:**

*   [packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql 565-618](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/0000_melted_killer_shrike.sql#L565-L618)
*   [packages/_internal/db-admin/drizzle/meta/0000_snapshot.json 152-277](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/_internal/db-admin/drizzle/meta/0000_snapshot.json#L152-L277)
