# IAM SDK | kriegcloud/beep-effect | DeepWiki

_Source: https://deepwiki.com/kriegcloud/beep-effect/5.1.4-iam-sdk_

Relevant source files
*   [docker-compose.yml](https://github.com/kriegcloud/beep-effect/blob/b64126f6/docker-compose.yml)
*   [packages/common/constants/src/paths/asset-paths.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/constants/src/paths/asset-paths.ts)
*   [packages/common/constants/src/paths/generated/asset-paths.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/constants/src/paths/generated/asset-paths.ts)
*   [packages/iam/infra/src/adapters/better-auth/Auth.service.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts)
*   [packages/iam/sdk/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/package.json)
*   [packages/iam/sdk/src/clients/sign-in/sign-in.client.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/src/clients/sign-in/sign-in.client.ts)
*   [packages/iam/sdk/src/index.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/src/index.ts)
*   [packages/iam/ui/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/package.json)
*   [packages/iam/ui/src/sign-up/sign-up.view.tsx](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/src/sign-up/sign-up.view.tsx)
*   [packages/iam/ui/tsconfig.build.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/tsconfig.build.json)
*   [packages/iam/ui/tsconfig.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/tsconfig.json)
*   [packages/iam/ui/tsconfig.src.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/tsconfig.src.json)
*   [packages/iam/ui/tsconfig.test.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/tsconfig.test.json)
*   [packages/runtime/client/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/package.json)
*   [packages/runtime/client/src/services/runtime/live-layer.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts)
*   [packages/runtime/server/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/package.json)
*   [packages/runtime/server/src/server-runtime.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts)

Purpose and Scope
-----------------

The IAM SDK (`@beep/iam-sdk`) is the client-facing API layer for the Identity and Access Management context. It provides type-safe authentication operations that wrap better-auth functionality within the Effect ecosystem. This package sits between the IAM Infrastructure layer (see [IAM Infrastructure](https://deepwiki.com/kriegcloud/beep-effect/5.1.3-iam-infrastructure)) and IAM UI Components (see [IAM UI Components](https://deepwiki.com/kriegcloud/beep-effect/5.1.5-iam-ui-components)) in the vertical slice architecture.

The SDK is responsible for:

*   Exposing authentication client methods (sign-in, sign-up, sign-out)
*   Wrapping better-auth operations with typed contracts
*   Integrating authentication flows with Effect's error handling
*   Providing toast notification patterns for user feedback
*   Managing authentication state transitions

For domain entities and business logic, see [IAM Domain Layer](https://deepwiki.com/kriegcloud/beep-effect/5.1.1-iam-domain-layer). For database operations and better-auth server configuration, see [IAM Infrastructure](https://deepwiki.com/kriegcloud/beep-effect/5.1.3-iam-infrastructure).

* * *

Architecture Position
---------------------

The IAM SDK occupies the presentation/API layer within the IAM bounded context, serving as the bridge between infrastructure services and UI components.

**Sources:**[packages/iam/sdk/package.json 1-74](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/package.json#L1-L74)[packages/iam/ui/src/sign-up/sign-up.view.tsx 1-131](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/src/sign-up/sign-up.view.tsx#L1-L131) Diagram 5 from high-level architecture

* * *

Package Structure
-----------------

The IAM SDK is organized as a standalone workspace package with clear separation of concerns:

| Export Path | Purpose |
| --- | --- |
| `@beep/iam-sdk` | Main entry point with authentication clients |
| `@beep/iam-sdk/auth-wrapper` | AuthHandler abstraction for Effect integration |
| `@beep/iam-sdk/clients` | Individual authentication client implementations |
| `@beep/iam-sdk/constants` | Authentication-related constants |

**Key Dependencies:**

*   `better-auth` - Underlying authentication framework
*   `effect` - Functional programming runtime
*   `@beep/shared-domain` - Shared domain types (paths, entity IDs)
*   `@beep/schema` - Effect Schema validation
*   `@beep/core-env` - Environment configuration

**Sources:**[packages/iam/sdk/package.json 11-14](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/package.json#L11-L14)[packages/iam/sdk/package.json 36-57](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/package.json#L36-L57)[packages/iam/sdk/src/index.ts 1-3](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/src/index.ts#L1-L3)

* * *

Better-Auth Client Wrapper
--------------------------

The SDK wraps the better-auth client library, which is instantiated based on the server's authentication configuration. The server-side AuthService (see [AuthService and Better-Auth](https://deepwiki.com/kriegcloud/beep-effect/4.3.1-authservice-and-better-auth)) configures the authentication system, and the client SDK provides methods to interact with it.

**Sources:**[packages/iam/sdk/src/clients/sign-in/sign-in.client.ts 1-102](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/src/clients/sign-in/sign-in.client.ts#L1-L102)[packages/iam/infra/src/adapters/better-auth/Auth.service.ts 27-249](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L27-L249)

* * *

AuthHandler Abstraction
-----------------------

The SDK uses an `AuthHandler` abstraction to wrap authentication operations with Effect-based error handling, toast notifications, and telemetry annotations. Each authentication method is defined as an `AuthHandler` instance.

### AuthHandler Structure

Each `AuthHandler.make` call defines:

| Property | Type | Purpose |
| --- | --- | --- |
| `name` | `string` | Identifier for telemetry and debugging |
| `plugin` | `string` | Better-auth plugin category |
| `method` | `string` | Specific authentication method |
| `schema` | `Schema` | Effect Schema for input validation |
| `run` | `Function` | Wrapped authentication logic |
| `toast` | `Object` | User feedback configuration |
| `defaultErrorMessage` | `string` | Fallback error message |
| `annotations` | `Object` | Telemetry span attributes |

### Sign-In Email Handler Example

**Sources:**[packages/iam/sdk/src/clients/sign-in/sign-in.client.ts 5-21](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/src/clients/sign-in/sign-in.client.ts#L5-L21)

* * *

Authentication Contracts
------------------------

The SDK defines typed contracts for each authentication method using Effect Schemas. These contracts ensure type safety and runtime validation for authentication payloads.

### Sign-In Contracts

Each contract includes:

*   Input validation schema
*   Type safety through Effect Schema encoding/decoding
*   Integration with better-auth client methods

**Sources:**[packages/iam/sdk/src/clients/sign-in/sign-in.client.ts 1-102](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/src/clients/sign-in/sign-in.client.ts#L1-L102)

* * *

Authentication Methods
----------------------

The SDK exposes authentication operations through client objects organized by functionality.

### Sign-In Client

The `signInClient` provides methods for user authentication:

| Method | Contract | Better-Auth Endpoint |
| --- | --- | --- |
| `signInClient.email` | `SignInEmailContract` | `/api/auth/sign-in/email` |
| `signInClient.social` | `SignInSocialContract` | `/api/auth/sign-in/social` |
| `signInClient.passkey` | `SignInPasskeyContract` | `/api/auth/sign-in/passkey` |
| `signInClient.oneTap` | `void` | `/api/auth/one-tap` |

**Email Sign-In Flow:**

**Sources:**[packages/iam/sdk/src/clients/sign-in/sign-in.client.ts 5-71](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/src/clients/sign-in/sign-in.client.ts#L5-L71)

Social authentication redirects users to OAuth providers configured in the server environment:

**Supported Providers:**

*   Configured via `serverEnv.oauth.authProviderNames`
*   Each provider requires `clientId` and `clientSecret` in environment
*   Providers include Google, GitHub, etc. (see better-auth plugins)

**Sources:**[packages/iam/sdk/src/clients/sign-in/sign-in.client.ts 22-38](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/src/clients/sign-in/sign-in.client.ts#L22-L38)[packages/iam/infra/src/adapters/better-auth/Auth.service.ts 106-117](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L106-L117)

### Passkey Authentication

Passkey authentication uses WebAuthn for passwordless sign-in:

The passkey handler includes custom error handling to capture and propagate WebAuthn errors:

**Sources:**[packages/iam/sdk/src/clients/sign-in/sign-in.client.ts 40-71](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/src/clients/sign-in/sign-in.client.ts#L40-L71)

### One-Tap Sign-In

One-tap sign-in provides a streamlined authentication experience using Google's One Tap API (configured via the one-tap plugin):

**Sources:**[packages/iam/sdk/src/clients/sign-in/sign-in.client.ts 73-95](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/src/clients/sign-in/sign-in.client.ts#L73-L95)

* * *

Integration with Effect Runtime
-------------------------------

The IAM SDK integrates deeply with the Effect runtime to provide type-safe, composable authentication operations.

### Client Runtime Integration

**Usage Pattern in UI Components:**

1.   Obtain runtime from `useRuntime()` hook
2.   Create bound executor with `makeRunClientPromise(runtime, spanName)`
3.   Pass executor to SDK methods
4.   SDK returns `Effect` programs that execute with telemetry

**Example from Sign-Up Component:**

The component uses the runtime to execute SDK methods with proper error handling and telemetry:

**Sources:**[packages/iam/ui/src/sign-up/sign-up.view.tsx 28-118](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/src/sign-up/sign-up.view.tsx#L28-L118)[packages/runtime/client/src/services/runtime/live-layer.ts 114-145](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts#L114-L145)

* * *

Toast Notification Patterns
---------------------------

The SDK standardizes user feedback through toast notification configurations attached to each `AuthHandler`:

### Toast Configuration Structure

Each handler's toast object defines:

*   `onWaiting`: Message displayed during operation (e.g., "Signing in...")
*   `onSuccess`: Message shown on successful completion
*   `onFailure`: Error message strategy
    *   `onNone()`: Default message when no error details available
    *   `onSome(error)`: Extract message from error object

**Sources:**[packages/iam/sdk/src/clients/sign-in/sign-in.client.ts 11-18](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/src/clients/sign-in/sign-in.client.ts#L11-L18)[packages/iam/sdk/src/clients/sign-in/sign-in.client.ts 28-35](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/src/clients/sign-in/sign-in.client.ts#L28-L35)

* * *

Sign-Up Client
--------------

The SDK provides sign-up functionality with email verification and automatic personal organization creation:

### Automatic Organization Creation

When a user signs up, the server-side database hook automatically:

1.   Creates a personal organization with slug `{username}-{userId}`
2.   Adds user as owner member with `active` status
3.   Sets organization type to `individual`
4.   Initializes subscription tier to `free`

**Sources:**[packages/iam/infra/src/adapters/better-auth/Auth.service.ts 119-158](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L119-L158)[packages/iam/ui/src/sign-up/sign-up.view.tsx 104-118](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/src/sign-up/sign-up.view.tsx#L104-L118)

* * *

Session Management
------------------

The SDK relies on better-auth's session management, which includes:

### Session Creation Hook

When a session is created, the `databaseHooks.session.create.before` hook:

1.   Queries user's organizations and memberships
2.   Sets `activeOrganizationId` to the user's personal organization
3.   Stores `organizationContext` as JSON with all org memberships

### Session Fields

| Field | Type | Purpose |
| --- | --- | --- |
| `activeOrganizationId` | `OrganizationId` | Currently active organization context |
| `organizationContext` | `JSON string` | Map of org ID to metadata (name, type, role, etc.) |

**Sources:**[packages/iam/infra/src/adapters/better-auth/Auth.service.ts 161-217](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L161-L217)

* * *

Environment Configuration
-------------------------

The SDK reads client environment configuration for:

*   **ReCAPTCHA:**`clientEnv.captchaSiteKey` for form protection
*   **Auth URLs:** Derived from server configuration via `serverEnv.app.authUrl`
*   **OAuth Providers:** Configured in server environment, consumed by client

The GoogleReCaptchaProvider wrapper enables CAPTCHA integration:

**Sources:**[packages/iam/ui/src/sign-up/sign-up.view.tsx 43](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/src/sign-up/sign-up.view.tsx#L43-L43)

* * *

Error Handling
--------------

The SDK uses Effect's error handling with:

1.   **Schema validation errors:** Caught by Effect Schema during contract validation
2.   **Network errors:** Propagated from HttpClient layer
3.   **Authentication errors:** Returned by better-auth server with status codes
4.   **Custom error messages:** Defined in `defaultErrorMessage` field

Error propagation flow:

**Sources:**[packages/iam/sdk/src/clients/sign-in/sign-in.client.ts 45-60](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/src/clients/sign-in/sign-in.client.ts#L45-L60)

* * *

Telemetry and Observability
---------------------------

Each authentication operation is wrapped in an observability span with custom annotations:

| Annotation | Example Value | Purpose |
| --- | --- | --- |
| `action` | `"sign-in"` | High-level operation category |
| `method` | `"email"` | Specific authentication method |
| `spanName` | `"iam.signUp.email"` | Trace span identifier |

The client runtime automatically instruments SDK calls with OpenTelemetry:

**Sources:**[packages/iam/sdk/src/clients/sign-in/sign-in.client.ts 20](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/src/clients/sign-in/sign-in.client.ts#L20-L20)[packages/runtime/client/src/services/runtime/live-layer.ts 114-119](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts#L114-L119)

* * *

Dependencies and Build Configuration
------------------------------------

### Package Dependencies

The SDK depends on:

*   **better-auth ecosystem:** Core auth, Stripe plugin, Dub integration
*   **Effect ecosystem:**`effect`, schemas, runtime
*   **Workspace packages:** domain, schemas, errors, UI utilities

### Build Pipeline

The SDK uses a dual-format build:

*   ESM output: `build/esm/`
*   CJS output: `build/cjs/` (Babel-transformed)
*   Pure call annotations for tree-shaking optimization

Build commands:

*   `pnpm build-esm`: TypeScript compilation to ESM
*   `pnpm build-cjs`: Babel transformation to CommonJS
*   `pnpm build-annotate`: Add pure call annotations

**Sources:**[packages/iam/sdk/package.json 22-26](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/package.json#L22-L26)[packages/iam/sdk/package.json 36-57](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/package.json#L36-L57)
