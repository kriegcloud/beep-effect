# Runtime and Service Composition | kriegcloud/beep-effect | DeepWiki

_Source: https://deepwiki.com/kriegcloud/beep-effect/4.2-runtime-and-service-composition_

Relevant source files
*   [apps/web/src/app-config.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/apps/web/src/app-config.ts)
*   [apps/web/src/app/layout.tsx](https://github.com/kriegcloud/beep-effect/blob/b64126f6/apps/web/src/app/layout.tsx)
*   [apps/web/src/libs/tanstack-query/query-data-helpers.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/apps/web/src/libs/tanstack-query/query-data-helpers.ts)
*   [docker-compose.yml](https://github.com/kriegcloud/beep-effect/blob/b64126f6/docker-compose.yml)
*   [packages/common/constants/src/paths/asset-paths.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/constants/src/paths/asset-paths.ts)
*   [packages/common/constants/src/paths/generated/asset-paths.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/common/constants/src/paths/generated/asset-paths.ts)
*   [packages/iam/infra/src/adapters/better-auth/Auth.service.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts)
*   [packages/iam/sdk/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/package.json)
*   [packages/iam/sdk/src/clients/sign-in/sign-in.client.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/src/clients/sign-in/sign-in.client.ts)
*   [packages/iam/sdk/src/index.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/sdk/src/index.ts)
*   [packages/iam/ui/src/sign-up/sign-up.view.tsx](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/src/sign-up/sign-up.view.tsx)
*   [packages/runtime/client/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/package.json)
*   [packages/runtime/client/src/services/runtime/live-layer.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts)
*   [packages/runtime/server/package.json](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/package.json)
*   [packages/runtime/server/src/server-runtime.ts](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts)

This page documents the runtime architecture and service composition patterns used throughout the beep-effect codebase. It explains how Effect's Layer system is used for dependency injection, how client and server runtimes are configured, and how services are composed into a cohesive dependency graph.

**Purpose and Scope:** This page focuses on the infrastructure layer that provides runtime environments for both client-side (browser) and server-side (Node.js) applications. For authentication service implementation details, see [4.3](https://deepwiki.com/kriegcloud/beep-effect/4.3-authentication-and-authorization). For database service composition, see [4.1](https://deepwiki.com/kriegcloud/beep-effect/4.1-database-layer).

Overview of Runtime Architecture
--------------------------------

The codebase uses Effect's `ManagedRuntime` to create isolated runtime environments with pre-configured service dependencies. The architecture separates client and server concerns while sharing a common pattern for service composition.

**Sources:**[packages/runtime/client/src/services/runtime/live-layer.ts 1-146](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts#L1-L146)[packages/runtime/server/src/server-runtime.ts 1-123](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L1-L123)

Effect Layer System
-------------------

Effect's Layer system provides compile-time type-safe dependency injection. A `Layer<RequirementsOut, Error, RequirementsIn>` describes how to construct services that require `RequirementsIn` dependencies and produce `RequirementsOut` services.

### Layer Composition Operators

| Operator | Purpose | Type Signature |
| --- | --- | --- |
| `Layer.mergeAll` | Combines multiple independent layers | `Layer<A | B | C, E, R>` |
| `Layer.provide` | Supplies dependencies to a layer | Eliminates `RequirementsIn` |
| `Layer.provideMerge` | Provides and merges in one operation | Combines provide + merge |

### Service Definition Pattern

Services are defined using `Effect.Service` with automatic accessor generation:

**Example Service Structure:**

The `AuthService` demonstrates the pattern at [packages/iam/infra/src/adapters/better-auth/Auth.service.ts 241-249](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L241-L249):

*   Declares dependencies: `AuthEmailService`, `IamDb.IamDb.Live`
*   Provides effect that constructs the service
*   Exports `AuthService.Default` layer for consumption

**Sources:**[packages/iam/infra/src/adapters/better-auth/Auth.service.ts 241-249](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L241-L249)

ManagedRuntime Pattern
----------------------

A `ManagedRuntime` is a long-lived runtime environment that manages the lifecycle of services. It provides methods to execute Effects within the configured context.

### Runtime Execution API

**Runtime Methods:**

*   `runPromise`: Executes Effect and returns Promise that rejects on failure
*   `runPromiseExit`: Executes Effect and returns Promise of Exit value (never rejects)

Both methods automatically inject runtime dependencies into the Effect.

**Sources:**[packages/runtime/server/src/server-runtime.ts 99-123](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L99-L123)[packages/runtime/client/src/services/runtime/live-layer.ts 114-145](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts#L114-L145)

Client Runtime Architecture
---------------------------

The client runtime is configured for browser environments and provides services for HTTP communication, telemetry, network monitoring, and TanStack Query integration.

### Client Service Layers

**HttpClientLive**[packages/runtime/client/src/services/runtime/live-layer.ts 64](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts#L64-L64)

*   Provides `FetchHttpClient` for browser HTTP requests
*   Uses browser's native `fetch` API

**ObservabilityLive**[packages/runtime/client/src/services/runtime/live-layer.ts 57](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts#L57-L57)

*   Telemetry: `WebSdk` with OTLP exporters for traces and logs
*   Logging: Pretty console in development, JSON in production
*   DevTools: WebSocket-based Effect DevTools in development only

**NetworkMonitorLive**[packages/runtime/client/src/services/runtime/live-layer.ts 67](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts#L67-L67)

*   Monitors browser connectivity state
*   Provides `NetworkMonitor` service for offline detection

**WorkerClientLive**[packages/runtime/client/src/services/runtime/live-layer.ts 70](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts#L70-L70)

*   Provides access to Web Worker transport
*   Enables background task execution

**RuntimeQueryClient**[packages/runtime/client/src/services/runtime/live-layer.ts 73](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts#L73-L73)

*   Wraps TanStack `QueryClient` as Effect service
*   Enables Effect-based query data manipulation

### Client Runtime Factory

The `createClientRuntimeLayer` function assembles these services:

[packages/runtime/client/src/services/runtime/live-layer.ts 88-95](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts#L88-L95)

```
// Combines all client services with observability
Layer.mergeAll(
  HttpClientLive,
  ObservabilityLive,
  NetworkMonitorLive,
  WorkerClientLive,
  makeQueryClientLayer(queryClient)
).pipe(Layer.provide(LogLevelLive))
```

### Client Runtime Usage Pattern

Applications create a `ManagedRuntime` from the client layer and use helper functions to execute Effects:

**Example usage** at [packages/iam/ui/src/sign-up/sign-up.view.tsx 28-30](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/src/sign-up/sign-up.view.tsx#L28-L30):

*   Component calls `useRuntime()` to access runtime
*   Creates span-wrapped executor: `makeRunClientPromise(runtime, "spanName")`
*   Executes Effects with automatic dependency injection

**Sources:**[packages/runtime/client/src/services/runtime/live-layer.ts 1-146](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts#L1-L146)[packages/iam/ui/src/sign-up/sign-up.view.tsx 28-30](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/src/sign-up/sign-up.view.tsx#L28-L30)

Server Runtime Architecture
---------------------------

The server runtime is configured for Node.js environments and provides database connections, authentication services, email delivery, and repository layers.

### Server Service Layers

**ObservabilityLive**[packages/runtime/server/src/server-runtime.ts 63](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L63-L63)

*   Telemetry: `NodeSdk` with OTLP exporters for traces and logs
*   Logging: Pretty console in development, JSON in production
*   DevTools: WebSocket-based Effect DevTools in development only

**DatabaseInfrastructureLive**[packages/runtime/server/src/server-runtime.ts 76](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L76-L76)

*   Combines domain-specific databases (`IamDb`, `FilesDb`)
*   Provides shared `Db.Live` layer (PostgreSQL via PgClient)

**RepositoriesLive**[packages/runtime/server/src/server-runtime.ts 79](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L79-L79)

*   Provides `IamRepos.layer` and `FilesRepos.layer`
*   Each repository layer contains multiple repository services
*   Depends on `DatabaseInfrastructureLive`

**CoreServicesLive**[packages/runtime/server/src/server-runtime.ts 89](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L89-L89)

*   Combines `RepositoriesLive` with `AuthEmailLive`
*   `AuthEmailLive` depends on `ResendService.Default` for email delivery

**AuthLive**[packages/runtime/server/src/server-runtime.ts 91](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L91-L91)

*   Provides `AuthService` (better-auth integration)
*   Depends on `CoreServicesLive` for database and email
*   Configured with database hooks for user/session lifecycle

**AppLive**[packages/runtime/server/src/server-runtime.ts 93](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L93-L93)

*   Top-level application layer
*   Combines `AuthLive` with `LoggerLive`
*   Serves as entry point for runtime composition

### Server Runtime Construction

The `serverRuntime` is created at [packages/runtime/server/src/server-runtime.ts 102](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L102-L102):

```
ManagedRuntime.make(
  AppLive.pipe(
    Layer.provide([ObservabilityLive, LogLevelLive])
  )
)
```

This creates a long-lived runtime that:

1.   Initializes all services on startup
2.   Manages service lifecycles (acquire/release)
3.   Provides dependency injection for all Effects

### Server Runtime Execution Helpers

Two helper functions wrap runtime execution with observability spans:

**runServerPromise**[packages/runtime/server/src/server-runtime.ts 109-113](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L109-L113)

*   Executes Effect and returns Promise
*   Automatically wraps in tracing span
*   Injects all runtime dependencies

**runServerPromiseExit**[packages/runtime/server/src/server-runtime.ts 118-122](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L118-L122)

*   Executes Effect and returns Exit value
*   Useful for error handling without exceptions
*   Also wraps in tracing span

**Usage Example** at [apps/web/src/app/layout.tsx 64](https://github.com/kriegcloud/beep-effect/blob/b64126f6/apps/web/src/app/layout.tsx#L64-L64):

```
const [nonce, appConfig] = await runServerPromise(
  getInitialProps,
  "RootLayout.getInitialProps"
);
```

**Sources:**[packages/runtime/server/src/server-runtime.ts 1-123](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L1-L123)[apps/web/src/app/layout.tsx 64](https://github.com/kriegcloud/beep-effect/blob/b64126f6/apps/web/src/app/layout.tsx#L64-L64)

Service Composition Patterns
----------------------------

### Hierarchical Layer Dependencies

Services are composed in dependency order, where each layer provides services required by the next:

### Service Definition with Dependencies

The `AuthService` demonstrates how services declare dependencies:

[packages/iam/infra/src/adapters/better-auth/Auth.service.ts 241-249](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L241-L249)

**Pattern:**

1.   **Service Definition**: Uses `Effect.Service()` with unique string tag
2.   **Dependencies Array**: Lists required services as Layer types
3.   **Effect Constructor**: Effect that produces service implementation
4.   **Accessors**: Automatically generated accessor methods

The `dependencies` field ensures:

*   Compile-time type checking of dependency graph
*   Automatic dependency resolution
*   Prevention of circular dependencies

### Layer Merging Strategies

**Independent Services (mergeAll)**

Used when services don't depend on each other:

[packages/runtime/server/src/server-runtime.ts 70](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L70-L70)

`Layer.mergeAll(IamRepos.layer, FilesRepos.layer)`
**Dependent Services (provideMerge)**

Used when one layer depends on another:

[packages/runtime/server/src/server-runtime.ts 79](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L79-L79)

`Layer.provideMerge(SliceRepositoriesLive, DatabaseInfrastructureLive)`
This pattern:

1.   Provides `DatabaseInfrastructureLive` to `SliceRepositoriesLive`
2.   Merges the result into the combined layer
3.   Exposes repository services without database layer

### Runtime Context Propagation

Effects execute within a runtime context that provides services:

When `runPromise` or `runPromiseExit` is called:

1.   Runtime constructs service context from layers
2.   Effect accesses services via dependency injection
3.   Services are provided without explicit passing

**Sources:**[packages/runtime/server/src/server-runtime.ts 69-93](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L69-L93)[packages/iam/infra/src/adapters/better-auth/Auth.service.ts 241-249](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/infra/src/adapters/better-auth/Auth.service.ts#L241-L249)

Runtime Usage in Applications
-----------------------------

### Server-Side Usage

Server routes and API handlers use `runServerPromise` to execute Effects:

[apps/web/src/app/layout.tsx 64](https://github.com/kriegcloud/beep-effect/blob/b64126f6/apps/web/src/app/layout.tsx#L64-L64)

**Pattern:**

*   Import `runServerPromise` from `@beep/runtime-server`
*   Wrap Effect with descriptive span name
*   Runtime automatically provides all dependencies
*   Returns Promise for integration with Next.js

### Client-Side Usage

React components use the `useRuntime` hook to access client runtime:

[packages/iam/ui/src/sign-up/sign-up.view.tsx 28-30](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/src/sign-up/sign-up.view.tsx#L28-L30)

**Pattern:**

1.   Call `useRuntime()` to get `ManagedRuntime` instance
2.   Create executor with `makeRunClientPromise(runtime, spanName)`
3.   Execute Effects in event handlers or async functions
4.   Runtime provides HttpClient, NetworkMonitor, QueryClient

### Query Client Integration

The client runtime wraps TanStack QueryClient as an Effect service:

[apps/web/src/libs/tanstack-query/query-data-helpers.ts 90-160](https://github.com/kriegcloud/beep-effect/blob/b64126f6/apps/web/src/libs/tanstack-query/query-data-helpers.ts#L90-L160)

**Integration Pattern:**

*   `makeQueryClientLayer` converts QueryClient to Effect service
*   Effects can access QueryClient via dependency injection
*   Enables imperative query operations within Effects
*   Combines TanStack Query's caching with Effect's composition

**Example Operations:**

*   `getData`: Retrieve cached query data
*   `setData`: Optimistically update cache
*   `invalidateQuery`: Mark query as stale
*   `refetchQuery`: Force query re-execution

**Sources:**[apps/web/src/app/layout.tsx 64](https://github.com/kriegcloud/beep-effect/blob/b64126f6/apps/web/src/app/layout.tsx#L64-L64)[packages/iam/ui/src/sign-up/sign-up.view.tsx 28-30](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/iam/ui/src/sign-up/sign-up.view.tsx#L28-L30)[apps/web/src/libs/tanstack-query/query-data-helpers.ts 90-160](https://github.com/kriegcloud/beep-effect/blob/b64126f6/apps/web/src/libs/tanstack-query/query-data-helpers.ts#L90-L160)

Runtime Configuration
---------------------

### Environment-Based Configuration

Both runtimes adjust behavior based on environment:

[packages/runtime/client/src/services/runtime/live-layer.ts 27-29](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts#L27-L29)

```
const isDevEnvironment = clientEnv.env === "dev";
const LoggerLive = isDevEnvironment ? Logger.pretty : Logger.json;
const LogLevelLive = Logger.minimumLogLevel(
  isDevEnvironment ? LogLevel.Debug : LogLevel.Info
);
```

**Development:**

*   Pretty console logging
*   Debug log level
*   DevTools enabled

**Production:**

*   Structured JSON logging
*   Info log level
*   DevTools disabled

### Slice-Specific Configuration Layers

Environment variables are still parsed once in `@beep/core-env`, but vertical slices now receive projected configs through Effect services:

*   `packages/iam/infra/src/config.ts:1` defines `IamConfig`, exposing only the IAM slice’s needs (app URLs, OAuth providers, payment keys, mail settings) and ships helpers for tests to supply overrides.
*   `packages/files/infra/src/config.ts:1` mirrors the pattern for the Files slice, surfacing the S3 bucket configuration without leaking cloud credentials elsewhere.
*   `packages/runtime/server/src/server-runtime.ts:78` provides `IamConfig.Live` alongside other runtime layers so authentication services and plugins depend on the slice contract instead of reaching into `serverEnv` directly.

This keeps cross-cutting env parsing centralized while maintaining vertical slice boundaries—the slices depend on their own configuration tags, and alternative layers can be provided in isolation during testing.

### Telemetry Configuration

OpenTelemetry exporters are configured with environment-specific URLs:

[packages/runtime/server/src/server-runtime.ts 29-30](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L29-L30)

```
const otlpTraceExporterUrl = serverEnv.otlp.traceExporterUrl.toString();
const otlpLogExporterUrl = serverEnv.otlp.logExporterUrl.toString();
```

Both client and server export to centralized OTLP collector (Grafana) specified in [docker-compose.yml 23-31](https://github.com/kriegcloud/beep-effect/blob/b64126f6/docker-compose.yml#L23-L31)

**Sources:**[packages/runtime/client/src/services/runtime/live-layer.ts 27-54](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts#L27-L54)[packages/runtime/server/src/server-runtime.ts 27-43](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L27-L43)[docker-compose.yml 23-31](https://github.com/kriegcloud/beep-effect/blob/b64126f6/docker-compose.yml#L23-L31)

Type Safety and Inference
-------------------------

The Layer system provides compile-time type safety throughout the dependency graph:

**Type-Level Guarantees:**

1.   **Dependency Requirements**: TypeScript enforces that all service dependencies are provided
2.   **Service Availability**: Effects can only access services present in runtime context
3.   **Error Tracking**: Effect error channel tracks all possible failure modes
4.   **Requirement Elimination**: `Layer.provide` removes requirements from type signature

**Example Type Flow:**

```
Effect<A, E, IamDb | EmailService>  // Requires two services
  .pipe(Layer.provide(IamDb.Live))  // Provides IamDb
  => Effect<A, E, EmailService>     // Still requires EmailService
  .pipe(Layer.provide(EmailService.Default))
  => Effect<A, E, never>            // No requirements
```

**Sources:**[packages/runtime/server/src/server-runtime.ts 102-104](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/server/src/server-runtime.ts#L102-L104)[packages/runtime/client/src/services/runtime/live-layer.ts 88-95](https://github.com/kriegcloud/beep-effect/blob/b64126f6/packages/runtime/client/src/services/runtime/live-layer.ts#L88-L95)
